/* Goo Engine 0.11.3
 * Copyright 2014 Goo Technologies AB
 */
(function () {
	'use strict';
	if (!window.define) {
		var _moduleBank = {};

		window.define = function (nam, dependencies, callback) {
			var resolvedModules;
			if (callback instanceof Function) {
				dependencies.forEach(function (dependency) {
					if (!_moduleBank[dependency] && dependency !== 'exports') {
						console.warn(dependency, 'requested by', nam, 'was not declared');
					}
				});
				resolvedModules = dependencies.map(function (dependency) {
					return _moduleBank[dependency];
				});
			} else {
				resolvedModules = [];
				callback = dependencies;
			}

			if (dependencies[0] === "exports") {
				_moduleBank[nam] = {};
				callback(_moduleBank[nam]);
			} else {
				_moduleBank[nam] = callback.apply(null, resolvedModules);
			}
		};

		window.require = function (dependencies, callback) {
			dependencies.forEach(function (dependency) {
				if (!_moduleBank[dependency]) {
					console.warn(dependency, 'was not declared');
				}
			});
			var resolvedModules = dependencies.map(function (dependency) {
				return _moduleBank[dependency];
			});

			callback.apply(null, resolvedModules);
		};

		window.goo = {};
	}
})();(function(window) {function f(){
define("goo/util/ArrayUtil",[],function(){"use strict";var t={};return t.getTypedArray=function(t,e){var r=e[0],i=e[1],n=e[2];if("float32"===n)return new Float32Array(t,r,i);if("uint8"===n)return new Uint8Array(t,r,i);if("uint16"===n)return new Uint16Array(t,r,i);if("uint32"===n)return new Uint32Array(t,r,i);throw new Error("Binary format "+n+" is not supported")},t.remove=function(t,e,r){var i=-1;if("function"==typeof r){for(var n=0;n<t.length;n++)if(r(t[n],e)){i=n;break}}else i=t.indexOf(e);i>-1&&t.splice(i,1)},t.find=function(t,e){for(var r=0;r<t.length;r++)if(e(t[r]))return t[r];return null},t}),define("goo/entities/Bus",["goo/util/ArrayUtil"],function(t){"use strict";function e(){this.trie={name:"",listeners:[],children:{}}}return e.prototype.emit=function(t,e,r){r=!!r,"string"==typeof t&&(t=[t]);for(var i=0;i<t.length;i++)this._emitToSingle(t[i],e,r);return this},e.prototype.getLastMessageOn=function(t){var e=this._getNode(t);return e?e.latestData:void 0},e.prototype._getNode=function(t,e){for(var r=this.trie,i=t.split("."),n=0;n<i.length;n++){var o=i[n];if(r.children[o])r=r.children[o];else{if(!e)return;var a={listeners:[],children:[]};r.children[o]=a,r=a}}return r},e.prototype._emitToSingle=function(t,e,r){var i=this._getNode(t,r);i&&(this._emitToAll(i,e),r&&(i.latestData=e))},e.prototype._emitToAll=function(t,e){for(var r=0;r<t.listeners.length;r++)t.listeners[r](e);for(var i=Object.keys(t.children),r=0;r<i.length;r++)this._emitToAll(t.children[i],e)},e.prototype.addListener=function(t,e,r){r=!!r;for(var i=this.trie,n=t.split("."),o=0;o<n.length;o++){var a=n[o];if(i.children[a])i=i.children[a];else{var s={listeners:[],children:[]};i.children[a]=s,i=s}}return-1===i.listeners.indexOf(e)&&(i.listeners.push(e),r&&i.latestData&&e(i.latestData)),this},e.prototype.removeListener=function(e,r){var i=this._getNode(e);return i&&t.remove(i.listeners,r),this},e.prototype.removeAllOnChannel=function(t){var e=this._getNode(t);return e&&(e.listeners=[]),this},e.prototype.removeChannelAndChildren=function(t){var e=t.split(".");if(e.length>1){var r=e.pop(),i=e.join("."),n=this._getNode(i);delete n.children[r]}else delete this.trie.children[t];return this},e.prototype._removeListener=function(e,r){t.remove(e.listeners,r);for(var i=Object.keys(e.children),n=0;n<i.length;n++)this._removeListener(e.children[i[n]],r)},e.prototype.removeListenerFromAllChannels=function(t){return this._removeListener(this.trie,t),this},e.prototype.clear=function(){this.trie={name:"",listeners:[],children:{}}},e}),define("goo/entities/components/Component",[],function(){"use strict";function t(){this.enabled=!0,this.installedAPI={}}return t.prototype.applyAPI=function(t){this.installedAPI||(this.installedAPI={});var e=this.api;if(e)for(var r=Object.keys(e),i=0;i<r.length;i++){var n=r[i];"undefined"==typeof t[n]?(t[n]=e[n],this.installedAPI[n]=!0):console.warn("Could not install method "+n+" of "+this.type+" as it is already taken")}},t.prototype.removeAPI=function(t){for(var e=this.installedAPI,r=Object.keys(e),i=0;i<r.length;i++){var n=r[i];delete t[n]}},t}),define("goo/util/StringUtil",[],function(){"use strict";function t(){}t.endsWith=function(t,e){return-1!==t.indexOf(e,t.length-e.length)},t.startsWith=function(t,e){return 0===t.indexOf(e)},t.capitalize=function(t){return t.charAt(0).toUpperCase()+t.substring(1)},t.uncapitalize=function(t){return t.charAt(0).toLowerCase()+t.substring(1)},t.createUniqueId=function(t){var e=Date.now(),r="xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(t){var r=(e+16*Math.random())%16|0;return"x"===t?r.toString(16):(3&r|8).toString(16)});return void 0===t?r:r+"."+t},t.getUntil=function(t,e){var r=t.indexOf(e);return-1===r?t:t.slice(0,r)},t.getAfterLast=function(t,e){var r=t.lastIndexOf(e);return-1===r?t:t.slice(r+e.length,t.length)},t.getFrom=function(t,e){var r=t.indexOf(e);return-1===r?"":t.slice(r+e.length,t.length)},t.getIndexedName=function(t,e,r){r||(r="_");var i,n=new RegExp(t+"("+r+"\\d+)?"),o=0;for(i in e){var a=e[i],s=n.exec(a);if(s)if(s.length>1&&s[1]){var h=parseInt(s[1].substring(r.length),10);h>=o&&(o=h+1)}else o=1}return t+r+o},t.getUniqueName=function(e,r,i){return-1===r.indexOf(e)?e:t.getIndexedName(e,r,i)},t.toAscii=function(t){return t.replace(/([^\x00-\x7F])/g,"x")},t.hashCode=function(t){var e=0;if(0===t.length)return e;for(var r=0;r<t.length;r++){var i=t.charCodeAt(r);e=(e<<5)-e+i,e&=e}return btoa(e).replace("/","_").replace("+","-")};var e=Date.now();t.getUniqueId=function(){e++;var r=Array.prototype.slice.call(arguments,0).join("");return t.hashCode(e+""+r)},t.escapeHtmlEntities=function(t){var e=document.createElement("div");e.appendChild(document.createTextNode(t));var r={34:"quot"};return e.innerHTML.replace(/[\u00A0-\u2666\"\']/g,function(t){var e=r[t.charCodeAt(0)];return"&"+(e||"#"+t.charCodeAt(0))+";"})};var r=new RegExp("^(?:([^:/?#.]+):)?(?://(?:([^/?#]*)@)?([\\w\\d\\-\\u0100-\\uffff.%]*)(?::([0-9]+))?)?([^?#]+)?(?:\\?([^#]*))?(?:#(.*))?$");return t.parseURL=function(t){var e=t.match(r);return{scheme:e[1],user_info:e[2],domain:e[3],port:e[4],path:e[5],query_data:e[6],fragment:e[7]}},t}),define("goo/entities/Entity",["goo/entities/components/Component","goo/util/StringUtil"],function(t,e){"use strict";function r(t,i,n){this._world=t,this._components=[],this.id=void 0!==n?n:e.createUniqueId("entity"),this._index=r.entityCount,this._tags={},this._attributes={},this.name=void 0!==i?i:"Entity_"+this._index,this.skip=!1,this.hidden=!1,this._hidden=!1,this.static=!1,r.entityCount++}function i(t){return t.charAt(0).toLowerCase()+t.substr(1)}return r.prototype.set=function(){for(var e=0;e<arguments.length;e++){var r=arguments[e];if(r instanceof t)this.setComponent(r);else{if(!this._world)return this;for(var i=this._world._components,n=0;n<i.length;n++){var o=i[n],a=o.applyOnEntity(r,this);if(a)break}}}return this},r.prototype.addToWorld=function(t){return this._world.addEntity(this,t),this},r.prototype.removeFromWorld=function(t){return this._world.removeEntity(this,t),this},r.prototype.setComponent=function(t){return this.hasComponent(t.type)?this:(this._components.push(t),this[i(t.type)]=t,t.attached&&t.attached(this),t.applyAPI(this),this._world&&this._world.entityManager.containsEntity(this)&&this._world.changedEntity(this,t,"addedComponent"),this)},r.prototype.hasComponent=function(t){var e=i(t),r=this[e];return!!r&&this._components.indexOf(r)>-1},r.prototype.getComponent=function(t){var e=i(t);return this.hasComponent(t)?this[e]:void 0},r.prototype.clearComponent=function(t){var e=i(t),r=this[e];if(r&&this._components.indexOf(r)>-1){r.detached&&r.detached(this),r.removeAPI(this);var n=this._components.indexOf(r);this._components.splice(n,1),delete this[e],this._world&&this._world.entityManager.containsEntity(this)&&this._world.changedEntity(this,r,"removedComponent")}return this},r.prototype.setTag=function(t){return this._tags[t]=!0,this},r.prototype.hasTag=function(t){return!!this._tags[t]},r.prototype.clearTag=function(t){return delete this._tags[t],this},r.prototype.setAttribute=function(t,e){return this._attributes[t]=e,this},r.prototype.hasAttribute=function(t){return"undefined"!=typeof this._attributes[t]},r.prototype.getAttribute=function(t){return this._attributes[t]},r.prototype.clearAttribute=function(t){return delete this._attributes[t],this},r.prototype.toString=function(){return this.name},r.entityCount=0,r}),define("goo/entities/Selection",[],function(){"use strict";function t(){if(this.stack=[],1===arguments.length){var r=arguments[0];r instanceof t?r.top&&this.stack.push(r.top):this.stack.push(Array.isArray(r)?r:[r])}else arguments.length>1&&this.stack.push(Array.prototype.slice.call(arguments,0));this.stack.length>0&&(this.stack[0]=e(this.stack[0])),this.top=0===this.stack.length?null:this.stack[0]}function e(t){for(var e=[],r=0;r<t.length;r++){var i=t[r];t.lastIndexOf(i)===r&&e.push(i)}return e}function r(){if(1===arguments.length){var e=arguments[0];return e instanceof t?e.top?e.top:[]:Array.isArray(e)?e:[e]}return arguments.length>1?Array.prototype.slice.call(arguments,0):[]}return t.EMPTY=new t,t.prototype.contains=function(t){return null===this.top?!1:-1!==this.top.indexOf(t)},t.prototype.size=function(){return null===this.top?0:this.top.length},t.prototype.each=function(t){if(null===this.top)return this;for(var e=0;e<this.top.length&&t(this.top[e],e)!==!1;e++);return this},t.prototype.filter=function(t){if(null===this.top)return this;var e=this.top.filter(t);return this.stack.push(e),this.top=e,this},t.prototype.map=function(t){if(null===this.top)return this;var e=this.top.map(t);return this.stack.push(e),this.top=e,this},t.prototype.flatMap=function(t){if(null===this.top)return this;var e=this.top.map(t),r=e.reduce(function(t,e){return t.concat(e)},[]);return this.stack.push(r),this.top=r,this},t.prototype.reduce=function(t,e){if(null===this.top)return this;var r=[this.top.reduce(t,e)];return this.stack.push(r),this.top=r,this},t.prototype.and=function(){if(null===this.top)return this;var t=r.apply(null,arguments),i=this.top.concat(t);return i=e(i),this.stack.push(i),this.top=i,this},t.prototype.intersects=function(t){if(null===this.top)return this;var e,i,t=r.apply(null,arguments),n=[];t.length>this.top.length?(e=this.top,i=t):(e=t,i=this.top);for(var o=0;o<e.length;o++){var a=e[o];-1!==i.indexOf(a)&&n.push(a)}return this.stack.push(n),this.top=n,this},t.prototype.without=function(){if(null===this.top)return this;for(var t=r.apply(null,arguments),e=[],i=0;i<this.top.length;i++){var n=this.top[i];-1===t.indexOf(n)&&e.push(n)}return this.stack.push(e),this.top=e,this},t.prototype.andSelf=function(){if(null===this.top)return this;if(this.stack.length<=1)return this;var t=this.stack[this.stack.length-2],r=t.concat(this.top);return r=e(r),this.stack.push(r),this.top=r,this},t.prototype.end=function(){return null===this.top?this:(this.stack.pop(),this.top=0===this.stack.length?null:this.stack[this.stack.length-1],this)},t.prototype.first=function(){return null===this.top?null:this.top[0]},t.prototype.clone=function(){var e=new t;return e.top=this.top,e.stack=this.stack.concat([]),e},t.prototype.get=function(t){return"number"!=typeof t?null===this.top?[]:this.top.concat([]):0>t?null===this.top?void 0:this.top[this.top.length+t]:null===this.top?void 0:this.top[t]},t.prototype.toArray=function(){return null===this.top?[]:this.top.concat([])},t}),define("goo/entities/EntitySelection",["goo/entities/Selection"],function(t){"use strict";function e(){t.apply(this,arguments)}function r(){if(1===arguments.length){var t=arguments[0];return t instanceof e?t.top?t.top:[]:Array.isArray(t)?t:[t]}return arguments.length>1?Array.prototype.slice.call(arguments,0):[]}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.and=function(t){if(null===this.top)return this;var e,i,n,t=r.apply(null,arguments);t.length>this.top.length?(i=this.top,n=t):(i=t,n=this.top);for(var o=[],a=0;a<n.length;a++){var s=n[a].id;o[s]=!0}e=n.concat([]);for(var a=0;a<i.length;a++)o[i[a].id]||e.push(i[a]);return this.stack.push(e),this.top=e,this},e.prototype.intersects=function(t){if(null===this.top)return this;var e,i,n,t=r.apply(null,arguments);t.length>this.top.length?(i=this.top,n=t):(i=t,n=this.top);for(var o=[],a=0;a<n.length;a++){var s=n[a].id;o[s]=!0}e=[];for(var a=0;a<i.length;a++)o[i[a].id]&&e.push(i[a]);return this.stack.push(e),this.top=e,this},e.prototype.without=function(){if(null===this.top)return this;for(var t,e=r.apply(null,arguments),i=[],n=0;n<e.length;n++){var o=e[n].id;i[o]=!0}t=[];for(var n=0;n<this.top.length;n++)i[this.top[n].id]||t.push(this.top[n]);return this.stack.push(t),this.top=t,this},e.prototype.andSelf=function(){if(null===this.top)return this;if(this.stack.length<=1)return this;var t=this.stack[this.stack.length-2];return this.and.apply(this,t)},e.prototype.parent=function(){if(null===this.top)return this;var t=[],e=this.top.filter(function(e){return e.transformComponent.parent?t[e.transformComponent.parent.entity.id]?!1:(t[e.transformComponent.parent.entity.id]=!0,!0):!1}).map(function(t){return t.transformComponent.parent.entity});return this.stack.push(e),this.top=e,this},e.prototype.children=function(){if(null===this.top)return this;var t=this.top.map(function(t){return t.transformComponent.children.map(function(t){return t.entity})}),e=t.reduce(function(t,e){return t.concat(e)},[]);return this.stack.push(e),this.top=e,this},e}),define("goo/util/ObjectUtil",[],function(){"use strict";var t={},e=Array.prototype,r=e.slice,i=e.forEach;t.defaults=function(t){return n(r.call(arguments,1),function(e){if(e)for(var r in e)("undefined"==typeof t[r]||null===t[r])&&(t[r]=e[r])}),t},t.extend=function(t){return n(r.call(arguments,1),function(e){if(e)for(var r in e)t[r]=e[r]}),t},t.isObject=function(t){return t===Object(t)},t.clone=function(e){return t.isObject(e)?Array.isArray(e)?e.slice():t.extend({},e):e};var n=t.each=t.forEach=function(t,e,r,n){if("undefined"!=typeof t&&null!==t)if(i&&t.forEach===i)t.forEach(e,r);else if(t.length===+t.length)for(var o=0,a=t.length;a>o;o++)e.call(r,t[o],o,t);else{var s=Object.keys(t);void 0!==n&&s.sort(function(e,r){return t[e][n]-t[r][n]});for(var o=0,h=s.length;h>o;o++)e.call(r,t[s[o]],s[o],t)}};return t.deepClone=function(e){if(!e)return e;var r,i=[Number,String,Boolean];if(i.forEach(function(t){e instanceof t&&(r=t(e))}),"undefined"==typeof r)if("[object Array]"===Object.prototype.toString.call(e))r=[],e.forEach(function(e,i){r[i]=t.deepClone(e)});else if("object"==typeof e)if(e.nodeType&&"function"==typeof e.cloneNode)var r=e.cloneNode(!0);else if(e.prototype)r=e;else if(e instanceof Date)r=new Date(e);else{r={};for(var n in e)r[n]=t.deepClone(e[n])}else r=e;return r},t}),define("goo/scripts/ScriptUtils",["goo/util/ObjectUtil"],function(t){"use strict";var e={};return e.defaultsByType={"float":0,"int":0,string:"",vec3:[0,0,0],"boolean":!1,texture:{},entity:{}},e.fillDefaultValues=function(r,i){if(i instanceof Array){var n=[];i.forEach(function(i){i&&"string"==typeof i.key&&((null===i["default"]||void 0===i["default"])&&(i["default"]=e.defaultsByType[i.type]),n.push(i.key),"undefined"==typeof r[i.key]&&(r[i.key]=t.clone(i["default"])))});for(var o in r)-1===n.indexOf(o)&&"enabled"!==o&&delete r[o]}},e.fillDefaultNames=function(t){function e(t){if("string"!=typeof t||0===t.length)return"";var e=t[0].toUpperCase()+t.slice(1);return e.replace(/(.)([A-Z])/g,"$1 $2")}t instanceof Array&&t.forEach(function(t){t&&"undefined"==typeof t.name&&(t.name=e(t.key))})},e.getKey=function(t){return e._keys[t]?e._keys[t]:t.charCodeAt(0)},e._keys={Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,Meta:91,Pause:19,Capslock:20,Esc:27,Space:32,Pageup:33,Pagedown:34,End:35,Home:36,Leftarrow:37,Uparrow:38,Rightarrow:39,Downarrow:40,Insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"0numpad":96,"1numpad":97,"2numpad":98,"3numpad":99,"4numpad":100,"5numpad":101,"6numpad":102,"7numpad":103,"8numpad":104,"9numpad":105,Multiply:106,Plus:107,Minus:109,Dot:110,Slash1:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,Equals:187,Comma:188,Slash:191,Backslash:220},e._keyInverse=function(t){for(var e={},r=Object.keys(t),i=0;i<r.length;i++)e[t[r[i]]]=r[i];return e}(e._keys),e.keyForCode=function(t){return e._keyInverse[t]},e}),define("goo/scripts/Scripts",["goo/scripts/ScriptUtils","goo/util/ObjectUtil"],function(t,e){"use strict";var r={},i={},n={};return n.register=function(e){var i=e.externals.key||e.externals.name;return r[i]?void console.warn("Script already registered for key "+i):(t.fillDefaultNames(e.externals.parameters),void(r[i]=e))},n.addClass=function(t,e){i[t]=e},n.getClasses=function(){return i},n.getScript=function(t){return r[t]},n.create=function(i,n){var o;if("string"==typeof i){if(o=r[i],!o)throw new Error('Script "'+i+'" is not registered')}else"function"==typeof i&&(o=i);var a=o();return a.parameters={},a.environment=null,a.externals=o.externals,o.externals&&(t.fillDefaultNames(a.externals.parameters),t.fillDefaultValues(a.parameters,o.externals.parameters)),n&&e.extend(a.parameters,n),a},n.allScripts=function(){for(var t={},e=Object.keys(r),i=0;i<e.length;i++){var n=e[i];t[n]=r[n]}return t},n}),define("goo/math/MathUtils",[],function(){"use strict";function t(){}return t.DEG_TO_RAD=Math.PI/180,t.RAD_TO_DEG=180/Math.PI,t.HALF_PI=.5*Math.PI,t.TWO_PI=2*Math.PI,t.EPSILON=1e-5,t.radFromDeg=function(e){return e*t.DEG_TO_RAD},t.degFromRad=function(e){return e*t.RAD_TO_DEG},t.lerp=function(t,e,r){return e===r?e:e+(r-e)*t},t.clamp=function(t,e,r){return r>e?e>t?e:t>r?r:t:r>t?r:t>e?e:t},t.radialClamp=function(e,r,i){var n=(r+i)/2+(i>r?Math.PI:0),o=t.moduloPositive(e-n,t.TWO_PI),a=t.moduloPositive(r-n,t.TWO_PI),s=t.moduloPositive(i-n,t.TWO_PI);return 0>e&&r>0?r-=t.TWO_PI:e>0&&0>r&&(r+=t.TWO_PI),e>t.TWO_PI&&i<t.TWO_PI&&(i+=t.TWO_PI),a>o?r:o>s?i:e},t.moduloPositive=function(t,e){var r=t%e;return r+=0>r?e:0},t.scurve3=function(t){return(-2*t+3)*t*t},t.scurve5=function(t){return((6*t-15)*t+10)*t*t*t},t.sphericalToCartesian=function(t,e,r,i){var n=t*Math.cos(r);i.x=n*Math.cos(e),i.y=t*Math.sin(r),i.z=n*Math.sin(e)},t.cartesianToSpherical=function(t,e,r,i){var n=Math.sqrt(t*t+r*r);i.x=Math.sqrt(t*t+e*e+r*r),i.y=Math.atan2(r,t),i.z=Math.atan2(e,n)},t.getTriangleNormal=function(t,e,r,i,n,o,a,s,h){var d=i-t,l=n-e,u=o-r,c=a-t,p=s-e,f=h-r,m=l*f-u*p,g=u*c-d*f,v=d*p-l*c;return[m,g,v]},t.isPowerOfTwo=function(t){return 0===(t&t-1)},t.nearestHigherPowerOfTwo=function(t){return Math.floor(Math.pow(2,Math.ceil(Math.log(t)/Math.log(2))))},t.closeTo=function(t,e,r){return r="undefined"!=typeof r?r:.001,Math.abs(t-e)<=r},t.sign=function(t){return 0>t?-1:t>0?1:0},t.triangleArea=function(t,e,r){return Math.abs(t.x*e.y+e.x*r.y+r.x*t.y-e.y*r.x-r.y*t.x-t.y*e.x)/2},t.barycentricInterpolation=function(e,r,i,n){var o=t.triangleArea(r,i,n),a=t.triangleArea(e,i,n),s=t.triangleArea(e,r,n),h=o+a+s;if(!h){if(n[0]===e[0]&&n[2]===e[2])return e;if(n[0]===r[0]&&n[2]===r[2])return r;if(n[0]===i[0]&&n[2]===i[2])return i}return n.z=(o*e.z+a*r.z+s*i.z)/h,n},t.smoothstep=function(e,r,i){return i=t.clamp((i-e)/(r-e),0,1),i*i*(3-2*i)},t.randomSeed=1337,t.fastRandom=function(){return t.randomSeed=(9301*t.randomSeed+49297)%233280,t.randomSeed/233280},t}),define("goo/math/Vector",["goo/math/MathUtils"],function(t){"use strict";function e(t){this.data=new Float32Array(t||0)}return e.setupAliases=function(t,e){for(var r=0;r<e.length;r++)!function(i){for(var n=0;n<e[i].length;n++)Object.defineProperty(t,e[i][n],{get:function(){return this.data[i]},set:function(t){this.data[i]=t}});Object.defineProperty(t,r,{get:function(){return this.data[i]},set:function(t){this.data[i]=t}})}(r)},e.add=function(t,r,i){var n=t.data||t,o=r.data||r,a=n.length;if(i||(i=new e(a)),o.length!==a||i.data.length!==a)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var s=0;a>s;s++)i.data[s]=n[s]+o[s];return i},e.prototype.add=function(t){return e.add(this,t,this)},e.sub=function(t,r,i){var n=t.data||t,o=r.data||r,a=n.length;if(i||(i=new e(a)),o.length!==a||i.data.length!==a)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var s=0;a>s;s++)i.data[s]=n[s]-o[s];return i},e.prototype.sub=function(t){return e.sub(this,t,this)},e.mul=function(t,r,i){var n=t.data||t,o=r.data||r,a=n.length;if(i||(i=new e(a)),o.length!==a||i.data.length!==a)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var s=0;a>s;s++)i.data[s]=n[s]*o[s];return i},e.prototype.mul=function(t){return e.mul(this,t,this)},e.div=function(t,r,i){var n=t.data||t,o=r.data||r,a=n.length;if(i||(i=new e(a)),o.length!==a||i.data.length!==a)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var s=0;a>s;s++)i.data[s]=n[s]/o[s];return i},e.prototype.div=function(t){return e.div(this,t,this)},e.copy=function(t,r){var i=t.data.length;if(r||(r=new e(i)),r.data.length!==i)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return r.data.set(t.data),r},e.prototype.copy=function(t){return e.copy(t,this)},e.dot=function(t,e){var r=t.data||t,i=e.data||e,n=r.length;if(i.length!==n)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var o=0,a=0;n>a;a++)o+=r[a]*i[a];return o},e.prototype.dot=function(t){return e.dot(this,t)},e.apply=function(t,r,i){var n=t.rows,o=t.cols,a=r.data.length;if(i||(i=new e(n)),i.data.length!==n||o!==a)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};if(i===r)return e.copy(e.apply(t,r),i);for(var s=0;o>s;s++)for(var h=s*n,d=0;n>d;d++){for(var l=0,u=0;a>u;u++)l+=t.data[u*t.rows+d]*r.data[u];i.data[h+d]=l}return i},e.prototype.apply=function(t){return e.apply(t,this,this)},e.equals=function(e,r){var i=e.data.length;if(i!==r.data.length)return!1;for(var n=0;i>n;n++)if(Math.abs(e.data[n]-r.data[n])>t.EPSILON)return!1;return!0},e.prototype.equals=function(t){return e.equals(this,t)},e.distanceSquared=function(t,r){return e.sub(t,r).lengthSquared()},e.prototype.distanceSquared=function(t){return e.sub(this,t).lengthSquared()},e.distance=function(t,r){return e.sub(t,r).length()},e.prototype.distance=function(t){return e.sub(this,t).length()},e.prototype.lengthSquared=function(){return e.dot(this,this)},e.prototype.length=function(){return Math.sqrt(e.dot(this,this))},e.prototype.scale=function(t){for(var e=this.data.length-1;e>=0;e--)this.data[e]*=t;return this},e.prototype.invert=function(){for(var t=0;t<this.data.length;t++)this.data[t]=0-this.data[t];return this},e.prototype.normalize=function(){var e=this.length(),r=this.data.length;if(e<t.EPSILON)for(var i=0;r>i;i++)this.data[i]=0;else{e=1/e;for(var i=0;r>i;i++)this.data[i]*=e}return this},e.prototype.clone=function(){return e.copy(this)},e.prototype.set=function(){if(1===arguments.length&&"object"==typeof arguments[0])if(arguments[0]instanceof e)this.copy(arguments[0]);else if(arguments[0].length>1)for(var t=0;t<arguments[0].length;t++)this.data[t]=arguments[0][t];else this.set(arguments[0][0]);else for(var t=0;t<arguments.length;t++)this.data[t]=arguments[t];return this},e.prototype.toString=function(){var t="";t+="[";for(var e=0;e<this.data.length;e++)t+=this.data[e],t+=e!==this.data.length-1?", ":"";return t+="]"},e}),define("goo/math/Vector3",["goo/math/Vector"],function(t){"use strict";function e(){t.call(this,3),0!==arguments.length?this.set(arguments):this.setd(0,0,0)}return e.prototype=Object.create(t.prototype),t.setupAliases(e.prototype,[["x","u","r"],["y","v","g"],["z","w","b"]]),e.ZERO=new e(0,0,0),e.ONE=new e(1,1,1),e.UNIT_X=new e(1,0,0),e.UNIT_Y=new e(0,1,0),e.UNIT_Z=new e(0,0,1),e.add=function(t,r,i){"number"==typeof t&&(t=[t,t,t]),"number"==typeof r&&(r=[r,r,r]),i||(i=new e);var n=t.data||t,o=r.data||r;if(3!==n.length||3!==o.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return i.data[0]=n[0]+o[0],i.data[1]=n[1]+o[1],i.data[2]=n[2]+o[2],i},e.addv=function(t,r,i){return i||(i=new e),i.data[0]=t.data[0]+r.data[0],i.data[1]=t.data[1]+r.data[1],i.data[2]=t.data[2]+r.data[2],i},e.prototype.add=function(t){return e.add(this,t,this)},e.sub=function(t,r,i){"number"==typeof t&&(t=[t,t,t]),"number"==typeof r&&(r=[r,r,r]),i||(i=new e);var n=t.data||t,o=r.data||r;if(3!==n.length||3!==o.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return i.data[0]=n[0]-o[0],i.data[1]=n[1]-o[1],i.data[2]=n[2]-o[2],i},e.subv=function(t,r,i){return i||(i=new e),i.data[0]=t.data[0]-r.data[0],i.data[1]=t.data[1]-r.data[1],i.data[2]=t.data[2]-r.data[2],i},e.prototype.sub=function(t){return e.sub(this,t,this)},e.prototype.invert=function(){return this.data[0]=0-this.data[0],this.data[1]=0-this.data[1],this.data[2]=0-this.data[2],this},e.mul=function(t,r,i){if(i||(i=new e),"number"==typeof t){var n=r.data||r;i.data[0]=t*n[0],i.data[1]=t*n[1],i.data[2]=t*n[2]}else if("number"==typeof r){var o=t.data||t;i.data[0]=o[0]*r,i.data[1]=o[1]*r,i.data[2]=o[2]*r}else{var o=t.data||t,n=r.data||r;if(3!==o.length||3!==n.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};i.data[0]=o[0]*n[0],i.data[1]=o[1]*n[1],i.data[2]=o[2]*n[2]}return i},e.prototype.mul=function(t){return e.mul(this,t,this)},e.div=function(t,r,i){if(i||(i=new e),"number"==typeof t){var n=r.data||r;i.data[0]=t/n[0],i.data[1]=t/n[1],i.data[2]=t/n[2]}else if("number"==typeof r){var o=1/r,a=t.data||t;i.data[0]=a[0]*o,i.data[1]=a[1]*o,i.data[2]=a[2]*o}else{var a=t.data||t,n=r.data||r;if(3!==a.length||3!==n.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};i.data[0]=a[0]/n[0],i.data[1]=a[1]/n[1],i.data[2]=a[2]/n[2]}return i},e.prototype.div=function(t){return e.div(this,t,this)},e.dot=function(t,e){"number"==typeof t&&(t=[t,t,t]),"number"==typeof e&&(e=[e,e,e]);var r=t.data||t,i=e.data||e;if(3!==r.length||3!==i.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};var n=0;return n+=r[0]*i[0],n+=r[1]*i[1],n+=r[2]*i[2]},e.dotv=function(t,e){var r=t.data,i=e.data,n=0;return n+=r[0]*i[0],n+=r[1]*i[1],n+=r[2]*i[2]},e.prototype.dot=function(t){return e.dot(this,t)},e.cross=function(t,r,i){i||(i=new e);var n=t.data||t,o=r.data||r;if(3!==n.length||3!==o.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};var a=o[2]*n[1]-o[1]*n[2],s=o[0]*n[2]-o[2]*n[0],h=o[1]*n[0]-o[0]*n[1];return i.data[0]=a,i.data[1]=s,i.data[2]=h,i},e.prototype.cross=function(t){return e.cross(this,t,this)},e.prototype.lerp=function(t,e){return this.data[0]=(1-e)*this.data[0]+e*t.data[0],this.data[1]=(1-e)*this.data[1]+e*t.data[1],this.data[2]=(1-e)*this.data[2]+e*t.data[2],this},e.prototype.setd=function(t,e,r){return this.data[0]=t,this.data[1]=e,this.data[2]=r,this},e.prototype.seta=function(t){return this.data[0]=t[0],this.data[1]=t[1],this.data[2]=t[2],this},e.prototype.setv=function(t){return this.data[0]=t.data[0],this.data[1]=t.data[1],this.data[2]=t.data[2],this},e.prototype.add_d=function(t,e,r){return this.data[0]+=t,this.data[1]+=e,this.data[2]+=r,this},e.prototype.addv=function(t){return this.data[0]+=t.data[0],this.data[1]+=t.data[1],this.data[2]+=t.data[2],this},e.prototype.mulv=function(t){return this.data[0]*=t.data[0],this.data[1]*=t.data[1],this.data[2]*=t.data[2],this},e.prototype.muld=function(t,e,r){return this.data[0]*=t,this.data[1]*=e,this.data[2]*=r,this},e.prototype.subv=function(t){return this.data[0]-=t.data[0],this.data[1]-=t.data[1],this.data[2]-=t.data[2],this},e.prototype.sub_d=function(t,e,r){return this.data[0]-=t,this.data[1]-=e,this.data[2]-=r,this},e.prototype.lengthSquared=function(){return this.data[0]*this.data[0]+this.data[1]*this.data[1]+this.data[2]*this.data[2]},e.prototype.length=function(){return Math.sqrt(this.lengthSquared())},e.prototype.normalize=function(){var t=this.length();return 1e-7>t?(this.data[0]=0,this.data[1]=0,this.data[2]=0):(t=1/t,this.data[0]*=t,this.data[1]*=t,this.data[2]*=t),this},e.distanceSquared=function(t,e){var r=t.data[0]-e.data[0],i=t.data[1]-e.data[1],n=t.data[2]-e.data[2];return r*r+i*i+n*n},e.distance=function(t,r){return Math.sqrt(e.distanceSquared(t,r))},e.prototype.distanceSquared=function(t){return e.distanceSquared(this,t)},e.prototype.distance=function(t){return e.distance(this,t)},e.prototype.clone=function(){return new e(this)},e}),define("goo/renderer/bounds/BoundingVolume",["goo/math/Vector3"],function(t){"use strict";function e(e){this.center=new t,e&&this.center.setv(e),this.min=new t(1/0,1/0,1/0),this.max=new t(-1/0,-1/0,-1/0)}return e.Outside=0,e.Inside=1,e.Intersects=2,e}),define("goo/renderer/BufferData",[],function(){"use strict";function t(t,e){this.data=t,this.target=e,this.glBuffer=null,this._dataUsage="StaticDraw",this._dataNeedsRefresh=!1}return t.prototype.setDataUsage=function(t){this._dataUsage=t},t.prototype.setDataNeedsRefresh=function(){this._dataNeedsRefresh=!0},t.prototype.destroy=function(t){t.deleteBuffer(this.glBuffer),this.glBuffer=null},t}),define("goo/renderer/Util",[],function(){"use strict";function t(){}function e(t,e,r){var i=document.createElement("canvas");i.width=e,i.height=r;var n=i.getContext("2d"),o=n.createImageData(e,r);return o.data.set(t),n.putImageData(o,0,0),i}return t.getByteSize=function(t){switch(t){case"Byte":return 1;case"UnsignedByte":return 1;case"Short":return 2;case"UnsignedShort":return 2;case"Int":return 4;case"HalfFloat":return 2;case"Float":return 4;case"Double":return 8;default:throw"Unknown type: "+t}},t.checkGLError=function(t){for(var e=t.getError(),r=!1;e!==t.NO_ERROR;){if(r=!0,e===t.INVALID_ENUM)console.error("An unacceptable value is specified for an enumerated argument. The offending command is ignored and has no other side effect than to set the error flag.");else if(e===t.INVALID_VALUE)console.error("A numeric argument is out of range. The offending command is ignored and has no other side effect than to set the error flag.");else if(e===t.INVALID_OPERATION)console.error("The specified operation is not allowed in the current state. The offending command is ignored and has no other side effect than to set the error flag.");else if(e===t.FRAMEBUFFER_COMPLETE)console.error("The command is trying to render to or read from the framebuffer while the currently bound framebuffer is not framebuffer complete (i.e. the return value from glCheckFramebufferStatus is not GL_FRAMEBUFFER_COMPLETE). The offending command is ignored and has no other side effect than to set the error flag.");else if(e===t.OUT_OF_MEMORY)throw"There is not enough memory left to execute the command. The state of the GL is undefined, except for the state of the error flags, after this error is recorded.";e=t.getError()}if(r)throw"Stopping due to error"},t.isPowerOfTwo=function(t){return 0===(t&t-1)},t.nearestPowerOfTwo=function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.log(2)))},t.clone=function(e){if(null===e||"object"!=typeof e)return e;if(e instanceof Uint8Array)return e;if(e instanceof Date){var r=new Date;return r.setTime(e.getTime()),r}if(e instanceof Array){for(var r=[],i=0,n=e.length;n>i;++i)r[i]=t.clone(e[i]);return r}if(e instanceof Object){var r={};for(var o in e)e.hasOwnProperty(o)&&(r[o]=t.clone(e[o]));return r}throw new Error("Unable to copy obj! Its type isn't supported.")},t._blankImages={},t.getBlankImage=function(e,r,i,n,o,a){var s=t.nearestPowerOfTwo(i),h=t.nearestPowerOfTwo(n);s=Math.min(s,o),h=Math.min(h,o);var d=4===r.length?"rgba("+Number(255*r[0]).toFixed(0)+","+Number(255*r[1]).toFixed(0)+","+Number(255*r[2]).toFixed(0)+","+Number(r[3]).toFixed(2)+")":"rgb("+Number(255*r[0]).toFixed(0)+","+Number(255*r[1]).toFixed(0)+","+Number(255*r[2]).toFixed(0)+")",l=d+s+"x"+h,u=t._blankImages[l];if(!u){u=document.createElement("canvas"),u.width=s,u.height=h;var c=u.getContext("2d");c.beginPath(),c.rect(0,0,s,h),c.fillStyle=d,c.fill(),t._blankImages[l]=u}void 0===a?e.image=u:(e.image.isData=!1,e.image.data[a]=u)},t.scaleImage=function(r,i,n,o,a,s){var h=t.nearestPowerOfTwo(n),d=t.nearestPowerOfTwo(o);if(h=Math.min(h,a),d=Math.min(d,a),i.width!==h||i.height!==d){var l=document.createElement("canvas");l.width=h,l.height=d,i.getAttribute&&l.setAttribute("data-ref",i.getAttribute("data-ref"));var u=l.getContext("2d");i.data?u.drawImage(e(i.data,i.width,i.height),0,0,i.width,i.height,0,0,h,d):u.drawImage(i,0,0,i.width,i.height,0,0,h,d),l.dataReady=!0,l.src=i.src,l.originalWidth=n,l.originalHeight=o,void 0===s?r.image=l:r.image.data[s]=l}},t}),define("goo/renderer/BufferUtils",[],function(){"use strict";function t(){}function e(){var e=["Trident","MSIE","Firefox","Safari","Chrome","Opera"],r=navigator.userAgent,i=e.length-1;
for(i;i>-1&&-1===r.indexOf(e[i]);i--);t.browserType=e[i]}return t.createIndexBuffer=function(e,r){var i;if(256>=r)i="Trident"===t.browserType?new Uint16Array(e):new Uint8Array(e);else{if(!(65536>=r))throw new Error("Maximum number of vertices is 65536. Got: "+r);i=new Uint16Array(e)}return i},e(),t}),define("goo/math/Vector2",["goo/math/Vector"],function(t){"use strict";function e(){t.call(this,2),0!==arguments.length?this.set(arguments):this.setd(0,0)}return e.prototype=Object.create(t.prototype),t.setupAliases(e.prototype,[["x","u","s"],["y","v","t"]]),e.ZERO=new e(0,0),e.ONE=new e(1,1),e.UNIT_X=new e(1,0),e.UNIT_Y=new e(0,1),e.add=function(t,r,i){"number"==typeof t&&(t=[t,t]),"number"==typeof r&&(r=[r,r]),i||(i=new e);var n=t.data||t,o=r.data||r;if(2!==n.length||2!==o.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return i.data[0]=n[0]+o[0],i.data[1]=n[1]+o[1],i},e.prototype.add=function(t){return e.add(this,t,this)},e.sub=function(t,r,i){"number"==typeof t&&(t=[t,t]),"number"==typeof r&&(r=[r,r]),i||(i=new e);var n=t.data||t,o=r.data||r;if(2!==n.length||2!==o.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return i.data[0]=n[0]-o[0],i.data[1]=n[1]-o[1],i},e.prototype.sub=function(t){return e.sub(this,t,this)},e.mul=function(t,r,i){"number"==typeof t&&(t=[t,t]),"number"==typeof r&&(r=[r,r]),i||(i=new e);var n=t.data||t,o=r.data||r;if(2!==n.length||2!==o.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return i.data[0]=n[0]*o[0],i.data[1]=n[1]*o[1],i},e.prototype.mul=function(t){return e.mul(this,t,this)},e.div=function(t,r,i){"number"==typeof t&&(t=[t,t]),"number"==typeof r&&(r=[r,r]),i||(i=new e);var n=t.data||t,o=r.data||r;if(2!==n.length||2!==o.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return i.data[0]=n[0]/o[0],i.data[1]=n[1]/o[1],i},e.prototype.div=function(t){return e.div(this,t,this)},e.dot=function(t,e){"number"==typeof t&&(t=[t,t]),"number"==typeof e&&(e=[e,e]);var r=t.data||t,i=e.data||e;if(2!==r.length||2!==i.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};var n=0;return n+=r[0]*i[0],n+=r[1]*i[1]},e.prototype.dot=function(t){return e.dot(this,t)},e.prototype.setd=function(t,e){return this.data[0]=t,this.data[1]=e,this},e.prototype.seta=function(t){return this.data[0]=t[0],this.data[1]=t[1],this},e.prototype.setv=function(t){return this.data[0]=t.data[0],this.data[1]=t.data[1],this},e.prototype.clone=function(){return new e(this)},e}),define("goo/math/Vector4",["goo/math/Vector"],function(t){"use strict";function e(){t.call(this,4),0!==arguments.length?this.set(arguments):this.setd(0,0,0,0)}return e.prototype=Object.create(t.prototype),t.setupAliases(e.prototype,[["x","r"],["y","g"],["z","b"],["w","a"]]),e.ZERO=new e(0,0,0,0),e.ONE=new e(1,1,1,1),e.UNIT_X=new e(1,0,0,0),e.UNIT_Y=new e(0,1,0,0),e.UNIT_Z=new e(0,0,1,0),e.UNIT_W=new e(0,0,0,1),e.add=function(t,r,i){"number"==typeof t&&(t=[t,t,t,t]),"number"==typeof r&&(r=[r,r,r,r]),i||(i=new e);var n=t.data||t,o=r.data||r;if(4!==n.length||4!==o.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return i.data[0]=n[0]+o[0],i.data[1]=n[1]+o[1],i.data[2]=n[2]+o[2],i.data[3]=n[3]+o[3],i},e.prototype.add=function(t){return e.add(this,t,this)},e.sub=function(t,r,i){"number"==typeof t&&(t=[t,t,t,t]),"number"==typeof r&&(r=[r,r,r,r]),i||(i=new e);var n=t.data||t,o=r.data||r;if(4!==n.length||4!==o.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return i.data[0]=n[0]-o[0],i.data[1]=n[1]-o[1],i.data[2]=n[2]-o[2],i.data[3]=n[3]-o[3],i},e.prototype.sub=function(t){return e.sub(this,t,this)},e.mul=function(t,r,i){"number"==typeof t&&(t=[t,t,t,t]),"number"==typeof r&&(r=[r,r,r,r]),i||(i=new e);var n=t.data||t,o=r.data||r;if(4!==n.length||4!==o.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return i.data[0]=n[0]*o[0],i.data[1]=n[1]*o[1],i.data[2]=n[2]*o[2],i.data[3]=n[3]*o[3],i},e.prototype.mul=function(t){return e.mul(this,t,this)},e.div=function(t,r,i){"number"==typeof t&&(t=[t,t,t,t]),"number"==typeof r&&(r=[r,r,r,r]),i||(i=new e);var n=t.data||t,o=r.data||r;if(4!==n.length||4!==o.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return i.data[0]=n[0]/o[0],i.data[1]=n[1]/o[1],i.data[2]=n[2]/o[2],i.data[3]=n[3]/o[3],i},e.prototype.div=function(t){return e.div(this,t,this)},e.dot=function(t,e){"number"==typeof t&&(t=[t,t,t,t]),"number"==typeof e&&(e=[e,e,e,e]);var r=t.data||t,i=e.data||e;if(4!==r.length||4!==i.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};var n=0;return n+=r[0]*i[0],n+=r[1]*i[1],n+=r[2]*i[2],n+=r[3]*i[3]},e.prototype.dot=function(t){return e.dot(this,t)},e.prototype.lerp=function(t,e){return this.x=(1-e)*this.x+e*t.x,this.y=(1-e)*this.y+e*t.y,this.z=(1-e)*this.z+e*t.z,this.w=(1-e)*this.w+e*t.w,this},e.prototype.setd=function(t,e,r,i){return this.data[0]=t,this.data[1]=e,this.data[2]=r,this.data[3]=i,this},e.prototype.seta=function(t){return this.data[0]=t[0],this.data[1]=t[1],this.data[2]=t[2],this.data[3]=t[3],this},e.prototype.setv=function(t){return this.data[0]=t.data[0],this.data[1]=t.data[1],this.data[2]=t.data[2],this.data[3]=t.data[3],this},e.prototype.clone=function(){return new e(this)},e}),define("goo/renderer/MeshData",["goo/renderer/BufferData","goo/renderer/Util","goo/renderer/BufferUtils","goo/math/Vector2","goo/math/Vector3","goo/math/Vector4"],function(t,e,r,i,n,o){"use strict";function a(t,e,r){this.attributeMap=t,this.vertexCount=void 0!==e?e:0,this.indexCount=void 0!==r?r:0,this.primitiveCounts=[0],this.vertexData=null,this.indexData=null,this.dataViews={},this.indexLengths=null,this.indexModes=["Triangles"],this.type=a.MESH,this.rebuildData(this.vertexCount,this.indexCount)}function s(t){for(var r={},i=0;i<t.length;i++){var n=t[i];if(void 0===p[n])throw"No default attribute named: "+n;r[n]=e.clone(p[n])}return r}var h=window.Uint8ClampedArray;a.MESH=0,a.SKINMESH=1,a.prototype.rebuildData=function(t,e,r){var i={},n=null;if(r){for(var o in this.attributeMap){var a=this.dataViews[o];a&&(i[o]=a)}this.indexData&&(n=this.indexData.data)}if(this.rebuildVertexData(t),this.rebuildIndexData(e),r){for(var o in this.attributeMap){var s=i[o];if(s){var a=this.dataViews[o];a.set(s)}}i={},n&&this.indexData.data.set(n)}},a.prototype.rebuildVertexData=function(r){if(isNaN(r)||(this.vertexCount=r,this._vertexCountStore=this.vertexCount),this.vertexCount>0){var i=0;for(var n in this.attributeMap){var o=this.attributeMap[n];i+=e.getByteSize(o.type)*o.count}this.vertexData=new t(new ArrayBuffer(i*this.vertexCount),"ArrayBuffer"),this.generateAttributeData()}},a.prototype.rebuildIndexData=function(e){if(void 0!==e&&(this.indexCount=e),this.indexCount>0){var i=r.createIndexBuffer(this.indexCount,this.vertexCount);this.indexData=new t(i,"ElementArrayBuffer")}},a.prototype.setVertexDataUpdated=function(){this.vertexData._dataNeedsRefresh=!0},a.prototype.getSectionCount=function(){return this.indexLengths?this.indexLengths.length:1},a.prototype.getPrimitiveCount=function(t){return t>=0&&t<this.primitiveCounts.length?this.primitiveCounts[t]:0},a.prototype.getPrimitiveVertices=function(t,e,r){var i=this.getPrimitiveCount(e);if(t>=i||0>t)throw new Error("Invalid primitiveIndex '"+t+"'.  Count is "+i);var o=this.indexModes[e],s=a.getVertexCount(o),h=r||[];h.length=s;for(var d=this.getAttributeBuffer(a.POSITION),l=0;s>l;l++)if(h[l]||(h[l]=new n),this.getIndexBuffer()){var u=this.getIndexBuffer()[this.getVertexIndex(t,l,e)];h[l].x=d[3*u+0],h[l].y=d[3*u+1],h[l].z=d[3*u+2]}else{var u=this.getVertexIndex(t,l,e);h[l].x=d[3*u+0],h[l].y=d[3*u+1],h[l].z=d[3*u+2]}return h},a.prototype.getVertexIndex=function(t,e,r){for(var i=0,n=0;r>n;n++)i+=this.indexLengths[n];switch(this.indexModes[r]){case"Triangles":i+=3*t+e;break;case"TriangleStrip":i+=t+e;break;case"TriangleFan":i+=0===e?0:t+e;break;case"Points":i+=t;break;case"Lines":i+=2*t+e;break;case"LineStrip":case"LineLoop":i+=t+e;break;default:return a.logger.warning("unimplemented index mode: "+this.indexModes[r]),-1}return i},a.prototype.getTotalPrimitiveCount=function(){for(var t=0,e=0,r=this.primitiveCounts.length;r>e;e++)t+=this.primitiveCounts[e];return t},a.prototype.updatePrimitiveCounts=function(){var t=this.indexData?this.indexData.data.length:this.vertexCount,e=this.getSectionCount();this.primitiveCounts.length!==e&&(this.primitiveCounts=[]);for(var r=0;e>r;r++){var i=this.indexLengths?this.indexLengths[r]:t,n=a.getPrimitiveCount(this.indexModes[r],i);this.primitiveCounts[r]=n}},a.getPrimitiveCount=function(t,e){switch(t){case"Triangles":return e/3;case"TriangleFan":case"TriangleStrip":return e-2;case"Lines":return e/2;case"LineStrip":return e-1;case"LineLoop":return e;case"Points":return e}throw new Error("unimplemented index mode: "+t)},a.getVertexCount=function(t){switch(t){case"Triangles":case"TriangleFan":case"TriangleStrip":return 3;case"Lines":case"LineStrip":case"LineLoop":return 2;case"Points":return 1}throw new Error("unimplemented index mode: "+t)};var d={Byte:Int8Array,UnsignedByte:Uint8Array,UnsignedByteClamped:h,Short:Int16Array,UnsignedShort:Uint16Array,Int:Int32Array,UnsignedInt:Uint32Array,Float:Float32Array};a.prototype.generateAttributeData=function(){var t,r=this.vertexData.data,i=0;for(var n in this.attributeMap){var o=this.attributeMap[n];o.offset=i;var a=this.vertexCount*o.count;i+=a*e.getByteSize(o.type);var s=d[o.type];if(!s)throw"Unsupported DataType: "+o.type;t=new s(r,o.offset,a),this.dataViews[n]=t}},a.prototype.makeInterleavedData=function(){var r=0,i=0;for(var n in this.attributeMap){var o=this.attributeMap[n];o.offset=r,r+=o.count*e.getByteSize(o.type)}var a=new t(new ArrayBuffer(r*this.vertexCount),this.vertexData.target);a._dataUsage=this.vertexData._dataUsage,a._dataNeedsRefresh=!0;var s=new DataView(a.data);for(var n in this.attributeMap){var h=this.dataViews[n],o=this.attributeMap[n];o.stride=r;for(var i=o.offset,d=o.count,l=e.getByteSize(o.type),u=this.getDataMethod(o.type),c=s[u],p=0;p<this.vertexCount;p++)for(var f=0;d>f;f++)c.apply(s,[i+r*p+f*l,h[p*d+f],!0])}this.vertexData=a},a.prototype.getDataMethod=function(t){switch(t){case"Byte":return"setInt8";case"UnsignedByte":return"setUInt8";case"Short":return"setInt16";case"UnsignedShort":return"setUInt16";case"Int":return"setInt32";case"HalfFloat":return"setInt16";case"Float":return"setFloat32"}},a.prototype.getAttributeBuffer=function(t){return this.dataViews[t]},a.prototype.getIndexData=function(){return this.indexData},a.prototype.getIndexBuffer=function(){return null!==this.indexData?this.indexData.data:null},a.prototype.getIndexLengths=function(){return this.indexLengths},a.prototype.getIndexModes=function(){return this.indexModes},a.prototype.resetVertexCount=function(){this.vertexCount=this._vertexCountStore},a.prototype.applyTransform=function(t,e){var r=new n,i=this.getAttributeBuffer(t),o=i.length;if(t===a.POSITION)for(var s=0;o>s;s+=3)r.setd(i[s+0],i[s+1],i[s+2]),e.matrix.applyPostPoint(r),i[s+0]=r[0],i[s+1]=r[1],i[s+2]=r[2];else if(t===a.NORMAL)for(var s=0;o>s;s+=3)r.setd(i[s+0],i[s+1],i[s+2]),e.rotation.applyPost(r),i[s+0]=r[0],i[s+1]=r[1],i[s+2]=r[2];else if(t===a.TANGENT)for(var s=0;o>s;s+=3)r.setd(i[s+0],i[s+1],i[s+2]),e.rotation.applyPost(r),i[s+0]=r[0],i[s+1]=r[1],i[s+2]=r[2];return this},a.prototype.applyFunction=function(t,e){var r,a,s=this.getAttributeBuffer(t),h=s.length,d=this.attributeMap[t].count;switch(d){case 1:for(var l=0;h>l;l++)s[l]=e(s[l]);break;case 2:r=new i;for(var l=0;h>l;l+=2)r.setd(s[l+0],s[l+1]),a=e(r),s[l+0]=a[0],s[l+1]=a[1];break;case 3:r=new n;for(var l=0;h>l;l+=3)r.setd(s[l+0],s[l+1],s[l+2]),a=e(r),s[l+0]=a[0],s[l+1]=a[1],s[l+2]=a[2];break;case 4:r=new o;for(var l=0;h>l;l+=4)r.setd(s[l+0],s[l+1],s[l+2],s[l+3]),a=e(r),s[l+0]=a[0],s[l+1]=a[1],s[l+2]=a[2],s[l+3]=a[3]}return this},a.prototype.getNormalsMeshData=function(t){if(void 0!==this.getAttributeBuffer("POSITION")&&void 0!==this.getAttributeBuffer("NORMAL")){t=void 0!==t?t:1;for(var e=[],r=[],i=this.dataViews.POSITION.length/3,n=0;i>n;n++)e.push(this.dataViews.POSITION[3*n+0],this.dataViews.POSITION[3*n+1],this.dataViews.POSITION[3*n+2],this.dataViews.POSITION[3*n+0]+this.dataViews.NORMAL[3*n+0]*t,this.dataViews.POSITION[3*n+1]+this.dataViews.NORMAL[3*n+1]*t,this.dataViews.POSITION[3*n+2]+this.dataViews.NORMAL[3*n+2]*t);for(var n=0;2*i>n;n+=2)r.push(n,n+1);var o=new a(a.defaultMap([a.POSITION]),e.length,r.length);return o.getAttributeBuffer(a.POSITION).set(e),o.getIndexBuffer().set(r),o.indexModes[0]="Lines",o}},a.prototype.buildWireframeData=function(){var t=e.clone(this.attributeMap),r=new a(t,this.vertexCount,0);r.indexModes[0]="Lines";var i=this.getIndexBuffer(),n=[],o=0;this.updatePrimitiveCounts();for(var s=0;s<this.getSectionCount();s++)for(var h=this.indexModes[s],d=this.getPrimitiveCount(s),l=0;d>l;l++)switch(h){case"Triangles":case"TriangleFan":case"TriangleStrip":var u=i[this.getVertexIndex(l,0,s)],c=i[this.getVertexIndex(l,1,s)],p=i[this.getVertexIndex(l,2,s)];n[o+0]=u,n[o+1]=c,n[o+2]=c,n[o+3]=p,n[o+4]=p,n[o+5]=u,o+=6;break;case"Lines":case"LineStrip":var u=i[this.getVertexIndex(l,0,s)],c=i[this.getVertexIndex(l,1,s)];n[o+0]=u,n[o+1]=c,o+=2;break;case"LineLoop":var u=i[this.getVertexIndex(l,0,s)],c=i[this.getVertexIndex(l,1,s)];l===d-1&&(c=i[this.getVertexIndex(0,0,s)]),n[o+0]=u,n[o+1]=c,o+=2;break;case"Points":}if(o>0){r.rebuildIndexData(o);for(var f in t)r.getAttributeBuffer(f).set(this.getAttributeBuffer(f));r.getIndexBuffer().set(n)}return r.paletteMap=this.paletteMap,r.weightsPerVertex=this.weightsPerVertex,r};var l=new n,u=new n,c=new n;a.prototype.buildFlatMeshData=function(){var t=this.getIndexBuffer();if(null===t)return console.debug("No indices, probably a point mesh"),this;var r=e.clone(this.attributeMap),i={};for(var n in r)i[n]={oldBuffer:this.getAttributeBuffer(n),values:[]};var o=0;this.updatePrimitiveCounts();for(var s=0;s<this.getSectionCount();s++)for(var h=this.indexModes[s],d=this.getPrimitiveCount(s),p=!1,f=0;d>f;f++)switch(h){case"TriangleStrip":p=f%2===1?!0:!1;case"Triangles":case"TriangleFan":var m=t[this.getVertexIndex(f,0,s)],g=t[this.getVertexIndex(f,1,s)],v=t[this.getVertexIndex(f,2,s)];if(p){var y=v;v=g,g=y}for(var n in i)if(n!==a.NORMAL){for(var x=r[n].count,_=0;x>_;_++)i[n].values[o*x+_]=i[n].oldBuffer[m*x+_],i[n].values[(o+1)*x+_]=i[n].oldBuffer[g*x+_],i[n].values[(o+2)*x+_]=i[n].oldBuffer[v*x+_];n===a.POSITION&&(l.setd(i[n].values[3*o],i[n].values[3*o+1],i[n].values[3*o+2]),u.setd(i[n].values[3*(o+1)],i[n].values[3*(o+1)+1],i[n].values[3*(o+1)+2]),c.setd(i[n].values[3*(o+2)],i[n].values[3*(o+2)+1],i[n].values[3*(o+2)+2]),u.subv(l),c.subv(l),u.cross(c).normalize(),i[a.NORMAL]&&(i[a.NORMAL].values[3*o]=u.data[0],i[a.NORMAL].values[3*o+1]=u.data[1],i[a.NORMAL].values[3*o+2]=u.data[2],i[a.NORMAL].values[3*(o+1)]=u.data[0],i[a.NORMAL].values[3*(o+1)+1]=u.data[1],i[a.NORMAL].values[3*(o+1)+2]=u.data[2],i[a.NORMAL].values[3*(o+2)]=u.data[0],i[a.NORMAL].values[3*(o+2)+1]=u.data[1],i[a.NORMAL].values[3*(o+2)+2]=u.data[2]))}o+=3}if(0===o)return console.warn("Could not build flat data"),this;var w=new a(r,o);for(var n in i)w.getAttributeBuffer(n).set(i[n].values);return w.paletteMap=this.paletteMap,w.weightPerVertex=this.weightsPerVertex,w},a.prototype.destroy=function(t){this.vertexData.destroy(t),this.indexData.destroy(t)},a.POSITION="POSITION",a.NORMAL="NORMAL",a.COLOR="COLOR",a.TANGENT="TANGENT",a.TEXCOORD0="TEXCOORD0",a.TEXCOORD1="TEXCOORD1",a.TEXCOORD2="TEXCOORD2",a.TEXCOORD3="TEXCOORD3",a.WEIGHTS="WEIGHTS",a.JOINTIDS="JOINTIDS",a.createAttribute=function(t,e,r){return{count:t,type:e,stride:0,offset:0,normalized:void 0!==r?r:!1}};var p={POSITION:a.createAttribute(3,"Float"),NORMAL:a.createAttribute(3,"Float"),COLOR:a.createAttribute(4,"Float"),TANGENT:a.createAttribute(4,"Float"),TEXCOORD0:a.createAttribute(2,"Float"),TEXCOORD1:a.createAttribute(2,"Float"),TEXCOORD2:a.createAttribute(2,"Float"),TEXCOORD3:a.createAttribute(2,"Float"),WEIGHTS:a.createAttribute(4,"Float"),JOINTIDS:a.createAttribute(4,"Float")};return a.defaultMap=function(t){return s(void 0===t?Object.keys(p):t)},a}),define("goo/renderer/bounds/BoundingSphere",["goo/math/Vector3","goo/math/MathUtils","goo/renderer/bounds/BoundingVolume","goo/renderer/MeshData"],function(t,e,r,i){"use strict";function n(t,e){r.call(this,t),this.radius=void 0!==e?e:1}var o=new t;return n.prototype=Object.create(r.prototype),n.prototype.constructor=n,n.prototype.computeFromPoints=function(t){var e=this.min,r=this.max,i=o;e.setd(1/0,1/0,1/0),r.setd(-1/0,-1/0,-1/0);for(var n,a,s,h=0;h<t.length;h+=3)n=t[h+0],a=t[h+1],s=t[h+2],e.x=n<e.x?n:e.x,e.y=a<e.y?a:e.y,e.z=s<e.z?s:e.z,r.x=n>r.x?n:r.x,r.y=a>r.y?a:r.y,r.z=s>r.z?s:r.z;for(var d,l=r.addv(e).div(2),u=0,h=0;h<t.length;h+=3)i.setd(t[h],t[h+1],t[h+2]),d=i.subv(l).lengthSquared(),d>u&&(u=d);this.radius=Math.sqrt(u),this.center.setv(l)},n.prototype.computeFromPrimitives=function(e,r,n,o,a){if(!(0>=a-o)){for(var s=[],h=[],d=i.getVertexCount(e.indexModes[r]),l=0,u=o;a>u;u++){h=e.getPrimitiveVertices(n[u],r,h);for(var c=0;d>c;c++)s[l++]=(new t).set(h[c])}this.averagePoints(s)}},n.prototype.averagePoints=function(e){this.center.set(e[0]);for(var r=1;r<e.length;r++)this.center.add(e[r]);var i=1/e.length;this.center.mul(i);for(var n=0,r=0;r<e.length;r++){var a=t.sub(e[r],this.center,o),s=a.lengthSquared();s>n&&(n=s)}this.radius=Math.sqrt(n)+1e-5},n.prototype.transform=function(t,e){null===e&&(e=new n),t.applyForward(this.center,e.center);var r=t.scale;return e.radius=Math.abs(this._maxAxis(r)*this.radius),e},n.prototype.whichSide=function(t){var e=t.normal.data,i=this.center.data,n=e[0]*i[0]+e[1]*i[1]+e[2]*i[2]-t.constant;return n<-this.radius?r.Inside:n>this.radius?r.Outside:r.Intersects},n.prototype._pseudoDistance=function(t,e){return t.normal.x*e.x+t.normal.y*e.y+t.normal.z*e.z-t.constant},n.prototype._maxAxis=function(t){return Math.max(Math.abs(t.x),Math.max(Math.abs(t.y),Math.abs(t.z)))},n.prototype.toString=function(){var t=Math.round(10*this.center.x)/10,e=Math.round(10*this.center.y)/10,r=Math.round(10*this.center.z)/10,i=Math.round(10*this.radius)/10;return"["+t+","+e+","+r+"] - "+i},n.prototype.intersects=function(t){return t.intersectsSphere(this)},n.prototype.intersectsBoundingBox=function(t){t.min.x=t.center.x-t.xExtent,t.min.y=t.center.y-t.yExtent,t.min.z=t.center.z-t.zExtent,t.max.x=t.center.x+t.xExtent,t.max.y=t.center.y+t.yExtent,t.max.z=t.center.z+t.zExtent;var e=Math.pow(this.radius,2),r=0;return this.center.x<t.min.x?r+=Math.pow(this.center.x-t.min.x,2):this.center.x>t.max.x&&(r+=Math.pow(this.center.x-t.max.x,2)),this.center.y<t.min.y?r+=Math.pow(this.center.y-t.min.y,2):this.center.y>t.max.y&&(r+=Math.pow(this.center.y-t.max.y,2)),this.center.z<t.min.z?r+=Math.pow(this.center.z-t.min.z,2):this.center.z>t.max.z&&(r+=Math.pow(this.center.z-t.max.z,2)),e>=r},n.prototype.intersectsSphere=function(t){var e=o.setv(this.center).subv(t.center),r=this.radius+t.radius;return e.dot(e)<=r*r},n.prototype.intersectsRay=function(e){if(!this.center)return!1;var r=(new t).copy(e.origin).sub(this.center),i=r.dot(r)-this.radius*this.radius;if(0>=i)return!0;var n=e.direction.dot(r);return n>=0?!1:n*n>=i},n.prototype.intersectsRayWhere=function(e){var r,i,n,o=(new t).copy(e.origin).sub(this.center),a=o.dot(o)-this.radius*this.radius;if(0>=a){r=e.direction.dot(o),i=r*r-a,n=Math.sqrt(i);var s=[n-r],h=[(new t).copy(e.direction).mul(s[0]).add(e.origin)];return{distances:s,points:h}}if(r=e.direction.dot(o),r>=0)return null;if(i=r*r-a,0>i)return null;if(i>=1e-5){n=Math.sqrt(i);var s=[-r-n,-r+n],h=[(new t).copy(e.direction).mul(s[0]).add(e.origin),(new t).copy(e.direction).mul(s[1]).add(e.origin)];return{distances:s,points:h}}var s=[-r],h=[(new t).copy(e.direction).mul(s[0]).add(e.origin)];return{distances:s,points:h}},n.prototype.merge=function(t){if(t instanceof n)return this.mergeSphere(t.center,t.radius,this);var e=o.setd(t.xExtent,t.yExtent,t.zExtent).length();return this.mergeSphere(t.center,e,this)},n.prototype.mergeSphere=function(t,r,i){i||(i=new n);var a=o.setv(t).subv(this.center),s=a.lengthSquared(),h=r-this.radius,d=h*h;if(d>=s)return 0>=h?(i.center.setv(this.center),i.radius=this.radius,i):(i.center.setv(t),i.radius=r,i);var l=Math.sqrt(s),u=i.center;if(l>e.EPSILON){var c=(l+h)/(2*l);u.addv(a.mul(c))}return i.radius=.5*(l+this.radius+r),i},n.prototype.clone=function(t){return t&&t instanceof n?(t.center.setv(this.center),t.radius=this.radius,t):new n(this.center,this.radius)},n}),define("goo/renderer/bounds/BoundingBox",["goo/math/Vector3","goo/renderer/bounds/BoundingVolume","goo/renderer/bounds/BoundingSphere","goo/math/MathUtils"],function(t,e,r,i){"use strict";function n(t,r,i,n){e.call(this,t),this.xExtent=void 0!==r?r:1,this.yExtent=void 0!==i?i:1,this.zExtent=void 0!==n?n:1}for(var o=new t,a=new t,s=new t,h=[],d=0;8>d;d++)h.push(new t);n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.computeFromPoints=function(t){var e=this.min,r=this.max,i=s;e.setd(t[0],t[1],t[2]),r.setd(t[0],t[1],t[2]);for(var n,o,a,h=3;h<t.length;h+=3)n=t[h+0],o=t[h+1],a=t[h+2],e.data[0]=n<e.data[0]?n:e.data[0],e.data[1]=o<e.data[1]?o:e.data[1],e.data[2]=a<e.data[2]?a:e.data[2],r.data[0]=n>r.data[0]?n:r.data[0],r.data[1]=o>r.data[1]?o:r.data[1],r.data[2]=a>r.data[2]?a:r.data[2];i.setv(r).subv(e).mul(.5),this.xExtent=i.data[0],this.yExtent=i.data[1],this.zExtent=i.data[2],this.center.setv(r).addv(e).mul(.5)};var l=[];return n.prototype.computeFromPrimitives=function(t,e,r,i,s){if(!(0>=s-i)){var h=o.set(1/0,1/0,1/0),d=a.set(-1/0,-1/0,-1/0),u=l;u.length=0;for(var c=i;s>c;c++){u=t.getPrimitiveVertices(r[c],e,u);for(var p=0;p<u.length;p++)n.checkMinMax(h,d,u[p])}this.center.copy(h.add(d)),this.center.mul(.5),this.xExtent=d.x-this.center.x,this.yExtent=d.y-this.center.y,this.zExtent=d.z-this.center.z}},n.checkMinMax=function(t,e,r){r.x<t.x&&(t.x=r.x),r.x>e.x&&(e.x=r.x),r.y<t.y&&(t.y=r.y),r.y>e.y&&(e.y=r.y),r.z<t.z&&(t.z=r.z),r.z>e.z&&(e.z=r.z)},n.prototype.transform=function(t,e){null===e&&(e=new n);var r=h;this.getCorners(r);for(var i=0;8>i;i++)t.matrix.applyPostPoint(r[i]);for(var o=r[0].data[0],a=r[0].data[1],s=r[0].data[2],d=o,l=a,u=s,i=1;8>i;i++){var c=r[i].data[0],p=r[i].data[1],f=r[i].data[2];o=Math.min(o,c),a=Math.min(a,p),s=Math.min(s,f),d=Math.max(d,c),l=Math.max(l,p),u=Math.max(u,f)}var m=.5*(d+o),g=.5*(l+a),v=.5*(u+s);return e.center.setd(m,g,v),e.xExtent=d-m,e.yExtent=l-g,e.zExtent=u-v,e},n.prototype.getCorners=function(t){var e=this.xExtent,r=this.yExtent,i=this.zExtent,n=this.center.data;return t[0].setd(n[0]+e,n[1]+r,n[2]+i),t[1].setd(n[0]+e,n[1]+r,n[2]-i),t[2].setd(n[0]+e,n[1]-r,n[2]+i),t[3].setd(n[0]+e,n[1]-r,n[2]-i),t[4].setd(n[0]-e,n[1]+r,n[2]+i),t[5].setd(n[0]-e,n[1]+r,n[2]-i),t[6].setd(n[0]-e,n[1]-r,n[2]+i),t[7].setd(n[0]-e,n[1]-r,n[2]-i),t},n.prototype.whichSide=function(t){var r=t.normal.data,i=this.center.data,n=Math.abs(this.xExtent*r[0])+Math.abs(this.yExtent*r[1])+Math.abs(this.zExtent*r[2]),o=r[0]*i[0]+r[1]*i[1]+r[2]*i[2]-t.constant;return-n>o?e.Inside:o>n?e.Outside:e.Intersects},n.prototype._pseudoDistance=function(t,e){var r=t.normal.data,i=e.data;return r[0]*i[0]+r[1]*i[1]+r[2]*i[2]-t.constant},n.prototype._maxAxis=function(t){return Math.max(Math.abs(t.x),Math.max(Math.abs(t.y),Math.abs(t.z)))},n.prototype.toString=function(){var t=Math.round(10*this.center.x)/10,e=Math.round(10*this.center.y)/10,r=Math.round(10*this.center.z)/10;return"["+t+","+e+","+r+"] - ["+this.xExtent+","+this.yExtent+","+this.zExtent+"]"},n.prototype.intersects=function(t){return t.intersectsBoundingBox(this)},n.prototype.intersectsBoundingBox=function(t){return this.center.x+this.xExtent<t.center.x-t.xExtent||this.center.x-this.xExtent>t.center.x+t.xExtent?!1:this.center.y+this.yExtent<t.center.y-t.yExtent||this.center.y-this.yExtent>t.center.y+t.yExtent?!1:this.center.z+this.zExtent<t.center.z-t.zExtent||this.center.z-this.zExtent>t.center.z+t.zExtent?!1:!0},n.prototype.intersectsSphere=function(t){this.min.x=this.center.x-this.xExtent,this.min.y=this.center.y-this.yExtent,this.min.z=this.center.z-this.zExtent,this.max.x=this.center.x+this.xExtent,this.max.y=this.center.y+this.yExtent,this.max.z=this.center.z+this.zExtent;var e=Math.pow(t.radius,2),r=0;return t.center.x<this.min.x?r+=Math.pow(t.center.x-this.min.x,2):t.center.x>this.max.x&&(r+=Math.pow(t.center.x-this.max.x,2)),t.center.y<this.min.y?r+=Math.pow(t.center.y-this.min.y,2):t.center.y>this.max.y&&(r+=Math.pow(t.center.y-this.max.y,2)),t.center.z<this.min.z?r+=Math.pow(t.center.z-this.min.z,2):t.center.z>this.max.z&&(r+=Math.pow(t.center.z-this.max.z,2)),e>=r},n.prototype.testStaticAABBAABB=function(e,r){var i=this,n=e,o={mtvDistance:1e10,mtvAxis:new t};return this.testAxisStatic(t.UNIT_X,i.center.x-i.xExtent,i.center.x+i.xExtent,n.center.x-n.xExtent,n.center.x+n.xExtent,o)&&this.testAxisStatic(t.UNIT_Y,i.center.y-i.yExtent,i.center.y+i.yExtent,n.center.y-n.yExtent,n.center.y+n.yExtent,o)&&this.testAxisStatic(t.UNIT_Z,i.center.z-i.zExtent,i.center.z+i.zExtent,n.center.z-n.zExtent,n.center.z+n.zExtent,o)?(r&&(r.isIntersecting=!0,r.normal=o.mtvAxis,r.penetration=1.001*Math.sqrt(o.mtvDistance)),!0):!1},n.prototype.testAxisStatic=function(e,r,i,n,o,a){var s=t.dot(e,e);if(1e-6>s)return!0;var h=o-r,d=i-n;if(0>=h||0>=d)return!1;var l=d>h?h:-d,u=(new t).copy(e).mul(l/s),c=t.dot(u,u);return c<a.mtvDistance&&(a.mtvDistance=c,a.mtvAxis=e),!0},n.prototype.intersectsRay=function(t){if(isNaN(this.center.x)||isNaN(this.center.y)||isNaN(this.center.z))return!1;var e=o.setv(t.origin).subv(this.center),r=t.direction,a=[0,1/0],s=this.xExtent;s<i.ZERO_TOLERANCE&&s>=0&&(s=i.ZERO_TOLERANCE);var h=this.yExtent;h<i.ZERO_TOLERANCE&&h>=0&&(h=i.ZERO_TOLERANCE);var d=this.zExtent;d<i.ZERO_TOLERANCE&&d>=0&&(d=i.ZERO_TOLERANCE);var l=n.clip(r.data[0],-e.data[0]-s,a)&&n.clip(-r.data[0],e.data[0]-s,a)&&n.clip(r.data[1],-e.data[1]-h,a)&&n.clip(-r.data[1],e.data[1]-h,a)&&n.clip(r.data[2],-e.data[2]-d,a)&&n.clip(-r.data[2],e.data[2]-d,a);return!l||0===a[0]&&1/0===a[1]?!1:!0},n.prototype.intersectsRayWhere=function(e){if(isNaN(this.center.x)||isNaN(this.center.y)||isNaN(this.center.z))return null;var r=t.sub(e.origin,this.center,o),a=e.direction,s=[0,1/0],h=this.xExtent;h<i.ZERO_TOLERANCE&&h>=0&&(h=i.ZERO_TOLERANCE);var d=this.yExtent;d<i.ZERO_TOLERANCE&&d>=0&&(d=i.ZERO_TOLERANCE);var l=this.zExtent;l<i.ZERO_TOLERANCE&&l>=0&&(l=i.ZERO_TOLERANCE);var u=n.clip(a.x,-r.x-h,s)&&n.clip(-a.x,r.x-h,s)&&n.clip(a.y,-r.y-d,s)&&n.clip(-a.y,r.y-d,s)&&n.clip(a.z,-r.z-l,s)&&n.clip(-a.z,r.z-l,s);if(u&&(0!==s[0]||1/0!==s[1])){if(s[1]>s[0]){var c=s,p=[new t(e.direction).mul(c[0]).add(e.origin),new t(e.direction).mul(c[1]).add(e.origin)];return{distances:c,points:p}}var c=[s[0]],p=[new t(e.direction).mul(c[0]).add(e.origin)];return{distances:c,points:p}}return null},n.clip=function(t,e,r){return t>0?e>t*r[1]?!1:(e>t*r[0]&&(r[0]=e/t),!0):0>t?e>t*r[0]?!1:(e>t*r[1]&&(r[1]=e/t),!0):0>=e},n.prototype.merge=function(t){return t instanceof n?this.mergeBox(t.center,t.xExtent,t.yExtent,t.zExtent,this):t instanceof r?this.mergeBox(t.center,t.radius,t.radius,t.radius,this):this},n.prototype.mergeBox=function(t,e,r,i,s){s||(s=new n);var h=o,d=a;return h.x=this.center.x-this.xExtent,h.x>t.x-e&&(h.x=t.x-e),h.y=this.center.y-this.yExtent,h.y>t.y-r&&(h.y=t.y-r),h.z=this.center.z-this.zExtent,h.z>t.z-i&&(h.z=t.z-i),d.x=this.center.x+this.xExtent,d.x<t.x+e&&(d.x=t.x+e),d.y=this.center.y+this.yExtent,d.y<t.y+r&&(d.y=t.y+r),d.z=this.center.z+this.zExtent,d.z<t.z+i&&(d.z=t.z+i),s.center.set(d).addv(h).muld(.5,.5,.5),s.xExtent=d.x-s.center.x,s.yExtent=d.y-s.center.y,s.zExtent=d.z-s.center.z,s},n.prototype.clone=function(t){return t&&t instanceof n?(t.center.setv(this.center),t.xExtent=this.xExtent,t.yExtent=this.yExtent,t.zExtent=this.zExtent,t):new n(this.center,this.xExtent,this.yExtent,this.zExtent)},n}),define("goo/entities/EntityUtils",["goo/scripts/Scripts","goo/renderer/bounds/BoundingBox","goo/util/ObjectUtil"],function(t,e,r){"use strict";function i(){}function n(t,e){e.skeletonMap=e.skeletonMap||{originals:[],clones:[]};var r,i=e.skeletonMap.originals.indexOf(t);return-1===i?(r=t.clone(),e.skeletonMap.originals.push(t),e.skeletonMap.clones.push(r)):r=e.skeletonMap.clones[i],r}function o(e,i,a){for(var s=e.createEntity(i.name),h=0;h<i._components.length;h++){var d=i._components[h];if("TransformComponent"===d.type)s.transformComponent.transform.copy(d.transform);else if("MeshDataComponent"===d.type){var l=new d.constructor(d.meshData);l.modelBound=new d.modelBound.constructor,d.currentPose&&(l.currentPose=n(d.currentPose,a)),s.setComponent(l)}else if("MeshRendererComponent"===d.type){for(var u=new d.constructor,c=0;c<d.materials.length;c++)u.materials.push(d.materials[c]);s.setComponent(u)}else if("AnimationComponent"===d.type){var p=d.clone();p._skeletonPose=n(d._skeletonPose,a),s.setComponent(p)}else if("ScriptComponent"===d.type){for(var f=new d.constructor,c=0;c<d.scripts.length;c++){var m,g=d.scripts[c],v=g.externals?g.externals.key||g.externals.name:null;v&&t.getScript(v)?m=t.create(v,g.parameters):(m={externals:g.externals,name:(g.name||"")+"_clone",enabled:!!g.enabled},g.parameters&&(m.parameters=r.deepClone(g.parameters)),g.setup&&(m.setup=g.setup),g.update&&(m.update=g.update),g.setup&&(m.cleanup=g.cleanup),f.scripts.push(m))}s.setComponent(f),e.getSystem("ScriptSystem").manualSetup&&d.scripts[0].context&&f.setup(s)}else s.setComponent(d)}for(var c=0;c<i.transformComponent.children.length;c++){var y=i.transformComponent.children[c],x=o(e,y.entity,a);s.transformComponent.attachChild(x.transformComponent)}return a.callback&&a.callback(s),s}return i.clone=function(t,e,r){return r=r||{},r.shareData=r.shareData||!0,r.shareMaterial=r.shareMaterial||!0,r.cloneHierarchy=r.cloneHierarchy||!0,o(t,e,r)},i.getRoot=function(t){for(;t.transformComponent.parent;)t=t.transformComponent.parent.entity;return t},i.updateWorldTransform=function(t){t.updateWorldTransform();for(var e=0;e<t.children.length;e++)i.updateWorldTransform(t.children[e])},i.show=function(t){t._hidden=!1;for(var e=t;e.transformComponent.parent;)if(e=e.transformComponent.parent.entity,e._hidden)return t.meshRendererComponent&&(t.meshRendererComponent.hidden=!0),t.lightComponent&&(t.lightComponent.hidden=!0),void(t.htmlComponent&&(t.htmlComponent.hidden=!0));t.traverse(function(t){return t._hidden?!1:(t.meshRendererComponent&&(t.meshRendererComponent.hidden=t._hidden),t.lightComponent&&(t.lightComponent.hidden=t._hidden),void(t.htmlComponent&&(t.htmlComponent.hidden=t._hidden)))})},i.hide=function(t){t._hidden=!0,t.traverse(function(t){t.meshRendererComponent&&(t.meshRendererComponent.hidden=!0),t.lightComponent&&(t.lightComponent.hidden=!0),t.htmlComponent&&(t.htmlComponent.hidden=!0)})},i.getTotalBoundingBox=function(t){var r=new e,i=!0;if(t.traverse(function(t){if(t.meshRendererComponent)if(i){var n=t.meshRendererComponent.worldBound;n instanceof e?n.clone(r):(r.center.setv(n.center),r.xExtent=r.yExtent=r.zExtent=n.radius),i=!1}else r.merge(t.meshRendererComponent.worldBound)}),i){var n=t.transformComponent.worldTransform.translation;r=new e(n.clone(),.001,.001,.001)}return r},i}),define("goo/entities/managers/Manager",[],function(){"use strict";function t(){}return t.prototype.applyAPI=function(t){this.installedAPI||(this.installedAPI={});var e=this.api;for(var r in e)"undefined"==typeof t[r]?(t[r]=e[r],this.installedAPI[r]=!0):console.warn("Could not install method "+r+" of "+this.type+" as it is already taken")},t}),define("goo/entities/managers/EntityManager",["goo/entities/managers/Manager","goo/entities/EntitySelection"],function(t,e){"use strict";function r(){this.type="EntityManager",this._entitiesById={},this._entitiesByIndex={},this._entityCount=0,this.api={id:function(){var t=r.prototype.getEntityById.apply(this,arguments);
return new e(t)}.bind(this),name:function(t){var r=this.getEntities();return new e(r.filter(function(e){return e.name===t}))}.bind(this)}}return r.prototype=Object.create(t.prototype),r.prototype.added=function(t){this.containsEntity(t)||(this._entitiesById[t.id]=t,this._entitiesByIndex[t._index]=t,this._entityCount++)},r.prototype.removed=function(t){this.containsEntity(t)&&(delete this._entitiesById[t.id],delete this._entitiesByIndex[t._index],this._entityCount--)},r.prototype.containsEntity=function(t){return void 0!==this._entitiesById[t.id]},r.prototype.getEntityById=function(t){return this._entitiesById[t]},r.prototype.getEntityByIndex=function(t){return this._entitiesByIndex[t]},r.prototype.getEntityByName=function(t){for(var e in this._entitiesById){var r=this._entitiesById[e];if(r.name===t)return r}},r.prototype.size=function(){return this._entityCount},r.prototype.getEntities=function(){var t=[];for(var e in this._entitiesById)t.push(this._entitiesById[e]);return t},r.prototype.getTopEntities=function(){var t=[];for(var e in this._entitiesById){var r=this._entitiesById[e];r.transformComponent?r.transformComponent.parent||t.push(r):t.push(r)}return t},r.prototype.clear=function(){this._entitiesById={},this._entitiesByIndex={},this._entityCount=0},r}),define("goo/math/Matrix",["goo/math/MathUtils"],function(t){"use strict";function e(t,e){this.rows=t||0,this.cols=e||0,this.data=new Float32Array(this.rows*this.cols)}return e.setupAliases=function(t,e){for(var r=0;r<e.length;r++)!function(i){for(var n=0;n<e[i].length;n++)Object.defineProperty(t,e[i][n],{get:function(){return this.data[i]},set:function(t){this.data[i]=t}});Object.defineProperty(t,r,{get:function(){return this.data[i]},set:function(t){this.data[i]=t}})}(r)},e.add=function(t,r,i){var n=t.rows,o=t.cols;if(i||(i=new e(n,o)),r instanceof e){if(r.rows!==n||r.cols!==o||i.rows!==n||i.cols!==o)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var a=0;a<t.data.length;a++)i.data[a]=t.data[a]+r.data[a]}else{if(i.rows!==n||i.cols!==o)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var a=0;a<t.data.length;a++)i.data[a]=t.data[a]+r}return i},e.prototype.add=function(t){return e.add(this,t,this)},e.sub=function(t,r,i){var n=t.rows,o=t.cols;if(i||(i=new e(n,o)),r instanceof e){if(r.rows!==n||r.cols!==o||i.rows!==n||i.cols!==o)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var a=0;a<t.data.length;a++)i.data[a]=t.data[a]-r.data[a]}else{if(i.rows!==n||i.cols!==o)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var a=0;a<t.data.length;a++)i.data[a]=t.data[a]-r}return i},e.prototype.sub=function(t){return e.sub(this,t,this)},e.mul=function(t,r,i){var n=t.rows,o=t.cols;if(i||(i=new e(n,o)),r instanceof e){if(r.rows!==n||r.cols!==o||i.rows!==n||i.cols!==o)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var a=0;a<t.data.length;a++)i.data[a]=t.data[a]*r.data[a]}else{if(i.rows!==n||i.cols!==o)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var a=0;a<t.data.length;a++)i.data[a]=t.data[a]*r}return i},e.prototype.mul=function(t){return e.mul(this,t,this)},e.div=function(t,r,i){var n=t.rows,o=t.cols;if(i||(i=new e(n,o)),r instanceof e){if(r.rows!==n||r.cols!==o||i.rows!==n||i.cols!==o)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var a=0;a<t.data.length;a++)i.data[a]=t.data[a]/r.data[a]}else{if(i.rows!==n||i.cols!==o)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};r=1/r;for(var a=0;a<t.data.length;a++)i.data[a]=t.data[a]*r}return i},e.prototype.div=function(t){return e.div(this,t,this)},e.combine=function(t,r,i){var n=t.rows,o=r.cols,a=t.cols=r.rows;if(i||(i=new e(n,o)),t.cols!==a||r.rows!==a||i.rows!==n||i.cols!==o)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};if(i===t||i===r)return e.copy(e.combine(t,r),i);for(var s=0;o>s;s++)for(var h=s*n,d=0;n>d;d++){for(var l=0,u=0;a>u;u++)l+=t.data[u*t.rows+d]*r.data[s*r.rows+u];i.data[h+d]=l}return i},e.prototype.combine=function(t){return e.combine(this,t,this)},e.transpose=function(t,r){var i=t.cols,n=t.rows;if(r||(r=new e(i,n)),r.rows!==i||r.cols!==n)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};if(r===t)return e.copy(e.transpose(t),r);for(var o=0;n>o;o++)for(var a=o*i,s=0;i>s;s++)r.data[a+s]=t.data[s*n+o];return r},e.prototype.transpose=function(){return e.transpose(this,this)},e.copy=function(t,r){var i=t.rows,n=t.cols;if(r||(r=new e(i,n)),r.rows!==i||r.cols!==n)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return r.data.set(t.data),r},e.prototype.copy=function(t){return e.copy(t,this)},e.equals=function(e,r){if(e.rows!==r.rows||e.cols!==r.cols)return!1;for(var i=0;i<e.data.length;i++)if(Math.abs(e.data[i]-r.data[i])>t.EPSILON)return!1;return!0},e.prototype.equals=function(t){return e.equals(this,t)},e.prototype.isOrthogonal=function(){for(var e=0;e<this.cols;e++)for(var r=e+1;r<this.cols;r++){for(var i=e*this.rows,n=r*this.rows,o=0,a=0;a<this.rows;a++)o+=this.data[i+a]*this.data[n+a];if(Math.abs(o)>t.EPSILON)return!1}return!0},e.prototype.isNormal=function(){for(var e=0;e<this.cols;e++){for(var r=e*this.rows,i=0,n=0;n<this.rows;n++)i+=this.data[r+n]*this.data[r+n];if(Math.abs(i-1)>t.EPSILON)return!1}return!0},e.prototype.isOrthonormal=function(){return this.isOrthogonal()&&this.isNormal()},e.prototype.clone=function(){return e.copy(this)},e.prototype.set=function(){if(1===arguments.length&&"object"==typeof arguments[0])if(arguments[0]instanceof e)this.copy(arguments[0]);else for(var t=0;t<arguments[0].length;t++)this.data[t]=arguments[0][t];else for(var t=0;t<arguments.length;t++)this.data[t]=arguments[t];return this},e.prototype.toString=function(){for(var t="",e=0;e<this.cols;e++){var r=e*this.rows;t+="[";for(var i=0;i<this.rows;i++)t+=this.data[r+i],t+=i!==this.rows-1?", ":"";t+=e!==this.cols-1?"], ":"]"}return t},e}),define("goo/math/Matrix3x3",["goo/math/MathUtils","goo/math/Matrix","goo/math/Vector3"],function(t,e,r){"use strict";function i(){e.call(this,3,3),0===arguments.length?this.setIdentity():this.set(arguments)}return i._tempX=new r,i._tempY=new r,i._tempZ=new r,i.prototype=Object.create(e.prototype),e.setupAliases(i.prototype,[["e00"],["e10"],["e20"],["e01"],["e11"],["e21"],["e02"],["e12"],["e22"]]),i.IDENTITY=new i(1,0,0,0,1,0,0,0,1),i.add=function(t,e,r){r||(r=new i);var n=r.data,o=t.data;if(e instanceof i){var a=e.data;n[0]=o[0]+a[0],n[1]=o[1]+a[1],n[2]=o[2]+a[2],n[3]=o[3]+a[3],n[4]=o[4]+a[4],n[5]=o[5]+a[5],n[6]=o[6]+a[6],n[7]=o[7]+a[7],n[8]=o[8]+a[8]}else n[0]=o[0]+e,n[1]=o[1]+e,n[2]=o[2]+e,n[3]=o[3]+e,n[4]=o[4]+e,n[5]=o[5]+e,n[6]=o[6]+e,n[7]=o[7]+e,n[8]=o[8]+e;return r},i.prototype.add=function(t){return i.add(this,t,this)},i.sub=function(t,e,r){r||(r=new i);var n=r.data,o=t.data;if(e instanceof i){var a=e.data;n[0]=o[0]-a[0],n[1]=o[1]-a[1],n[2]=o[2]-a[2],n[3]=o[3]-a[3],n[4]=o[4]-a[4],n[5]=o[5]-a[5],n[6]=o[6]-a[6],n[7]=o[7]-a[7],n[8]=o[8]-a[8]}else n[0]=o[0]-e,n[1]=o[1]-e,n[2]=o[2]-e,n[3]=o[3]-e,n[4]=o[4]-e,n[5]=o[5]-e,n[6]=o[6]-e,n[7]=o[7]-e,n[8]=o[8]-e;return r},i.prototype.sub=function(t){return i.sub(this,t,this)},i.mul=function(t,e,r){r||(r=new i);var n=r.data,o=t.data;if(e instanceof i){var a=e.data;n[0]=o[0]*a[0],n[1]=o[1]*a[1],n[2]=o[2]*a[2],n[3]=o[3]*a[3],n[4]=o[4]*a[4],n[5]=o[5]*a[5],n[6]=o[6]*a[6],n[7]=o[7]*a[7],n[8]=o[8]*a[8]}else n[0]=o[0]*e,n[1]=o[1]*e,n[2]=o[2]*e,n[3]=o[3]*e,n[4]=o[4]*e,n[5]=o[5]*e,n[6]=o[6]*e,n[7]=o[7]*e,n[8]=o[8]*e;return r},i.prototype.mul=function(t){return i.mul(this,t,this)},i.div=function(t,e,r){r||(r=new i);var n=r.data,o=t.data;if(e instanceof i){var a=e.data;n[0]=o[0]/a[0],n[1]=o[1]/a[1],n[2]=o[2]/a[2],n[3]=o[3]/a[3],n[4]=o[4]/a[4],n[5]=o[5]/a[5],n[6]=o[6]/a[6],n[7]=o[7]/a[7],n[8]=o[8]/a[8]}else n[0]=o[0]/e,n[1]=o[1]/e,n[2]=o[2]/e,n[3]=o[3]/e,n[4]=o[4]/e,n[5]=o[5]/e,n[6]=o[6]/e,n[7]=o[7]/e,n[8]=o[8]/e;return r},i.prototype.div=function(t){return i.div(this,t,this)},i.combine=function(t,e,r){r||(r=new i);var n=t.data,o=n[0],a=n[3],s=n[6],h=n[1],d=n[4],l=n[7],u=n[2],c=n[5],p=n[8],f=e.data,m=f[0],g=f[3],v=f[6],y=f[1],x=f[4],_=f[7],w=f[2],b=f[5],S=f[8],E=r.data;return E[0]=o*m+a*y+s*w,E[3]=o*g+a*x+s*b,E[6]=o*v+a*_+s*S,E[1]=h*m+d*y+l*w,E[4]=h*g+d*x+l*b,E[7]=h*v+d*_+l*S,E[2]=u*m+c*y+p*w,E[5]=u*g+c*x+p*b,E[8]=u*v+c*_+p*S,r},i.prototype.combine=function(t){return i.combine(this,t,this)},i.transpose=function(t,e){e||(e=new i);var r=t.data,n=e.data;if(e===t){var o=r[3],a=r[6],s=r[7];return n[3]=r[1],n[6]=r[2],n[7]=r[5],n[1]=o,n[2]=a,n[5]=s,e}return n[0]=r[0],n[1]=r[3],n[2]=r[6],n[3]=r[1],n[4]=r[4],n[5]=r[7],n[6]=r[2],n[7]=r[5],n[8]=r[8],e},i.prototype.transpose=function(){return i.transpose(this,this)},i.invert=function(r,n){if(n||(n=new i),n===r)return e.copy(i.invert(r),n);var o=r.determinant();if(Math.abs(o)<t.EPSILON)return n;o=1/o;var a=n.data,s=r.data;return a[0]=(s[4]*s[8]-s[7]*s[5])*o,a[1]=(s[7]*s[2]-s[1]*s[8])*o,a[2]=(s[1]*s[5]-s[4]*s[2])*o,a[3]=(s[6]*s[5]-s[3]*s[8])*o,a[4]=(s[0]*s[8]-s[6]*s[2])*o,a[5]=(s[3]*s[2]-s[0]*s[5])*o,a[6]=(s[3]*s[7]-s[6]*s[4])*o,a[7]=(s[6]*s[1]-s[0]*s[7])*o,a[8]=(s[0]*s[4]-s[3]*s[1])*o,n},i.prototype.invert=function(){return i.invert(this,this)},i.prototype.isOrthogonal=function(){var e=this.data,r=e[0]*e[3]+e[1]*e[4]+e[2]*e[5];return Math.abs(r)>t.EPSILON?!1:(r=e[0]*e[6]+e[1]*e[7]+e[2]*e[8],Math.abs(r)>t.EPSILON?!1:(r=e[3]*e[6]+e[4]*e[7]+e[5]*e[8],Math.abs(r)>t.EPSILON?!1:!0))},i.prototype.isNormal=function(){var e=this.data,r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];return Math.abs(r-1)>t.EPSILON?!1:(r=e[3]*e[3]+e[4]*e[4]+e[5]*e[5],Math.abs(r-1)>t.EPSILON?!1:(r=e[6]*e[6]+e[7]*e[7]+e[8]*e[8],Math.abs(r-1)>t.EPSILON?!1:!0))},i.prototype.isOrthonormal=function(){return this.isOrthogonal()&&this.isNormal()},i.prototype.determinant=function(){var t=this.data;return t[0]*(t[4]*t[8]-t[7]*t[5])-t[3]*(t[1]*t[8]-t[7]*t[2])+t[6]*(t[1]*t[5]-t[4]*t[2])},i.prototype.setIdentity=function(){var t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},i.prototype.applyPost=function(t){var e=t.data,r=this.data,i=e[0],n=e[1],o=e[2];return e[0]=r[0]*i+r[3]*n+r[6]*o,e[1]=r[1]*i+r[4]*n+r[7]*o,e[2]=r[2]*i+r[5]*n+r[8]*o,t},i.prototype.applyPre=function(t){var e=t.data,r=this.data,i=e[0],n=e[1],o=e[2];return e[0]=r[0]*i+r[1]*n+r[2]*o,e[1]=r[3]*i+r[4]*n+r[5]*o,e[2]=r[6]*i+r[7]*n+r[8]*o,t},i.prototype.multiplyDiagonalPost=function(t,e){var r=t.data[0],i=t.data[1],n=t.data[2],o=this.data,a=e.data;return a[0]=r*o[0],a[1]=r*o[1],a[2]=r*o[2],a[3]=i*o[3],a[4]=i*o[4],a[5]=i*o[5],a[6]=n*o[6],a[7]=n*o[7],a[8]=n*o[8],e},i.prototype.fromAngles=function(t,e,r){var i=Math.cos(t),n=Math.sin(t),o=Math.cos(e),a=Math.sin(e),s=Math.cos(r),h=Math.sin(r),d=this.data;return d[0]=o*s,d[3]=a*n-o*h*i,d[6]=o*h*n+a*i,d[1]=h,d[4]=s*i,d[7]=-s*n,d[2]=-a*s,d[5]=a*h*i+o*n,d[8]=-a*h*n+o*i,this},i.prototype.rotateX=function(t,e){e=e||this;var r=this.data,i=e.data,n=Math.sin(t),o=Math.cos(t),a=r[3],s=r[4],h=r[5],d=r[6],l=r[7],u=r[8];return r!==i&&(i[0]=r[0],i[1]=r[1],i[2]=r[2]),i[3]=a*o+d*n,i[4]=s*o+l*n,i[5]=h*o+u*n,i[6]=d*o-a*n,i[7]=l*o-s*n,i[8]=u*o-h*n,e},i.prototype.rotateY=function(t,e){e=e||this;var r=this.data,i=e.data,n=Math.sin(t),o=Math.cos(t),a=r[0],s=r[1],h=r[2],d=r[6],l=r[7],u=r[8];return r!==i&&(i[3]=r[3],i[4]=r[4],i[5]=r[5]),i[0]=a*o-d*n,i[1]=s*o-l*n,i[2]=h*o-u*n,i[6]=a*n+d*o,i[7]=s*n+l*o,i[8]=h*n+u*o,e},i.prototype.rotateZ=function(t,e){e=e||this;var r=this.data,i=e.data,n=Math.sin(t),o=Math.cos(t),a=r[0],s=r[1],h=r[2],d=r[3],l=r[4],u=r[5];return r!==i&&(i[6]=r[6],i[7]=r[7],i[8]=r[8]),i[0]=a*o+d*n,i[1]=s*o+l*n,i[2]=h*o+u*n,i[3]=d*o-a*n,i[4]=l*o-s*n,i[5]=u*o-h*n,e},i.prototype.toAngles=function(e){var i=e;i||(i=new r);var n=this.data,o=i.data;return n[3]>1-t.EPSILON?(o[1]=Math.atan2(n[2],n[8]),o[2]=Math.PI/2,o[0]=0):n[3]<-1+t.EPSILON?(o[1]=Math.atan2(n[2],n[8]),o[2]=-Math.PI/2,o[0]=0):(o[1]=Math.atan2(-n[2],n[0]),o[0]=Math.atan2(-n[7],n[4]),o[2]=Math.asin(n[1])),i},i.prototype.fromAngleNormalAxis=function(t,e,r,i){var n=Math.cos(t),o=Math.sin(t),a=1-n,s=e*e,h=r*r,d=i*i,l=e*r*a,u=e*i*a,c=r*i*a,p=e*o,f=r*o,m=i*o,g=this.data;return g[0]=s*a+n,g[3]=l-m,g[6]=u+f,g[1]=l+m,g[4]=h*a+n,g[7]=c-p,g[2]=u-f,g[5]=c+p,g[8]=d*a+n,this},i.prototype.lookAt=function(t,e){var n=i._tempX,o=i._tempY,a=i._tempZ;a.setv(t).normalize(),n.setv(e).cross(a).normalize(),n.equals(r.ZERO)&&(0!==a.data[0]?n.setd(a.data[1],-a.data[0],0):n.setd(0,a.data[2],-a.data[1])),o.setv(a).cross(n);var s=this.data;return s[0]=n.data[0],s[1]=n.data[1],s[2]=n.data[2],s[3]=o.data[0],s[4]=o.data[1],s[5]=o.data[2],s[6]=a.data[0],s[7]=a.data[1],s[8]=a.data[2],this},i.prototype.copyQuaternion=function(t){return t.toRotationMatrix(this)},i.prototype.copy=function(t){var e=this.data,r=t.data;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],this},i.prototype.clone=function(){var t=this.data;return new i(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},i}),define("goo/math/Matrix4x4",["goo/math/MathUtils","goo/math/Matrix"],function(t,e){"use strict";function r(){e.call(this,4,4),0===arguments.length?this.setIdentity():this.set(arguments)}return r.prototype=Object.create(e.prototype),e.setupAliases(r.prototype,[["e00"],["e10"],["e20"],["e30"],["e01"],["e11"],["e21"],["e31"],["e02"],["e12"],["e22"],["e32"],["e03"],["e13"],["e23"],["e33"]]),r.IDENTITY=new r(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),r.add=function(t,e,i){return i||(i=new r),e instanceof r?(i.e00=t.e00+e.e00,i.e10=t.e10+e.e10,i.e20=t.e20+e.e20,i.e30=t.e30+e.e30,i.e01=t.e01+e.e01,i.e11=t.e11+e.e11,i.e21=t.e21+e.e21,i.e31=t.e31+e.e31,i.e02=t.e02+e.e02,i.e12=t.e12+e.e12,i.e22=t.e22+e.e22,i.e32=t.e32+e.e32,i.e03=t.e03+e.e03,i.e13=t.e13+e.e13,i.e23=t.e23+e.e23,i.e33=t.e33+e.e33):(i.e00=t.e00+e,i.e10=t.e10+e,i.e20=t.e20+e,i.e30=t.e30+e,i.e01=t.e01+e,i.e11=t.e11+e,i.e21=t.e21+e,i.e31=t.e31+e,i.e02=t.e02+e,i.e12=t.e12+e,i.e22=t.e22+e,i.e32=t.e32+e,i.e03=t.e03+e,i.e13=t.e13+e,i.e23=t.e23+e,i.e33=t.e33+e),i},r.prototype.add=function(t){return r.add(this,t,this)},r.sub=function(t,e,i){return i||(i=new r),e instanceof r?(i.e00=t.e00-e.e00,i.e10=t.e10-e.e10,i.e20=t.e20-e.e20,i.e30=t.e30-e.e30,i.e01=t.e01-e.e01,i.e11=t.e11-e.e11,i.e21=t.e21-e.e21,i.e31=t.e31-e.e31,i.e02=t.e02-e.e02,i.e12=t.e12-e.e12,i.e22=t.e22-e.e22,i.e32=t.e32-e.e32,i.e03=t.e03-e.e03,i.e13=t.e13-e.e13,i.e23=t.e23-e.e23,i.e33=t.e33-e.e33):(i.e00=t.e00-e,i.e10=t.e10-e,i.e20=t.e20-e,i.e30=t.e30-e,i.e01=t.e01-e,i.e11=t.e11-e,i.e21=t.e21-e,i.e31=t.e31-e,i.e02=t.e02-e,i.e12=t.e12-e,i.e22=t.e22-e,i.e32=t.e32-e,i.e03=t.e03-e,i.e13=t.e13-e,i.e23=t.e23-e,i.e33=t.e33-e),i},r.prototype.sub=function(t){return r.sub(this,t,this)},r.mul=function(t,e,i){return i||(i=new r),e instanceof r?(i.e00=t.e00*e.e00,i.e10=t.e10*e.e10,i.e20=t.e20*e.e20,i.e30=t.e30*e.e30,i.e01=t.e01*e.e01,i.e11=t.e11*e.e11,i.e21=t.e21*e.e21,i.e31=t.e31*e.e31,i.e02=t.e02*e.e02,i.e12=t.e12*e.e12,i.e22=t.e22*e.e22,i.e32=t.e32*e.e32,i.e03=t.e03*e.e03,i.e13=t.e13*e.e13,i.e23=t.e23*e.e23,i.e33=t.e33*e.e33):(i.e00=t.e00*e,i.e10=t.e10*e,i.e20=t.e20*e,i.e30=t.e30*e,i.e01=t.e01*e,i.e11=t.e11*e,i.e21=t.e21*e,i.e31=t.e31*e,i.e02=t.e02*e,i.e12=t.e12*e,i.e22=t.e22*e,i.e32=t.e32*e,i.e03=t.e03*e,i.e13=t.e13*e,i.e23=t.e23*e,i.e33=t.e33*e),i},r.prototype.mul=function(t){return r.mul(this,t,this)},r.div=function(t,e,i){return i||(i=new r),e instanceof r?(i.e00=t.e00/e.e00,i.e10=t.e10/e.e10,i.e20=t.e20/e.e20,i.e30=t.e30/e.e30,i.e01=t.e01/e.e01,i.e11=t.e11/e.e11,i.e21=t.e21/e.e21,i.e31=t.e31/e.e31,i.e02=t.e02/e.e02,i.e12=t.e12/e.e12,i.e22=t.e22/e.e22,i.e32=t.e32/e.e32,i.e03=t.e03/e.e03,i.e13=t.e13/e.e13,i.e23=t.e23/e.e23,i.e33=t.e33/e.e33):(e=1/e,i.e00=t.e00*e,i.e10=t.e10*e,i.e20=t.e20*e,i.e30=t.e30*e,i.e01=t.e01*e,i.e11=t.e11*e,i.e21=t.e21*e,i.e31=t.e31*e,i.e02=t.e02*e,i.e12=t.e12*e,i.e22=t.e22*e,i.e32=t.e32*e,i.e03=t.e03*e,i.e13=t.e13*e,i.e23=t.e23*e,i.e33=t.e33*e),i},r.prototype.div=function(t){return r.div(this,t,this)},r.combine=function(t,e,i){i||(i=new r);var n=t.data,o=n[0],a=n[4],s=n[8],h=n[12],d=n[1],l=n[5],u=n[9],c=n[13],p=n[2],f=n[6],m=n[10],g=n[14],v=n[3],y=n[7],x=n[11],_=n[15],w=e.data,b=w[0],S=w[4],E=w[8],C=w[12],M=w[1],T=w[5],P=w[9],R=w[13],A=w[2],D=w[6],I=w[10],O=w[14],L=w[3],N=w[7],B=w[11],F=w[15],k=i.data;return k[0]=o*b+a*M+s*A+h*L,k[4]=o*S+a*T+s*D+h*N,k[8]=o*E+a*P+s*I+h*B,k[12]=o*C+a*R+s*O+h*F,k[1]=d*b+l*M+u*A+c*L,k[5]=d*S+l*T+u*D+c*N,k[9]=d*E+l*P+u*I+c*B,k[13]=d*C+l*R+u*O+c*F,k[2]=p*b+f*M+m*A+g*L,k[6]=p*S+f*T+m*D+g*N,k[10]=p*E+f*P+m*I+g*B,k[14]=p*C+f*R+m*O+g*F,k[3]=v*b+y*M+x*A+_*L,k[7]=v*S+y*T+x*D+_*N,k[11]=v*E+y*P+x*I+_*B,k[15]=v*C+y*R+x*O+_*F,i},r.prototype.combine=function(t){return r.combine(this,t,this)},r.transpose=function(t,e){e||(e=new r);var i=t.data,n=e.data;if(e===t){var o=i[4],a=i[8],s=i[12],h=i[9],d=i[13],l=i[14];return n[4]=i[1],n[8]=i[2],n[12]=i[3],n[9]=i[6],n[13]=i[7],n[14]=i[11],n[1]=o,n[2]=a,n[3]=s,n[6]=h,n[7]=d,n[11]=l,e}return n[0]=i[0],n[1]=i[4],n[2]=i[8],n[3]=i[12],n[4]=i[1],n[5]=i[5],n[6]=i[9],n[7]=i[13],n[8]=i[2],n[9]=i[6],n[10]=i[10],n[11]=i[14],n[12]=i[3],n[13]=i[7],n[14]=i[11],n[15]=i[15],e},r.prototype.transpose=function(){return r.transpose(this,this)},r.invert=function(t,i){if(i||(i=new r),i===t)return e.copy(r.invert(t),i);var n=t.determinant();if(!n)return i;var o=t.data,a=i.data;return n=1/n,a[0]=(o[5]*(o[10]*o[15]-o[14]*o[11])-o[9]*(o[6]*o[15]-o[14]*o[7])+o[13]*(o[6]*o[11]-o[10]*o[7]))*n,a[1]=(o[1]*(o[14]*o[11]-o[10]*o[15])-o[9]*(o[14]*o[3]-o[2]*o[15])+o[13]*(o[10]*o[3]-o[2]*o[11]))*n,a[2]=(o[1]*(o[6]*o[15]-o[14]*o[7])-o[5]*(o[2]*o[15]-o[14]*o[3])+o[13]*(o[2]*o[7]-o[6]*o[3]))*n,a[3]=(o[1]*(o[10]*o[7]-o[6]*o[11])-o[5]*(o[10]*o[3]-o[2]*o[11])+o[9]*(o[6]*o[3]-o[2]*o[7]))*n,a[4]=(o[4]*(o[14]*o[11]-o[10]*o[15])-o[8]*(o[14]*o[7]-o[6]*o[15])+o[12]*(o[10]*o[7]-o[6]*o[11]))*n,a[5]=(o[0]*(o[10]*o[15]-o[14]*o[11])-o[8]*(o[2]*o[15]-o[14]*o[3])+o[12]*(o[2]*o[11]-o[10]*o[3]))*n,a[6]=(o[0]*(o[14]*o[7]-o[6]*o[15])-o[4]*(o[14]*o[3]-o[2]*o[15])+o[12]*(o[6]*o[3]-o[2]*o[7]))*n,a[7]=(o[0]*(o[6]*o[11]-o[10]*o[7])-o[4]*(o[2]*o[11]-o[10]*o[3])+o[8]*(o[2]*o[7]-o[6]*o[3]))*n,a[8]=(o[4]*(o[9]*o[15]-o[13]*o[11])-o[8]*(o[5]*o[15]-o[13]*o[7])+o[12]*(o[5]*o[11]-o[9]*o[7]))*n,a[9]=(o[0]*(o[13]*o[11]-o[9]*o[15])-o[8]*(o[13]*o[3]-o[1]*o[15])+o[12]*(o[9]*o[3]-o[1]*o[11]))*n,a[10]=(o[0]*(o[5]*o[15]-o[13]*o[7])-o[4]*(o[1]*o[15]-o[13]*o[3])+o[12]*(o[1]*o[7]-o[5]*o[3]))*n,a[11]=(o[0]*(o[9]*o[7]-o[5]*o[11])-o[4]*(o[9]*o[3]-o[1]*o[11])+o[8]*(o[5]*o[3]-o[1]*o[7]))*n,a[12]=(o[4]*(o[13]*o[10]-o[9]*o[14])-o[8]*(o[13]*o[6]-o[5]*o[14])+o[12]*(o[9]*o[6]-o[5]*o[10]))*n,a[13]=(o[0]*(o[9]*o[14]-o[13]*o[10])-o[8]*(o[1]*o[14]-o[13]*o[2])+o[12]*(o[1]*o[10]-o[9]*o[2]))*n,a[14]=(o[0]*(o[13]*o[6]-o[5]*o[14])-o[4]*(o[13]*o[2]-o[1]*o[14])+o[12]*(o[5]*o[2]-o[1]*o[6]))*n,a[15]=(o[0]*(o[5]*o[10]-o[9]*o[6])-o[4]*(o[1]*o[10]-o[9]*o[2])+o[8]*(o[1]*o[6]-o[5]*o[2]))*n,i},r.prototype.invert=function(){return r.invert(this,this)},r.prototype.isOrthogonal=function(){var e;return e=this.e00*this.e01+this.e10*this.e11+this.e20*this.e21+this.e30*this.e31,Math.abs(e)>t.EPSILON?!1:(e=this.e00*this.e02+this.e10*this.e12+this.e20*this.e22+this.e30*this.e32,Math.abs(e)>t.EPSILON?!1:(e=this.e00*this.e03+this.e10*this.e13+this.e20*this.e23+this.e30*this.e33,Math.abs(e)>t.EPSILON?!1:(e=this.e01*this.e02+this.e11*this.e12+this.e21*this.e22+this.e31*this.e32,Math.abs(e)>t.EPSILON?!1:(e=this.e01*this.e03+this.e11*this.e13+this.e21*this.e23+this.e31*this.e33,Math.abs(e)>t.EPSILON?!1:(e=this.e02*this.e03+this.e12*this.e13+this.e22*this.e23+this.e32*this.e33,Math.abs(e)>t.EPSILON?!1:!0)))))},r.prototype.isNormal=function(){var e;return e=this.e00*this.e00+this.e10*this.e10+this.e20*this.e20+this.e30*this.e30,Math.abs(e-1)>t.EPSILON?!1:(e=this.e01*this.e01+this.e11*this.e11+this.e21*this.e21+this.e31*this.e31,Math.abs(e-1)>t.EPSILON?!1:(e=this.e02*this.e02+this.e12*this.e12+this.e22*this.e22+this.e32*this.e32,Math.abs(e-1)>t.EPSILON?!1:(e=this.e03*this.e03+this.e13*this.e13+this.e23*this.e23+this.e33*this.e33,Math.abs(e-1)>t.EPSILON?!1:!0)))},r.prototype.isOrthonormal=function(){return this.isOrthogonal()&&this.isNormal()},r.prototype.determinant=function(){var t=this.data,e=t[5]*t[10]*t[15]+t[9]*t[14]*t[7]+t[13]*t[6]*t[11]-t[13]*t[10]*t[7]-t[9]*t[6]*t[15]-t[5]*t[14]*t[11],r=t[1]*t[10]*t[15]+t[9]*t[14]*t[3]+t[13]*t[2]*t[11]-t[13]*t[10]*t[3]-t[9]*t[2]*t[15]-t[1]*t[14]*t[11],i=t[1]*t[6]*t[15]+t[5]*t[14]*t[3]+t[13]*t[2]*t[7]-t[13]*t[6]*t[3]-t[5]*t[2]*t[15]-t[1]*t[14]*t[7],n=t[1]*t[6]*t[11]+t[5]*t[10]*t[3]+t[9]*t[2]*t[7]-t[9]*t[6]*t[3]-t[5]*t[2]*t[11]-t[1]*t[10]*t[7];return t[0]*e-t[4]*r+t[8]*i-t[12]*n},r.prototype.setIdentity=function(){var t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},r.prototype.setRotationFromVector=function(t){var e=Math.sin(t.x),r=Math.cos(t.x),i=Math.sin(t.y),n=Math.cos(t.y),o=Math.sin(t.z),a=Math.cos(t.z);return this.e00=a*n,this.e10=o*n,this.e20=0-i,this.e01=a*i*e-o*r,this.e11=o*i*e+a*r,this.e21=n*e,this.e02=a*i*r+o*e,this.e12=o*i*r-a*e,this.e22=n*r,this},r.prototype.setRotationFromQuaternion=function(t){var e=t.lengthSquared();e=e>0?2/e:0;var r=t.x*e,i=t.y*e,n=t.z*e,o=t.w*r,a=t.w*i,s=t.w*n,h=t.x*r,d=t.x*i,l=t.x*n,u=t.y*i,c=t.y*n,p=t.z*n;return this.e00=1-u-p,this.e10=d+s,this.e20=l-a,this.e01=d-s,this.e11=1-h-p,this.e21=c+o,this.e02=l+a,this.e12=c-o,this.e22=1-h-u,this},r.prototype.setTranslation=function(t){return this.e03=t.x,this.e13=t.y,this.e23=t.z,this},r.prototype.getTranslation=function(t){return t.x=this.data[12],t.y=this.data[13],t.z=this.data[14],this},r.prototype.getRotation=function(t){var e=this.data;return t.set(e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]),this},r.prototype.getScale=function(t){var e=Math.sqrt(t.setd(this.data[0],this.data[4],this.data[8]).lengthSquared()),r=Math.sqrt(t.setd(this.data[1],this.data[5],this.data[9]).lengthSquared()),i=Math.sqrt(t.setd(this.data[2],this.data[6],this.data[10]).lengthSquared());return t.x=e,t.y=r,t.z=i,this},r.prototype.setScale=function(t){return this.e00*=t.x,this.e10*=t.y,this.e20*=t.z,this.e01*=t.x,this.e11*=t.y,this.e21*=t.z,this.e02*=t.x,this.e12*=t.y,this.e22*=t.z,this},r.prototype.applyPre=function(t){var e=t.data[0],r=t.data[1],i=t.data[2],n=t.data[3],o=this.data;return t.data[0]=o[0]*e+o[1]*r+o[2]*i+o[3]*n,t.data[1]=o[4]*e+o[5]*r+o[6]*i+o[7]*n,t.data[2]=o[8]*e+o[9]*r+o[10]*i+o[11]*n,t.data[3]=o[12]*e+o[13]*r+o[14]*i+o[15]*n,t},r.prototype.applyPost=function(t){var e=t.data[0],r=t.data[1],i=t.data[2],n=t.data[3],o=this.data;return t.data[0]=o[0]*e+o[4]*r+o[8]*i+o[12]*n,t.data[1]=o[1]*e+o[5]*r+o[9]*i+o[13]*n,t.data[2]=o[2]*e+o[6]*r+o[10]*i+o[14]*n,t.data[3]=o[3]*e+o[7]*r+o[11]*i+o[15]*n,t},r.prototype.applyPostPoint=function(t){var e=t.data[0],r=t.data[1],i=t.data[2],n=this.data;return t.data[0]=n[0]*e+n[4]*r+n[8]*i+n[12],t.data[1]=n[1]*e+n[5]*r+n[9]*i+n[13],t.data[2]=n[2]*e+n[6]*r+n[10]*i+n[14],t},r.prototype.applyPostVector=function(t){var e=t.x,r=t.y,i=t.z,n=this.data;return t.x=n[0]*e+n[4]*r+n[8]*i,t.y=n[1]*e+n[5]*r+n[9]*i,t.z=n[2]*e+n[6]*r+n[10]*i,t},r.prototype.copy=function(t){var e=this.data,r=t.data;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],this},r.prototype.clone=function(){var t=this.data;return new r(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},r}),define("goo/math/Transform",["goo/math/Vector3","goo/math/Matrix3x3","goo/math/Matrix4x4"],function(t,e,r){"use strict";function i(){this.matrix=new r,this.normalMatrix=new r,this.translation=new t,this.rotation=new e,this.scale=new t(1,1,1)}var n=new t,o=new t,a=new e;return i.combine=function(t,r,s){if(t.scale.data[0]!==t.scale.data[1]||t.scale.data[0]!==t.scale.data[2])throw{name:"NonUniformScaleException",message:"Non-uniform scaling in left hand transform, cannot resolve combined transform"};return s=s||new i,n.setv(r.translation),t.rotation.applyPost(n),n.mulv(t.scale),n.addv(t.translation),o.setv(r.scale),o.mulv(t.scale),e.combine(t.rotation,r.rotation,a),s.rotation.copy(a),s.scale.setv(o),s.translation.setv(n),s.update(),s},i.prototype.combine=function(t){return i.combine(this,t,this)},i.prototype.multiply=function(t,i){r.combine(t.matrix,i.matrix,this.matrix),a.data.set(t.rotation.data),this.rotation.data.set(i.rotation.data),e.combine(a,this.rotation,this.rotation),this.translation.setv(i.translation),this.translation.mulv(t.scale),a.applyPost(this.translation).addv(t.translation),n.setv(t.scale).mulv(i.scale),this.scale.setv(n)},i.prototype.setIdentity=function(){this.matrix.setIdentity(),this.translation.setv(t.ZERO),this.rotation.setIdentity(),this.scale.setv(t.ONE)},i.prototype.applyForward=function(t,e){return e.setv(t),this.matrix.applyPostPoint(e),e},i.prototype.applyForwardVector=function(t,e){return e.copy(t),e.set(e.x*this.scale.x,e.y*this.scale.y,e.z*this.scale.z),this.rotation.applyPost(e),e},i.prototype.update=function(){var t=this.matrix.data,e=this.rotation.data,r=this.scale.data,i=this.translation.data;t[0]=r[0]*e[0],t[1]=r[0]*e[1],t[2]=r[0]*e[2],t[3]=0,t[4]=r[1]*e[3],t[5]=r[1]*e[4],t[6]=r[1]*e[5],t[7]=0,t[8]=r[2]*e[6],t[9]=r[2]*e[7],t[10]=r[2]*e[8],t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1},i.prototype.copy=function(t){this.matrix.copy(t.matrix),this.translation.setv(t.translation),this.rotation.copy(t.rotation),this.scale.setv(t.scale)},i.prototype.setRotationXYZ=function(t,e,r){this.rotation.fromAngles(t,e,r)},i.prototype.lookAt=function(e,r){r||(r=t.UNIT_Y),n.setv(this.translation).subv(e).normalize(),this.rotation.lookAt(n,r)},i.prototype.invert=function(e){var r=e;r||(r=new i),r.matrix.copy(this.matrix),r.matrix.invert();var n=r.rotation.copy(this.rotation);return n.transpose(),r.scale.setv(t.ONE).div(this.scale),r.translation.copy(this.translation).invert().mulv(r.scale),r.rotation.applyPost(r.translation),r},i.prototype.toString=function(){return""+this.matrix},i}),define("goo/entities/components/TransformComponent",["goo/math/Transform","goo/math/Vector3","goo/entities/components/Component","goo/entities/EntitySelection","goo/math/Matrix4x4"],function(t,e,r,i,n){"use strict";function o(){this.type="TransformComponent",this.entity=null,this.parent=null,this.children=[],this.transform=new t,this.worldTransform=new t,this._dirty=!0,this._updated=!1}o.type="TransformComponent",o.prototype=Object.create(r.prototype),o.prototype.constructor=o,o.prototype.api={setTranslation:function(){return o.prototype.setTranslation.apply(this.transformComponent,arguments),this},setRotation:function(){return o.prototype.setRotation.apply(this.transformComponent,arguments),this},setScale:function(){return o.prototype.setScale.apply(this.transformComponent,arguments),this},lookAt:function(){return o.prototype.lookAt.apply(this.transformComponent,arguments),this},getTranslation:function(){return o.prototype.getTranslation.apply(this.transformComponent,arguments)},getRotation:function(){return o.prototype.getRotation.apply(this.transformComponent,arguments)},getScale:function(){return o.prototype.getScale.apply(this.transformComponent,arguments)},addTranslation:function(){return o.prototype.addTranslation.apply(this.transformComponent,arguments),this},addRotation:function(){return o.prototype.addRotation.apply(this.transformComponent,arguments),this},attachChild:function(t){return this.transformComponent.attachChild(t.transformComponent),this},detachChild:function(t){return this.transformComponent.detachChild(t.transformComponent),this},children:function(){return new i(this).children()},parent:function(){return new i(this).parent()},traverse:function(t,e){if(e=void 0!==e?e:0,t(this,e)!==!1)for(var r=0;r<this.transformComponent.children.length;r++){var i=this.transformComponent.children[r].entity;i.traverse(t,e+1)}return this},traverseUp:function(t){for(var e=this.transformComponent;t(e.entity)!==!1&&e.parent;)e=e.parent;return this},hide:function(){return this._hidden=!0,this.traverse(function(t){for(var e=0;e<t._components.length;e++){var r=t._components[e];"boolean"==typeof r.hidden&&(r.hidden=!0)}}),this},show:function(){this._hidden=!1;for(var t=this;t.transformComponent.parent;)if(t=t.transformComponent.parent.entity,t._hidden){for(var e=0;e<this._components.length;e++){var r=this._components[e];"boolean"==typeof r.hidden&&(r.hidden=!0)}return this}return this.traverse(function(t){if(t._hidden)return!1;for(var e=0;e<t._components.length;e++){var r=t._components[e];"boolean"==typeof r.hidden&&(r.hidden=t._hidden)}}),this},isVisiblyHidden:function(){var t=this;if(t._hidden)return!0;for(;t.transformComponent.parent;)if(t=t.transformComponent.parent.entity,t._hidden)return!0;return!1},isHidden:function(){return this._hidden}};var a=new e;return o.prototype.getTranslation=function(){return this.transform.translation},o.prototype.setTranslation=function(){return this.transform.translation.set(arguments),this._dirty=!0,this},o.prototype.getScale=function(){return this.transform.scale},o.prototype.setScale=function(){return this.transform.scale.set(arguments),this._dirty=!0,this},o.prototype.addTranslation=function(){return this.transform.translation.add(3===arguments.length?arguments:arguments[0]),this._dirty=!0,this},o.prototype.getRotation=function(t){return t=t||new e,this.transform.rotation.toAngles(t)},o.prototype.addRotation=function(){if(this.getRotation(a),1===arguments.length&&"object"==typeof arguments[0]){var t=arguments[0];t instanceof e?this.transform.rotation.fromAngles(a.x+t.x,a.y+t.y,a.z+t.z):3===t.length&&this.transform.rotation.fromAngles(a.x+t[0],a.y+t[1],a.z+t[2])}else this.transform.rotation.fromAngles(a.x+arguments[0],a.y+arguments[1],a.z+arguments[2]);return this._dirty=!0,this},o.prototype.setRotation=function(){if(1===arguments.length&&"object"==typeof arguments[0]){var t=arguments[0];t instanceof e?this.transform.rotation.fromAngles(t.x,t.y,t.z):3===t.length&&this.transform.rotation.fromAngles(t[0],t[1],t[2])}else this.transform.rotation.fromAngles(arguments[0],arguments[1],arguments[2]);return this._dirty=!0,this},o.prototype.lookAt=function(t,r){return 3===arguments.length?this.transform.lookAt(new e(arguments[0],arguments[1],arguments[2])):(Array.isArray(t)&&(t=new e(t)),Array.isArray(r)&&(r=new e(r)),this.transform.lookAt(t,r)),this._dirty=!0,this},o.prototype.setUpdated=function(){this._dirty=!0},o.prototype.attached=function(t){this.entity=t},o.prototype.detached=function(){this.entity=void 0},o.prototype.attachChild=function(t,e){for(var r=this;r;){if(r===t)return void console.warn("attachChild: An object can't be added as a descendant of itself.");r=r.parent}t.parent&&t.parent.detachChild(t),e&&(t.updateTransform(),this.updateTransform(),this.updateWorldTransform(),t.transform.multiply(this.worldTransform.invert(),t.transform)),t.parent=this,this.children.push(t)},o.prototype.detachChild=function(t,e){if(t===this)return void console.warn("attachChild: An object can't be removed from itself.");e&&t.transform.copy(t.worldTransform);var r=this.children.indexOf(t);-1!==r&&(t.parent=null,this.children.splice(r,1))},o.prototype.updateTransform=function(){this.transform.update()},o.prototype.updateWorldTransform=function(){this.parent?this.worldTransform.multiply(this.parent.worldTransform,this.transform):this.worldTransform.copy(this.transform);var t=this.worldTransform.scale;t.x!==t.y||t.x!==t.z?(n.invert(this.worldTransform.matrix,this.worldTransform.normalMatrix),n.transpose(this.worldTransform.normalMatrix,this.worldTransform.normalMatrix)):this.worldTransform.normalMatrix.copy(this.worldTransform.matrix),this._dirty=!1,this._updated=!0},o.applyOnEntity=function(r,i){var n=i.transformComponent;n||(n=new o);var a=!1;return Array.isArray(r)&&3===r.length?(n.transform.translation.setd(r[0],r[1],r[2]),a=!0):r instanceof e?(n.transform.translation.setd(r.data[0],r.data[1],r.data[2]),a=!0):"object"==typeof r&&"undefined"!=typeof r.x&&"undefined"!=typeof r.y&&"undefined"!=typeof r.z?(n.transform.translation.setd(r.x,r.y,r.z),a=!0):r instanceof t&&(n.transform=r,a=!0),a?(i.setComponent(n),!0):void 0
},o}),define("goo/entities/systems/System",[],function(){"use strict";function t(t,e){this.type=t,this.interests=e,this._activeEntities=[],this.passive=!1,this.priority=0}function e(t){return t.charAt(0).toLowerCase()+t.substr(1)}return t.prototype.added=function(t){this._check(t)},t.prototype.changed=function(t){this._check(t)},t.prototype.removed=function(t){var e=this._activeEntities.indexOf(t);-1!==e&&(this._activeEntities.splice(e,1),this.deleted&&this.deleted(t))},t.prototype._check=function(t){if(!this.interests||0!==this.interests.length){var r=null===this.interests;if(!r&&this.interests.length<=t._components.length){r=!0;for(var i=0;i<this.interests.length;i++){var n=e(this.interests[i]);if(!t[n]){r=!1;break}}}var o=this._activeEntities.indexOf(t);r&&-1===o?(this._activeEntities.push(t),this.inserted&&this.inserted(t)):r||-1===o||(this._activeEntities.splice(o,1),this.deleted&&this.deleted(t))}},t.prototype._process=function(t){this.process&&this.process(this._activeEntities,t)},t.prototype.clear=function(){this._activeEntities=[]},t}),define("goo/entities/World",["goo/entities/Entity","goo/entities/managers/EntityManager","goo/entities/components/TransformComponent","goo/entities/managers/Manager","goo/entities/systems/System","goo/entities/components/Component","goo/entities/EntitySelection"],function(t,e,r,i,n,o,a){"use strict";function s(t){this.gooRunner=t,this._managers=[],this._systems=[],this._addedEntities=[],this._changedEntities=[],this._removedEntities=[],this.by={},this._installDefaultSelectors(),this.entityManager=new e,this.setManager(this.entityManager),this.time=0,this.tpf=1,this._components=[]}return s.time=0,s.tpf=1,s.prototype._installDefaultSelectors=function(){this.by.system=function(t){var e=this.getSystem(t);return new a(e._activeEntities)}.bind(this),this.by.component=function(t){var e=this.entityManager.getEntities();return new a(e.filter(function(e){return!!e[t]}))}.bind(this),this.by.tag=function(t){var e=this.entityManager.getEntities();return new a(e.filter(function(e){return e.hasTag(t)}))}.bind(this),this.by.attribute=function(t){var e=this.entityManager.getEntities();return new a(e.filter(function(e){return e.hasAttribute(t)}))}.bind(this)},s.prototype.add=function(){for(var e=0;e<arguments.length;e++){var r=arguments[e];r instanceof t?this.addEntity(r):r instanceof i?this.setManager(r):r instanceof n?this.setSystem(r):r instanceof o&&this.registerComponent(r)}return this},s.prototype.registerComponent=function(t){return-1===this._components.indexOf(t)&&this._components.push(t),this},s.prototype.setManager=function(t){return this._managers.push(t),t.applyAPI(this.by),this},s.prototype.getManager=function(t){for(var e=0;e<this._managers.length;e++){var r=this._managers[e];if(r.type===t)return r}},s.prototype.setSystem=function(t){for(var e=t.priority,r=0;r<this._systems.length&&!(this._systems[r].priority>e);r++);return this._systems.splice(r,0,t),this},s.prototype.getSystem=function(t){for(var e=0;e<this._systems.length;e++){var r=this._systems[e];if(r.type===t)return r}},s.prototype.clearSystem=function(t){for(var e=0;e<this._systems.length;e++){var r=this._systems[e];r.type===t&&this._systems.splice(e,1)}return this},s.prototype.createEntity=function(){for(var e=new t(this),i=0;i<arguments.length;i++)"string"==typeof arguments[i]?e.name=arguments[i]:e.set(arguments[i]);return e.transformComponent||e.setComponent(new r),e},s.prototype.getEntities=function(){return this.entityManager.getEntities()},s.prototype.addEntity=function(t,e){if(-1===this._addedEntities.indexOf(t)&&this._addedEntities.push(t),t.transformComponent&&(void 0===e||e===!0))for(var r=t.transformComponent.children,i=0;i<r.length;i++)this.addEntity(r[i].entity,e);for(var i=0;i<this._managers.length;i++){var n=this._managers[i];n.added(t)}return this},s.prototype.removeEntity=function(t,e){-1===this._removedEntities.indexOf(t)&&this._removedEntities.push(t);var r=t.transformComponent;if(r.parent&&(r.parent.detachChild(r),r.parent=null),e===!1){for(var i=r.children,n=0;n<i.length;n++)i[n].parent=null;r.children=[]}else for(var i=r.children,n=0;n<i.length;n++)this._recursiveRemoval(i[n].entity,e);for(var n=0;n<this._managers.length;n++){var o=this._managers[n];o.removed(t)}return this},s.prototype._recursiveRemoval=function(t,e){-1===this._removedEntities.indexOf(t)&&this._removedEntities.push(t);for(var r=0;r<this._managers.length;r++){var i=this._managers[r];i.removed(t)}if(t.transformComponent&&(void 0===e||e===!0))for(var n=t.transformComponent.children,r=0;r<n.length;r++)this._recursiveRemoval(n[r].entity,e)},s.prototype.changedEntity=function(t,e,r){var i={entity:t};void 0!==e&&(i.component=e),void 0!==r&&(i.eventType=r),this._changedEntities.push(i)},s.prototype.processEntityChanges=function(){this._check(this._addedEntities,function(t,e){if(t.added&&t.added(e),t.addedComponent)for(var r=0;r<e._components.length;r++)t.addedComponent(e,e._components[r])}),this._check(this._changedEntities,function(t,e){t.changed&&t.changed(e.entity),void 0!==e.eventType&&t[e.eventType]&&t[e.eventType](e.entity,e.component)}),this._check(this._removedEntities,function(t,e){if(t.removed&&t.removed(e),t.removedComponent)for(var r=0;r<e._components.length;r++)t.removedComponent(e,e._components[r])})},s.prototype.process=function(){this.processEntityChanges();for(var t=0;t<this._systems.length;t++){var e=this._systems[t];e.passive||e._process(this.tpf)}},s.prototype._check=function(t,e){for(var r=0;r<t.length;r++)for(var i=t[r],n=0;n<this._systems.length;n++){var o=this._systems[n];e(o,i)}t.length=0},s.prototype.clear=function(){for(var t=0;t<this._systems.length;t++){var e=this._systems[t];e.clear&&e.clear()}this._systems=[];for(var r=this.entityManager.getEntities(),t=0;t<r.length;t++){var i=r[t];i._world=null}this.entityManager.clear(),this._addedEntities=[],this._changedEntities=[],this._removedEntities=[],this.gooRunner=null},s}),define("goo/renderer/RendererRecord",[],function(){"use strict";function t(){this.currentBuffer={ArrayBuffer:{buffer:null,valid:!1},ElementArrayBuffer:{buffer:null,valid:!1}},this.currentFrameBuffer=null,this.clippingTestValid=!1,this.clippingTestEnabled=!1,this.clips=[],this.enabledTextures=0,this.texturesValid=!1,this.currentTextureArraysUnit=0,this.textureRecord=[],this.usedProgram=null,this.boundAttributes=[],this.enabledAttributes=[],this.newlyEnabledAttributes=[],this.depthRecord={},this.cullRecord={},this.blendRecord={},this.offsetRecord={},this.lineRecord={},this.pointRecord={},this.shaderCache={}}return t.prototype.invalidateBuffer=function(t){this.currentBuffer[t].buffer=null,this.currentBuffer[t].valid=!1},t}),define("goo/renderer/Texture",["goo/math/Vector2"],function(t){"use strict";function e(e,r,i,n){this.glTexture=null,r=r||{},this.wrapS=r.wrapS||"Repeat",this.wrapT=r.wrapT||"Repeat",this.magFilter=r.magFilter||"Bilinear",this.minFilter=r.minFilter||"Trilinear",this.anisotropy=void 0!==r.anisotropy?r.anisotropy:1,this.format=r.format||"RGBA",this.type=r.type||"UnsignedByte",this.variant="2D",this.offset=new t(r.offset||[0,0]),this.repeat=new t(r.repeat||[1,1]),this.lodBias=0,this.generateMipmaps=void 0!==r.generateMipmaps?r.generateMipmaps:!0,this.premultiplyAlpha=void 0!==r.premultiplyAlpha?r.premultiplyAlpha:!1,this.unpackAlignment=void 0!==r.unpackAlignment?r.unpackAlignment:1,this.flipY=void 0!==r.flipY?r.flipY:!0,this.hasBorder=!1,this.needsUpdate=!1,this.updateCallback=null,this.readyCallback=null,e&&this.setImage(e,i,n,r)}return e.prototype.checkDataReady=function(){return this.image&&(this.image.dataReady||this.image instanceof HTMLImageElement)||null!==this.readyCallback&&this.readyCallback()},e.prototype.checkNeedsUpdate=function(){return this.needsUpdate||null!==this.updateCallback&&this.updateCallback()},e.prototype.setNeedsUpdate=function(){this.needsUpdate=!0},e.prototype.setImage=function(t,e,r,i){this.image=t;var n=t instanceof Array?t[0]:t;if(n instanceof Uint8Array||n instanceof Uint8ClampedArray||n instanceof Uint16Array||n instanceof Float32Array){if(e=e||t.width,r=r||t.height,void 0===e||void 0===r)throw"Data textures need width and height";this.image={data:t},this.image.width=e,this.image.height=r,this.image.isData=!0,this.image.dataReady=!0,n instanceof Uint8Array||n instanceof Uint8ClampedArray?this.type="UnsignedByte":n instanceof Uint16Array?(this.type="UnsignedShort565",this.format=i.format||"RGB"):n instanceof Float32Array&&(this.type="Float",this.format=i.format||"RGBA")}else t instanceof Array&&(this.image={data:t}),n instanceof HTMLCanvasElement&&(this.image.dataReady=!0);this.setNeedsUpdate()},e.prototype.destroy=function(t){t.deleteTexture(this.glTexture),this.glTexture=null},e.prototype.getSizeInMemory=function(){var t,e=this.image.width||this.image.length,r=this.image.height||1;return t=e*r,"Luminance"===this.format||"Alpha"===this.format?t*=1:"Lumin`anceAlpha"===this.format?t*=2:"RGB"===this.format?t*=3:"RGBA"===this.format?t*=4:"PrecompressedDXT1"===this.format?t*=.5:"PrecompressedDXT1A"===this.format?t*=4/6:("PrecompressedDXT3"===this.format||"PrecompressedDXT5"===this.format)&&(t*=1),this.generateMipmaps&&(t=Math.ceil(4*t/3)),t},e.CUBE_FACES=["PositiveX","NegativeX","PositiveY","NegativeY","PositiveZ","NegativeZ"],e}),define("goo/util/rsvp",["exports"],function(t){"use strict";function e(t,e){o.async(function(){t.trigger("promise:resolved",{detail:e}),t.isResolved=!0,t.resolvedValue=e})}function r(t,e){o.async(function(){t.trigger("promise:failed",{detail:e}),t.isRejected=!0,t.rejectedValue=e})}function i(t){var e,r=[],i=new g,n=t.length;0===n&&i.resolve([]);var o=function(t,e){r[t]=e,0===--n&&i.resolve(r)},a=function(t){return function(e){o(t,e)}},s=function(t){i.reject(t)};for(e=0;n>e;e++)t[e].then(a(e),s);return i}function n(t,e){o[t]=e}var o={},a="undefined"!=typeof window?window:{},s=a.MutationObserver||a.WebKitMutationObserver,h=window.process;if("undefined"!=typeof h&&"[object process]"==={}.toString.call(h))o.async=function(t,e){h.nextTick(function(){t.call(e)})};else if(s){var d=[],l=new s(function(){var t=d.slice();d=[],t.forEach(function(t){var e=t[0],r=t[1];e.call(r)})}),u=document.createElement("div");l.observe(u,{attributes:!0}),window.addEventListener("unload",function(){l.disconnect(),l=null}),o.async=function(t,e){d.push([t,e]),u.setAttribute("drainQueue","drainQueue")}}else o.async=function(t,e){setTimeout(function(){t.call(e)},1)};var c=function(t,e){this.type=t;for(var r in e)e.hasOwnProperty(r)&&(this[r]=e[r])},p=function(t,e){for(var r=0,i=t.length;i>r;r++)if(t[r][0]===e)return r;return-1},f=function(t){var e=t._promiseCallbacks;return e||(e=t._promiseCallbacks={}),e},m={mixin:function(t){return t.on=this.on,t.off=this.off,t.trigger=this.trigger,t},on:function(t,e,r){var i,n,o=f(this);for(t=t.split(/\s+/),r=r||this;n=t.shift();)i=o[n],i||(i=o[n]=[]),-1===p(i,e)&&i.push([e,r])},off:function(t,e){var r,i,n,o=f(this);for(t=t.split(/\s+/);i=t.shift();)e?(r=o[i],n=p(r,e),-1!==n&&r.splice(n,1)):o[i]=[]},trigger:function(t,e){var r,i,n,o,a,s=f(this);if(r=s[t])for(var h=0,d=r.length;d>h;h++)i=r[h],n=i[0],o=i[1],"object"!=typeof e&&(e={detail:e}),a=new c(t,e),n.call(o,a)}},g=function(){this.on("promise:resolved",function(t){this.trigger("success",{detail:t.detail})},this),this.on("promise:failed",function(t){this.trigger("error",{detail:t.detail})},this)},v=function(){},y=function(t,e,r,i){var n,o,a,s,h="function"==typeof r;if(h)try{n=r(i.detail),a=!0}catch(d){s=!0,o=d}else n=i.detail,a=!0;n&&"function"==typeof n.then?n.then(function(t){e.resolve(t)},function(t){e.reject(t)}):h&&a?e.resolve(n):s?e.reject(o):e[t](n)};g.prototype={then:function(t,e){var r=new g;return this.isResolved&&o.async(function(){y("resolve",r,t,{detail:this.resolvedValue})},this),this.isRejected&&o.async(function(){y("reject",r,e,{detail:this.rejectedValue})},this),this.on("promise:resolved",function(e){y("resolve",r,t,e)}),this.on("promise:failed",function(t){y("reject",r,e,t)}),r},resolve:function(t){e(this,t),this.resolve=v,this.reject=v},reject:function(t){r(this,t),this.resolve=v,this.reject=v}},m.mixin(g.prototype),t.Promise=g,t.Event=c,t.EventTarget=m,t.all=i,t.configure=n}),define("goo/util/PromiseUtil",["goo/util/rsvp"],function(t){"use strict";var e=(!!window.Promise,{});e.createPromise=function(e){var r=new t.Promise;return e(function(t){r.resolve(t)},function(t){r.reject(t)}),r},e.resolve=function(e){var r=new t.Promise;return r.resolve(e),r},e.reject=function(e){var r=new t.Promise;return r.reject(e),r};var r=!1;return e.createDummyPromise=function(e,i){r||(r=!0,console.warn("PromiseUtil.createDummyPromise is deprecated; please consider using PromiseUtil.resolve/reject instead"));var n=new t.Promise;return i?n.reject(i):n.resolve(e),n},e.optimisticAll=function(e){var r=0,i=e.length,n=[],o=new t.Promise;if(i>0)for(var a=0;i>a;a++)!function(t){e[t].then(function(e){n[t]=e,r++,r===i&&o.resolve(n)},function(e){n[t]=e,r++,r===i&&o.resolve(n)})}(a);else o.resolve(n);return o},e.defer=function(e,r){var i,n,o;return o=new t.Promise,r.apply?(i=new t.Promise,n=i.then(function(){return r()}),setTimeout(function(){i.resolve()},e),n):(setTimeout(function(){o.resolve(r)},e),o)},e}),define("goo/loaders/handlers/ConfigHandler",["goo/util/rsvp","goo/util/PromiseUtil"],function(t,e){"use strict";function r(t,e,r,i){this.world=t,this.getConfig=e,this.updateObject=r,this.loadObject=i,this._objects={},this._loading={}}return r.prototype._create=function(){return{}},r.prototype._remove=function(t){delete this._objects[t]},r.prototype._prepare=function(t){t=t},r.prototype._load=function(t,e){return this.loadObject(t,e)},r.prototype.load=function(t,r){var i=t.substr(t.lastIndexOf(".")+1);if(i!==this.constructor._type)throw new Error("Trying to load type"+i+" with handler for "+this._type);var n=this;return this._loading[t]?this._loading[t]:this._objects[t]&&!r.reload?e.resolve(this._objects[t]):this._loading[t]=this.getConfig(t,r).then(function(e){return n.update(t,e,r)}).then(function(e){return delete n._loading[t],e}).then(null,function(e){throw delete n._loading[t],e})},r.prototype.clear=function(){var e=[];for(var r in this._objects)e.push(this.update(r,null,{}));for(var i in this._objects)delete this._objects[i];for(var i in this._loading)delete this._loading[i];return t.all(e)},r.prototype.update=function(t,e,r){var i=this;return this._loading[t]=this._update(t,e,r).then(function(e){return delete i._loading[t],e})},r.prototype._update=function(t,r,i){return r?(this._objects[t]||(this._objects[t]=this._create()),this._prepare(r),e.resolve(this._objects[t])):(this._remove(t,i),e.resolve())},r.handlerClasses={},r.getHandler=function(t){return r.handlerClasses[t]},r._registerClass=function(t,e){return e._type=t,r.handlerClasses[t]=e},r}),define("goo/loaders/dds/DdsUtils",[],function(){"use strict";function t(){}return t.getDdsExtension=function(t){for(var e=["","WEBKIT_","MOZ_"],r=0;r<e.length;r++){var i=t.getExtension(e[r]+"WEBGL_compressed_texture_s3tc");if("undefined"!=typeof i&&null!==i)return i}return null},t.isSupported=function(e){return null!==t.getDdsExtension(e)},t.shiftCount=function(t){if(0===t)return 0;for(var e=0;0===(1&t);)if(t>>=1,e++,e>32)throw"invalid mask!";return e},t.isSet=function(t,e){return(t&e)===e},t.getIntFromString=function(e){for(var r=[],i=0;i<e.length;i++)r[i]=e.charCodeAt(i);return t.getIntFromBytes(r)},t.getIntFromBytes=function(t){var e=0;return e|=(255&t[0])<<0,t.length>1&&(e|=(255&t[1])<<8),t.length>2&&(e|=(255&t[2])<<16),t.length>3&&(e|=(255&t[3])<<24),e},t.getComponents=function(t){switch(t){case"Alpha":return 1;case"RGB":return 3;case"RGBA":return 4;case"Luminance":return 1;case"LuminanceAlpha":return 2;case"PrecompressedDXT1":return 1;case"PrecompressedDXT1A":return 1;case"PrecompressedDXT3":return 2;case"PrecompressedDXT5":return 2}return 0},t.flipDXT=function(e,r,i,n){for(var o=new Uint8Array(e.length),a=r+3>>2,s=i+3>>2,h=8*t.getComponents(n),d=0;s>d;d++)for(var l=s-d-1,u=0;a>u;u++){var c=(l*a+u)*h,p=(d*a+u)*h;switch(n){case"PrecompressedDXT1":case"PrecompressedDXT1A":o[c+0]=e[p+0],o[c+1]=e[p+1],o[c+2]=e[p+2],o[c+3]=e[p+3],o[c+4]=e[p+7],o[c+5]=e[p+6],o[c+6]=e[p+5],o[c+7]=e[p+4];break;case"PrecompressedDXT3":o[c+0]=e[p+6],o[c+1]=e[p+7],o[c+2]=e[p+4],o[c+3]=e[p+5],o[c+4]=e[p+2],o[c+5]=e[p+3],o[c+6]=e[p+0],o[c+7]=e[p+1],o[c+8]=e[p+8],o[c+9]=e[p+9],o[c+10]=e[p+10],o[c+11]=e[p+11],o[c+12]=e[p+15],o[c+13]=e[p+14],o[c+14]=e[p+13],o[c+15]=e[p+12];break;case"PrecompressedDXT5":o[c+0]=e[p+0],o[c+1]=e[p+1],t.getBytesFromUInt24(o,c+5,t.flipUInt24(t.getUInt24(e,p+2))),t.getBytesFromUInt24(o,c+2,t.flipUInt24(t.getUInt24(e,p+5))),o[c+8]=e[p+8],o[c+9]=e[p+9],o[c+10]=e[p+10],o[c+11]=e[p+11],o[c+12]=e[p+15],o[c+13]=e[p+14],o[c+14]=e[p+13],o[c+15]=e[p+12]}}return o},t.getUInt24=function(t,e){var r=0;return r|=(255&t[e+0])<<0,r|=(255&t[e+1])<<8,r|=(255&t[e+2])<<16},t.getBytesFromUInt24=function(t,e,r){t[e+0]=255&r,t[e+1]=(65280&r)>>8,t[e+2]=(16711680&r)>>16},t.ThreeBitMask=7,t.flipUInt24=function(e){for(var r=[],i=0;2>i;i++)r.push([0,0,0,0]);r[0][0]=e&t.ThreeBitMask,e>>=3,r[0][1]=e&t.ThreeBitMask,e>>=3,r[0][2]=e&t.ThreeBitMask,e>>=3,r[0][3]=e&t.ThreeBitMask,e>>=3,r[1][0]=e&t.ThreeBitMask,e>>=3,r[1][1]=e&t.ThreeBitMask,e>>=3,r[1][2]=e&t.ThreeBitMask,e>>=3,r[1][3]=e&t.ThreeBitMask;var n=0;return n|=r[1][0]<<0,n|=r[1][1]<<3,n|=r[1][2]<<6,n|=r[1][3]<<9,n|=r[0][0]<<12,n|=r[0][1]<<15,n|=r[0][2]<<18,n|=r[0][3]<<21},t}),define("goo/loaders/dds/DdsLoader",["goo/loaders/dds/DdsUtils"],function(t){"use strict";function e(){this.dwSize=0,this.dwFlags=0,this.dwFourCC=0,this.dwRGBBitCount=0,this.dwRBitMask=0,this.dwGBitMask=0,this.dwBBitMask=0,this.dwABitMask=0}function r(){this.dwSize=0,this.dwFlags=0,this.dwHeight=0,this.dwWidth=0,this.dwLinearSize=0,this.dwDepth=0,this.dwMipMapCount=0,this.dwAlphaBitDepth=0,this.dwReserved1=[],this.ddpf=null,this.dwCaps=0,this.dwCaps2=0,this.dwCaps3=0,this.dwCaps4=0,this.dwTextureStage=0}function i(){this.flipVertically=!1,this.bpp=0,this.header=null,this.headerDX10=null,this.mipmapByteSizes=[]}function n(){}return e.HEADER_OFFSET=19,e.DDPF_ALPHAPIXELS=1,e.DDPF_ALPHA=2,e.DDPF_FOURCC=4,e.DDPF_RGB=64,e.DDPF_YUV=512,e.DDPF_LUMINANCE=131072,e.read=function(t){var r=new e;if(r.dwSize=t[e.HEADER_OFFSET+0],32!==r.dwSize)throw"invalid pixel format size: "+r.dwSize;return r.dwFlags=t[e.HEADER_OFFSET+1],r.dwFourCC=t[e.HEADER_OFFSET+2],r.dwRGBBitCount=t[e.HEADER_OFFSET+3],r.dwRBitMask=t[e.HEADER_OFFSET+4],r.dwGBitMask=t[e.HEADER_OFFSET+5],r.dwBBitMask=t[e.HEADER_OFFSET+6],r.dwABitMask=t[e.HEADER_OFFSET+7],r},r.DDSD_CAPS=1,r.DDSD_HEIGHT=2,r.DDSD_WIDTH=4,r.DDSD_PITCH=8,r.DDSD_PIXELFORMAT=4096,r.DDSD_MIPMAPCOUNT=131072,r.DDSD_LINEARSIZE=524288,r.DDSD_DEPTH=8388608,r.DDSCAPS_COMPLEX=8,r.DDSCAPS_MIPMAP=4194304,r.DDSCAPS_TEXTURE=4096,r.DDSCAPS2_CUBEMAP=512,r.DDSCAPS2_CUBEMAP_POSITIVEX=1024,r.DDSCAPS2_CUBEMAP_NEGATIVEX=2048,r.DDSCAPS2_CUBEMAP_POSITIVEY=4096,r.DDSCAPS2_CUBEMAP_NEGATIVEY=8192,r.DDSCAPS2_CUBEMAP_POSITIVEZ=16384,r.DDSCAPS2_CUBEMAP_NEGATIVEZ=32768,r.DDSCAPS2_VOLUME=2097152,r.read=function(i){var n=new r;if(n.dwSize=i[1],124!==n.dwSize)throw"invalid dds header size: "+n.dwSize;n.dwFlags=i[2],n.dwHeight=i[3],n.dwWidth=i[4],n.dwLinearSize=i[5],n.dwDepth=i[6],n.dwMipMapCount=i[7],n.dwAlphaBitDepth=i[8];for(var o=0;o<n.dwReserved1.length;o++)n.dwReserved1[o]=i[9+o];n.ddpf=e.read(i),n.dwCaps=i[27],n.dwCaps2=i[28],n.dwCaps3=i[29],n.dwCaps4=i[30],n.dwTextureStage=i[31];var a=1+Math.ceil(Math.log(Math.max(n.dwHeight,n.dwWidth))/Math.log(2));return t.isSet(n.dwCaps,r.DDSCAPS_MIPMAP)?t.isSet(n.dwFlags,r.DDSD_MIPMAPCOUNT)?n.dwMipMapCount!==a&&console.warn("Got "+n.dwMipMapCount+" mipmaps, expected "+a):n.dwMipMapCount=a:n.dwMipMapCount=1,n},i.prototype.calcMipmapSizes=function(t){for(var e=this.header.dwWidth,r=this.header.dwHeight,i=0,n=0;n<this.header.dwMipMapCount;n++)i=t?~~((e+3)/4)*~~((r+3)/4)*this.bpp*2:~~(e*r*this.bpp/8),this.mipmapByteSizes.push(4*~~((i+3)/4)),e=~~(e/2)>1?~~(e/2):1,r=~~(r/2)>1?~~(r/2):1},n.updateDepth=function(e,i){if(t.isSet(i.header.dwCaps2,r.DDSCAPS2_CUBEMAP)){var n=0;if(t.isSet(i.header.dwCaps2,r.DDSCAPS2_CUBEMAP_POSITIVEX)&&n++,t.isSet(i.header.dwCaps2,r.DDSCAPS2_CUBEMAP_NEGATIVEX)&&n++,t.isSet(i.header.dwCaps2,r.DDSCAPS2_CUBEMAP_POSITIVEY)&&n++,t.isSet(i.header.dwCaps2,r.DDSCAPS2_CUBEMAP_NEGATIVEY)&&n++,t.isSet(i.header.dwCaps2,r.DDSCAPS2_CUBEMAP_POSITIVEZ)&&n++,t.isSet(i.header.dwCaps2,r.DDSCAPS2_CUBEMAP_NEGATIVEZ)&&n++,6!==n)throw new Error("Cubemaps without all faces defined are not currently supported.");e.depth=n}else e.depth=i.header.dwDepth>0?i.header.dwDepth:1},n.readDXT=function(e,r,i,n){if(n.image.isCompressed=!0,!i.flipVertically)return new Uint8Array(e.buffer,e.byteOffset+0,r);for(var o=i.header.dwWidth,a=i.header.dwHeight,s=new Uint8Array(r),h=0,d=0;d<i.header.dwMipMapCount;d++){var l=e.subarray(h,h+i.mipmapByteSizes[d]),u=t.flipDXT(l,o,a,n.format);s.set(u,h),h+=u.length,o=~~(o/2)>1?~~(o/2):1,a=~~(a/2)>1?~~(a/2):1}return s},n.readUncompressed=function(e,r,i,n,o,a,s,h){var d=t.shiftCount(s.header.ddpf.dwRBitMask),l=t.shiftCount(s.header.ddpf.dwGBitMask),u=t.shiftCount(s.header.ddpf.dwBBitMask),c=t.shiftCount(s.header.ddpf.dwABitMask),p=~~(s.header.ddpf.dwRGBBitCount/8),f=1*t.getComponents(h.format),m=new Uint8Array(r),g=s.header.dwWidth,v=s.header.dwHeight,y=0,x=0,_=0,w=[];for(_=0;p>_;_++)w.push(0);for(var b=0;b<s.header.dwMipMapCount;b++){for(var S=0;v>S;S++)for(var E=0;g>E;E++){for(_=0;p>_;_++)w[_]=e[x++];_=t.getIntFromBytes(w);var C=(_&s.header.ddpf.dwRBitMask)>>d,M=(_&s.header.ddpf.dwGBitMask)>>l,T=(_&s.header.ddpf.dwBBitMask)>>u,P=(_&s.header.ddpf.dwABitMask)>>c;o?m[y++]=P:n?(m[y++]=C,a&&(m[y++]=P)):i&&(m[y++]=C,m[y++]=M,m[y++]=T,a&&(m[y++]=P))}y+=g*v*f,g=~~(g/2)>1?~~(g/2):1,v=~~(v/2)>1?~~(v/2):1}return m},n.populate=function(r,i,o){var a=i.header.ddpf.dwFlags,s=t.isSet(a,e.DDPF_FOURCC),h=t.isSet(a,e.DDPF_RGB),d=t.isSet(a,e.DDPF_ALPHAPIXELS),l=t.isSet(a,e.DDPF_LUMINANCE),u=t.isSet(a,e.DDPF_ALPHA);if(r.type="UnsignedByte",s){var c=i.header.ddpf.dwFourCC;if(c===t.getIntFromString("DXT1"))i.bpp=4,r.format="PrecompressedDXT1A";else if(c===t.getIntFromString("DXT3"))i.bpp=8,r.format="PrecompressedDXT3";else{if(c!==t.getIntFromString("DXT5"))throw c===t.getIntFromString("DX10")?new Error("dxt10 LATC formats not supported currently: "+i.headerDX10.dxgiFormat):c===t.getIntFromString("DXT2")?"DXT2 is not supported.":c===t.getIntFromString("DXT4")?"DXT4 is not supported.":"unsupported compressed dds format found ("+c+")";i.bpp=8,r.format="PrecompressedDXT5"}}else if(i.bpp=i.header.ddpf.dwRGBBitCount,h)r.format=d?"RGBA":"RGB";else{if(!l&&!d)throw new Error("unsupported uncompressed dds format found.");l&&d?r.format="LuminanceAlpha":l?r.format="Luminance":u&&(r.format="Alpha")}i.calcMipmapSizes(s),r.image.mipmapSizes=i.mipmapByteSizes;for(var p=0,f=0;f<i.mipmapByteSizes.length;f++)p+=i.mipmapByteSizes[f];for(var m=[],f=0;f<r.image.depth;f++)s?m.push(n.readDXT(o,p,i,r)):(h||l||u)&&m.push(n.readUncompressed(o,p,h,l,u,d,i,r));r.image.data=1===r.image.depth?m[0]:m,r.image.useArrays=!0},n.prototype.load=function(e,o,a,s,h){var d=new Int32Array(e,s+0,32),l=d[0];if(l!==t.getIntFromString("DDS "))throw"Not a dds file.";var u=new i;u.flipVertically=a,u.header=r.read(d),u.headerDX10=u.header.ddpf.dwFourCC===t.getIntFromString("DX10")?r.read(Int32Array.create(e,s+128,5)):null;var c=o.image;("undefined"==typeof c||null===c)&&(c={},o.image=c),c.width=u.header.dwWidth,c.height=u.header.dwHeight,n.updateDepth(c,u);var p=128+(u.headerDX10?20:0);n.populate(o,u,new Uint8Array(e,s+p,h-p)),(!u.mipmapByteSizes||u.mipmapByteSizes.length<2)&&(o.minFilter="BilinearNoMipMaps"),c.bpp=u.bpp,c.dataReady=!0,c.isData=!0,o.needsUpdate=!0},n.SUPPORTS_DDS=!1,n.prototype.isSupported=function(){return n.SUPPORTS_DDS},n.prototype.toString=function(){return"DdsLoader"},n}),define("goo/loaders/crunch/CrunchLoader",["goo/loaders/dds/DdsLoader","goo/loaders/dds/DdsUtils"],function(t,e){"use strict";function r(){}return r.cCRNFmtDXT1=0,r.cCRNFmtDXT3=1,r.cCRNFmtDXT5=2,r.prototype.arrayBufferCopy=function(t,e,r,i){var n,o=r/4,a=i%4,s=new Uint32Array(t.buffer,0,(i-a)/4),h=new Uint32Array(e.buffer);for(n=0;n<s.length;n++)h[o+n]=s[n];for(n=i-a;i>n;n++)e[r+n]=t[n]},r.prototype.load=function(t,i,n){if("undefined"==typeof window.CrunchModule)return void console.warn("Crunch library not loaded! Include a script tag pointing to lib/crunch/crunch.js in your html-file.");var o,a,s,h,d,l,u,c,p=window.CrunchModule,f=new Uint8Array(t),m=t.byteLength,g=p._malloc(m);this.arrayBufferCopy(f,p.HEAPU8,g,m),o=p._crn_get_dxt_format(g,m);var v;switch(o){case r.cCRNFmtDXT1:i.format="PrecompressedDXT1A",v=4;break;case r.cCRNFmtDXT3:i.format="PrecompressedDXT3",v=8;break;case r.cCRNFmtDXT5:i.format="PrecompressedDXT5",v=8;break;default:return console.error("Unsupported image format"),0}h=p._crn_get_width(g,m),d=p._crn_get_height(g,m),l=p._crn_get_levels(g,m),s=p._crn_get_uncompressed_size(g,m,0),a=p._malloc(s);var y=i.image;("undefined"==typeof y||null===y)&&(y={},i.image=y),y.width=h,y.height=d,y.depth=1;var x=[];for(i.image.mipmapSizes=[],c=0;l>c;++c)c&&(s=p._crn_get_uncompressed_size(g,m,c)),p._crn_decompress(g,m,a,s,c),u=new Uint8Array(p.HEAPU8.buffer,a,s),n&&(u=e.flipDXT(u,h,d,i.format)),x.push(u),i.image.mipmapSizes.push(s),h*=.5,d*=.5;i.image.data=x,i.image.useArrays=!0,i.type="UnsignedByte",i.image.isCompressed=!0,1>=l&&(i.minFilter="BilinearNoMipMaps"),y.bpp=v,y.dataReady=!0,y.isData=!0,i.needsUpdate=!0,p._free(g),p._free(a)},r.prototype.dxtToRgb565=function(t,e,r,i){for(var n=new Uint16Array(4),o=new Uint16Array(r*i),a=0,s=0,h=0,d=0,l=0,u=0,c=0,p=0,f=0,m=r/4,g=i/4,v=0;g>v;v++)for(var y=0;m>y;y++)h=e+4*(v*m+y),n[0]=t[h],n[1]=t[h+1],d=31&n[0],l=2016&n[0],u=63488&n[0],c=31&n[1],p=2016&n[1],f=63488&n[1],n[2]=5*d+3*c>>3|5*l+3*p>>3&2016|5*u+3*f>>3&63488,n[3]=5*c+3*d>>3|5*p+3*l>>3&2016|5*f+3*u>>3&63488,a=t[h+2],s=4*v*r+4*y,o[s]=n[3&a],o[s+1]=n[a>>2&3],o[s+2]=n[a>>4&3],o[s+3]=n[a>>6&3],s+=r,o[s]=n[a>>8&3],o[s+1]=n[a>>10&3],o[s+2]=n[a>>12&3],o[s+3]=n[a>>14],a=t[h+3],s+=r,o[s]=n[3&a],o[s+1]=n[a>>2&3],o[s+2]=n[a>>4&3],o[s+3]=n[a>>6&3],s+=r,o[s]=n[a>>8&3],o[s+1]=n[a>>10&3],o[s+2]=n[a>>12&3],o[s+3]=n[a>>14];return o},r.prototype.isSupported=function(){return t.SUPPORTS_DDS},r.prototype.toString=function(){return"CrunchLoader"},r}),define("goo/loaders/tga/TgaLoader",[],function(){"use strict";function t(){this.header=null,this.offset=0,this.use_rle=!1,this.use_pal=!1,this.use_rgb=!1,this.use_grey=!1}return t.TYPE_NO_DATA=0,t.TYPE_INDEXED=1,t.TYPE_RGB=2,t.TYPE_GREY=3,t.TYPE_RLE_INDEXED=9,t.TYPE_RLE_RGB=10,t.TYPE_RLE_GREY=11,t.ORIGIN_MASK=48,t.ORIGIN_SHIFT=4,t.ORIGIN_BL=0,t.ORIGIN_BR=1,t.ORIGIN_UL=2,t.ORIGIN_UR=3,t.prototype.load=function(t,e){this.loadData(new Uint8Array(t));var r=this.getCanvas();e.setImage(r,r.width,r.height),r.dataReady=!0,e.needsUpdate=!0},t.prototype.loadData=function(e){if(e.length<19)throw new Error("Targa::load() - Not enough data to contain header.");if(this.offset=0,this.header={id_length:e[this.offset++],colormap_type:e[this.offset++],image_type:e[this.offset++],colormap_index:e[this.offset++]|e[this.offset++]<<8,colormap_length:e[this.offset++]|e[this.offset++]<<8,colormap_size:e[this.offset++],origin:[e[this.offset++]|e[this.offset++]<<8,e[this.offset++]|e[this.offset++]<<8],width:e[this.offset++]|e[this.offset++]<<8,height:e[this.offset++]|e[this.offset++]<<8,pixel_size:e[this.offset++],flags:e[this.offset++]},this.checkHeader(),this.header.id_length+this.offset>e.length)throw new Error("Targa::load() - No data ?");switch(this.offset+=this.header.id_length,this.header.image_type){case t.TYPE_RLE_INDEXED:this.use_rle=!0;break;case t.TYPE_INDEXED:this.use_pal=!0;break;case t.TYPE_RLE_RGB:this.use_rle=!0;break;case t.TYPE_RGB:this.use_rgb=!0;break;case t.TYPE_RLE_GREY:this.use_rle=!0;break;case t.TYPE_GREY:this.use_grey=!0}this.parse(e)},t.prototype.checkHeader=function(){switch(this.header.image_type){case t.TYPE_INDEXED:case t.TYPE_RLE_INDEXED:if(this.header.colormap_length>256||24!==this.header.colormap_size||1!==this.header.colormap_type)throw new Error("Targa::checkHeader() - Invalid type colormap data for indexed type");break;case t.TYPE_RGB:case t.TYPE_GREY:case t.TYPE_RLE_RGB:case t.TYPE_RLE_GREY:if(this.header.colormap_type)throw new Error("Targa::checkHeader() - Invalid type colormap data for colormap type");break;case t.TYPE_NO_DATA:throw new Error("Targa::checkHeader() - No data on this TGA file");default:throw new Error("Targa::checkHeader() - Invalid type '"+this.header.image_type+"'")}if(this.header.width<=0||this.header.height<=0)throw new Error("Targa::checkHeader() - Invalid image size");if(8!==this.header.pixel_size&&16!==this.header.pixel_size&&24!==this.header.pixel_size&&32!==this.header.pixel_size)throw new Error("Targa::checkHeader() - Invalid pixel size '"+this.header.pixel_size+"'")},t.prototype.parse=function(t){var e,r,i,n,o;if(e=this.header,r=15&e.flags,n=e.pixel_size>>3,o=e.width*e.height*n,this.use_pal&&(this.palettes=t.subarray(this.offset,this.offset+=e.colormap_length*n)),this.use_rle){i=new Uint8Array(o);for(var a,s,h,d=0,l=new Uint8Array(n);o>d;)if(a=t[this.offset++],s=(127&a)+1,128&a){for(h=0;n>h;++h)l[h]=t[this.offset++];for(h=0;s>h;++h)i.set(l,d+h*n);d+=n*s}else{for(s*=n,h=0;s>h;++h)i[d+h]=t[this.offset++];d+=s}}else i=t.subarray(this.offset,this.offset+=this.use_pal?e.width*e.height:o);this.image=i},t.prototype.getImageData=function(e){var r,i,n,o,a,s,h,d,l=this.header.width,u=this.header.height;switch(d=e||{width:l,height:u,data:new Uint8Array(l*u*4)},(this.header.flags&t.ORIGIN_MASK)>>t.ORIGIN_SHIFT){default:case t.ORIGIN_UL:r=0,n=1,s=l,i=0,o=1,a=u;break;case t.ORIGIN_BL:r=0,n=1,s=l,i=u-1,o=-1,a=-1;break;case t.ORIGIN_UR:r=l-1,n=-1,s=-1,i=0,o=1,a=u;break;case t.ORIGIN_BR:r=l-1,n=-1,s=-1,i=u-1,o=-1,a=-1}return h="getImageData"+(this.use_grey?"Grey":"")+this.header.pixel_size+"bits",this[h](d.data,i,o,a,r,n,s),d},t.prototype.getCanvas=function(){var t=document.createElement("canvas"),e=t.getContext("2d"),r=e.createImageData(this.header.width,this.header.height);return t.width=this.header.width,t.height=this.header.height,e.putImageData(this.getImageData(r),0,0),t},t.prototype.getDataURL=function(t){return this.getCanvas().toDataURL(t||"image/png")},t.prototype.getImageData8bits=function(t,e,r,i,n,o,a){var s,h,d,l=this.image,u=this.palettes,c=this.header.width,p=0;for(d=e;d!==i;d+=r)for(h=n;h!==a;h+=o,p++)s=l[p],t[4*(h+c*d)+3]=255,t[4*(h+c*d)+2]=u[3*s+0],t[4*(h+c*d)+1]=u[3*s+1],t[4*(h+c*d)+0]=u[3*s+2];return t},t.prototype.getImageData16bits=function(t,e,r,i,n,o,a){var s,h,d,l=this.image,u=this.header.width,c=0;for(d=e;d!==i;d+=r)for(h=n;h!==a;h+=o,c+=2)s=l[c+0]+(l[c+1]<<8),t[4*(h+u*d)+0]=(31744&s)>>7,t[4*(h+u*d)+1]=(992&s)>>2,t[4*(h+u*d)+2]=(31&s)>>3,t[4*(h+u*d)+3]=32768&s?0:255;return t},t.prototype.getImageData24bits=function(t,e,r,i,n,o,a){var s,h,d=this.image,l=this.header.width,u=0;for(h=e;h!==i;h+=r)for(s=n;s!==a;s+=o,u+=3)t[4*(s+l*h)+3]=255,t[4*(s+l*h)+2]=d[u+0],t[4*(s+l*h)+1]=d[u+1],t[4*(s+l*h)+0]=d[u+2];return t},t.prototype.getImageData32bits=function(t,e,r,i,n,o,a){var s,h,d=this.image,l=this.header.width,u=0;for(h=e;h!==i;h+=r)for(s=n;s!==a;s+=o,u+=4)t[4*(s+l*h)+2]=d[u+0],t[4*(s+l*h)+1]=d[u+1],t[4*(s+l*h)+0]=d[u+2],t[4*(s+l*h)+3]=d[u+3];return t},t.prototype.getImageDataGrey8bits=function(t,e,r,i,n,o,a){var s,h,d,l=this.image,u=this.header.width,c=0;for(d=e;d!==i;d+=r)for(h=n;h!==a;h+=o,c++)s=l[c],t[4*(h+u*d)+0]=s,t[4*(h+u*d)+1]=s,t[4*(h+u*d)+2]=s,t[4*(h+u*d)+3]=255;return t},t.prototype.getImageDataGrey16bits=function(t,e,r,i,n,o,a){var s,h,d=this.image,l=this.header.width,u=0;for(h=e;h!==i;h+=r)for(s=n;s!==a;s+=o,u+=2)t[4*(s+l*h)+0]=d[u+0],t[4*(s+l*h)+1]=d[u+0],t[4*(s+l*h)+2]=d[u+0],t[4*(s+l*h)+3]=d[u+1];return t},t.prototype.isSupported=function(){return!0},t.prototype.toString=function(){return"TgaLoader"},t}),define("goo/util/CanvasUtils",["goo/util/PromiseUtil"],function(t){"use strict";function e(){}return e.loadCanvasFromPath=function(t,e){var r={};3===arguments.length&&(r=arguments[1],e=arguments[2]);
var i=new Image;i.onerror=function(){console.error("Failed to load svg!"),e()},i.src=t;var n=document.createElement("canvas"),o=n.getContext("2d");i.onload=function(){if(0===i.width&&0===i.height)return e();if(r.width=r.width?r.width:i.width,r.height=r.height?r.height:i.height,r.sourceX=r.sourceX?r.sourceX:0,r.sourceY=r.sourceY?r.sourceY:0,r.sourceWidth=r.sourceWidth?r.sourceWidth:i.width,r.sourceHeight=r.sourceHeight?r.sourceHeight:i.height,r.destX=r.destX?r.destX:0,r.destY=r.destY?r.destY:0,r.destWidth=r.destWidth?r.destWidth:r.width,r.destHeight=r.destHeight?r.destHeight:r.height,r.resizeToFit){var t=r.sourceWidth/r.sourceHeight;t>1?(r.destHeight=r.destWidth/t,r.destY=.5*(r.height-r.destHeight)):1>t&&(r.destWidth=r.destHeight*t,r.destX=.5*(r.width-r.destWidth))}n.width=r.width,n.height=r.height,o.drawImage(i,r.sourceX,r.sourceY,r.sourceWidth,r.sourceHeight,r.destX,r.destY,r.destWidth,r.destHeight),e(n)}},e.renderSvgToCanvas=function(t,r,i){var n=window.URL||window.webkitURL||window,o=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),a=n.createObjectURL(o);e.loadCanvasFromPath(a,r,i)},e.getMatrixFromCanvas=function(t){for(var e=t.getContext("2d"),r=function(r,i){return 0>r||r>t.width||0>i||i>t.height?0:e.getImageData(r,i,1,1).data[0]/255},i=[],n=0;n<t.width;n++){i.push([]);for(var o=0;o<t.height;o++)i[n].push(r(n,t.height-(o+1)))}return i},e.svgDataToImage=function(e){var r=window.URL||window.webkitURL||window,i=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),n=new Image;return n.src=r.createObjectURL(i),t.createPromise(function(t,e){n.onload=function(){t(n)},n.onerror=function(){e("Could not load SVG image.")}})},e}),define("goo/loaders/handlers/TextureHandler",["goo/loaders/handlers/ConfigHandler","goo/renderer/Texture","goo/loaders/dds/DdsLoader","goo/loaders/crunch/CrunchLoader","goo/loaders/tga/TgaLoader","goo/util/rsvp","goo/util/PromiseUtil","goo/renderer/Util","goo/util/ObjectUtil","goo/util/CanvasUtils","goo/util/StringUtil"],function(t,e,r,i,n,o,a,s,h,d,l){"use strict";function u(){t.apply(this,arguments)}return u.prototype=Object.create(t.prototype),u.prototype.constructor=u,t._registerClass("texture",u),u.minFilters=["NearestNeighborNoMipMaps","NearestNeighborNearestMipMap","NearestNeighborLinearMipMap","BilinearNoMipMaps","BilinearNearestMipMap","Trilinear"],u.magFilters=["NearestNeighbor","Bilinear"],u.loaders={dds:r,crn:i,tga:n},u.WHITE=new Uint8Array([255,255,255,255]),u.BLACK=new Uint8Array([0,0,0,255]),u.prototype._prepare=function(t){h.defaults(t,{wrapS:"Repeat",wrapT:"Repeat",magFilter:"Bilinear",minFilter:"Trilinear",anisotropy:1,offset:[0,0],repeat:[1,1],flipY:!0,lodBias:0,loop:!0})},u.prototype._remove=function(t){this._objects[t]&&this._objects[t].destroy&&this.world.gooRunner&&this._objects[t].destroy(this.world.gooRunner.renderer.context),delete this._objects[t]},u.prototype._create=function(){return new e},u.prototype._update=function(e,r,i){var n=this;return t.prototype._update.call(this,e,r,i).then(function(t){if(t){var e;t.wrapS=r.wrapS,t.wrapT=r.wrapT,-1!==u.magFilters.indexOf(r.magFilter)&&(t.magFilter=r.magFilter),-1!==u.minFilters.indexOf(r.minFilter)&&(t.minFilter=r.minFilter),t.anisotropy=Math.max(r.anisotropy,1),t.offset.set(r.offset),t.repeat.set(r.repeat),t.lodBias=r.lodBias,t.flipY!==r.flipY&&(t.flipY=r.flipY,t.setNeedsUpdate()),t.updateCallback=null;var o=r.imageRef;if(o){var c=l.parseURL(o).path,p=c.substr(c.lastIndexOf(".")+1).toLowerCase(),f=u.loaders[p];if(f)t.a=o,e=n.loadObject(o).then(function(e){if(e&&e.preloaded)return h.extend(t.image,e.image),t.format=e.format,t.setNeedsUpdate(),t;var i=new f;return i.load(e,t,r.flipY,0,e.byteLength),t});else if(-1!==["jpg","jpeg","png","gif"].indexOf(p))e=n.loadObject(o,i).then(function(e){return t.image!==e&&t.setImage(e),t});else{if(-1===["mp4","ogv","webm"].indexOf(p))throw new Error("Unknown texture type");e=n.loadObject(o,i).then(function(e){return e.width=e.videoWidth,e.height=e.videoHeight,e.loop=void 0!==r.loop?r.loop:!0,(s.isPowerOfTwo(e.width)===!1||s.isPowerOfTwo(e.height)===!1)&&(t.generateMipmaps=!1,t.minFilter="BilinearNoMipMaps"),t.setImage(e),t.updateCallback=function(){return!e.paused},(void 0===r.autoPlay||r.autoPlay)&&e.play(),t})}}else e=r.svgData?a.createPromise(function(e,i){d.renderSvgToCanvas(r.svgData,{},function(r){r?(t.setImage(r),e(t)):i("could not render svg to canvas")})}):t;return i&&i.texture&&i.texture.dontwait?t:e}})},u.prototype._remove=function(t){this._objects[t]&&this._objects[t].destroy&&this.world.gooRunner&&this._objects[t].destroy(this.world.gooRunner.renderer.context),delete this._objects[t]},u}),define("goo/sound/AudioContext",[],function(){"use strict";try{var t=window.AudioContext||window.webkitAudioContext;return new t}catch(e){console.warn("Web audio not supported")}}),define("goo/util/Ajax",["goo/loaders/handlers/TextureHandler","goo/sound/AudioContext","goo/util/PromiseUtil","goo/util/ObjectUtil","goo/util/StringUtil","goo/util/rsvp"],function(t,e,r,i,n,o){"use strict";function a(t,e){t&&(this._rootPath=t,"/"!==t.slice(-1)&&(this._rootPath+="/")),this.options=e||{},this._cache={}}function s(t,e){for(var r=0;r<e.length;r++)t[e[r]]=!0;return t}return a.prototype.prefill=function(t,e){e?this._cache=t:i.extend(this._cache,t)},a.prototype.clear=function(){this._cache={}},a.prototype.get=function(t){t=t||{};var e=t.url||"",i="GET",n=new XMLHttpRequest;return n.open(i,e,!0),t.responseType&&(n.responseType=t.responseType),r.createPromise(function(t,e){var r=function(){4===n.readyState&&(n.status>=200&&n.status<=299?(n.removeEventListener("readystatechange",r),t(n)):(n.removeEventListener("readystatechange",r),e(n.statusText)))};n.addEventListener("readystatechange",r),n.send()})},a.ARRAY_BUFFER="arraybuffer",a.crossOrigin=!1,a.prototype.load=function(t,e){function i(t,e){return t&&a.types[e]&&a.types[e][t]}var s=this,h=n.parseURL(t).path,d=h.substr(h.lastIndexOf(".")+1).toLowerCase();if(t||r.reject("Path was undefined"),0===t.indexOf(a.ENGINE_SHADER_PREFIX))return r.resolve();if(this._cache[t]&&!e)return i(d,"bundle")&&this.prefill(this._cache[t],e),this._cache[t]instanceof o.Promise?this._cache[t]:r.resolve(this._cache[t]);var l=this._rootPath?this._rootPath+t:t;if(i(d,"image"))return this._cache[t]=this._loadImage(l);if(i(d,"video")){var u={mp4:"video/mp4",ogv:"video/ogg",webm:"video/webm"};return this._cache[t]=this._loadVideo(l,u[d])}if(i(d,"audio"))return this._cache[t]=this._loadAudio(l);var c={url:l};return i(d,"binary")&&(c.responseType=a.ARRAY_BUFFER),this._cache[t]=this.get(c).then(function(t){if(i(d,"bundle")){var r=JSON.parse(t.response);return s.prefill(r,e),r}return i(d,"json")?JSON.parse(t.response):t.response}).then(null,function(e){throw new Error("Could not load data from "+t+", "+e)})},a.prototype.update=function(t,e){return this._cache[t]=e,r.resolve(e)},a.prototype._loadImage=function(t){window.URL=window.URL||window.webkitURL;var e=new Image;return a.crossOrigin&&(e.crossOrigin="anonymous"),r.createPromise(function(r,i){var n=function(){e.dataReady=!0,window.URL&&void 0!==window.URL.revokeObjectURL&&window.URL.revokeObjectURL(e.src),e.removeEventListener("load",n),e.removeEventListener("error",o),r(e)},o=function(r){e.removeEventListener("load",n),e.removeEventListener("error",o),i("Could not load image from "+t+", "+r)};e.addEventListener("load",n,!1),e.addEventListener("error",o,!1),e.src=t})},a.prototype._loadVideo=function(t,e){var i=document.createElement("video");a.crossOrigin&&(i.crossOrigin="anonymous");var n=r.createPromise(function(e,r){i.addEventListener("canplay",function(){i.dataReady=!0,e(i)},!1),i.addEventListener("onerror",function(e){r("Could not load video from "+t+", "+e)},!1)}),o={url:t,responseType:a.ARRAY_BUFFER};return this.get(o).then(function(t){var r=new Blob([t.response],{type:e}),n=window.URL.createObjectURL(r);i.src=n}),n},a.prototype._loadAudio=function(t){var e={url:t,responseType:a.ARRAY_BUFFER};return this.get(e).then(function(t){return t.response}).then(null,function(e){throw new Error("Could not load data from "+t+", "+e)})},a.ENGINE_SHADER_PREFIX="GOO_ENGINE_SHADERS/",a.types={text:{vert:!0,frag:!0},json:{shader:!0,script:!0,entity:!0,material:!0,scene:!0,mesh:!0,texture:!0,skeleton:!0,animation:!0,clip:!0,bundle:!0,project:!0,machine:!0,posteffects:!0,animstate:!0,sound:!0,environment:!0,skybox:!0},image:{jpg:!0,jpeg:!0,png:!0,gif:!0},video:{mp4:!0,ogv:!0,webm:!0},binary:s({dat:!0,bin:!0},Object.keys(t.loaders)),audio:{mp3:!0,wav:!0,ogg:!0},bundle:{bundle:!0}},a.types.asset=s({},Object.keys(a.types.image).concat(Object.keys(a.types.binary))),a}),define("goo/util/Latch",[],function(){"use strict";function t(t,e){this.count=t,this.callback=e}return t.prototype.countDown=function(){this.count--,this.isDone()&&this.callback&&this.callback.done?this.callback.done():this.callback&&this.callback.progress&&this.callback.progress(this.count)},t.prototype.isDone=function(){return 0===this.count},t}),define("goo/renderer/TextureCreator",["goo/renderer/Texture","goo/renderer/Util","goo/loaders/handlers/TextureHandler","goo/util/Ajax","goo/util/StringUtil","goo/util/Latch"],function(t,e,r,i,n,o){"use strict";function a(){var t=this.ajax=new i;this.textureHandler=new r({},function(e,r){return t.load(e,r?r.noCache:!1)},function(){},function(e,r){return t.load(e,r?r.noCache:!1)})}a.UNSUPPORTED_FALLBACK=".png",a.clearCache=function(){},a.prototype.clear=function(){this.ajax.clear(),this.textureHandler.clear()},a.prototype.loadTexture2D=function(t,e,r){var i=n.createUniqueId("texture");e=e||{},e.imageRef=t;var o=this.textureHandler._objects[i]=this.textureHandler._create();return this.textureHandler.update(i,e).then(function(){r&&r(o)}),o},a.prototype.loadTextureVideo=function(t,e,r,i){var o=n.createUniqueId("texture");r=r||{},r.imageRef=t,r.loop=e,r.wrapS="EdgeClamp",r.wrapT="EdgeClamp",r.autoPlay=!0;var a=this.textureHandler._objects[o]=this.textureHandler._create();return this.textureHandler.update(o,r,{texture:{dontwait:!0}}).then(null,function(t){i(t)}),a},a.prototype.loadTextureWebCam=function(){var r=document.createElement("video");r.autoplay=!0,r.loop=!0;var i=new t(r,{wrapS:"EdgeClamp",wrapT:"EdgeClamp"});return i.readyCallback=function(){return r.readyState>=3?(console.log("WebCam video ready: "+r.videoWidth+", "+r.videoHeight),r.width=r.videoWidth,r.height=r.videoHeight,(e.isPowerOfTwo(r.width)===!1||e.isPowerOfTwo(r.height)===!1)&&(i.generateMipmaps=!1,i.minFilter="BilinearNoMipMaps"),r.dataReady=!0,!0):!1},i.updateCallback=function(){return!r.paused},window.URL=window.URL||window.webkitURL,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia?navigator.getUserMedia({video:!0},function(t){r.src=window.URL.createObjectURL(t)},function(t){console.warn("Unable to capture WebCam. Please reload the page.",t)}):console.warn("No support for WebCam getUserMedia found!"),i},a.prototype.loadTextureCube=function(e,r,i){var n=new t(null,r);n.variant="CUBE";for(var a=[],s=new o(6,{done:function(){for(var t=a[0].width,e=a[0].height,r=0;6>r;r++){var o=a[r];(t!==o.width||e!==o.height)&&(n.generateMipmaps=!1,n.minFilter="BilinearNoMipMaps",console.error("Images not all the same size!"))}n.setImage(a),n.image.dataReady=!0,n.image.width=t,n.image.height=e,i&&i()}}),h=this,d=0;d<e.length;d++)!function(t){var r=e[t];"string"==typeof r?h.ajax._loadImage(r).then(function(e){a[t]=e,s.countDown()}):(a[t]=r,s.countDown())}(d);return n},a._globalCallback=null,a._finishedLoading=function(t){if(a._globalCallback)try{a._globalCallback(t)}catch(e){console.error("Error in texture callback:",e)}};var s=new Uint8Array([255,255,255,255]);return a.DEFAULT_TEXTURE_2D=new t(s,null,1,1),a.DEFAULT_TEXTURE_CUBE=new t([s,s,s,s,s,s],null,1,1),a.DEFAULT_TEXTURE_CUBE.variant="CUBE",a}),define("goo/renderer/pass/RenderTarget",["goo/math/Vector2"],function(t){"use strict";function e(e,r,i){this.glTexture=null,this._glRenderBuffer=null,this._glFrameBuffer=null,this.width=Math.floor(e),this.height=Math.floor(r),i=i||{},this.wrapS=void 0!==i.wrapS?i.wrapS:"EdgeClamp",this.wrapT=void 0!==i.wrapT?i.wrapT:"EdgeClamp",this.magFilter=void 0!==i.magFilter?i.magFilter:"Bilinear",this.minFilter=void 0!==i.minFilter?i.minFilter:"BilinearNoMipMaps",this.anisotropy=void 0!==i.anisotropy?i.anisotropy:1,this.format=void 0!==i.format?i.format:"RGBA",this.type=void 0!==i.type?i.type:"UnsignedByte",this.variant="2D",this.offset=new t(0,0),this.repeat=new t(1,1),this.generateMipmaps=void 0!==i.generateMipmaps?i.generateMipmaps:!1,this.premultiplyAlpha=void 0!==i.premultiplyAlpha?i.premultiplyAlpha:!1,this.unpackAlignment=void 0!==i.unpackAlignment?i.unpackAlignment:1,this.flipY=void 0!==i.flipY?i.flipY:!0,this.depthBuffer=void 0!==i.depthBuffer?i.depthBuffer:!0,this.stencilBuffer=void 0!==i.stencilBuffer?i.stencilBuffer:!0}return e.prototype.clone=function(){var t=new e(this.width,this.height);return t.wrapS=this.wrapS,t.wrapT=this.wrapT,t.magFilter=this.magFilter,t.minFilter=this.minFilter,t.anisotropy=this.anisotropy,t.format=this.format,t.type=this.type,t.variant=this.variant,t.offset.copy(this.offset),t.repeat.copy(this.repeat),t.generateMipmaps=this.generateMipmaps,t.premultiplyAlpha=this.premultiplyAlpha,t.unpackAlignment=this.unpackAlignment,t.flipY=this.flipY,t.depthBuffer=this.depthBuffer,t.stencilBuffer=this.stencilBuffer,t},e.prototype.getSizeInMemory=function(){var t=this.width*this.height*4;return this.generateMipmaps&&(t=Math.ceil(4*t/3)),t},e.prototype.destroy=function(t){this.glTexture&&(t.deleteTexture(this.glTexture),this.glTexture=null),this._glRenderBuffer&&(t.deleteRenderbuffer(this._glRenderBuffer),this._glRenderBuffer=null),this._glFrameBuffer&&(t.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null)},e}),define("goo/renderer/ShaderCall",[],function(){"use strict";function t(t,e,r){if(this.context=t,this.location=e,this.location.value=void 0,r)switch(r){case"float":this.call=this.uniform1f;break;case"bool":case"int":case"integer":case"sampler2D":case"sampler3D":case"samplerCube":this.call=this.uniform1i;break;case"floatarray":this.call=this.uniform1fv;break;case"intarray":case"samplerArray":this.call=this.uniform1iv;break;case"vec2":this.call=this.uniform2fv;break;case"vec3":this.call=this.uniform3fv;break;case"vec4":this.call=this.uniform4fv;break;case"mat2":this.call=this.uniformMatrix2fv;break;case"mat3":this.call=this.uniformMatrix3fv;break;case"mat4":this.call=this.uniformMatrix4fv;break;default:throw"Uniform type not handled: "+r}}function e(t,e,r){if(0>r)return!1;for(;r--;)if(t[r]!==e[r])return!1;return!0}function r(t,e){for(var r=t.length;r--;)if(t[r]!==e[r])return!1;return!0}return t.prototype.uniform1f=function(t){var e=this.location.value;e!==t&&(this.context.uniform1f(this.location,t),this.location.value=t)},t.prototype.uniform1fv=function(t){var e=this.location.value;void 0!==e&&r(t,e)||(this.context.uniform1fv(this.location,t),this.location.value=t.slice())},t.prototype.uniform1i=function(t){var e=this.location.value;e!==t&&(this.context.uniform1i(this.location,t),this.location.value=t)},t.prototype.uniform1iv=function(t){var e=this.location.value;void 0!==e&&r(t,e)||(this.context.uniform1iv(this.location,t),this.location.value=t.slice())},t.prototype.uniform2f=function(t,e){var r=this.location.value;(void 0===r||2!==r.length||r[0]!==t||r[1]!==e)&&(this.context.uniform2f(this.location,t,e),this.location.value=[t,e])},t.prototype.uniform2fv=function(t){var e=this.location.value;if(void 0!==e){if(r(t,e))return}else e=this.location.value=new Float64Array(t.length);this.context.uniform2fv(this.location,t);for(var i=t.length;i--;)e[i]=t[i]},t.prototype.uniform2i=function(t,e){var r=this.location.value;(void 0===r||2!==r.length||r[0]!==t||r[1]!==e)&&(this.context.uniform2i(this.location,t,e),this.location.value=[t,e])},t.prototype.uniform2iv=function(t){var e=this.location.value;void 0!==e&&r(t,e)||(this.context.uniform2iv(this.location,t),this.location.value=t.slice())},t.prototype.uniform3f=function(t,e,r){var i=this.location.value;if(void 0!==i){if(3===i.length&&i[0]===t&&i[1]===e&&i[2]===r)return}else i=this.location.value=[];this.context.uniform3f(this.location,t,e,r),i[0]=t,i[1]=e,i[2]=r},t.prototype.uniform3fv=function(t){var e=this.location.value;if(void 0!==e){if(r(t,e))return}else e=this.location.value=new Float64Array(t.length);this.context.uniform3fv(this.location,t);for(var i=t.length;i--;)e[i]=t[i]},t.prototype.uniform3i=function(t,e,r){var i=this.location.value;(void 0===i||3!==i.length||i[0]!==t||i[1]!==e||i[2]!==r)&&(this.context.uniform3i(this.location,t,e,r),this.location.value=[t,e,r])},t.prototype.uniform3iv=function(t){var e=this.location.value;void 0!==e&&r(t,e)||(this.context.uniform3iv(this.location,t),this.location.value=t.slice())},t.prototype.uniform4f=function(t,e,r,i){var n=this.location.value;(void 0===n||4!==n.length||n[0]!==t||n[1]!==e||n[2]!==r||n[3]!==i)&&(this.context.uniform4f(this.location,t,e,r,i),this.location.value=[t,e,r,i])},t.prototype.uniform4fv=function(t){var e=this.location.value;if(void 0!==e){if(r(t,e))return}else e=this.location.value=new Float64Array(t.length);this.context.uniform4fv(this.location,t);for(var i=t.length;i--;)e[i]=t[i]},t.prototype.uniform4i=function(t,e,r,i){var n=this.location.value;(void 0===n||4!==n.length||n[0]!==t||n[1]!==e||n[2]!==r||n[3]!==i)&&(this.context.uniform4i(this.location,t,e,r,i),this.location.value=[t,e,r,i])},t.prototype.uniform4iv=function(t){var e=this.location.value;void 0!==e&&r(t,e)||(this.context.uniform4iv(this.location,t),this.location.value=t.slice())},t.prototype.uniformMatrix2fv=function(t,r){if(r=r===!0,!t.data)return void this.context.uniformMatrix2fv(this.location,r,t);var i=this.location.value;if(void 0!==i){var n=e(i.data,t.data,4);if(n)return;i.copy(t)}else this.location.value=t.clone();this.context.uniformMatrix2fv(this.location,r,t.data)},t.prototype.uniformMatrix3fv=function(t,r){if(r=r===!0,!t.data)return void this.context.uniformMatrix3fv(this.location,r,t);var i=this.location.value;if(void 0!==i){var n=e(i.data,t.data,9);if(n)return;i.copy(t)}else this.location.value=t.clone();this.context.uniformMatrix3fv(this.location,r,t.data)},t.prototype.uniformMatrix4fv=function(t,i){if(i=i===!0,t.data){var n=this.location.value;if(void 0!==n){var o=e(n.data,t.data,16);if(o)return;n.copy(t)}else this.location.value=t.clone();this.context.uniformMatrix4fv(this.location,i,t.data)}else{var a=t,n=this.location.value;if(void 0!==n){if(r(a,n))return}else n=this.location.value=new Float64Array(a.length);this.context.uniformMatrix4fv(this.location,i,a);for(var s=a.length;s--;)n[s]=a[s]}},t}),define("goo/renderer/RenderQueue",["goo/math/Vector3"],function(t){"use strict";function e(){this.opaqueSorter=function(t,e){var r=t.meshRendererComponent.materials[0],i=e.meshRendererComponent.materials[0];if(null===r||null===i)return 0;if(r===i){var n=t.meshRendererComponent.worldBound,o=e.meshRendererComponent.worldBound;if(null===n||null===o)return 0;var a=t.meshRendererComponent._renderDistance,s=e.meshRendererComponent._renderDistance;return a-s}var h=r.shader,d=i.shader;if(null===h||null===d)return 0;if(h._id===d._id){var n=t.meshRendererComponent.worldBound,o=e.meshRendererComponent.worldBound;if(null===n||null===o)return 0;var a=t.meshRendererComponent._renderDistance,s=e.meshRendererComponent._renderDistance;return a-s}return h._id-d._id},this.transparentSorter=function(t,e){var r=t.meshRendererComponent._renderDistance,i=e.meshRendererComponent._renderDistance;return i-r},this.bucketSorter=function(t,e){return t-e}}var r=[],i=new t;return e.prototype.sort=function(t,n){var o=0;this.camera=n;var a={};r.length=0;for(var s=0;s<t.length;s++){var h=t[s],d=h.meshRendererComponent;if(d&&0!==d.materials.length){var l=d.materials[0].getRenderQueue(),u=0,c=d.worldBound;null!==c?u=i.setv(n.translation).subv(c.center).lengthSquared():h.transformComponent&&(u=i.setv(n.translation).subv(h.transformComponent.worldTransform.translation).lengthSquared()),d._renderDistance=u;var p=a[l];p||(p=[],a[l]=p,r.push(l)),p.push(h)}else t[o]=h,o++}r.length>1&&r.sort(this.bucketSorter);for(var f=0;f<r.length;f++){var m=r[f],p=a[m];m>=0&&p.sort(m<e.TRANSPARENT?this.opaqueSorter:this.transparentSorter);for(var s=0;s<p.length;s++)t[o]=p[s],o++}},e.BACKGROUND=0,e.OPAQUE=1e3,e.TRANSPARENT=2e3,e.OVERLAY=3e3,e}),define("goo/entities/SystemBus",["goo/entities/Bus"],function(t){"use strict";return new t}),define("goo/renderer/Shader",["goo/renderer/ShaderCall","goo/math/Matrix4x4","goo/entities/World","goo/renderer/RenderQueue","goo/renderer/Util","goo/entities/SystemBus"],function(t,e,r,i,n,o){"use strict";function a(t,e){if(!e.vshader||!e.fshader)throw new Error("Missing shader sources for shader: "+t);this.originalShaderDefinition=e,this.shaderDefinition=e,this.name=t,this.origVertexSource=e.vshader,this.origFragmentSource=e.fshader,this.vertexSource="function"==typeof this.origVertexSource?this.origVertexSource():this.origVertexSource,this.fragmentSource="function"==typeof this.origFragmentSource?this.origFragmentSource():this.origFragmentSource,this.shaderProgram=null,this.vertexShader=null,this.fragmentShader=null,this.renderer=null,this.attributeMapping={},this.attributeIndexMapping={},this.uniformMapping={},this.uniformCallMapping={},this.textureSlots=[],this.textureSlotsNaming={},this.currentCallbacks={},this.overridePrecision=e.precision||null,this.processors=e.processors,this.builder=e.builder,this.defines=e.defines,this.attributes=e.attributes||{},this.uniforms=e.uniforms||{},this.attributeKeys=null,this.uniformKeys=null,this.matchedUniforms=[],this.renderQueue=i.OPAQUE,this._id=a.id++,this.errorOnce=!1}function s(t){t[a.PROJECTION_MATRIX]=function(t,e){var r=e.camera.getProjectionMatrix();t.uniformMatrix4fv(r)},t[a.VIEW_MATRIX]=function(t,e){var r=e.camera.getViewMatrix();t.uniformMatrix4fv(r)},t[a.WORLD_MATRIX]=function(t,r){var i=void 0!==r.transform?r.transform.matrix:e.IDENTITY;t.uniformMatrix4fv(i)},t[a.NORMAL_MATRIX]=function(t,r){var i=void 0!==r.transform?r.transform.normalMatrix:e.IDENTITY;t.uniformMatrix4fv(i)},t[a.VIEW_INVERSE_MATRIX]=function(t,e){var r=e.camera.getViewInverseMatrix();t.uniformMatrix4fv(r)},t[a.VIEW_PROJECTION_MATRIX]=function(t,e){var r=e.camera.getViewProjectionMatrix();t.uniformMatrix4fv(r)},t[a.VIEW_PROJECTION_INVERSE_MATRIX]=function(t,e){var r=e.camera.getViewProjectionInverseMatrix();t.uniformMatrix4fv(r)};for(var i=0;16>i;i++)t[a["TEXTURE"+i]]=function(t){return function(e){e.uniform1i(t)}}(i);for(var i=0;8>i;i++)t[a["LIGHT"+i]]=function(t){return function(e,r){var i=r.lights[t];void 0!==i?e.uniform3f(i.translation.data[0],i.translation.data[1],i.translation.data[2]):e.uniform3f(-20,20,20)}}(i);t[a.LIGHTCOUNT]=function(t,e){t.uniform1i(e.lights.length)},t[a.CAMERA]=function(t,e){var r=e.camera.translation;t.uniform3f(r.data[0],r.data[1],r.data[2])},t[a.NEAR_PLANE]=function(t,e){t.uniform1f(e.camera.near)},t[a.FAR_PLANE]=function(t,e){t.uniform1f(e.camera.far)},t[a.MAIN_NEAR_PLANE]=function(t,e){t.uniform1f(e.mainCamera.near)},t[a.MAIN_FAR_PLANE]=function(t,e){t.uniform1f(e.mainCamera.far)},t[a.MAIN_DEPTH_SCALE]=function(t,e){t.uniform1f(1/(e.mainCamera.far-e.mainCamera.near))},t[a.AMBIENT]=function(t,e){var r=void 0!==e.material.materialState?e.material.materialState.ambient:a.DEFAULT_AMBIENT;t.uniform4fv(r)},t[a.EMISSIVE]=function(t,e){var r=void 0!==e.material.materialState?e.material.materialState.emissive:a.DEFAULT_EMISSIVE;t.uniform4fv(r)},t[a.DIFFUSE]=function(t,e){var r=void 0!==e.material.materialState?e.material.materialState.diffuse:a.DEFAULT_DIFFUSE;t.uniform4fv(r)},t[a.SPECULAR]=function(t,e){var r=void 0!==e.material.materialState?e.material.materialState.specular:a.DEFAULT_SPECULAR;t.uniform4fv(r)},t[a.SPECULAR_POWER]=function(t,e){var r=void 0!==e.material.materialState?e.material.materialState.shininess:a.DEFAULT_SHININESS;r=Math.max(r,1),t.uniform1f(r)},t[a.TIME]=function(t){t.uniform1f(r.time)},t[a.TPF]=function(t){t.uniform1f(r.tpf)},t[a.RESOLUTION]=function(t,e){t.uniform2f(e.renderer.viewportWidth,e.renderer.viewportHeight)}}var h=window.WebGLRenderingContext;a.id=0,a.prototype.clone=function(){return new a(this.name,n.clone({precision:this.precision,processors:this.processors,builder:this.builder,defines:this.defines,attributes:this.attributes,uniforms:this.uniforms,vshader:this.origVertexSource,fshader:this.origFragmentSource}))},a.prototype.cloneOriginal=function(){return new a(this.name,this.originalShaderDefinition)},a.prototype.precompile=function(t){null===this.shaderProgram&&(this._investigateShaders(),this.addDefines(this.defines),this.addPrecision(this.overridePrecision||t.shaderPrecision),this.compile(t))};var d=/\b(attribute|uniform)\s+(float|int|bool|vec2|vec3|vec4|mat3|mat4|sampler2D|sampler3D|samplerCube)\s+(\w+)(\s*\[\s*\w+\s*\])*;/g;a.prototype.apply=function(t,e){var r=e.context,i=e.rendererRecord;null===this.shaderProgram&&(this._investigateShaders(),this.addDefines(this.defines),this.addPrecision(this.overridePrecision||e.shaderPrecision),this.compile(e));var n=!1;if(i.usedProgram!==this.shaderProgram&&(r.useProgram(this.shaderProgram),i.usedProgram=this.shaderProgram,n=!0),i.newlyEnabledAttributes.length=0,this.attributes)for(var o=t.meshData.attributeMap,a=this.attributes,s=this.attributeKeys,h=0,d=s.length;d>h;h++){var l=s[h],u=o[a[l]];if(u){var c=this.attributeIndexMapping[l];void 0!==c&&(i.newlyEnabledAttributes[c]=!0,e.bindVertexAttribute(c,u))}}for(var h=0,d=i.enabledAttributes.length;d>h;h++){var p=i.enabledAttributes[h],f=i.newlyEnabledAttributes[h];!f&&p&&(e.context.disableVertexAttribArray(h),i.enabledAttributes[h]=!1)}for(var h=0,d=i.newlyEnabledAttributes.length;d>h;h++){var p=i.enabledAttributes[h],f=i.newlyEnabledAttributes[h];f&&!p&&(e.context.enableVertexAttribArray(h),i.enabledAttributes[h]=!0)}if(this.matchedUniforms){this.textureIndex=0;for(var h=0,d=this.matchedUniforms.length;d>h;h++)this._bindUniform(this.matchedUniforms[h],t)}},a.prototype._bindUniform=function(t,e){var r=this.uniformCallMapping[t];if(void 0!==r){var i=e.material.uniforms[t];void 0===i&&(i=this.uniforms[t]);var n=typeof i;if("string"===n){var o=this.currentCallbacks[t];if(o)o(r,e);else{var a=this.textureSlotsNaming[t];if(void 0!==a){var s=e.material.getTexture(a.mapping);if(s instanceof Array){var h=[];a.index=[];for(var d=0;d<s.length;d++)a.index.push(this.textureIndex),h.push(this.textureIndex++);r.call(h)}else a.index=this.textureIndex,r.call(this.textureIndex++)}}}else{var l="function"===n?i(e):i;r.call(l)}}},a.prototype.rebuild=function(){this.shaderProgram=null,this.attributeMapping={},this.attributeIndexMapping={},this.uniformMapping={},this.uniformCallMapping={},this.currentCallbacks={},this.attributeKeys=null,this.uniformKeys=null,this.vertexSource="function"==typeof this.origVertexSource?this.origVertexSource():this.origVertexSource,this.fragmentSource="function"==typeof this.origFragmentSource?this.origFragmentSource():this.origFragmentSource},a.prototype._investigateShaders=function(){this.textureSlots=[],this.textureSlotsNaming={},a.investigateShader(this.vertexSource,this),a.investigateShader(this.fragmentSource,this)},a.investigateShader=function(t,e){d.lastIndex=0;for(var r=d.exec(t);null!==r;){var i={format:r[2]},n=r[1],o=r[3],a=r[4];if(a&&("float"===i.format?i.format="floatarray":"int"===i.format?i.format="intarray":0===i.format.indexOf("sampler")&&(i.format="samplerArray")),"attribute"===n)e.attributeMapping[o]=i;else{if(0===i.format.indexOf("sampler")){var s={format:i.format,name:o,mapping:e.uniforms[o],index:e.textureSlots.length};e.textureSlots.push(s),e.textureSlotsNaming[s.name]=s}e.uniformMapping[o]=i}r=d.exec(t)}},a.prototype.compile=function(e){var r=e.context;this.renderer=e,this.vertexShader=this._getShader(r,h.VERTEX_SHADER,this.vertexSource),this.fragmentShader=this._getShader(r,h.FRAGMENT_SHADER,this.fragmentSource),(null===this.vertexShader||null===this.fragmentShader)&&console.error("Shader error - no shaders"),this.shaderProgram=r.createProgram();var i=r.getError();if((null===this.shaderProgram||i!==h.NO_ERROR)&&(console.error("Shader error: "+i+" [shader: "+this.name+"]"),o.emit("goo.shader.error")),r.attachShader(this.shaderProgram,this.vertexShader),r.attachShader(this.shaderProgram,this.fragmentShader),r.linkProgram(this.shaderProgram),!r.getProgramParameter(this.shaderProgram,h.LINK_STATUS)){var n=r.getProgramInfoLog(this.shaderProgram);console.error("Could not initialise shaders: "+n),o.emit("goo.shader.error",n)}for(var a in this.attributeMapping){var s=r.getAttribLocation(this.shaderProgram,a);-1!==s&&(this.attributeIndexMapping[a]=s)}for(var a in this.uniformMapping){var d=r.getUniformLocation(this.shaderProgram,a);if(null!==d)this.uniformCallMapping[a]=new t(r,d,this.uniformMapping[a].format);else for(var l=this.textureSlots.length,u=0;l>u;u++){var c=this.textureSlots[u];if(c.name===a){for(this.textureSlots.splice(u,1),delete this.textureSlotsNaming[c.name];l-1>u;u++)this.textureSlots[u].index--;break}}}if(this.attributes&&(this.attributeKeys=Object.keys(this.attributes)),this.uniforms){if(this.uniforms.$link){for(var p=this.uniforms.$link instanceof Array?this.uniforms.$link:[this.uniforms.$link],u=0;u<p.length;u++){var f=p[u];for(var a in f)this.uniforms[a]=f[a]}delete this.uniforms.$link}this.matchedUniforms=[];for(var m in this.uniforms){var g=this.uniformCallMapping[m];void 0!==g&&this.matchedUniforms.push(m);var v=this.uniforms[m];this.defaultCallbacks[v]&&(this.currentCallbacks[m]=this.defaultCallbacks[v])}this.uniformKeys=Object.keys(this.uniforms)}};var l=/\b\d+:(\d+):\s(.+)\b/g,u=/\((\d+),\s*\d+\):\s(.+)/g;a.prototype._getShader=function(t,e,r){var i=t.createShader(e);if(t.shaderSource(i,r),t.compileShader(i),!t.getShaderParameter(i,h.COMPILE_STATUS)){var n=t.getShaderInfoLog(i),o=e===h.VERTEX_SHADER?"VertexShader":"FragmentShader";l.lastIndex=0;var a=l.exec(n);if(null===a&&(a=u.exec(n)),null!==a)for(;null!==a;){var s=r.split("\n"),d=a[1],c=a[2];console.error("Error in "+o+" - ["+this.name+"]["+this._id+"] at line "+d+":"),console.error("	Error: "+c),console.error("	Source: "+s[d-1]),a=l.exec(n)}else console.error("Error in "+o+" - ["+this.name+"]["+this._id+"] "+n);return null}return i};var c=/\bprecision\s+(lowp|mediump|highp)\s+(float|int);/g;a.prototype.addPrecision=function(t){c.lastIndex=0;var e=c.exec(this.vertexSource);null===e&&(this.vertexSource="precision "+t+" float;\n"+this.vertexSource),c.lastIndex=0;var r=c.exec(this.fragmentSource);null===r&&(this.fragmentSource="precision "+t+" float;\n"+this.fragmentSource)},a.prototype.addDefines=function(t){if(t){var e=this.generateDefines(t);this.vertexSource=e+"\n"+this.vertexSource,this.fragmentSource=e+"\n"+this.fragmentSource}},a.prototype.generateDefines=function(t){var e=[];for(var r in t){var i=t[r];if(i!==!1){var n="#define "+r+" "+i;e.push(n)}}return e.join("\n")},a.prototype.getShaderDefinition=function(){return{vshader:this.vertexSource,fshader:this.fragmentSource,defines:this.defines,attributes:this.attributes,uniforms:this.uniforms}},a.prototype.destroy=function(){this.shaderProgram&&(this.renderer.context.deleteProgram(this.shaderProgram),this.shaderProgram=null),this.vertexShader&&(this.renderer.context.deleteShader(this.vertexShader),this.vertexShader=null),this.fragmentShader&&(this.renderer.context.deleteShader(this.fragmentShader),this.fragmentShader=null),this.renderer=null},a.prototype.toString=function(){return this.name},a.PROJECTION_MATRIX="PROJECTION_MATRIX",a.VIEW_MATRIX="VIEW_MATRIX",a.VIEW_INVERSE_MATRIX="VIEW_INVERSE_MATRIX",a.VIEW_PROJECTION_MATRIX="VIEW_PROJECTION_MATRIX",a.VIEW_PROJECTION_INVERSE_MATRIX="VIEW_PROJECTION_INVERSE_MATRIX",a.WORLD_MATRIX="WORLD_MATRIX",a.NORMAL_MATRIX="NORMAL_MATRIX";for(var p=0;8>p;p++)a["LIGHT"+p]="LIGHT"+p;return a.CAMERA="CAMERA",a.AMBIENT="AMBIENT",a.EMISSIVE="EMISSIVE",a.DIFFUSE="DIFFUSE",a.SPECULAR="SPECULAR",a.SPECULAR_POWER="SPECULAR_POWER",a.NEAR_PLANE="NEAR_PLANE",a.FAR_PLANE="FAR_PLANE",a.MAIN_NEAR_PLANE="NEAR_PLANE",a.MAIN_FAR_PLANE="FAR_PLANE",a.MAIN_DEPTH_SCALE="DEPTH_SCALE",a.TIME="TIME",a.TPF="TPF",a.RESOLUTION="RESOLUTION",a.DIFFUSE_MAP="DIFFUSE_MAP",a.NORMAL_MAP="NORMAL_MAP",a.SPECULAR_MAP="SPECULAR_MAP",a.LIGHT_MAP="LIGHT_MAP",a.SHADOW_MAP="SHADOW_MAP",a.AO_MAP="AO_MAP",a.EMISSIVE_MAP="EMISSIVE_MAP",a.DEPTH_MAP="DEPTH_MAP",a.DEFAULT_AMBIENT=[.1,.1,.1,1],a.DEFAULT_EMISSIVE=[0,0,0,0],a.DEFAULT_DIFFUSE=[.8,.8,.8,1],a.DEFAULT_SPECULAR=[.6,.6,.6,1],a.DEFAULT_SHININESS=64,a.prototype.defaultCallbacks={},s(a.prototype.defaultCallbacks),a
}),define("goo/renderer/Material",["goo/renderer/Shader"],function(t){"use strict";function e(){this.id=null,this.name="Default Material",this.shader=null,"string"==typeof arguments[0]?this.name=arguments[0]:arguments[0]&&arguments[0].vshader&&arguments[0].fshader&&(this.shader=e.createShader(arguments[0])),arguments[1]&&arguments[1].vshader&&arguments[1].fshader?this.shader=e.createShader(arguments[1]):"string"==typeof arguments[1]&&(this.name=arguments[1]),this.uniforms={},this._textureMaps={},this.cullState={enabled:!0,cullFace:"Back",frontFace:"CCW"},this.blendState={blending:"NoBlending",blendEquation:"AddEquation",blendSrc:"SrcAlphaFactor",blendDst:"OneMinusSrcAlphaFactor"},this.depthState={enabled:!0,write:!0},this.offsetState={enabled:!1,factor:1,units:1},this.dualTransparency=!1,this.wireframe=!1,this.flat=!1,this.renderQueue=null}return e.prototype.setTexture=function(t,e){this._textureMaps[t]=e},e.prototype.getTexture=function(t){return this._textureMaps[t]},e.prototype.removeTexture=function(t){delete this._textureMaps[t]},e.prototype.getTextures=function(){var t=[];for(var e in this._textureMaps)t.push(this._textureMaps[e]);return t},e.prototype.getTextureEntries=function(){return this._textureMaps},e.prototype.getRenderQueue=function(){return null!==this.renderQueue?this.renderQueue:null!==this.shader?this.shader.renderQueue:1e3},e.prototype.setRenderQueue=function(t){this.renderQueue=t},e.store=[],e.hash=[],e.createShader=function(r,i){var n=e.store.indexOf(r);if(-1!==n)return e.hash[n];var o=new t(i||null,r);return null===o.name&&(o.name="DefaultShader"+o._id),e.store.push(r),e.hash.push(o),o},e.clearShaderCache=function(){e.store.length=0,e.hash.length=0},e.createEmptyMaterial=function(t,r){var i=new e(r||"Empty Material");return i.empty(),i.shader=t?e.createShader(t):void 0,i},e.prototype.empty=function(){this.cullState={},this.blendState={},this.depthState={},this.offsetState={},this.wireframe=void 0,this.renderQueue=void 0,this.flat=void 0,this._textureMaps={},this.shader=void 0,this.uniforms={}},e}),define("goo/renderer/shaders/ShaderFragment",[],function(){"use strict";function t(){}return t.noisecommon=["vec4 mod289(vec4 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec3 mod289(vec3 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec2 mod289(vec2 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec3 permute(vec3 x) {","  return mod289(((x*34.0)+1.0)*x);","}","vec4 permute(vec4 x) {","  return mod289(((x*34.0)+1.0)*x);","}"].join("\n"),t.noise2d=[t.noisecommon,"float snoise(vec2 v)","  {","  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0","                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)","                     -0.577350269189626,  // -1.0 + 2.0 * C.x","                      0.024390243902439); // 1.0 / 41.0","  vec2 i  = floor(v + dot(v, C.yy) );","  vec2 x0 = v -   i + dot(i, C.xx);","  vec2 i1;","  //i1.x = step( x0.y, x0.x ); // x0.x > x0.y ? 1.0 : 0.0","  //i1.y = 1.0 - i1.x;","  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);","  // x0 = x0 - 0.0 + 0.0 * C.xx ;","  // x1 = x0 - i1 + 1.0 * C.xx ;","  // x2 = x0 - 1.0 + 2.0 * C.xx ;","  vec4 x12 = x0.xyxy + C.xxzz;","  x12.xy -= i1;","  i = mod289(i); // Avoid truncation effects in permutation","  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))","		+ i.x + vec3(0.0, i1.x, 1.0 ));","  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);","  m = m*m ;","  m = m*m ;","  vec3 x = 2.0 * fract(p * C.www) - 1.0;","  vec3 h = abs(x) - 0.5;","  vec3 ox = floor(x + 0.5);","  vec3 a0 = x - ox;","  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );","  vec3 g;","  g.x  = a0.x  * x0.x  + h.x  * x0.y;","  g.yz = a0.yz * x12.xz + h.yz * x12.yw;","  return 130.0 * dot(m, g);","}"].join("\n"),t.noise3d=[t.noisecommon,"vec4 taylorInvSqrt(vec4 r) {","	return 1.79284291400159 - 0.85373472095314 * r;","}","float snoise(vec3 v) {","	const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;","	const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);","	vec3 i  = floor(v + dot(v, C.yyy) );","	vec3 x0 =   v - i + dot(i, C.xxx) ;","	vec3 g = step(x0.yzx, x0.xyz);","	vec3 l = 1.0 - g;","	vec3 i1 = min( g.xyz, l.zxy );","	vec3 i2 = max( g.xyz, l.zxy );","	vec3 x1 = x0 - i1 + C.xxx;","	vec3 x2 = x0 - i2 + C.yyy; // 2.0*C.x = 1/3 = C.y","	vec3 x3 = x0 - D.yyy;      // -1.0+3.0*C.x = -0.5 = -D.y","	i = mod289(i); ","	vec4 p = permute( permute( permute( ","         i.z + vec4(0.0, i1.z, i2.z, 1.0 ))","       + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) ","       + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));","	float n_ = 0.142857142857; // 1.0/7.0","	vec3  ns = n_ * D.wyz - D.xzx;","	vec4 j = p - 49.0 * floor(p * ns.z * ns.z);  //  mod(p,7*7)","	vec4 x_ = floor(j * ns.z);","	vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)","	vec4 x = x_ *ns.x + ns.yyyy;","	vec4 y = y_ *ns.x + ns.yyyy;","	vec4 h = 1.0 - abs(x) - abs(y);","	vec4 b0 = vec4( x.xy, y.xy );","	vec4 b1 = vec4( x.zw, y.zw );","	vec4 s0 = floor(b0)*2.0 + 1.0;","	vec4 s1 = floor(b1)*2.0 + 1.0;","	vec4 sh = -step(h, vec4(0.0));","	vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;","	vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;","	vec3 p0 = vec3(a0.xy,h.x);","	vec3 p1 = vec3(a0.zw,h.y);","	vec3 p2 = vec3(a1.xy,h.z);","	vec3 p3 = vec3(a1.zw,h.w);","	vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));","	p0 *= norm.x;","	p1 *= norm.y;","	p2 *= norm.z;","	p3 *= norm.w;","	vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);","	m = m * m;","	return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) ) );","}"].join("\n"),t.methods={packDepth:["vec4 packDepth( const in float depth ) {","	const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","	const vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","	vec4 res = fract( depth * bit_shift );","	res -= res.xxyz * bit_mask;","	return res;","}"].join("\n"),unpackDepth:["float unpackDepth( const in vec4 rgba_depth ) {","	const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","	float depth = dot( rgba_depth, bit_shift );","	return depth;","}"].join("\n"),packDepth16:["vec2 packDepth16( const in float depth ) {","	const vec2 bias = vec2(1.0 / 255.0, 0.0);","	vec2 res = vec2(depth, fract(depth * 255.0));","	return res - (res.yy * bias);","}"].join("\n"),unpackDepth16:["float unpackDepth16( const in vec2 rg_depth ) {","	return rg_depth.x + (rg_depth.y / 255.0);","}"].join("\n"),hsv:["vec3 rgb2hsv(vec3 c) {","vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);","vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));","vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));","float d = q.x - min(q.w, q.y);","float e = 1.0e-10;","return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);","}","vec3 hsv2rgb(vec3 c){","vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);","vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);","return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}"].join("\n")},t.blendmodes=["#define BlendLinearDodgef				BlendAddf","#define BlendLinearBurnf				BlendSubstractf","#define BlendAddf(base, blend)			min(base + blend, 1.0)","#define BlendSubstractf(base, blend)	max(base + blend - 1.0, 0.0)","#define BlendLightenf(base, blend)		max(blend, base)","#define BlendDarkenf(base, blend)		min(blend, base)","#define BlendLinearLightf(base, blend)	(blend < 0.5 ? BlendLinearBurnf(base, (2.0 * blend)) : BlendLinearDodgef(base, (2.0 * (blend - 0.5))))","#define BlendScreenf(base, blend)		(1.0 - ((1.0 - base) * (1.0 - blend)))","#define BlendOverlayf(base, blend)		(base < 0.5 ? (2.0 * base * blend) : (1.0 - 2.0 * (1.0 - base) * (1.0 - blend)))","#define BlendSoftLightf(base, blend)	((blend < 0.5) ? (2.0 * base * blend + base * base * (1.0 - 2.0 * blend)) : (sqrt(base) * (2.0 * blend - 1.0) + 2.0 * base * (1.0 - blend)))","#define BlendColorDodgef(base, blend)	((blend == 1.0) ? blend : min(base / (1.0 - blend), 1.0))","#define BlendColorBurnf(base, blend)	((blend == 0.0) ? blend : max((1.0 - ((1.0 - base) / blend)), 0.0))","#define BlendVividLightf(base, blend)	((blend < 0.5) ? BlendColorBurnf(base, (2.0 * blend)) : BlendColorDodgef(base, (2.0 * (blend - 0.5))))","#define BlendPinLightf(base, blend)	((blend < 0.5) ? BlendDarkenf(base, (2.0 * blend)) : BlendLightenf(base, (2.0 *(blend - 0.5))))","#define BlendHardMixf(base, blend)		((BlendVividLightf(base, blend) < 0.5) ? 0.0 : 1.0)","#define BlendReflectf(base, blend)		((blend == 1.0) ? blend : min(base * base / (1.0 - blend), 1.0))","#define Blend(base, blend, funcf)		vec3(funcf(base.r, blend.r), funcf(base.g, blend.g), funcf(base.b, blend.b))","#define BlendNormal(base, blend)		(blend)","#define BlendLighten					BlendLightenf","#define BlendDarken					BlendDarkenf","#define BlendMultiply(base, blend)		(base * blend)","#define BlendAverage(base, blend)		((base + blend) / 2.0)","#define BlendAdd(base, blend)			min(base + blend, vec3(1.0))","#define BlendSubstract(base, blend)	max(base + blend - vec3(1.0), vec3(0.0))","#define BlendDifference(base, blend)	abs(base - blend)","#define BlendNegation(base, blend)		(vec3(1.0) - abs(vec3(1.0) - base - blend))","#define BlendExclusion(base, blend)	(base + blend - 2.0 * base * blend)","#define BlendScreen(base, blend)		Blend(base, blend, BlendScreenf)","#define BlendOverlay(base, blend)		Blend(base, blend, BlendOverlayf)","#define BlendSoftLight(base, blend)	Blend(base, blend, BlendSoftLightf)","#define BlendHardLight(base, blend)	BlendOverlay(blend, base)","#define BlendColorDodge(base, blend)	Blend(base, blend, BlendColorDodgef)","#define BlendColorBurn(base, blend)	Blend(base, blend, BlendColorBurnf)","#define BlendLinearDodge				BlendAdd","#define BlendLinearBurn				BlendSubstract","#define BlendLinearLight(base, blend)	Blend(base, blend, BlendLinearLightf)","#define BlendVividLight(base, blend)	Blend(base, blend, BlendVividLightf)","#define BlendPinLight(base, blend)		Blend(base, blend, BlendPinLightf)","#define BlendHardMix(base, blend)		Blend(base, blend, BlendHardMixf)","#define BlendReflect(base, blend)		Blend(base, blend, BlendReflectf)","#define BlendGlow(base, blend)			BlendReflect(blend, base)","#define BlendPhoenix(base, blend)		(min(base, blend) - max(base, blend) + vec3(1.0))","#define GammaCorrection(color, gamma)											pow(color, vec3(1.0 / gamma))","#define LevelsControlInputRange(color, minInput, maxInput)						min(max(color - vec3(minInput), vec3(0.0)) / (vec3(maxInput) - vec3(minInput)), vec3(1.0))","#define LevelsControlInput(color, minInput, gamma, maxInput)					GammaCorrection(LevelsControlInputRange(color, minInput, maxInput), gamma)","#define LevelsControlOutputRange(color, minOutput, maxOutput)					mix(vec3(minOutput), vec3(maxOutput), color)","#define LevelsControl(color, minInput, gamma, maxInput, minOutput, maxOutput)	LevelsControlOutputRange(LevelsControlInput(color, minInput, gamma, maxInput), minOutput, maxOutput)"].join("\n"),t}),define("goo/renderer/light/Light",["goo/math/Vector3"],function(t){"use strict";function e(e){this.translation=new t,this.color=e||new t(1,1,1),this.intensity=1,this.specularIntensity=1,this.shadowCaster=!1,this.lightCookie=null,this.shadowSettings={size:100,near:1,far:1e3,resolution:[512,512],upVector:t.UNIT_Y,darkness:1,shadowType:"VSM"},this.changedProperties=!1,this.changedColor=!1}return e.prototype.destroy=function(t){var e=this.shadowSettings;e.shadowData&&(e.shadowData.shadowTarget&&e.shadowData.shadowTarget.destroy(t.context),e.shadowData.shadowTargetDown&&e.shadowData.shadowTargetDown.destroy(t.context),e.shadowData.shadowBlurred&&e.shadowData.shadowBlurred.destroy(t.context)),delete e.shadowData},e}),define("goo/renderer/light/PointLight",["goo/renderer/light/Light"],function(t){"use strict";function e(e){t.call(this,e),this.range=1e3}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.update=function(t){t.matrix.getTranslation(this.translation)},e}),define("goo/renderer/light/DirectionalLight",["goo/math/Vector3","goo/renderer/light/Light"],function(t,e){"use strict";function r(r){e.call(this,r),this.direction=new t}return r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype.update=function(t){t.matrix.getTranslation(this.translation),this.direction.setd(0,0,-1),t.matrix.applyPostVector(this.direction)},r}),define("goo/renderer/light/SpotLight",["goo/math/Vector3","goo/renderer/light/Light"],function(t,e){"use strict";function r(r){e.call(this,r),this.direction=new t,this.range=1e3,this.angle=45,this.penumbra=null,this.exponent=16}return r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype.update=function(t){t.matrix.getTranslation(this.translation),this.direction.setd(0,0,-1),t.matrix.applyPostVector(this.direction)},r}),define("goo/util/TangentGenerator",["goo/math/Vector2","goo/math/Vector3","goo/renderer/MeshData"],function(t,e,r){"use strict";function i(){}return i.addTangentBuffer=function(i,n){function o(e){for(var r=[],i=0;i<e.length;i+=2)r.push(new t(e[i+0],e[i+1]));return r}function a(t){for(var r=[],i=0;i<t.length;i+=3)r.push(new e(t[i+0],t[i+1],t[i+2]));return r}n=n||0;var s=i.getAttributeBuffer(r.POSITION);if(s){var h=i.getAttributeBuffer(r.NORMAL);if(h){var d=i.getAttributeBuffer("TEXCOORD"+n);if(d||0===n||(d=i.getAttributeBuffer(r.TEXCOORD0)),d){var l=i.getIndexBuffer();if(l){for(var u=i.vertexCount,c=i.indexCount/3,p=[],f=[],m=0;u>m;m++)p[m]=new e,f[m]=new e;for(var g=a(s),v=a(h),y=o(d),x=0;c>x;x++){var _=l[3*x],w=l[3*x+1],b=l[3*x+2],S=g[_],E=g[w],C=g[b],M=y[_],T=y[w],P=y[b],R=E.x-S.x,A=C.x-S.x,D=E.y-S.y,I=C.y-S.y,O=E.z-S.z,L=C.z-S.z,N=T.x-M.x,B=P.x-M.x,F=T.y-M.y,k=P.y-M.y,U=1/(N*k-B*F);if(isFinite(U)!==!1){var z=new e((k*R-F*A)*U,(k*D-F*I)*U,(k*O-F*L)*U),V=new e((N*A-B*R)*U,(N*I-B*D)*U,(N*L-B*O)*U);p[_].add(z),p[w].add(z),p[b].add(z),f[_].add(V),f[w].add(V),f[b].add(V)}}i.attributeMap[r.TANGENT]=r.createAttribute(4,"Float"),i.rebuildData(i.vertexCount,i.indexCount,!0);for(var j=i.getAttributeBuffer(r.TANGENT),H=new e,G=new e,x=0;u>x;x++){var X=v[x],W=p[x],Y=X.dot(W);H.copy(W).sub(G.copy(X).mul(Y)).normalize(),j[4*x+0]=H.x,j[4*x+1]=H.y,j[4*x+2]=H.z,Y=H.copy(X).cross(W).dot(f[x]);var q=0>Y?-1:1;j[4*x+3]=q}return j}}}}},i}),define("goo/renderer/shaders/ShaderBuilder",["goo/renderer/MeshData","goo/renderer/light/PointLight","goo/renderer/light/DirectionalLight","goo/renderer/light/SpotLight","goo/renderer/Texture","goo/math/MathUtils","goo/util/TangentGenerator"],function(t,e,r,i,n,o,a){"use strict";function s(){}var h=new r;h.translation.setd(10,10,10),h.direction.setd(1,1,1).normalize(),s.defaultLight=h,s.SKYBOX=null,s.SKYSPHERE=null,s.ENVIRONMENT_TYPE=0,s.GLOBAL_AMBIENT=[0,0,0],s.CLEAR_COLOR=[.3,.3,.3,1],s.USE_FOG=!1,s.FOG_SETTINGS=[0,1e4],s.FOG_COLOR=[1,1,1],s.uber={processor:function(e,r){var i=r.meshData.attributeMap,n=r.material,o=n._textureMaps;e.defines=e.defines||{},e.uniforms.clearColor=s.CLEAR_COLOR,n.uniforms.reflectivity||n.uniforms.refractivity?e.defines.REFLECTIVE=!0:void 0!==e.defines.REFLECTIVE&&delete e.defines.REFLECTIVE,s.SKYBOX&&(n.uniforms.reflectivity||n.uniforms.refractivity)?n.setTexture("ENVIRONMENT_CUBE",s.SKYBOX):n.getTexture("ENVIRONMENT_CUBE")&&n.removeTexture("ENVIRONMENT_CUBE"),s.SKYSPHERE&&(n.uniforms.reflectivity||n.uniforms.refractivity)?(n.setTexture("ENVIRONMENT_SPHERE",s.SKYSPHERE),e.defines.ENVIRONMENT_TYPE=s.ENVIRONMENT_TYPE):n.getTexture("ENVIRONMENT_SPHERE")&&n.removeTexture("ENVIRONMENT_SPHERE");for(var h=Object.keys(i),d=0,l=h.length;l>d;d++){var u=h[d];e.defines[u]||(e.defines[u]=!0)}for(var h=Object.keys(o),d=0,l=h.length;l>d;d++){var c=h[d];void 0!==o[c]&&null!==o[c]&&"SHADOW_MAP"!==c&&(e.defines[c]||(e.defines[c]=!0))}if(e.uniforms.offsetRepeat=e.uniforms.offsetRepeat||[0,0,1,1],o.DIFFUSE_MAP){var p=o.DIFFUSE_MAP.offset,f=o.DIFFUSE_MAP.repeat;e.uniforms.offsetRepeat[0]=p.data[0],e.uniforms.offsetRepeat[1]=p.data[1],e.uniforms.offsetRepeat[2]=f.data[0],e.uniforms.offsetRepeat[3]=f.data[1],e.uniforms.lodBias=o.DIFFUSE_MAP.lodBias}else e.uniforms.offsetRepeat[0]=0,e.uniforms.offsetRepeat[1]=0,e.uniforms.offsetRepeat[2]=1,e.uniforms.offsetRepeat[3]=1,e.uniforms.lodBias=0;for(var h=Object.keys(e.defines),d=0,l=h.length;l>d;d++){var u=h[d];"MAX_POINT_LIGHTS"!==u&&"MAX_DIRECTIONAL_LIGHTS"!==u&&"MAX_SPOT_LIGHTS"!==u&&"SHADOW_TYPE"!==u&&"JOINT_COUNT"!==u&&"WEIGHTS"!==u&&"PHYSICALLY_BASED_SHADING"!==u&&"ENVIRONMENT_TYPE"!==u&&"REFLECTIVE"!==u&&"DISCARD"!==u&&"FOG"!==u&&"REFLECTION_TYPE"!==u&&"SKIP_SPECULAR"!==u&&"WRAP_AROUND"!==u&&(i[u]||o[u]||delete e.defines[u])}n.uniforms.discardThreshold>=0?e.defines.DISCARD=!0:void 0!==e.defines.DISCARD&&delete e.defines.DISCARD,s.USE_FOG?(e.defines.FOG=!0,e.uniforms.fogSettings=s.FOG_SETTINGS,e.uniforms.fogColor=s.FOG_COLOR):void 0!==e.defines.FOG&&delete e.defines.FOG,n.multiplyAmbient&&(e.defines.MULTIPLY_AMBIENT=!0),e.defines.SKIP_SPECULAR=!0,e.defines.REFLECTION_TYPE=void 0!==n.uniforms.reflectionType?n.uniforms.reflectionType:0,e.defines.NORMAL&&e.defines.NORMAL_MAP&&!r.meshData.getAttributeBuffer(t.TANGENT)&&a.addTangentBuffer(r.meshData)}};var d=[];return s.light={processor:function(t,a){var h=t.uniforms;h.materialAmbient=h.materialAmbient||"AMBIENT",h.materialEmissive=h.materialEmissive||"EMISSIVE",h.materialDiffuse=h.materialDiffuse||"DIFFUSE",h.materialSpecular=h.materialSpecular||"SPECULAR",h.materialSpecularPower=h.materialSpecularPower||"SPECULAR_POWER",h.globalAmbient=s.GLOBAL_AMBIENT,t.defines=t.defines||{};for(var l=a.lights,u=0;u<l.length;u++){var c=l[u];if(c instanceof e){h["pointLight"+u]=h["pointLight"+u]||[],h["pointLightColor"+u]=h["pointLightColor"+u]||[];var p=h["pointLight"+u],f=c.translation.data;p[0]=f[0],p[1]=f[1],p[2]=f[2],p[3]=c.range;var m=h["pointLightColor"+u],g=c.color.data;m[0]=g[0]*c.intensity,m[1]=g[1]*c.intensity,m[2]=g[2]*c.intensity,m[3]=c.specularIntensity,d.push("P")}else if(c instanceof r){h["directionalLightDirection"+u]=h["directionalLightDirection"+u]||[],h["directionalLightColor"+u]=h["directionalLightColor"+u]||[];var v=h["directionalLightDirection"+u],y=c.direction.data;v[0]=y[0],v[1]=y[1],v[2]=y[2];var x=h["directionalLightColor"+u],g=c.color.data;x[0]=g[0]*c.intensity,x[1]=g[1]*c.intensity,x[2]=g[2]*c.intensity,x[3]=c.specularIntensity,d.push("D")}else c instanceof i&&(h["spotLight"+u]=[c.translation.data[0],c.translation.data[1],c.translation.data[2],c.range],h["spotLightColor"+u]=[c.color.data[0]*c.intensity,c.color.data[1]*c.intensity,c.color.data[2]*c.intensity,c.specularIntensity],h["spotLightDirection"+u]=[c.direction.data[0],c.direction.data[1],c.direction.data[2]],h["spotLightAngle"+u]=Math.cos(c.angle*o.DEG_TO_RAD/2),h["spotLightPenumbra"+u]=void 0!==c.penumbra?Math.sin(c.penumbra*o.DEG_TO_RAD/4):0,d.push("S"));var _=c.lightCookie instanceof n;if((_||c.shadowCaster&&a.renderable.meshRendererComponent&&a.renderable.meshRendererComponent.receiveShadows)&&c.shadowSettings.shadowData){var w=c.shadowSettings.shadowData;c.shadowCaster&&(h["shadowMaps"+u]="SHADOW_MAP"+u,a.material.setTexture("SHADOW_MAP"+u,w.shadowResult)),_?(h["lightCookie"+u]="LIGHT_COOKIE"+u,a.material.setTexture("LIGHT_COOKIE"+u,c.lightCookie),d.push("C"),t.defines.COOKIE=!0):delete t.defines.COOKIE;for(var b=w.lightCamera.getViewProjectionMatrix().data,S=h["shadowLightMatrices"+u]=h["shadowLightMatrices"+u]||[],E=0;16>E;E++)S[E]=b[E];if(c.shadowCaster){var C=w.lightCamera.translation.data,M=h["shadowLightPositions"+u]=h["shadowLightPositions"+u]||[];if(M[0]=C[0],M[1]=C[1],M[2]=C[2],h["cameraScales"+u]=1/(w.lightCamera.far-w.lightCamera.near),h["shadowDarkness"+u]=c.shadowSettings.darkness,"PCF"===c.shadowSettings.shadowType){var T=h["shadowMapSizes"+u]=h["shadowMapSizes"+u]||[];T[0]=c.shadowSettings.resolution[0],T[1]=c.shadowSettings.resolution[1]}d.push("H","PCF"===c.shadowSettings.shadowType?1:"VSM"===c.shadowSettings.shadowType?2:0)}}}var P=d.join("");t.defines.LIGHT!==P&&(t.defines.LIGHT=P),d.length=0},builder:function(t,o){var a=[],h=[],d=[],l=[];a.push("const mat4 ScaleMatrix = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),d.push("uniform vec4 materialAmbient;","uniform vec4 materialEmissive;","uniform vec4 materialDiffuse;","uniform vec4 materialSpecular;","uniform float materialSpecularPower;","uniform vec3 globalAmbient;","uniform vec2 wrapSettings;","float ChebychevInequality(in vec2 moments, in float t) {","if ( t <= moments.x ) return 1.0;","float variance = moments.y - (moments.x * moments.x);","variance = max(variance, 0.02);","float d = t - moments.x;","return variance / (variance + d * d);","}"),l.push("#if defined(SPECULAR_MAP) && defined(TEXCOORD0)","float specularStrength = texture2D(specularMap, texCoord0).x;","#else","float specularStrength = 1.0;","#endif","vec3 totalDiffuse = vec3(0.0);","vec3 totalSpecular = vec3(0.0);");for(var u=o.lights,c=0;c<u.length;c++){var p=u[c];l.push("{","float shadow = 1.0;","vec3 normalizedViewPosition = normalize(viewPosition);");var f=p.lightCookie instanceof n;(f||p.shadowCaster&&o.renderable.meshRendererComponent&&o.renderable.meshRendererComponent.receiveShadows)&&(a.push("uniform mat4 shadowLightMatrices"+c+";","varying vec4 shadowLightDepths"+c+";"),h.push("shadowLightDepths"+c+" = ScaleMatrix * shadowLightMatrices"+c+" * worldPos;"),p.shadowCaster&&d.push("uniform sampler2D shadowMaps"+c+";","uniform vec3 shadowLightPositions"+c+";","uniform float cameraScales"+c+";","uniform float shadowDarkness"+c+";"),f&&d.push("uniform sampler2D lightCookie"+c+";"),d.push("varying vec4 shadowLightDepths"+c+";"),p.shadowCaster&&"PCF"===p.shadowSettings.shadowType&&d.push("uniform vec2 shadowMapSizes"+c+";"),l.push("vec3 depth = shadowLightDepths"+c+".xyz / shadowLightDepths"+c+".w;"),p.shadowCaster&&(l.push("depth.z = length(vWorldPos.xyz - shadowLightPositions"+c+") * cameraScales"+c+";","if (depth.x >= 0.0 && depth.x <= 1.0 && depth.y >= 0.0 && depth.y <= 1.0 && shadowLightDepths"+c+".z >= 0.0 && depth.z <= 1.0) {"),"PCF"===p.shadowSettings.shadowType?l.push("depth.z *= 0.96;","float shadowPcf = 0.0;","const float shadowDelta = 1.0 / 9.0;","float xPixelOffset = 1.0 / shadowMapSizes"+c+".x;","float yPixelOffset = 1.0 / shadowMapSizes"+c+".y;","float dx0 = -1.25 * xPixelOffset;","float dy0 = -1.25 * yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","float fDepth = 0.0;","fDepth = texture2D(shadowMaps"+c+", depth.xy + vec2(dx0, dy0)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+c+", depth.xy + vec2(0.0, dy0)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+c+", depth.xy + vec2(dx1, dy0)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+c+", depth.xy + vec2(dx0, 0.0)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth =  texture2D(shadowMaps"+c+", depth.xy).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+c+", depth.xy + vec2(dx1, 0.0)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+c+", depth.xy + vec2(dx0, dy1)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+c+", depth.xy + vec2(0.0, dy1)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+c+", depth.xy + vec2(dx1, dy1)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","shadow = mix(1.0, 1.0 - shadowPcf, shadowDarkness"+c+");"):"VSM"===p.shadowSettings.shadowType?l.push("vec4 texel = texture2D(shadowMaps"+c+", depth.xy);","vec2 moments = vec2(texel.x, texel.y);","shadow = ChebychevInequality(moments, depth.z);","shadow = pow(shadow, shadowDarkness"+c+" * 8.0);"):l.push("depth.z *= 0.96;","float shadowDepth = texture2D(shadowMaps"+c+", depth.xy).x;","if ( depth.z > shadowDepth ) shadow = 1.0 - shadowDarkness"+c+";"),l.push("}","shadow = clamp(shadow, 0.0, 1.0);"))),p instanceof e?(d.push("uniform vec4 pointLight"+c+";","uniform vec4 pointLightColor"+c+";"),l.push("vec3 lVector = normalize(pointLight"+c+".xyz - vWorldPos.xyz);","float lDistance = 1.0 - min((length(pointLight"+c+".xyz - vWorldPos.xyz) / pointLight"+c+".w), 1.0);","float dotProduct = dot(N, lVector);","float pointDiffuseWeightFull = max(dotProduct, 0.0);","float pointDiffuseWeightHalf = max(mix(dotProduct, 1.0, wrapSettings.x), 0.0);","vec3 pointDiffuseWeight = mix(vec3(pointDiffuseWeightFull), vec3(pointDiffuseWeightHalf), wrapSettings.y);","totalDiffuse += materialDiffuse.rgb * pointLightColor"+c+".rgb * pointDiffuseWeight * lDistance * shadow;","vec3 pointHalfVector = normalize(lVector + normalizedViewPosition);","float pointDotNormalHalf = max(dot(N, pointHalfVector), 0.0);","float pointSpecularWeight = pointLightColor"+c+".a * specularStrength * max(pow(pointDotNormalHalf, materialSpecularPower), 0.0);","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = (materialSpecularPower + 2.0001 ) / 8.0;","vec3 schlick = materialSpecular.rgb + vec3(1.0 - materialSpecular.rgb) * pow(1.0 - dot(lVector, pointHalfVector), 5.0);","totalSpecular += schlick * pointLightColor"+c+".rgb * pointSpecularWeight * pointDiffuseWeight * lDistance * specularNormalization * shadow;","#else","totalSpecular += materialSpecular.rgb * pointLightColor"+c+".rgb * pointSpecularWeight * pointDiffuseWeight * lDistance * shadow;","#endif")):p instanceof r?(d.push("uniform vec4 directionalLightColor"+c+";","uniform vec3 directionalLightDirection"+c+";"),l.push("vec3 dirVector = normalize(-directionalLightDirection"+c+");","float dotProduct = dot(N, dirVector);","float dirDiffuseWeightFull = max(dotProduct, 0.0);","float dirDiffuseWeightHalf = max(mix(dotProduct, 1.0, wrapSettings.x), 0.0);","vec3 dirDiffuseWeight = mix(vec3(dirDiffuseWeightFull), vec3(dirDiffuseWeightHalf), wrapSettings.y);","vec3 cookie = vec3(1.0);"),f&&l.push("vec4 cookieTex = texture2D(lightCookie"+c+", depth.xy);","cookie = cookieTex.rgb * cookieTex.a;"),l.push("totalDiffuse += materialDiffuse.rgb * directionalLightColor"+c+".rgb * dirDiffuseWeight * shadow * cookie;","vec3 dirHalfVector = normalize(dirVector + normalizedViewPosition);","float dirDotNormalHalf = max(dot(N, dirHalfVector), 0.0);","float dirSpecularWeight = directionalLightColor"+c+".a * specularStrength * max(pow(dirDotNormalHalf, materialSpecularPower), 0.0);","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = (materialSpecularPower + 2.0001) / 8.0;","vec3 schlick = materialSpecular.rgb + vec3(1.0 - materialSpecular.rgb) * pow(1.0 - dot(dirVector, dirHalfVector), 5.0);","totalSpecular += schlick * directionalLightColor"+c+".rgb * dirSpecularWeight * dirDiffuseWeight * specularNormalization * shadow * cookie;","#else","totalSpecular += materialSpecular.rgb * directionalLightColor"+c+".rgb * dirSpecularWeight * dirDiffuseWeight * shadow * cookie;","#endif")):p instanceof i&&(d.push("uniform vec4 spotLightColor"+c+";","uniform vec4 spotLight"+c+";","uniform vec3 spotLightDirection"+c+";","uniform float spotLightAngle"+c+";","uniform float spotLightPenumbra"+c+";"),l.push("vec3 lVector = normalize(spotLight"+c+".xyz - vWorldPos.xyz);","float lDistance = 1.0 - min((length(spotLight"+c+".xyz - vWorldPos.xyz) / spotLight"+c+".w), 1.0);","float spotEffect = dot(normalize(-spotLightDirection"+c+"), lVector);","if (spotEffect > spotLightAngle"+c+") {","if (spotLightPenumbra"+c+" > 0.0) {","spotEffect = (spotEffect - spotLightAngle"+c+") / spotLightPenumbra"+c+";","spotEffect = clamp(spotEffect, 0.0, 1.0);","} else {","spotEffect = 1.0;","}","float dotProduct = dot(N, lVector);","float spotDiffuseWeightFull = max(dotProduct, 0.0);","float spotDiffuseWeightHalf = max(mix(dotProduct, 1.0, wrapSettings.x), 0.0);","vec3 spotDiffuseWeight = mix(vec3(spotDiffuseWeightFull), vec3(spotDiffuseWeightHalf), wrapSettings.y);","vec3 cookie = vec3(1.0);"),f&&l.push("cookie = texture2D(lightCookie"+c+", depth.xy).rgb;"),l.push("totalDiffuse += materialDiffuse.rgb * spotLightColor"+c+".rgb * spotDiffuseWeight * lDistance * spotEffect * shadow * cookie;","vec3 spotHalfVector = normalize(lVector + normalizedViewPosition);","float spotDotNormalHalf = max(dot(N, spotHalfVector), 0.0);","float spotSpecularWeight = spotLightColor"+c+".a * specularStrength * max(pow(spotDotNormalHalf, materialSpecularPower), 0.0);","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = (materialSpecularPower + 2.0001) / 8.0;","vec3 schlick = materialSpecular.rgb + vec3(1.0 - materialSpecular.rgb) * pow(1.0 - dot(lVector, spotHalfVector), 5.0);","totalSpecular += schlick * spotLightColor"+c+".rgb * spotSpecularWeight * spotDiffuseWeight * lDistance * specularNormalization * spotEffect * shadow * cookie;","#else","totalSpecular += materialSpecular.rgb * spotLightColor"+c+".rgb * spotSpecularWeight * spotDiffuseWeight * lDistance * spotEffect * shadow * cookie;","#endif","}")),l.push("}")}l.push("#if defined(EMISSIVE_MAP) && defined(TEXCOORD0)","vec3 emissive = vec3(0.0);","#else","vec3 emissive = materialEmissive.rgb;","#endif","#if defined(MULTIPLY_AMBIENT)","vec3 ambient = globalAmbient * materialAmbient.rgb;","#else","vec3 ambient = globalAmbient + materialAmbient.rgb;","#endif","#ifdef SKIP_SPECULAR","final_color.xyz = final_color.xyz * (emissive + totalDiffuse + ambient);","#else","final_color.xyz = final_color.xyz * (emissive + totalDiffuse + ambient) + totalSpecular;","#endif","#if defined(EMISSIVE_MAP) && defined(TEXCOORD0)","final_color.rgb += texture2D(emissiveMap, texCoord0).rgb * materialEmissive.rgb;","#endif"),s.light.prevertex=a.join("\n"),s.light.vertex=h.join("\n"),s.light.prefragment=d.join("\n"),s.light.fragment=l.join("\n")}},s.animation={processor:function(t,e){var r=e.currentPose;t.defines=t.defines||{},r?(t.uniforms.jointPalette||(t.uniforms.jointPalette=s.animation.jointPalette),t.defines.JOINT_COUNT=Math.max(3*e.meshData.paletteMap.length,80)):delete t.defines.JOINT_COUNT},jointPalette:function(t){var e=t.meshData,r=t.currentPose;if(r){var i=r._matrixPalette,n=e.store;n||(n=new Float32Array(12*e.paletteMap.length),e.store=n);for(var o,a=0;a<e.paletteMap.length;a++){o=i[e.paletteMap[a]];for(var h=0;12>h;h++)n[12*a+h]=o.data[s.animation.order[h]]}return n}},order:[0,4,8,12,1,5,9,13,2,6,10,14],prevertex:["#ifdef JOINTIDS","attribute vec4 vertexJointIDs;","#endif","#ifdef WEIGHTS","attribute vec4 vertexWeights;","#endif","#ifdef JOINT_COUNT","uniform vec4 jointPalette[JOINT_COUNT];","#endif"].join("\n"),vertex:["#if defined(JOINT_COUNT) && defined(WEIGHTS) && defined(JOINTIDS)","int x = 3*int(vertexJointIDs.x);","int y = 3*int(vertexJointIDs.y);","int z = 3*int(vertexJointIDs.z);","int w = 3*int(vertexJointIDs.w);","mat4 mat = mat4(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);","mat += mat4(","	jointPalette[x+0].x, jointPalette[x+1].x, jointPalette[x+2].x, 0,","	jointPalette[x+0].y, jointPalette[x+1].y, jointPalette[x+2].y, 0,","	jointPalette[x+0].z, jointPalette[x+1].z, jointPalette[x+2].z, 0,","	jointPalette[x+0].w, jointPalette[x+1].w, jointPalette[x+2].w, 1",") * vertexWeights.x;","mat += mat4(","	jointPalette[y+0].x, jointPalette[y+1].x, jointPalette[y+2].x, 0,","	jointPalette[y+0].y, jointPalette[y+1].y, jointPalette[y+2].y, 0,","	jointPalette[y+0].z, jointPalette[y+1].z, jointPalette[y+2].z, 0,","	jointPalette[y+0].w, jointPalette[y+1].w, jointPalette[y+2].w, 1",") * vertexWeights.y;","mat += mat4(","	jointPalette[z+0].x, jointPalette[z+1].x, jointPalette[z+2].x, 0,","	jointPalette[z+0].y, jointPalette[z+1].y, jointPalette[z+2].y, 0,","	jointPalette[z+0].z, jointPalette[z+1].z, jointPalette[z+2].z, 0,","	jointPalette[z+0].w, jointPalette[z+1].w, jointPalette[z+2].w, 1",") * vertexWeights.z;","mat += mat4(","	jointPalette[w+0].x, jointPalette[w+1].x, jointPalette[w+2].x, 0,","	jointPalette[w+0].y, jointPalette[w+1].y, jointPalette[w+2].y, 0,","	jointPalette[w+0].z, jointPalette[w+1].z, jointPalette[w+2].z, 0,","	jointPalette[w+0].w, jointPalette[w+1].w, jointPalette[w+2].w, 1",") * vertexWeights.w;","wMatrix = wMatrix * mat / mat[3][3];","#ifdef NORMAL","nMatrix = nMatrix * mat / mat[3][3];","#endif","#endif"].join("\n")},s
}),define("goo/renderer/shaders/ShaderLib",["goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/shaders/ShaderFragment","goo/renderer/shaders/ShaderBuilder"],function(t,e,r,i){"use strict";function n(){}return n.uber={processors:[i.uber.processor,i.light.processor,i.animation.processor],attributes:{vertexPosition:t.POSITION,vertexNormal:t.NORMAL,vertexTangent:t.TANGENT,vertexColor:t.COLOR,vertexUV0:t.TEXCOORD0,vertexUV1:t.TEXCOORD1,vertexJointIDs:t.JOINTIDS,vertexWeights:t.WEIGHTS},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,normalMatrix:e.NORMAL_MATRIX,cameraPosition:e.CAMERA,diffuseMap:e.DIFFUSE_MAP,offsetRepeat:[0,0,1,1],normalMap:e.NORMAL_MAP,normalMultiplier:1,specularMap:e.SPECULAR_MAP,emissiveMap:e.EMISSIVE_MAP,aoMap:e.AO_MAP,lightMap:e.LIGHT_MAP,environmentCube:"ENVIRONMENT_CUBE",environmentSphere:"ENVIRONMENT_SPHERE",reflectionMap:"REFLECTION_MAP",transparencyMap:"TRANSPARENCY_MAP",opacity:1,reflectivity:0,refractivity:0,etaRatio:-.5,fresnel:0,discardThreshold:-.01,fogSettings:[0,1e4],fogColor:[1,1,1],shadowDarkness:.5,vertexColorAmount:1,lodBias:0,wrapSettings:[.5,0]},builder:function(t,e){i.light.builder(t,e)},vshader:function(){return["attribute vec3 vertexPosition;","#ifdef NORMAL","attribute vec3 vertexNormal;","#endif","#ifdef TANGENT","attribute vec4 vertexTangent;","#endif","#ifdef COLOR","attribute vec4 vertexColor;","#endif","#ifdef TEXCOORD0","attribute vec2 vertexUV0;","uniform vec4 offsetRepeat;","varying vec2 texCoord0;","#endif","#ifdef TEXCOORD1","attribute vec2 vertexUV1;","varying vec2 texCoord1;","#endif","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform mat4 normalMatrix;","uniform vec3 cameraPosition;","varying vec3 vWorldPos;","varying vec3 viewPosition;","#ifdef NORMAL","varying vec3 normal;","#endif","#ifdef TANGENT","varying vec3 binormal;","varying vec3 tangent;","#endif","#ifdef COLOR","varying vec4 color;","#endif",i.light.prevertex,i.animation.prevertex,"void main(void) {","mat4 wMatrix = worldMatrix;","#ifdef NORMAL","mat4 nMatrix = normalMatrix;","#endif",i.animation.vertex,"vec4 worldPos = wMatrix * vec4(vertexPosition, 1.0);","vWorldPos = worldPos.xyz;","gl_Position = viewProjectionMatrix * worldPos;","viewPosition = cameraPosition - worldPos.xyz;","#ifdef NORMAL","	normal = normalize((nMatrix * vec4(vertexNormal, 0.0)).xyz);","#endif","#ifdef TANGENT","	tangent = normalize((nMatrix * vec4(vertexTangent.xyz, 0.0)).xyz);","	binormal = cross(normal, tangent) * vec3(vertexTangent.w);","#endif","#ifdef COLOR","	color = vertexColor;","#endif","#ifdef TEXCOORD0","	texCoord0 = vertexUV0 * offsetRepeat.zw + offsetRepeat.xy;","#endif","#ifdef TEXCOORD1","	texCoord1 = vertexUV1;","#endif",i.light.vertex,"}"].join("\n")},fshader:function(){return["uniform float lodBias;","#ifdef DIFFUSE_MAP","uniform sampler2D diffuseMap;","#endif","#ifdef NORMAL_MAP","uniform sampler2D normalMap;","uniform float normalMultiplier;","#endif","#ifdef SPECULAR_MAP","uniform sampler2D specularMap;","#endif","#ifdef EMISSIVE_MAP","uniform sampler2D emissiveMap;","#endif","#ifdef AO_MAP","uniform sampler2D aoMap;","#endif","#ifdef LIGHT_MAP","uniform sampler2D lightMap;","#endif","#ifdef TRANSPARENCY_MAP","uniform sampler2D transparencyMap;","#endif","#ifdef REFLECTIVE","#ifdef ENVIRONMENT_CUBE","uniform samplerCube environmentCube;","#elif defined(ENVIRONMENT_SPHERE)","uniform sampler2D environmentSphere;","#endif","uniform vec4 clearColor;","uniform float reflectivity;","uniform float fresnel;","uniform float refractivity;","uniform float etaRatio;","#ifdef REFLECTION_MAP","uniform sampler2D reflectionMap;","#endif","#endif","uniform float opacity;","#ifdef DISCARD","uniform float discardThreshold;","#endif","#ifdef FOG","uniform vec2 fogSettings;","uniform vec3 fogColor;","#endif","varying vec3 vWorldPos;","varying vec3 viewPosition;","#ifdef NORMAL","varying vec3 normal;","#endif","#ifdef TANGENT","varying vec3 binormal;","varying vec3 tangent;","#endif","#ifdef COLOR","varying vec4 color;","uniform float vertexColorAmount;","#endif","#ifdef TEXCOORD0","varying vec2 texCoord0;","#endif","#ifdef TEXCOORD1","varying vec2 texCoord1;","#endif",i.light.prefragment,"void main(void)","{","vec4 final_color = vec4(1.0);","#if defined(DIFFUSE_MAP) && defined(TEXCOORD0)","final_color *= texture2D(diffuseMap, texCoord0, lodBias);","#endif","#ifdef COLOR","final_color *= mix(vec4(1.0), color, vertexColorAmount);","#endif","#if defined(TRANSPARENCY_MAP) && defined(TEXCOORD0)","final_color.a = texture2D(transparencyMap, texCoord0).a;","#endif","final_color.a *= opacity;","#ifdef DISCARD","if (final_color.a < discardThreshold) discard;","#endif","#ifdef AO_MAP","#ifdef TEXCOORD1","final_color.rgb *= texture2D(aoMap, texCoord1).rgb;","#elif defined(TEXCOORD0)","final_color.rgb *= texture2D(aoMap, texCoord0).rgb;","#endif","#endif","#ifdef LIGHT_MAP","#ifdef TEXCOORD1","final_color.rgb *= texture2D(lightMap, texCoord1).rgb * 2.0 - 0.5;","#elif defined(TEXCOORD0)","final_color.rgb *= texture2D(lightMap, texCoord0).rgb * 2.0 - 0.5;","#endif","#else","vec3 N = vec3(0.0, 1.0, 0.0);","#if defined(NORMAL)","N = normalize(normal);","#endif","#if defined(TANGENT) && defined(NORMAL_MAP) && defined(TEXCOORD0)","mat3 tangentToWorld = mat3(tangent, binormal, normal);","vec3 tangentNormal = texture2D(normalMap, texCoord0, lodBias).xyz * vec3(2.0) - vec3(1.0);","tangentNormal.xy *= normalMultiplier;","vec3 worldNormal = (tangentToWorld * tangentNormal);","N = normalize(worldNormal);","#endif",i.light.fragment,"#endif","#ifdef REFLECTIVE","if (refractivity > 0.0) {","vec3 refractionVector = refract(normalize(viewPosition), N, etaRatio);","refractionVector.x = -refractionVector.x;","vec4 environment = vec4(0.0);","#ifdef ENVIRONMENT_CUBE","environment = textureCube(environmentCube, refractionVector);","#elif defined(ENVIRONMENT_SPHERE)","refractionVector = -refractionVector;","float m = 4.0 * sqrt(refractionVector.x*refractionVector.x + refractionVector.y*refractionVector.y + (refractionVector.z+1.0)*(refractionVector.z+1.0));","environment = texture2D(environmentSphere, (refractionVector.xy / m) + 0.5);","#endif","environment.rgb = mix(clearColor.rgb, environment.rgb, environment.a);","final_color.rgb = mix(final_color.rgb, environment.rgb, refractivity);","}","if (reflectivity > 0.0) {","vec3 reflectionVector = reflect(viewPosition, N);","reflectionVector.yz = -reflectionVector.yz;","vec4 environment = vec4(0.0);","#ifdef ENVIRONMENT_CUBE","environment = textureCube(environmentCube, reflectionVector);","#elif defined(ENVIRONMENT_SPHERE)","reflectionVector = -reflectionVector;","float m = 4.0 * sqrt(reflectionVector.x*reflectionVector.x + reflectionVector.y*reflectionVector.y + (reflectionVector.z+1.0)*(reflectionVector.z+1.0));","environment = texture2D(environmentSphere, (reflectionVector.xy / m) + 0.5);","#endif","environment.rgb = mix(clearColor.rgb, environment.rgb, environment.a);","float reflectionAmount = reflectivity;","#if defined(REFLECTION_MAP) && defined(TEXCOORD0)","reflectionAmount *= texture2D(reflectionMap, texCoord0).r;","#endif","float fresnelVal = pow(1.0 - abs(dot(normalize(viewPosition), N)), fresnel * 4.0);","reflectionAmount *= fresnelVal;","#if REFLECTION_TYPE == 0","final_color.rgb = mix(final_color.rgb, environment.rgb, reflectionAmount);","#elif REFLECTION_TYPE == 1","final_color.rgb += environment.rgb * reflectionAmount;","#endif","}","#endif","#ifndef LIGHT_MAP","final_color.rgb += totalSpecular;","final_color.a += min(length(totalSpecular), 1.0);","#endif","#ifdef FOG","float d = pow(smoothstep(fogSettings.x, fogSettings.y, length(viewPosition)), 1.0);","final_color.rgb = mix(final_color.rgb, fogColor, d);","#endif","gl_FragColor = final_color;","}"].join("\n")}},n.screenCopy={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{diffuseMap:e.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","varying vec2 texCoord0;","void main(void)","{","gl_FragColor = texture2D(diffuseMap, texCoord0);","}"].join("\n")},n.copy={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,opacity:1,diffuseMap:e.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","uniform float opacity;","varying vec2 texCoord0;","void main(void)","{","gl_FragColor = vec4(texture2D(diffuseMap, texCoord0).rgb, opacity);","}"].join("\n")},n.copyPure={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,opacity:1,diffuseMap:e.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","uniform float opacity;","varying vec2 texCoord0;","void main(void)","{","vec4 col = texture2D(diffuseMap, texCoord0);","gl_FragColor = vec4(col.rgb, col.a * opacity);","}"].join("\n")},n.simple={attributes:{vertexPosition:t.POSITION},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","void main(void) {","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["void main(void)","{","gl_FragColor = vec4(1.0);","}"].join("\n")},n.simpleColored={attributes:{vertexPosition:t.POSITION},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,color:[1,1,1],opacity:1},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","void main(void) {","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform vec3 color;","uniform float opacity;","void main(void)","{","if (opacity == 0.0) {","discard;","}","gl_FragColor = vec4(color, opacity);","}"].join("\n")},n.simpleLit={processors:[i.light.processor],defines:{NORMAL:!0},attributes:{vertexPosition:t.POSITION,vertexNormal:t.NORMAL},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,cameraPosition:e.CAMERA,opacity:1},builder:function(t,e){i.light.builder(t,e)},vshader:function(){return["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;",i.light.prevertex,"varying vec3 normal;","varying vec3 vWorldPos;","varying vec3 viewPosition;","void main(void) {","vec4 worldPos = worldMatrix * vec4(vertexPosition, 1.0);","vWorldPos = worldPos.xyz;","gl_Position = viewProjectionMatrix * worldPos;",i.light.vertex,"normal = (worldMatrix * vec4(vertexNormal, 0.0)).xyz;","viewPosition = cameraPosition - worldPos.xyz;","}"].join("\n")},fshader:function(){return["#ifdef SPECULAR_MAP","uniform sampler2D specularMap;","#ifdef TEXCOORD0","varying vec2 texCoord0;","#endif","#endif","uniform float opacity;",i.light.prefragment,"#ifdef NORMAL","varying vec3 normal;","#endif","varying vec3 vWorldPos;","varying vec3 viewPosition;","void main(void)","{","if (opacity == 0.0) {","discard;","}","#ifdef NORMAL","vec3 N = normalize(normal);","#else","vec3 N = vec3(0,0,1);","#endif","vec4 final_color = vec4(1.0);",i.light.fragment,"final_color.a = opacity;","gl_FragColor = final_color;","}"].join("\n")}},n.textured={defines:{TEXCOORD0:!0,DIFFUSE_MAP:!0},attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,diffuseMap:e.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["#if defined(TEXCOORD0) && defined(DIFFUSE_MAP)","uniform sampler2D diffuseMap;","varying vec2 texCoord0;","#endif","void main(void)","{","#if defined(TEXCOORD0) && defined(DIFFUSE_MAP)","gl_FragColor = texture2D(diffuseMap, texCoord0);","#else","gl_FragColor = vec4(1.0);","#endif","}"].join("\n")},n.texturedLit={processors:[i.light.processor],attributes:{vertexPosition:t.POSITION,vertexNormal:t.NORMAL,vertexUV0:t.TEXCOORD0},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,cameraPosition:e.CAMERA,diffuseMap:e.DIFFUSE_MAP},builder:function(t,e){i.light.builder(t,e)},vshader:function(){return["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;",i.light.prevertex,"varying vec3 normal;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec2 texCoord0;","void main(void) {","vec4 worldPos = worldMatrix * vec4(vertexPosition, 1.0);","vWorldPos = worldPos.xyz;","gl_Position = viewProjectionMatrix * worldPos;",i.light.vertex,"normal = (worldMatrix * vec4(vertexNormal, 0.0)).xyz;","texCoord0 = vertexUV0;","viewPosition = cameraPosition - worldPos.xyz;","}"].join("\n")},fshader:function(){return["uniform sampler2D diffuseMap;",i.light.prefragment,"varying vec3 normal;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec2 texCoord0;","void main(void)","{","vec3 N = normalize(normal);","vec4 final_color = texture2D(diffuseMap, texCoord0);",i.light.fragment,"gl_FragColor = final_color;","}"].join("\n")}},n.convolution={defines:{KERNEL_SIZE_FLOAT:"25.0",KERNEL_SIZE_INT:"25"},attributes:{position:t.POSITION,uv:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP,uImageIncrement:[.001953125,0],cKernel:[],size:1},vshader:["attribute vec3 position;","attribute vec2 uv;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform float size;","uniform vec2 uImageIncrement;","varying vec2 vUv;","void main() {","vUv = uv - ( ( KERNEL_SIZE_FLOAT - 1.0 ) / 2.0 ) * size * uImageIncrement;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( position, 1.0 );","}"].join("\n"),fshader:["uniform float cKernel[ KERNEL_SIZE_INT ];","uniform sampler2D tDiffuse;","uniform vec2 uImageIncrement;","uniform float size;","varying vec2 vUv;","void main() {","vec2 imageCoord = vUv;","vec4 sum = vec4( 0.0 );","for( int i = 0; i < KERNEL_SIZE_INT; i ++ ) {","sum += texture2D( tDiffuse, imageCoord ) * cKernel[ i ];","imageCoord += uImageIncrement * size;","}","gl_FragColor = sum;","}"].join("\n"),buildKernel:function(t){function e(t,e){return Math.exp(-(t*t)/(2*e*e))}var r,i,n,o,a=25,s=2*Math.ceil(3*t)+1;for(s>a&&(s=a),o=.5*(s-1),i=new Array(s),n=0,r=0;s>r;++r)i[r]=e(r-o,t),n+=i[r];for(r=0;s>r;++r)i[r]/=n;return i}},n.showNormals={defines:{NORMAL:!0},attributes:{vertexPosition:t.POSITION,vertexNormal:t.NORMAL},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,opacity:1},vshader:["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec3 normal;","void main() {","normal = vec3(worldMatrix * vec4(vertexNormal, 0.0));","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform float opacity;","#ifdef NORMAL","varying vec3 normal;","#else","vec3 normal = vec3(0,0,1);","#endif","void main() {","gl_FragColor = vec4( 0.5 * normalize( normal ) + 0.5, opacity );","}"].join("\n")},n.particles={attributes:{vertexPosition:t.POSITION,vertexColor:t.COLOR,vertexUV0:t.TEXCOORD0},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,diffuseMap:e.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec4 vertexColor;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","varying vec4 color;","void main(void) {","texCoord0 = vertexUV0;","color = vertexColor;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","varying vec2 texCoord0;","varying vec4 color;","void main(void)","{","vec4 texCol = texture2D(diffuseMap, texCoord0);","if (color.a == 0.0 || texCol.a == 0.0) discard;","else gl_FragColor = texCol * color;","}"].join("\n")},n.normalmap={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,heightMap:e.DIFFUSE_MAP,resolution:[512,512],height:.05},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform float height;","uniform vec2 resolution;","uniform sampler2D heightMap;","varying vec2 vUv;","void main() {","float val = texture2D( heightMap, vUv ).x;","float valU = texture2D( heightMap, vUv + vec2( 1.0 / resolution.x, 0.0 ) ).x;","float valV = texture2D( heightMap, vUv + vec2( 0.0, 1.0 / resolution.y ) ).x;","gl_FragColor = vec4( ( 0.5 * normalize( vec3( val - valU, val - valV, height  ) ) + 0.5 ), 1.0 );","}"].join("\n")},n.point={attributes:{vertexPosition:t.POSITION,vertexColor:t.COLOR},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,pointSize:2},vshader:["attribute vec3 vertexPosition;","attribute vec4 vertexColor;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform float pointSize;","varying vec4 color;","void main(void) {","color = vertexColor;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","gl_PointSize = pointSize;","}"].join("\n"),fshader:["varying vec4 color;","void main(void)","{","gl_FragColor = color;","}"].join("\n")},n.downsample={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","}"].join("\n")},n.lightDepth={processors:[i.animation.processor],defines:{SHADOW_TYPE:0,WEIGHTS:!0,JOINTIDS:!0},attributes:{vertexPosition:t.POSITION,vertexJointIDs:t.JOINTIDS,vertexWeights:t.WEIGHTS},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,cameraScale:e.MAIN_DEPTH_SCALE},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec4 worldPosition;",i.animation.prevertex,"void main(void) {","mat4 wMatrix = worldMatrix;",i.animation.vertex,"worldPosition = viewMatrix * wMatrix * vec4(vertexPosition, 1.0);","gl_Position = projectionMatrix * worldPosition;","}"].join("\n"),fshader:["uniform float cameraScale;","varying vec4 worldPosition;","void main(void)","{","float linearDepth = length(worldPosition) * cameraScale;","#if SHADOW_TYPE == 0","gl_FragColor = vec4(linearDepth);","#elif SHADOW_TYPE == 1","gl_FragColor = vec4(linearDepth);","#elif SHADOW_TYPE == 2","gl_FragColor = vec4(linearDepth, linearDepth * linearDepth, 0.0, 0.0);","#endif","}"].join("\n")},n.pickingShader={defines:{WEIGHTS:!0,JOINTIDS:!0},attributes:{vertexPosition:t.POSITION,vertexJointIDs:t.JOINTIDS,vertexWeights:t.WEIGHTS},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,cameraFar:e.FAR_PLANE,id:function(t){return null!=t.renderable._index?t.renderable._index+1:t.renderable.id+1}},processors:[i.animation.processor],vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform float cameraFar;",i.animation.prevertex,"varying float depth;","void main() {","mat4 wMatrix = worldMatrix;",i.animation.vertex,"vec4 mvPosition = viewMatrix * wMatrix * vec4( vertexPosition, 1.0 );","depth = -mvPosition.z / cameraFar;","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fshader:["uniform float id;","varying float depth;",r.methods.packDepth16,"void main() {","vec2 packedId = vec2(floor(id/255.0), mod(id, 255.0)) * vec2(1.0/255.0);","vec2 packedDepth = packDepth16(depth);","gl_FragColor = vec4(packedId, packedDepth);","}"].join("\n")},n}),define("goo/shapes/Quad",["goo/renderer/MeshData"],function(t){"use strict";function e(e,r,i,n){if(1===arguments.length&&arguments[0]instanceof Object){var o=arguments[0];e=o.width,r=o.height,i=o.tileX,n=o.tileY}this.xExtent=void 0!==e?.5*e:.5,this.yExtent=void 0!==r?.5*r:.5,this.tileX=i||1,this.tileY=n||1;var a=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]);t.call(this,a,4,6),this.rebuild()}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.rebuild=function(){var e=this.xExtent,r=this.yExtent,i=this.tileX,n=this.tileY;return this.getAttributeBuffer(t.POSITION).set([-e,-r,0,-e,r,0,e,r,0,e,-r,0]),this.getAttributeBuffer(t.NORMAL).set([0,0,1,0,0,1,0,0,1,0,0,1]),this.getAttributeBuffer(t.TEXCOORD0).set([0,0,0,n,i,n,i,0]),this.getIndexBuffer().set([0,3,1,1,3,2]),this},e}),define("goo/util/Handy",[],function(){"use strict";function t(){}return t.deepFreeze=function(e){var r,i;Object.freeze(e);for(i in e)r=e[i],e.hasOwnProperty(i)&&"object"==typeof r&&!Object.isFrozen(r)&&t.deepFreeze(r)},t.defineProperty=function(t,e,r,i){var n=r;Object.defineProperty(t,e,{get:function(){return n},set:function(t){n=t,i(n)},configurable:!0,enumerable:!0})},t.addListener=function(t,e,r,i){var n=t[e];Object.defineProperty(t,e,{get:function(){return r&&r(),n},set:function(t){n=t,i&&i(n)},configurable:!0,enumerable:!0})},t}),define("goo/math/Plane",["goo/math/Vector3"],function(t){"use strict";function e(e,r){this.normal=new t(void 0!==e?e:t.UNIT_Y),this.constant=isNaN(r)?0:r}e.XZ=new e(t.UNIT_Y,0),e.XY=new e(t.UNIT_Z,0),e.YZ=new e(t.UNIT_X,0),e.prototype.pseudoDistance=function(t){return this.normal.dot(t)-this.constant},e.prototype.setPlanePoints=function(t,e,r){return this.normal.set(e).sub(t),this.normal.cross([r.x-t.x,r.y-t.y,r.z-t.z]).normalize(),this.constant=this.normal.dot(t),this},e.prototype.reflectVector=function(e,r){var i=r;"undefined"==typeof i&&(i=new t);var n=2*this.normal.dot(e);return i.set(e).sub([this.normal.x*n,this.normal.y*n,this.normal.z*n]),i};var r=new t;return e.prototype.rayIntersect=function(e,i,n,o){o="undefined"==typeof o?1e-7:o,i=i||new t;var a=e.direction.dot(this.normal);if(Math.abs(a)<o)return n||console.warn("Ray parallell with plane"),null;var s=this.constant,h=r.set(this.normal).muld(s,s,s).subv(e.origin).dot(this.normal),d=h/a;return i.setv(e.direction).muld(d,d,d).addv(e.origin)},e}),define("goo/math/Ray",["goo/math/Vector3","goo/math/MathUtils"],function(t,e){"use strict";function r(e,r){this.origin=e||new t,this.direction=r||(new t).copy(t.UNIT_Z)}var i=new t,n=new t,o=new t,a=new t;return r.prototype.intersects=function(t,e,r){return 3===t.length?this.intersectsTriangle(t[0],t[1],t[2],e,r):4===t.length?this.intersectsTriangle(t[0],t[1],t[2],e,r)||this.intersectsTriangle(t[0],t[2],t[3],e,r):!1},r.prototype.intersectsTriangle=function(r,s,h,d,l){var u,c=i.set(this.origin).sub(r),p=n.set(s).sub(r),f=o.set(h).sub(r),m=a.set(p).cross(f),g=this.direction.dot(m);if(g>e.EPSILON)u=1;else{if(!(g<-e.EPSILON))return!1;u=-1,g=-g}var v=u*this.direction.dot(t.cross(c,f,f)),y=!1;if(v>=0){var x=u*this.direction.dot(p.cross(c));if(x>=0&&g>=v+x){var _=-u*c.dot(m);if(_>=0){if(!l)return!0;var w=1/g,b=_*w;if(d){var S=v*w,E=x*w;l.setd(b,S,E)}else l.setv(this.origin).add_d(this.direction.x*b,this.direction.y*b,this.direction.z*b);y=!0}}}return y},r.prototype.getDistanceToPrimitive=function(t){var e=i;return this.intersects(t,!1,e)?this.origin.distance(e.x,e.y,e.z):1/0},r.prototype.intersectsPlane=function(t,e){var r=t.normal,i=r.dot(this.direction);if(Math.abs(i)<1e-5)return!1;var n=-r.dot(this.origin)+t.constant,o=n/i;return 1e-5>o?!1:(e&&e.setv(this.direction).scale(o).addv(this.origin),!0)},r.prototype.distanceSquared=function(t,e){var r=i;r.setv(t).subv(this.origin);var n=this.direction.dot(r);return n>0?(r.setv(this.direction).scale(n),r.addv(this.origin)):r.setv(this.origin),e&&e.setv(r),r.subv(t),r.lengthSquared()},r}),define("goo/renderer/Camera",["goo/util/Handy","goo/math/Vector3","goo/math/Vector4","goo/math/Matrix4x4","goo/math/Plane","goo/math/MathUtils","goo/math/Ray","goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere","goo/renderer/bounds/BoundingVolume"],function(t,e,r,i,n,o,a,s,h,d){"use strict";function l(o,a,s,h){o="undefined"!=typeof o?o:45,a="undefined"!=typeof a?a:1,s="undefined"!=typeof s?s:1,h="undefined"!=typeof h?h:1e3,this.translation=new e(0,0,0),this._left=new e(-1,0,0),this._up=new e(0,1,0),this._direction=new e(0,0,-1),t.defineProperty(this,"this._depthRangeNear",0,function(){this._depthRangeDirty=!0}),t.defineProperty(this,"this._depthRangeFar",1,function(){this._depthRangeDirty=!0}),this._depthRangeDirty=!0,this._frustumNear=1,this._frustumFar=2,this._frustumLeft=-.5,this._frustumRight=.5,this._frustumTop=.5,this._frustumBottom=-.5,this._coeffLeft=[],this._coeffRight=[],this._coeffBottom=[],this._coeffTop=[],this._viewPortLeft=0,this._viewPortRight=1,this._viewPortTop=1,this._viewPortBottom=0,this._worldPlane=[];for(var d=0;d<l.FRUSTUM_PLANES;d++)this._worldPlane[d]=new n;this.projectionMode=l.Perspective,this.lockedRatio=!1,this.aspect=a,this._updateMVMatrix=!0,this._updateInverseMVMatrix=!0,this._updatePMatrix=!0,this._updateMVPMatrix=!0,this._updateInverseMVPMatrix=!0,this.modelView=new i,this.modelViewInverse=new i,this.projection=new i,this.modelViewProjection=new i,this.modelViewProjectionInverse=new i,this._depthRangeDirty=!0,this._viewPortDirty=!0,this._planeState=0,this._clipPlane=new r,this._qCalc=new r,this._corners=[];for(var d=0;8>d;d++)this._corners.push(new e);this._extents=new e,this.vNearPlaneCenter=new e,this.vFarPlaneCenter=new e,this.direction=new e,this.left=new e,this.up=new e,this.planeNormal=new e,this.changedProperties=!0,this.setFrustumPerspective(o,a,s,h),this.onFrameChange()}var u=new e;return l.LEFT_PLANE=0,l.RIGHT_PLANE=1,l.BOTTOM_PLANE=2,l.TOP_PLANE=3,l.FAR_PLANE=4,l.NEAR_PLANE=5,l.FRUSTUM_PLANES=6,l.Perspective=0,l.Parallel=1,l.Custom=2,l.Outside=0,l.Inside=1,l.Intersects=2,l.prototype.normalize=function(){this._left.normalize(),this._up.normalize(),this._direction.normalize(),this.onFrameChange()},l.prototype.setProjectionMode=function(t){this.projectionMode=t,this.update()},l.prototype.setFrustumPerspective=function(t,e,r,i){if(void 0!==t&&null!==t&&(this.fov=t),void 0!==e&&null!==e&&(this.aspect=e),void 0!==r&&null!==r&&(this.near=r),void 0!==i&&null!==i&&(this.far=i),void 0!==this.fov){var n=Math.tan(this.fov*o.DEG_TO_RAD*.5)*this.near,a=n*this.aspect;this._frustumLeft=-a,this._frustumRight=a,this._frustumBottom=-n,this._frustumTop=n,this._frustumNear=this.near,this._frustumFar=this.far,this.onFrustumChange()}},l.prototype.setFrustum=function(t,e,r,i,n,o,a){void 0!==t&&null!==t&&(this.near=t),void 0!==e&&null!==e&&(this.far=e),void 0!==r&&null!==r&&(this.left=r),void 0!==i&&null!==i&&(this.right=i),void 0!==n&&null!==n&&(this.top=n),void 0!==o&&null!==o&&(this.bottom=o),void 0!==a&&null!==a&&(this.aspect=a),this._frustumNear=this.near,this._frustumFar=this.far,this._frustumLeft=this.left*this.aspect,this._frustumRight=this.right*this.aspect,this._frustumTop=this.top,this._frustumBottom=this.bottom,this.onFrustumChange()},l.prototype.copy=function(t){this.translation.setv(t.translation),this._left.setv(t._left),this._up.setv(t._up),this._direction.setv(t._direction),this.fov=t.fov,this.aspect=t.aspect,this.near=t.near,this.far=t.far,this._frustumLeft=t._frustumLeft,this._frustumRight=t._frustumRight,this._frustumBottom=t._frustumBottom,this._frustumTop=t._frustumTop,this._frustumNear=t._frustumNear,this._frustumFar=t._frustumFar,this.projectionMode=t.projectionMode,this._depthRangeDirty=!0,this.onFrustumChange(),this.onFrameChange()},l.prototype.setFrame=function(t,e,r,i){this._left.copy(e),this._up.copy(r),this._direction.copy(i),this.translation.copy(t),this.onFrameChange()},l.prototype.lookAt=function(t,r){u.copy(t).sub(this.translation).normalize(),u.equals(this._direction)||(this._direction.copy(u),this._up.copy(r).normalize(),this._up.equals(e.ZERO)&&this._up.copy(e.UNIT_Y),this._left.copy(this._up).cross(this._direction).normalize(),this._left.equals(e.ZERO)&&(0!==this._direction.x?this._left.set(this._direction.y,-this._direction.x,0):this._left.set(0,this._direction.z,-this._direction.y)),this._up.copy(this._direction).cross(this._left).normalize(),this.onFrameChange())},l.prototype.makeDirty=function(){this._depthRangeDirty=!0,this._viewPortDirty=!0},l.prototype.update=function(){this._depthRangeDirty=!0,this.onFrustumChange(),this.onFrameChange()},l.prototype.contains=function(t){if(!t)return l.Inside;for(var e=l.Inside,r=l.FRUSTUM_PLANES-1;r>=0;r--)switch(t.whichSide(this._worldPlane[r])){case d.Inside:return l.Outside;case d.Outside:break;case d.Intersects:e=l.Intersects}return e},l.prototype.onFrustumChange=function(){if(this.projectionMode===l.Perspective){var t=this._frustumNear*this._frustumNear,e=this._frustumLeft*this._frustumLeft,r=this._frustumRight*this._frustumRight,i=this._frustumBottom*this._frustumBottom,n=this._frustumTop*this._frustumTop,o=1/Math.sqrt(t+e);this._coeffLeft[0]=this._frustumNear*o,this._coeffLeft[1]=-this._frustumLeft*o,o=1/Math.sqrt(t+r),this._coeffRight[0]=-this._frustumNear*o,this._coeffRight[1]=this._frustumRight*o,o=1/Math.sqrt(t+i),this._coeffBottom[0]=this._frustumNear*o,this._coeffBottom[1]=-this._frustumBottom*o,o=1/Math.sqrt(t+n),this._coeffTop[0]=-this._frustumNear*o,this._coeffTop[1]=this._frustumTop*o}else this.projectionMode===l.Parallel&&(this._frustumRight>this._frustumLeft?(this._coeffLeft[0]=-1,this._coeffLeft[1]=0,this._coeffRight[0]=1,this._coeffRight[1]=0):(this._coeffLeft[0]=1,this._coeffLeft[1]=0,this._coeffRight[0]=-1,this._coeffRight[1]=0),this._frustumTop>this._frustumBottom?(this._coeffBottom[0]=-1,this._coeffBottom[1]=0,this._coeffTop[0]=1,this._coeffTop[1]=0):(this._coeffBottom[0]=1,this._coeffBottom[1]=0,this._coeffTop[0]=-1,this._coeffTop[1]=0));this._updatePMatrix=!0,this._updateMVPMatrix=!0,this._updateInverseMVMatrix=!0,this._updateInverseMVPMatrix=!0,this.changedProperties=!0},l.prototype.onFrameChange=function(){var t=this._direction.dot(this.translation),e=this.planeNormal;e.x=this._left.x*this._coeffLeft[0],e.y=this._left.y*this._coeffLeft[0],e.z=this._left.z*this._coeffLeft[0],e.add([this._direction.x*this._coeffLeft[1],this._direction.y*this._coeffLeft[1],this._direction.z*this._coeffLeft[1]]),this._worldPlane[l.LEFT_PLANE].normal.copy(e),this._worldPlane[l.LEFT_PLANE].constant=this.translation.dot(e),e.x=this._left.x*this._coeffRight[0],e.y=this._left.y*this._coeffRight[0],e.z=this._left.z*this._coeffRight[0],e.add([this._direction.x*this._coeffRight[1],this._direction.y*this._coeffRight[1],this._direction.z*this._coeffRight[1]]),this._worldPlane[l.RIGHT_PLANE].normal.copy(e),this._worldPlane[l.RIGHT_PLANE].constant=this.translation.dot(e),e.x=this._up.x*this._coeffBottom[0],e.y=this._up.y*this._coeffBottom[0],e.z=this._up.z*this._coeffBottom[0],e.add([this._direction.x*this._coeffBottom[1],this._direction.y*this._coeffBottom[1],this._direction.z*this._coeffBottom[1]]),this._worldPlane[l.BOTTOM_PLANE].normal.copy(e),this._worldPlane[l.BOTTOM_PLANE].constant=this.translation.dot(e),e.x=this._up.x*this._coeffTop[0],e.y=this._up.y*this._coeffTop[0],e.z=this._up.z*this._coeffTop[0],e.add([this._direction.x*this._coeffTop[1],this._direction.y*this._coeffTop[1],this._direction.z*this._coeffTop[1]]),this._worldPlane[l.TOP_PLANE].normal.copy(e),this._worldPlane[l.TOP_PLANE].constant=this.translation.dot(e),this.projectionMode===l.Parallel&&(this._frustumRight>this._frustumLeft?(this._worldPlane[l.LEFT_PLANE].constant=this._worldPlane[l.LEFT_PLANE].contant+this._frustumLeft,this._worldPlane[l.RIGHT_PLANE].constant=this._worldPlane[l.RIGHT_PLANE].contant-this._frustumRight):(this._worldPlane[l.LEFT_PLANE].constant=this._worldPlane[l.LEFT_PLANE].contant-this._frustumLeft,this._worldPlane[l.RIGHT_PLANE].constant=this._worldPlane[l.RIGHT_PLANE].contant+this._frustumRight),this._frustumBottom>this._frustumTop?(this._worldPlane[l.TOP_PLANE].constant=this._worldPlane[l.TOP_PLANE].contant+this._frustumTop,this._worldPlane[l.BOTTOM_PLANE].constant=this._worldPlane[l.BOTTOM_PLANE].contant-this._frustumBottom):(this._worldPlane[l.TOP_PLANE].constant=this._worldPlane[l.TOP_PLANE].contant-this._frustumTop,this._worldPlane[l.BOTTOM_PLANE].constant=this._worldPlane[l.BOTTOM_PLANE].contant+this._frustumBottom)),e.copy(this._direction).invert(),this._worldPlane[l.FAR_PLANE].normal.copy(e),this._worldPlane[l.FAR_PLANE].constant=-(t+this._frustumFar),this._worldPlane[l.NEAR_PLANE].normal.copy(this._direction),this._worldPlane[l.NEAR_PLANE].constant=t+this._frustumNear,this._updateMVMatrix=!0,this._updateMVPMatrix=!0,this._updateInverseMVMatrix=!0,this._updateInverseMVPMatrix=!0
},l.prototype.updateProjectionMatrix=function(){if(this.projectionMode===l.Parallel){this.projection.setIdentity();var t=this.projection.data;t[0]=2/(this._frustumRight-this._frustumLeft),t[5]=2/(this._frustumTop-this._frustumBottom),t[10]=-2/(this._frustumFar-this._frustumNear),t[12]=-(this._frustumRight+this._frustumLeft)/(this._frustumRight-this._frustumLeft),t[13]=-(this._frustumTop+this._frustumBottom)/(this._frustumTop-this._frustumBottom),t[14]=-(this._frustumFar+this._frustumNear)/(this._frustumFar-this._frustumNear)}else if(this.projectionMode===l.Perspective){this.projection.setIdentity();var t=this.projection.data;t[0]=2*this._frustumNear/(this._frustumRight-this._frustumLeft),t[5]=2*this._frustumNear/(this._frustumTop-this._frustumBottom),t[8]=(this._frustumRight+this._frustumLeft)/(this._frustumRight-this._frustumLeft),t[9]=(this._frustumTop+this._frustumBottom)/(this._frustumTop-this._frustumBottom),t[10]=-(this._frustumFar+this._frustumNear)/(this._frustumFar-this._frustumNear),t[11]=-1,t[14]=-(2*this._frustumFar*this._frustumNear)/(this._frustumFar-this._frustumNear),t[15]=-0}},l.prototype.updateModelViewMatrix=function(){this.modelView.setIdentity();var t=this.modelView.data;t[0]=-this._left.x,t[4]=-this._left.y,t[8]=-this._left.z,t[1]=this._up.x,t[5]=this._up.y,t[9]=this._up.z,t[2]=-this._direction.x,t[6]=-this._direction.y,t[10]=-this._direction.z,t[12]=this._left.dot(this.translation),t[13]=-this._up.dot(this.translation),t[14]=this._direction.dot(this.translation)},l.prototype.getPickRay=function(t,e,r,i,n){return n||(n=new a),this.getWorldCoordinates(t,e,r,i,0,n.origin),this.getWorldCoordinates(t,e,r,i,.3,n.direction).sub(n.origin).normalize(),n},l.prototype.getWorldPosition=function(t,e,r,i,n,o){return n=this.projectionMode===l.Parallel?(n-this.near)/(this.far-this.near):this.far/(this.far-this.near)+this.far*this.near/(this.near-this.far)/n,this.getWorldCoordinates(t,e,r,i,n,o)},l.prototype.getWorldCoordinates=function(t,i,n,o,a,s){s||(s=new e),this.checkInverseModelViewProjection();var h=new r,d=(t/n-this._viewPortLeft)/(this._viewPortRight-this._viewPortLeft)*2-1,l=((o-i)/o-this._viewPortBottom)/(this._viewPortTop-this._viewPortBottom)*2-1;return h.set(d,l,2*a-1,1),this.modelViewProjectionInverse.applyPost(h),h.mul(1/h.w),s.x=h.x,s.y=h.y,s.z=h.z,s},l.prototype.getScreenCoordinates=function(t,e,r,i){return i=this.getNormalizedDeviceCoordinates(t,i),i.x=(i.x+1)*(this._viewPortRight-this._viewPortLeft)/2*e,i.y=(1-i.y)*(this._viewPortTop-this._viewPortBottom)/2*r,i.z=(i.z+1)/2,i},l.prototype.getFrustumCoordinates=function(t,e){return e=this.getNormalizedDeviceCoordinates(t,e),e.x=(e.x+1)*(this._frustumRight-this._frustumLeft)/2+this._frustumLeft,e.y=(e.y+1)*(this._frustumTop-this._frustumBottom)/2+this._frustumBottom,e.z=(e.z+1)*(this._frustumFar-this._frustumNear)/2+this._frustumNear,e},l.prototype.getNormalizedDeviceCoordinates=function(t,i){i||(i=new e),this.checkModelViewProjection();var n=new r;return n.set(t.x,t.y,t.z,1),this.modelViewProjection.applyPost(n),n.mul(1/n.w),i.x=n.x,i.y=n.y,i.z=n.z,i},l.prototype.checkModelView=function(){this._updateMVMatrix&&(this.updateModelViewMatrix(),this._updateMVMatrix=!1)},l.prototype.checkProjection=function(){this._updatePMatrix&&(this.updateProjectionMatrix(),this._updatePMatrix=!1)},l.prototype.checkModelViewProjection=function(){this._updateMVPMatrix&&(this.checkModelView(),this.checkProjection(),this.modelViewProjection.copy(this.getProjectionMatrix()).combine(this.getViewMatrix()),this._updateMVPMatrix=!1)},l.prototype.checkInverseModelView=function(){this._updateInverseMVMatrix&&(this.checkModelView(),i.invert(this.modelView,this.modelViewInverse),this._updateInverseMVMatrix=!1)},l.prototype.checkInverseModelViewProjection=function(){this._updateInverseMVPMatrix&&(this.checkModelViewProjection(),i.invert(this.modelViewProjection,this.modelViewProjectionInverse),this._updateInverseMVPMatrix=!1)},l.prototype.getViewMatrix=function(){return this.checkModelView(),this.modelView},l.prototype.getProjectionMatrix=function(){return this.checkProjection(),this.projection},l.prototype.getViewProjectionMatrix=function(){return this.checkModelViewProjection(),this.modelViewProjection},l.prototype.getViewInverseMatrix=function(){return this.checkInverseModelView(),this.modelViewInverse},l.prototype.getViewProjectionInverseMatrix=function(){return this.checkInverseModelViewProjection(),this.modelViewProjectionInverse},l.prototype.pack=function(t){for(var e=t.center,i=this._corners,n=this._extents,o=0;o<i.length;o++)i[o].set(e);t instanceof s?n.setd(t.xExtent,t.yExtent,t.zExtent):t instanceof h&&n.setd(t.radius,t.radius,t.radius),i[0].add_d(n.x,n.y,n.z),i[1].add_d(n.x,-n.y,n.z),i[2].add_d(n.x,n.y,-n.z),i[3].add_d(n.x,-n.y,-n.z),i[4].add_d(-n.x,n.y,n.z),i[5].add_d(-n.x,-n.y,n.z),i[6].add_d(-n.x,n.y,-n.z),i[7].add_d(-n.x,-n.y,-n.z);for(var a=this.getViewMatrix(),d=Number.MAX_VALUE,l=-Number.MAX_VALUE,u=new r,o=0;o<i.length;o++)u.setd(i[o].x,i[o].y,i[o].z,1),a.applyPre(u),d=Math.min(-u.z,d),l=Math.max(-u.z,l);d=Math.min(Math.max(this._frustumNear,d),this._frustumFar),l=Math.max(d,Math.min(this._frustumFar,l));var c=d/this._frustumNear;this._frustumLeft=this._frustumLeft*c,this._frustumRight=this._frustumRight*c,this._frustumTop=this._frustumTop*c,this._frustumBottom=this._frustumBottom*c,this._frustumNear=d,this._frustumFar=l},l.prototype.calculateFrustumCorners=function(t,e){t=void 0!==t?t:this._frustumNear,e=void 0!==e?e:this._frustumFar;var r=(this._frustumTop-this._frustumBottom)*t*.5/this._frustumNear,i=(this._frustumRight-this._frustumLeft)*t*.5/this._frustumNear,n=(this._frustumTop-this._frustumBottom)*e*.5/this._frustumNear,o=(this._frustumRight-this._frustumLeft)*e*.5/this._frustumNear;this.projectionMode===l.Parallel&&(r=.5*(this._frustumTop-this._frustumBottom),i=.5*(this._frustumRight-this._frustumLeft),n=.5*(this._frustumTop-this._frustumBottom),o=.5*(this._frustumRight-this._frustumLeft));var a=this.vNearPlaneCenter,s=this.vFarPlaneCenter,h=this.direction,d=this.left,u=this.up;return h.setv(this._direction).mul(t),a.setv(this.translation).addv(h),h.setv(this._direction).mul(e),s.setv(this.translation).addv(h),d.setv(this._left).mul(i),u.setv(this._up).mul(r),this._corners[0].setv(a).subv(d).subv(u),this._corners[1].setv(a).addv(d).subv(u),this._corners[2].setv(a).addv(d).addv(u),this._corners[3].setv(a).subv(d).addv(u),d.setv(this._left).mul(o),u.setv(this._up).mul(n),this._corners[4].setv(s).subv(d).subv(u),this._corners[5].setv(s).addv(d).subv(u),this._corners[6].setv(s).addv(d).addv(u),this._corners[7].setv(s).subv(d).addv(u),this._corners},l.prototype.setToObliqueMatrix=function(t,e){e=e||0;var i=this._clipPlane.setv(t);this.getViewMatrix().applyPost(i),i.w=this.translation.y*t.y+e,this._updatePMatrix=!0;var n=this.getProjectionMatrix();this._qCalc.setd((o.sign(i.x)+n[8])/n[0],(o.sign(i.y)+n[9])/n[5],-1,(1+n[10])/n[14]),i.mul(2/r.dot(i,this._qCalc)),n[2]=i.x,n[6]=i.y,n[10]=i.z+1,n[14]=i.w,this._updateMVPMatrix=!0,this._updateInverseMVPMatrix=!0},l}),define("goo/renderer/pass/FullscreenUtil",["goo/shapes/Quad","goo/renderer/Camera","goo/math/Vector3"],function(t,e,r){"use strict";function i(){}var n=new e;return n.projectionMode=e.Parallel,n.setFrustum(0,1,-1,1,1,-1),n._left.copy(r.UNIT_X).invert(),n._up.copy(r.UNIT_Y),n._direction.copy(r.UNIT_Z),n.onFrameChange(),i.camera=n,i.quad=new t(2,2),i}),define("goo/renderer/pass/Pass",[],function(){"use strict";function t(){}return t.prototype.destroy=function(){},t.prototype.render=function(){},t.prototype.updateSize=function(){},t}),define("goo/renderer/pass/FullscreenPass",["goo/renderer/Material","goo/renderer/pass/FullscreenUtil","goo/renderer/shaders/ShaderLib","goo/renderer/pass/Pass"],function(t,e,r,i){"use strict";function n(i){this.material=new t(i||r.simple),this.useReadBuffer=!0,this.renderToScreen=!1,this.renderable={meshData:e.quad,materials:[this.material]},this.enabled=!0,this.clear=!1,this.needsSwap=!0}return n.prototype=Object.create(i.prototype),n.prototype.constructor=n,n.prototype.render=function(t,r,i){this.useReadBuffer&&this.material.setTexture("DIFFUSE_MAP",i),this.renderToScreen?t.render(this.renderable,e.camera,[],null,this.clear):t.render(this.renderable,e.camera,[],r,this.clear)},n.prototype.destroy=function(){this.material.shader.destroy()},n}),define("goo/renderer/shadow/ShadowHandler",["goo/math/Vector3","goo/renderer/pass/FullscreenPass","goo/renderer/Camera","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/renderer/pass/RenderTarget","goo/math/Vector4","goo/renderer/light/PointLight","goo/renderer/light/DirectionalLight","goo/renderer/light/SpotLight"],function(t,e,r,i,n,o,a,s,h,d){"use strict";function l(){this.depthMaterial=new i(n.lightDepth,"depthMaterial"),this.depthMaterial.cullState.cullFace="Back",this.fullscreenPass=new e,this.downsample=i.createShader(n.downsample,"downsample");var t=2;this.blurfilter=i.createShader(n.convolution,"blurfilter");var r=2*Math.ceil(3*t)+1;this.blurfilter.defines={KERNEL_SIZE_FLOAT:r.toFixed(1),KERNEL_SIZE_INT:r.toFixed(0)},this.blurfilter.uniforms.cKernel=n.convolution.buildKernel(t),this.oldClearColor=new a(0,0,0,0),this.shadowClearColor=new a(1,1,1,1),this.renderList=[],this.shadowList=[],this.first=!0}var u=new t;return l.prototype._createShadowData=function(t){var e=t.resolution[0],r=t.resolution[1];t.shadowData=t.shadowData||{},t.shadowData.shadowTarget=new o(e,r,{type:"Float",magFilter:"NearestNeighbor",minFilter:"NearestNeighborNoMipMaps"}),t.shadowData.shadowResult=null,"VSM"===t.shadowType&&(t.shadowData.shadowTargetDown=new o(e/2,r/2,{type:"Float"}),t.shadowData.shadowBlurred=new o(e/2,r/2,{type:"Float"})),t.shadowRecord=t.shadowRecord||{},t.shadowRecord.resolution=t.shadowRecord.resolution||[],t.shadowRecord.resolution[0]=e,t.shadowRecord.shadowType=t.shadowType},l.prototype._testStatesEqual=function(t,e){var r=Object.keys(t),i=Object.keys(e);if(r.length!==i.length)return!1;for(var n=0;n<r.length;n++){var o=r[n];if(t[o]!==e[o])return!1}return!0},l.prototype.checkShadowRendering=function(e,i,n,o){if(this.first===!0)return void(this.first=!1);for(var a=0;a<o.length;a++){var h=o[a];if(h.shadowCaster||h.lightCookie){var l=h.shadowSettings;l.shadowData||(this._createShadowData(l),l.shadowData.lightCamera=new r(55,1,1,1e3));var c=l.shadowRecord,p=l.shadowData.lightCamera;if(p.translation.copy(h.translation),h.direction?(u.setv(h.translation).addv(h.direction),p.lookAt(u,l.upVector)):p.lookAt(t.ZERO,l.upVector),c.angle!==h.angle||!c.resolution||c.resolution[0]!==l.resolution[0]||c.resolution[1]!==l.resolution[1]||c.near!==l.near||c.far!==l.far||c.size!==l.size){if(c.resolution&&c.resolution[0]===l.resolution[0]&&c.resolution[1]===l.resolution[1]||this._createShadowData(l),h instanceof d)p.setFrustumPerspective(h.angle,l.resolution[0]/l.resolution[1],l.near,l.far);else if(h instanceof s)p.setFrustumPerspective(90,l.resolution[0]/l.resolution[1],l.near,l.far);else{var f=l.size;p.setFrustum(l.near,l.far,-f,f,f,-f),p.projectionMode=r.Parallel}p.update(),c.resolution=c.resolution||[],c.resolution[0]=l.resolution[0],c.resolution[1]=l.resolution[1],c.angle=h.angle,c.near=l.near,c.far=l.far,c.size=l.size}if("VSM"===l.shadowType&&c.shadowType!==l.shadowType&&(this._createShadowData(l),c.shadowType=l.shadowType),p.onFrameChange(),h.shadowCaster){this.depthMaterial.shader.defines.SHADOW_TYPE="VSM"===l.shadowType?2:0,this.depthMaterial.uniforms.cameraScale=1/(p.far-p.near),this.oldClearColor.copy(e.clearColor),e.setClearColor(this.shadowClearColor.r,this.shadowClearColor.g,this.shadowClearColor.b,this.shadowClearColor.a),this.shadowList.length=0;for(var m=0;m<n.length;m++){var g=n[m];g.meshRendererComponent&&g.meshRendererComponent.castShadows&&!g.isSkybox&&this.shadowList.push(g)}switch(i.process(p,this.shadowList,this.renderList),e.render(this.renderList,p,[],l.shadowData.shadowTarget,!0,this.depthMaterial),l.shadowType){case"VSM":this.fullscreenPass.material.shader=this.downsample,this.fullscreenPass.render(e,l.shadowData.shadowTargetDown,l.shadowData.shadowTarget,0),this.fullscreenPass.material.shader=this.blurfilter,this.fullscreenPass.material.uniforms.uImageIncrement=[2/l.resolution[0],0],this.fullscreenPass.render(e,l.shadowData.shadowBlurred,l.shadowData.shadowTargetDown,0),this.fullscreenPass.material.uniforms.uImageIncrement=[0,2/l.resolution[1]],this.fullscreenPass.render(e,l.shadowData.shadowTargetDown,l.shadowData.shadowBlurred,0),l.shadowData.shadowResult=l.shadowData.shadowTargetDown;break;case"PCF":l.shadowData.shadowResult=l.shadowData.shadowTarget;break;case"Basic":l.shadowData.shadowResult=l.shadowData.shadowTarget;break;default:l.shadowData.shadowResult=l.shadowData.shadowTarget}e.setClearColor(this.oldClearColor.r,this.oldClearColor.g,this.oldClearColor.b,this.oldClearColor.a)}}}},l}),define("goo/renderer/TaskScheduler",["goo/util/PromiseUtil"],function(t){"use strict";function e(){}return function(){window.performance=window.performance||{},performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return Date.now()}}()}(),e.maxTimePerFrame=50,e.each=function(r){return t.createPromise(function(t){function i(){for(var o=performance.now();n<r.length&&performance.now()-o<e.maxTimePerFrame;)r[n](),n++;n<r.length?setTimeout(i,4):t()}var n=0;i()})},e}),define("goo/renderer/Renderer",["goo/renderer/RendererRecord","goo/renderer/Util","goo/renderer/TextureCreator","goo/renderer/pass/RenderTarget","goo/math/Vector4","goo/entities/Entity","goo/renderer/Texture","goo/loaders/dds/DdsLoader","goo/loaders/dds/DdsUtils","goo/renderer/Material","goo/math/Transform","goo/renderer/RenderQueue","goo/renderer/shaders/ShaderLib","goo/renderer/shadow/ShadowHandler","goo/entities/SystemBus","goo/renderer/TaskScheduler"],function(t,e,r,i,n,o,a,s,h,d,l,u,c,p,f,m){"use strict";function g(e){e=e||{};var r=e.canvas;void 0===r&&(r=document.createElement("canvas"),r.width=500,r.height=500),r.screencanvas=!0,this.domElement=r,this._alpha=void 0!==e.alpha?e.alpha:!1,this._premultipliedAlpha=void 0!==e.premultipliedAlpha?e.premultipliedAlpha:!0,this._antialias=void 0!==e.antialias?e.antialias:!0,this._stencil=void 0!==e.stencil?e.stencil:!1,this._preserveDrawingBuffer=void 0!==e.preserveDrawingBuffer?e.preserveDrawingBuffer:!1,this._useDevicePixelRatio=void 0!==e.useDevicePixelRatio?e.useDevicePixelRatio:!1,this._onError=e.onError;var i={alpha:this._alpha,premultipliedAlpha:this._premultipliedAlpha,antialias:this._antialias,stencil:this._stencil,preserveDrawingBuffer:this._preserveDrawingBuffer};if(this.context=null,!window.WebGLRenderingContext)throw{name:"GooWebGLError",message:"WebGL is not supported",supported:!1,enabled:!1};for(var o=["experimental-webgl","webgl","moz-webgl","webkit-3d"],a=0;a<o.length;a++)try{if(this.context=r.getContext(o[a],i),this.context&&"function"==typeof this.context.getParameter)break}catch(l){}if(!this.context)throw{name:"GooWebGLError",message:"WebGL is supported but disabled",supported:!0,enabled:!1};if(e.debug){var c=new XMLHttpRequest;c.open("GET","/js/goo/lib/webgl-debug.js",!1),c.onreadystatechange=function(){4===c.readyState&&c.status>=200&&c.status<=299&&window.eval.call(window,c.responseText)},c.send(null),"undefined"==typeof window.WebGLDebugUtils?console.warn("You need to include webgl-debug.js in your script definition to run in debug mode."):(console.log("Running in webgl debug mode."),e.validate?(console.log('Running with "undefined arguments" validation.'),this.context=window.WebGLDebugUtils.makeDebugContext(this.context,this.onDebugError.bind(this),v)):this.context=window.WebGLDebugUtils.makeDebugContext(this.context,this.onDebugError.bind(this)))}this.rendererRecord=new t,this.glExtensionCompressedTextureS3TC=s.SUPPORTS_DDS=h.isSupported(this.context),this.glExtensionTextureFloat=this.context.getExtension("OES_texture_float"),this.glExtensionTextureFloatLinear=this.context.getExtension("OES_texture_float_linear"),this.glExtensionTextureHalfFloat=this.context.getExtension("OES_texture_half_float"),this.glExtensionStandardDerivatives=this.context.getExtension("OES_standard_derivatives"),this.glExtensionTextureFilterAnisotropic=this.context.getExtension("EXT_texture_filter_anisotropic")||this.context.getExtension("MOZ_EXT_texture_filter_anisotropic")||this.context.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.glExtensionDepthTexture=this.context.getExtension("WEBGL_depth_texture")||this.context.getExtension("WEBKIT_WEBGL_depth_texture")||this.context.getExtension("MOZ_WEBGL_depth_texture"),this.glExtensionElementIndexUInt=this.context.getExtension("OES_element_index_uint"),this.glExtensionTextureFloat||console.log("Float textures not supported."),this.glExtensionTextureFloatLinear||console.log("Float textures with linear filtering not supported."),this.glExtensionStandardDerivatives||console.log("Standard derivatives not supported."),this.glExtensionTextureFilterAnisotropic||console.log("Anisotropic texture filtering not supported."),this.glExtensionCompressedTextureS3TC||console.log("S3TC compressed textures not supported."),this.glExtensionDepthTexture||console.log("Depth textures not supported."),this.glExtensionElementIndexUInt||console.log("32 bit indices not supported."),void 0===this.context.getShaderPrecisionFormat&&(this.context.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}),this.capabilities={maxTexureSize:this.context.getParameter(y.MAX_TEXTURE_SIZE),maxCubemapSize:this.context.getParameter(y.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderbufferSize:this.context.getParameter(y.MAX_RENDERBUFFER_SIZE),maxViewPortDims:this.context.getParameter(y.MAX_VIEWPORT_DIMS),maxAnisotropy:this.glExtensionTextureFilterAnisotropic?this.context.getParameter(this.glExtensionTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,maxVertexTextureUnits:this.context.getParameter(y.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxFragmentTextureUnits:this.context.getParameter(y.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTextureUnits:this.context.getParameter(y.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.context.getParameter(y.MAX_VERTEX_ATTRIBS),maxVertexUniformVectors:this.context.getParameter(y.MAX_VERTEX_UNIFORM_VECTORS),maxFragmentUniformVectors:this.context.getParameter(y.MAX_FRAGMENT_UNIFORM_VECTORS),maxVaryingVectors:this.context.getParameter(y.MAX_VARYING_VECTORS),aliasedPointSizeRange:this.context.getParameter(y.ALIASED_POINT_SIZE_RANGE),aliasedLineWidthRange:this.context.getParameter(y.ALIASED_LINE_WIDTH_RANGE),samples:this.context.getParameter(y.SAMPLES),sampleBuffers:this.context.getParameter(y.SAMPLE_BUFFERS),depthBits:this.context.getParameter(y.DEPTH_BITS),stencilBits:this.context.getParameter(y.STENCIL_BITS),subpixelBits:this.context.getParameter(y.SUBPIXEL_BITS),supportedExtensionsList:this.context.getSupportedExtensions(),renderer:this.context.getParameter(y.RENDERER),vendor:this.context.getParameter(y.VENDOR),version:this.context.getParameter(y.VERSION),shadingLanguageVersion:this.context.getParameter(y.SHADING_LANGUAGE_VERSION),vertexShaderHighpFloat:this.context.getShaderPrecisionFormat(this.context.VERTEX_SHADER,this.context.HIGH_FLOAT),vertexShaderMediumpFloat:this.context.getShaderPrecisionFormat(this.context.VERTEX_SHADER,this.context.MEDIUM_FLOAT),vertexShaderLowpFloat:this.context.getShaderPrecisionFormat(this.context.VERTEX_SHADER,this.context.LOW_FLOAT),fragmentShaderHighpFloat:this.context.getShaderPrecisionFormat(this.context.FRAGMENT_SHADER,this.context.HIGH_FLOAT),fragmentShaderMediumpFloat:this.context.getShaderPrecisionFormat(this.context.FRAGMENT_SHADER,this.context.MEDIUM_FLOAT),fragmentShaderLowpFloat:this.context.getShaderPrecisionFormat(this.context.FRAGMENT_SHADER,this.context.LOW_FLOAT),vertexShaderHighpInt:this.context.getShaderPrecisionFormat(this.context.VERTEX_SHADER,this.context.HIGH_INT),vertexShaderMediumpInt:this.context.getShaderPrecisionFormat(this.context.VERTEX_SHADER,this.context.MEDIUM_INT),vertexShaderLowpInt:this.context.getShaderPrecisionFormat(this.context.VERTEX_SHADER,this.context.LOW_INT),fragmentShaderHighpInt:this.context.getShaderPrecisionFormat(this.context.FRAGMENT_SHADER,this.context.HIGH_INT),fragmentShaderMediumpInt:this.context.getShaderPrecisionFormat(this.context.FRAGMENT_SHADER,this.context.MEDIUM_INT),fragmentShaderLowpInt:this.context.getShaderPrecisionFormat(this.context.FRAGMENT_SHADER,this.context.LOW_INT)},this.maxTextureSize=isNaN(e.maxTextureSize)?this.capabilities.maxTexureSize:Math.min(e.maxTextureSize,this.capabilities.maxTexureSize),this.maxCubemapSize=isNaN(e.maxTextureSize)?this.capabilities.maxCubemapSize:Math.min(e.maxTextureSize,this.capabilities.maxCubemapSize),this.shaderPrecision=e.shaderPrecision||"highp",this.shaderPrecision="highp"===this.shaderPrecision&&this.capabilities.vertexShaderHighpFloat.precision>0&&this.capabilities.fragmentShaderHighpFloat.precision>0?"highp":"lowp"!==this.shaderPrecision&&this.capabilities.vertexShaderMediumpFloat.precision>0&&this.capabilities.fragmentShaderMediumpFloat.precision>0?"mediump":"lowp",this.downScale=e.downScale||1,this.clearColor=new n,this._clearColor=new Float64Array(4),this.setClearColor(.3,.3,.3,1),this.context.clearDepth(1),this.context.clearStencil(0),this.context.stencilMask(0),this.context.enable(y.DEPTH_TEST),this.context.depthFunc(y.LEQUAL),this.viewportX=0,this.viewportY=0,this.viewportWidth=0,this.viewportHeight=0,this.currentWidth=0,this.currentHeight=0,this.devicePixelRatio=1,this._overrideMaterials=[],this._mergedMaterial=new d("Merged Material"),this.renderQueue=new u,this.info={calls:0,vertices:0,indices:0,reset:function(){this.calls=0,this.vertices=0,this.indices=0},toString:function(){return"Calls: "+this.calls+"<br/>Vertices: "+this.vertices+"<br/>Indices: "+this.indices}},this.shadowHandler=new p,this.hardwarePicking=null,f.addListener("goo.setClearColor",function(t){this.setClearColor.apply(this,t)}.bind(this)),document.createElementNS?(this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("xmlns","http://www.w3.org/2000/svg"),this.svg.setAttribute("version","1.1"),this.svg.style.position="absolute",this.svg.style.display="none",document.body.appendChild(this.svg)):this.svg={currentScale:1},f.addListener("goo.setCurrentCamera",function(t){g.mainCamera=t.camera,this.checkResize(g.mainCamera)}.bind(this))}function v(t,e){for(var r=0;r<e.length;++r)void 0===e[r]&&console.error("undefined passed to gl."+t+"("+window.WebGLDebugUtils.glFunctionArgsToString(t,e)+")")}var y=window.WebGLRenderingContext;return g.prototype.onDebugError=function(t,e,r){for(var i="WebGL error "+window.WebGLDebugUtils.glEnumToString(t)+" in "+e+"(",n=0;n<r.length;++n)i+=(0===n?"":", ")+window.WebGLDebugUtils.glFunctionArgToString(e,n,r[n]);i+=")",console.error(i),this._onError&&this._onError(i)},g.mainCamera=null,g.prototype.checkResize=function(t){var e,r,i=this.devicePixelRatio=this._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/this.svg.currentScale:1;document.querySelector?(e=this.domElement.offsetWidth,r=this.domElement.offsetHeight):(e=window.innerWidth,r=window.innerHeight),e=e*i/this.downScale,r=r*i/this.downScale;var n=e,o=r;t&&t.lockedRatio===!0&&t.aspect&&(e=r*t.aspect);var a=e/r;this.setSize(e,r,n,o),t&&t.lockedRatio===!1&&t.aspect!==a&&(t.aspect=a,0===t.projectionMode?t.setFrustumPerspective():t.setFrustum(),t.onFrameChange())},g.prototype.setSize=function(t,e,r,i){if(void 0===r&&(r=t),void 0===i&&(i=e),this.domElement.width=r,this.domElement.height=i,t>r){var n=r/t;t=r,e=i*n}var o=.5*(r-t),a=.5*(i-e);(o!==this.viewportX||a!==this.viewportY||t!==this.viewportWidth||e!==this.viewportHeight)&&(this.setViewport(o,a,t,e),null!==this.hardwarePicking&&(this.hardwarePicking.pickingTarget=null))},g.prototype.setViewport=function(t,e,r,i){this.viewportX=void 0!==t?t:0,this.viewportY=void 0!==e?e:0,this.viewportWidth=void 0!==r?r:this.domElement.width,this.viewportHeight=void 0!==i?i:this.domElement.height,this.context.viewport(this.viewportX,this.viewportY,this.viewportWidth,this.viewportHeight),f.emit("goo.viewportResize",{x:this.viewportX,y:this.viewportY,width:this.viewportWidth,height:this.viewportHeight},!0)},g.prototype.setClearColor=function(t,e,r,i){(this._clearColor[0]!==t||this._clearColor[1]!==e||this._clearColor[2]!==r||this._clearColor[3]!==i)&&(this._clearColor[0]=t,this._clearColor[1]=e,this._clearColor[2]=r,this._clearColor[3]=i,this.clearColor.seta(this._clearColor),this.context.clearColor(t,e,r,i))},g.prototype.bindData=function(t){var e=t.glBuffer;null!==e?(this.setBoundBuffer(e,t.target),t._dataNeedsRefresh&&(this.context.bufferSubData(this.getGLBufferTarget(t.target),0,t.data),t._dataNeedsRefresh=!1)):(e=this.context.createBuffer(),t.glBuffer=e,this.rendererRecord.invalidateBuffer(t.target),this.setBoundBuffer(e,t.target),this.context.bufferData(this.getGLBufferTarget(t.target),t.data,this.getGLBufferUsage(t._dataUsage)))},g.prototype.setShadowType=function(t){this.shadowHandler.shadowType=t},g.prototype.updateShadows=function(t,e,r){this.shadowHandler.checkShadowRendering(this,t,e,r)},g.prototype.preloadTexture=function(t,r){t.bindTexture(this.getGLType(r.variant),r.glTexture),t.pixelStorei(y.UNPACK_ALIGNMENT,r.unpackAlignment),t.pixelStorei(y.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.premultiplyAlpha),t.pixelStorei(y.UNPACK_FLIP_Y_WEBGL,r.flipY);var i=r.image;if("2D"===r.variant)i?(!i.isCompressed&&(r.generateMipmaps||i.width>this.maxTextureSize||i.height>this.maxTextureSize)&&(this.checkRescale(r,i,i.width,i.height,this.maxTextureSize),i=r.image),i.isData===!0?i.isCompressed?this.loadCompressedTexture(t,y.TEXTURE_2D,r,i.data):t.texImage2D(y.TEXTURE_2D,0,this.getGLInternalFormat(r.format),i.width,i.height,r.hasBorder?1:0,this.getGLInternalFormat(r.format),this.getGLPixelDataType(r.type),i.data):t.texImage2D(y.TEXTURE_2D,0,this.getGLInternalFormat(r.format),this.getGLInternalFormat(r.format),this.getGLPixelDataType(r.type),i),r.generateMipmaps&&!i.isCompressed&&t.generateMipmap(y.TEXTURE_2D)):t.texImage2D(y.TEXTURE_2D,0,this.getGLInternalFormat(r.format),r.width,r.height,0,this.getGLInternalFormat(r.format),this.getGLPixelDataType(r.type),null);else if("CUBE"===r.variant){if(i&&(r.generateMipmaps||i.width>this.maxCubemapSize||i.height>this.maxCubemapSize)){for(var n=0;n<a.CUBE_FACES.length;n++)i.data[n]&&!i.data[n].buffer?e.scaleImage(r,i.data[n],i.width,i.height,this.maxCubemapSize,n):e.getBlankImage(r,[.3,.3,.3,0],i.width,i.height,this.maxCubemapSize,n);r.image.width=Math.min(this.maxCubemapSize,e.nearestPowerOfTwo(r.image.width)),r.image.height=Math.min(this.maxCubemapSize,e.nearestPowerOfTwo(r.image.height)),i=r.image}for(var o=0;o<a.CUBE_FACES.length;o++){var s=a.CUBE_FACES[o];i?i.isData===!0?i.isCompressed?this.loadCompressedTexture(t,this.getGLCubeMapFace(s),r,i.data[o]):t.texImage2D(this.getGLCubeMapFace(s),0,this.getGLInternalFormat(r.format),i.width,i.height,r.hasBorder?1:0,this.getGLInternalFormat(r.format),this.getGLPixelDataType(r.type),i.data[o]):t.texImage2D(this.getGLCubeMapFace(s),0,this.getGLInternalFormat(r.format),this.getGLInternalFormat(r.format),this.getGLPixelDataType(r.type),i.data[o]):t.texImage2D(this.getGLCubeMapFace(s),0,this.getGLInternalFormat(r.format),r.width,r.height,0,this.getGLInternalFormat(r.format),this.getGLPixelDataType(r.type),null)}i&&r.generateMipmaps&&!i.isCompressed&&t.generateMipmap(y.TEXTURE_CUBE_MAP)}},g.prototype.preloadTextures=function(t,e){var n=this.context,o=Object.keys(t._textureMaps);o.forEach(function(o){var a=t.getTexture(o);if(void 0!==a){var s=a;a instanceof Array==!1&&(s=[a]),s.forEach(function(t){e.push(function(){(null===t||t instanceof i==!1&&(void 0===t.image||t.checkDataReady()===!1))&&("2D"===t.variant?t=r.DEFAULT_TEXTURE_2D:"CUBE"===t.variant&&(t=r.DEFAULT_TEXTURE_CUBE)),null===t.glTexture?(t.glTexture=n.createTexture(),this.preloadTexture(n,t),t.needsUpdate=!1):t instanceof i==!1&&t.checkNeedsUpdate()&&(this.preloadTexture(n,t),t.needsUpdate=!1)}.bind(this))}.bind(this))}}.bind(this))},g.prototype.preloadMaterials=function(t){var e=[],r={};if(Array.isArray(t))for(var i=0;i<t.length;i++){var n=t[i];if(!(n.isSkybox&&this._overrideMaterials.length>0)){this.fillRenderInfo(n,r);for(var o=0;o<r.materials.length;o++)this.preloadTextures(r.materials[o],e)}}else{this.fillRenderInfo(t,r);for(var o=0;o<r.materials.length;o++)this.preloadTextures(r.materials[o],e)}return m.each(e)},g.prototype.precompileShader=function(t,e,r){var i=t.shader;if(i.processors||i.defines){if(i.processors)for(var n=0;n<i.processors.length;n++)i.processors[n](i,e);for(var o=Object.keys(i.defines),a=o.length,s=[],n=0;a>n;n++){var h=o[n];s.push(h+"_"+i.defines[h])}s.sort();var d=s.join("_")+"_"+i.name,l=this.rendererRecord.shaderCache=this.rendererRecord.shaderCache||{};if(l[d]){if(i=l[d],i!==t.shader){for(var u=t.shader.uniforms,c=Object.keys(u),p=0,f=c.length;f>p;p++){var h=c[p],m=i.uniforms[h]=u[h];m instanceof Array&&(i.uniforms[h]=m.slice(0))}t.shader=i}}else i.builder&&i.builder(i,e),i=t.shader=i.clone(),l[d]=i}r.push(function(){i.precompile(this)}.bind(this))},g.prototype.clearShaderCache=function(){var t=this.rendererRecord.shaderCache;if(t)for(var e=Object.keys(t),r=0;r<e.length;r++)delete t[e[r]]},g.prototype.precompileShaders=function(t,e){var r={lights:e},i=[];if(Array.isArray(t))for(var n=0;n<t.length;n++){var o=t[n];if(!(o.isSkybox&&this._overrideMaterials.length>0)){this.fillRenderInfo(o,r);for(var a=0;a<r.materials.length;a++)r.material=r.materials[a],this.precompileShader(r.materials[a],r,i)}}else{this.fillRenderInfo(t,r);for(var a=0;a<r.materials.length;a++)r.material=r.materials[a],this.precompileShader(r.materials[a],r,i)}return m.each(i)},g.prototype.preloadBuffers=function(t){var e={};if(Array.isArray(t))for(var r=0;r<t.length;r++){var i=t[r];if(!(i.isSkybox&&this._overrideMaterials.length>0)){this.fillRenderInfo(i,e);for(var n=0;n<e.materials.length;n++)e.material=e.materials[n],this.preloadBuffer(i,e.materials[n],e)}}else{this.fillRenderInfo(t,e);for(var n=0;n<e.materials.length;n++)e.material=e.materials[n],this.preloadBuffer(t,e.materials[n],e)}},g.prototype.preloadBuffer=function(t,e,r){var i=r.meshData;if(!(null===i.vertexData||null!==i.vertexData&&0===i.vertexData.data.byteLength||null!==i.indexData&&0===i.indexData.data.byteLength)){this.bindData(i.vertexData),null!==i.getIndexBuffer()&&this.bindData(i.getIndexData());var n=r.materials,o=null,a=i,s=0;s=0===this._overrideMaterials.length?n.length:this._overrideMaterials.length;for(var h=0;s>h;h++){var e=null,d=null;h<n.length&&(e=n[h]),h<this._overrideMaterials.length&&(d=this._overrideMaterials[h]),e&&d?(this._override(d,e,this._mergedMaterial),e=this._mergedMaterial):d&&(e=d),e.shader?(e.errorOnce=!1,e.wireframe&&"wire"!==o?(i.wireframeData||(i.wireframeData=i.buildWireframeData()),i=i.wireframeData,this.bindData(i.vertexData),o="wire"):e.flat&&"flat"!==o?(i.flatMeshData||(i.flatMeshData=i.buildFlatMeshData()),i=i.flatMeshData,this.bindData(i.vertexData),o="flat"):e.wireframe||e.flat||null===o||(i=a,this.bindData(i.vertexData),o=null)):e.errorOnce||(console.warn("No shader set on material: "+e.name),e.errorOnce=!0)}}},g.prototype.render=function(t,r,i,n,o,a){if(this._overrideMaterials=a?a instanceof Array?a:[a]:[],r){null===g.mainCamera&&(g.mainCamera=r),this.setRenderTarget(n),void 0===o||null===o||o===!0?this.clear():"object"==typeof o&&this.clear(o.color,o.depth,o.stencil);var s={camera:r,mainCamera:g.mainCamera,lights:i,shadowHandler:this.shadowHandler,renderer:this};if(Array.isArray(t)){this.renderQueue.sort(t,r);for(var h=0;h<t.length;h++){var d=t[h];d.isSkybox&&this._overrideMaterials.length>0||(this.fillRenderInfo(d,s),this.renderMesh(s))}}else this.fillRenderInfo(t,s),this.renderMesh(s);n&&n.generateMipmaps&&e.isPowerOfTwo(n.width)&&e.isPowerOfTwo(n.height)&&this.updateRenderTargetMipmap(n)}},g.prototype.fillRenderInfo=function(t,e){t instanceof o?(e.meshData=t.meshDataComponent.meshData,e.materials=t.meshRendererComponent.materials,e.transform=t.particleComponent?l.IDENTITY:t.transformComponent.worldTransform,e.currentPose=t.meshDataComponent.currentPose?t.meshDataComponent.currentPose:void 0):(e.meshData=t.meshData,e.materials=t.materials,e.transform=t.transform,e.currentPose=t.currentPose?t.currentPose:void 0),e.renderable=t
},g.prototype._override=function(t,e,r){r.empty();for(var i=Object.keys(r),n=0,o=i.length;o>n;n++){var a=i[n],s=r[a],h=t[a],d=e[a];if(s instanceof Object&&"shader"!==a){for(var l=Object.keys(h),u=0,c=l.length;c>u;u++){var p=l[u];s[p]=h[p]}for(var l=Object.keys(d),u=0,c=l.length;c>u;u++){var p=l[u];void 0===s[p]&&(s[p]=d[p])}}else r[a]=void 0!==h?h:d}},g.prototype.renderMesh=function(t){var e=t.meshData;if(!(!e||null===e.vertexData||null!==e.vertexData&&0===e.vertexData.data.byteLength||null!==e.indexData&&0===e.indexData.data.byteLength)){this.bindData(e.vertexData);var r=t.materials,i=null,n=e,o=0;o=0===this._overrideMaterials.length?r.length:this._overrideMaterials.length;for(var a=0;o>a;a++){var s=null,h=null;if(a<r.length&&(s=r[a]),a<this._overrideMaterials.length&&(h=this._overrideMaterials[a]),s&&h?(this._override(h,s,this._mergedMaterial),s=this._mergedMaterial):h&&(s=h),s.shader){s.errorOnce=!1,s.wireframe&&"wire"!==i?(e.wireframeData||(e.wireframeData=e.buildWireframeData()),e=e.wireframeData,this.bindData(e.vertexData),i="wire"):s.flat&&"flat"!==i?(e.flatMeshData||(e.flatMeshData=e.buildFlatMeshData()),e=e.flatMeshData,this.bindData(e.vertexData),i="flat"):s.wireframe||s.flat||null===i||(e=n,this.bindData(e.vertexData),i=null),t.material=s,t.meshData=e;var d=s.shader;if(d.processors||d.defines){if(d.processors)for(var l=0;l<d.processors.length;l++)d.processors[l](d,t);var u=Object.keys(d.defines),c=u.length,p=this.rendererRecord.shaderKeyArray=this.rendererRecord.shaderKeyArray||[];p.length=0;for(var l=0;c>l;l++){var f=u[l];p.push(f+"_"+d.defines[f])}p.sort();var m=p.join("_")+"_"+d.name,g=this.rendererRecord.shaderCache=this.rendererRecord.shaderCache||{};if(g[m]){if(d=g[m],d!==s.shader){for(var v=s.shader.uniforms,y=Object.keys(v),x=0,_=y.length;_>x;x++){var f=y[x],w=d.uniforms[f]=v[f];w instanceof Array&&(d.uniforms[f]=w.slice(0))}s.shader=d}}else d.builder&&d.builder(d,t),d=s.shader=d.clone(),g[m]=d}d.apply(t,this),this.updateDepthTest(s),this.updateCulling(s),this.updateBlending(s),this.updateOffset(s),this.updateTextures(s),this.updateLineAndPointSettings(s),this._checkDualTransparency(s,e),this.updateCulling(s),this._drawBuffers(e),this.info.calls++,this.info.vertices+=e.vertexCount,this.info.indices+=e.indexCount}else s.errorOnce||(console.warn("No shader set on material: "+s.name),s.errorOnce=!0)}}},g.prototype._drawBuffers=function(t){null!==t.getIndexBuffer()?(this.bindData(t.getIndexData()),null!==t.getIndexLengths()?this.drawElementsVBO(t.getIndexBuffer(),t.getIndexModes(),t.getIndexLengths()):this.drawElementsVBO(t.getIndexBuffer(),t.getIndexModes(),[t.getIndexBuffer().length])):null!==t.getIndexLengths()?this.drawArraysVBO(t.getIndexModes(),t.getIndexLengths()):this.drawArraysVBO(t.getIndexModes(),[t.vertexCount])},g.prototype._checkDualTransparency=function(t,e){if(t.dualTransparency){var r=t.cullState.cullFace,i="Front"===r?"Back":"Front";t.cullState.cullFace=i,this.updateCulling(t),this._drawBuffers(e),t.cullState.cullFace=r}},g.prototype.readPixels=function(t,e,r,i,n){return n=n||new Uint8Array(r*i*4),this.context.readPixels(t,e,r,i,y.RGBA,y.UNSIGNED_BYTE,n),n},g.prototype.readTexturePixels=function(t,e,r,i,n,o){o=o||new Uint8Array(i*n*4);var a=this.context.createFramebuffer();return this.context.bindFramebuffer(y.FRAMEBUFFER,a),this.context.framebufferTexture2D(y.FRAMEBUFFER,y.COLOR_ATTACHMENT0,y.TEXTURE_2D,t.glTexture,0),this.context.checkFramebufferStatus(y.FRAMEBUFFER)===y.FRAMEBUFFER_COMPLETE&&this.context.readPixels(e,r,i,n,y.RGBA,y.UNSIGNED_BYTE,o),o},g.prototype.drawElementsVBO=function(t,e,r){for(var i=0,n=0,o=t.type=t.type||this.getGLArrayType(t),a=this.getGLByteSize(t),s=0;s<r.length;s++){var h=r[s],d=this.getGLIndexMode(e[n]);this.context.drawElements(d,h,o,i*a),i+=h,n<e.length-1&&n++}},g.prototype.drawArraysVBO=function(t,e){for(var r=0,i=0,n=0;n<e.length;n++){var o=e[n],a=this.getGLIndexMode(t[i]);this.context.drawArrays(a,r,o),r+=o,i<t.length-1&&i++}},g.prototype.renderToPick=function(t,e,r,o,a,s,h,l,u){if(this.viewportWidth*this.viewportHeight!==0){var p=4;if(null===this.hardwarePicking){var f=d.createEmptyMaterial(c.pickingShader,"pickingMaterial");f.blendState={blending:"NoBlending",blendEquation:"AddEquation",blendSrc:"SrcAlphaFactor",blendDst:"OneMinusSrcAlphaFactor"},f.wireframe=!1,this.hardwarePicking={pickingTarget:new i(this.viewportWidth/p,this.viewportHeight/p,{minFilter:"NearestNeighborNoMipMaps",magFilter:"NearestNeighbor"}),pickingMaterial:f,pickingBuffer:new Uint8Array(4),clearColorStore:new n},o=!1}else null===this.hardwarePicking.pickingTarget&&(this.hardwarePicking.pickingTarget=new i(this.viewportWidth/p,this.viewportHeight/p,{minFilter:"NearestNeighborNoMipMaps",magFilter:"NearestNeighbor"}),o=!1);if(o)this.setRenderTarget(this.hardwarePicking.pickingTarget);else{if(this.hardwarePicking.clearColorStore.setv(this.clearColor),a&&void 0!==s&&void 0!==h){var m=this._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/this.svg.currentScale:1,g=Math.floor((s*m-this.viewportX)/p),v=Math.floor((this.viewportHeight-(h*m-this.viewportY))/p);this.context.enable(y.SCISSOR_TEST),this.context.scissor(g,v,1,1)}for(var x=[],_=0,w=t.length;w>_;_++){var b=t[_];(!b.meshRendererComponent||b.meshRendererComponent.isPickable)&&x.push(b)}u?this.render(x,e,[],this.hardwarePicking.pickingTarget,r):this.render(x,e,[],this.hardwarePicking.pickingTarget,r,l||this.hardwarePicking.pickingMaterial),a&&this.context.disable(y.SCISSOR_TEST)}}},g.prototype.pick=function(t,e,r,i){if(this.viewportWidth*this.viewportHeight===0)return r.id=-1,void(r.depth=0);var n=this._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/this.svg.currentScale:1,o=4,a=Math.floor((t*n-this.viewportX)/o),s=Math.floor((this.viewportHeight-(e*n-this.viewportY))/o);this.readPixels(a,s,1,1,this.hardwarePicking.pickingBuffer);var h=255*this.hardwarePicking.pickingBuffer[0]+this.hardwarePicking.pickingBuffer[1]-1,d=(this.hardwarePicking.pickingBuffer[2]/255+this.hardwarePicking.pickingBuffer[3]/65025)*i.far;r.id=h,r.depth=d},g.prototype.updateLineAndPointSettings=function(t){var e=this.rendererRecord.lineRecord,r=t.lineWidth||1;e.lineWidth!==r&&(this.context.lineWidth(r),e.lineWidth=r)},g.prototype.updateDepthTest=function(t){var e=this.rendererRecord.depthRecord,r=t.depthState;e.enabled!==r.enabled&&(r.enabled?this.context.enable(y.DEPTH_TEST):this.context.disable(y.DEPTH_TEST),e.enabled=r.enabled),e.write!==r.write&&(this.context.depthMask(r.write?!0:!1),e.write=r.write)},g.prototype.updateCulling=function(t){var e=this.rendererRecord.cullRecord,r=t.cullState.cullFace,i=t.cullState.frontFace,n=t.cullState.enabled;if(e.enabled!==n&&(n?this.context.enable(y.CULL_FACE):this.context.disable(y.CULL_FACE),e.enabled=n),e.cullFace!==r){var o="Front"===r?y.FRONT:"Back"===r?y.BACK:y.FRONT_AND_BACK;this.context.cullFace(o),e.cullFace=r}if(e.frontFace!==i){switch(i){case"CCW":this.context.frontFace(y.CCW);break;case"CW":this.context.frontFace(y.CW)}e.frontFace=i}},g.prototype.updateTextures=function(t){for(var n=this.context,o=t.shader.textureSlots,a=0;a<o.length;a++){var s=o[a],h=t.getTexture(s.mapping);if(void 0!==h){var d=h;h instanceof Array==!1&&(d=[h]);for(var l=0;l<d.length;l++){h=d[l];var u=s.index instanceof Array?s.index[l]:s.index;(null===h||h instanceof i==!1&&(void 0===h.image||h.checkDataReady()===!1))&&("sampler2D"===s.format?h=r.DEFAULT_TEXTURE_2D:"samplerCube"===s.format&&(h=r.DEFAULT_TEXTURE_CUBE));var c=this.rendererRecord.textureRecord[u];void 0===c&&(c=this.rendererRecord.textureRecord[u]={}),null===h.glTexture?(h.glTexture=n.createTexture(),this.updateTexture(n,h,u,c),h.needsUpdate=!1):h instanceof i==!1&&h.checkNeedsUpdate()?(this.updateTexture(n,h,u,c),h.needsUpdate=!1):this.bindTexture(n,h,u,c);var p=void 0!==h.image?h.image:h,f=e.isPowerOfTwo(p.width)&&e.isPowerOfTwo(p.height);this.updateTextureParameters(h,f)}}}},g.prototype.updateTextureParameters=function(t,e){var r=this.context,i=t.textureRecord;void 0===i&&(i={},t.textureRecord=i);var n=this.getGLType(t.variant);i.magFilter!==t.magFilter&&(r.texParameteri(n,y.TEXTURE_MAG_FILTER,this.getGLMagFilter(t.magFilter)),i.magFilter=t.magFilter);var o=e?t.minFilter:this.getFilterFallback(t.minFilter);i.minFilter!==o&&(r.texParameteri(n,y.TEXTURE_MIN_FILTER,this.getGLMinFilter(o)),i.minFilter=o);var a=e?t.wrapS:"EdgeClamp";if(i.wrapS!==a){var s=this.getGLWrap(a,r);r.texParameteri(n,y.TEXTURE_WRAP_S,s),i.wrapS=a}var h=e?t.wrapT:"EdgeClamp";if(i.wrapT!==h){var d=this.getGLWrap(h,r);r.texParameteri(n,y.TEXTURE_WRAP_T,d),i.wrapT=h}if(this.glExtensionTextureFilterAnisotropic&&"Float"!==t.type){var l=t.anisotropy;i.anisotropy!==l&&(r.texParameterf(n,this.glExtensionTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(l,this.capabilities.maxAnisotropy)),i.anisotropy=l)}},g.prototype.bindTexture=function(t,e,r,i){(void 0===i.boundTexture||void 0!==e.glTexture&&i.boundTexture!==e.glTexture)&&(t.activeTexture(y.TEXTURE0+r),t.bindTexture(this.getGLType(e.variant),e.glTexture),i.boundTexture=e.glTexture)},g.prototype.getGLType=function(t){switch(t){case"2D":return y.TEXTURE_2D;case"CUBE":return y.TEXTURE_CUBE_MAP}throw"invalid texture type: "+t},g.prototype.loadCompressedTexture=function(t,e,r,i){var n=r.image.mipmapSizes,o=0,a=0,s=r.image.width,d=r.image.height,l=h.getDdsExtension(t),u=l.COMPRESSED_RGBA_S3TC_DXT5_EXT;if("PrecompressedDXT1"===r.format)u=l.COMPRESSED_RGB_S3TC_DXT1_EXT;else if("PrecompressedDXT1A"===r.format)u=l.COMPRESSED_RGBA_S3TC_DXT1_EXT;else if("PrecompressedDXT3"===r.format)u=l.COMPRESSED_RGBA_S3TC_DXT3_EXT;else{if("PrecompressedDXT5"!==r.format)throw new Error("Unhandled compression format: "+i.getDataFormat().name());u=l.COMPRESSED_RGBA_S3TC_DXT5_EXT}if("undefined"==typeof n||null===n)i instanceof Uint8Array?t.compressedTexImage2D(e,0,u,s,d,0,i):t.compressedTexImage2D(e,0,u,s,d,0,new Uint8Array(i.buffer,i.byteOffset,i.byteLength));else{if(r.generateMipmaps=!1,i instanceof Array)for(var c=0;c<i.length;c++)t.compressedTexImage2D(e,c,u,s,d,0,i[c]),s=~~(s/2)>1?~~(s/2):1,d=~~(d/2)>1?~~(d/2):1;else for(var c=0;c<n.length;c++)a=n[c],t.compressedTexImage2D(e,c,u,s,d,0,new Uint8Array(i.buffer,i.byteOffset+o,a)),s=~~(s/2)>1?~~(s/2):1,d=~~(d/2)>1?~~(d/2):1,o+=a;var p=1+Math.ceil(Math.log(Math.max(r.image.height,r.image.width))/Math.log(2)),f=n[n.length-1];if(n.length<p)for(var c=n.length;p>c;c++)f=~~((s+3)/4)*~~((d+3)/4)*r.image.bpp*2,t.compressedTexImage2D(e,c,u,s,d,0,new Uint8Array(f)),s=~~(s/2)>1?~~(s/2):1,d=~~(d/2)>1?~~(d/2):1}},g.prototype.updateTexture=function(t,r,i,n){t.activeTexture(y.TEXTURE0+i),t.bindTexture(this.getGLType(r.variant),r.glTexture),n.boundTexture=r.glTexture,t.pixelStorei(y.UNPACK_ALIGNMENT,r.unpackAlignment),t.pixelStorei(y.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.premultiplyAlpha),t.pixelStorei(y.UNPACK_FLIP_Y_WEBGL,r.flipY);var o=r.image;if("2D"===r.variant)o?(!o.isCompressed&&(r.generateMipmaps||o.width>this.maxTextureSize||o.height>this.maxTextureSize)&&(this.checkRescale(r,o,o.width,o.height,this.maxTextureSize),o=r.image),o.isData===!0?o.isCompressed?this.loadCompressedTexture(t,y.TEXTURE_2D,r,o.data):t.texImage2D(y.TEXTURE_2D,0,this.getGLInternalFormat(r.format),o.width,o.height,r.hasBorder?1:0,this.getGLInternalFormat(r.format),this.getGLPixelDataType(r.type),o.data):t.texImage2D(y.TEXTURE_2D,0,this.getGLInternalFormat(r.format),this.getGLInternalFormat(r.format),this.getGLPixelDataType(r.type),o),r.generateMipmaps&&!o.isCompressed&&t.generateMipmap(y.TEXTURE_2D)):t.texImage2D(y.TEXTURE_2D,0,this.getGLInternalFormat(r.format),r.width,r.height,0,this.getGLInternalFormat(r.format),this.getGLPixelDataType(r.type),null);else if("CUBE"===r.variant){if(o&&(r.generateMipmaps||o.width>this.maxCubemapSize||o.height>this.maxCubemapSize)){for(var s=0;s<a.CUBE_FACES.length;s++)o.data[s]&&!o.data[s].buffer?e.scaleImage(r,o.data[s],o.width,o.height,this.maxCubemapSize,s):e.getBlankImage(r,[.3,.3,.3,0],o.width,o.height,this.maxCubemapSize,s);r.image.width=Math.min(this.maxCubemapSize,e.nearestPowerOfTwo(r.image.width)),r.image.height=Math.min(this.maxCubemapSize,e.nearestPowerOfTwo(r.image.height)),o=r.image}for(var h=0;h<a.CUBE_FACES.length;h++){var d=a.CUBE_FACES[h];o?o.isData===!0?o.isCompressed?this.loadCompressedTexture(t,this.getGLCubeMapFace(d),r,o.data[h]):t.texImage2D(this.getGLCubeMapFace(d),0,this.getGLInternalFormat(r.format),o.width,o.height,r.hasBorder?1:0,this.getGLInternalFormat(r.format),this.getGLPixelDataType(r.type),o.data[h]):t.texImage2D(this.getGLCubeMapFace(d),0,this.getGLInternalFormat(r.format),this.getGLInternalFormat(r.format),this.getGLPixelDataType(r.type),o.data[h]):t.texImage2D(this.getGLCubeMapFace(d),0,this.getGLInternalFormat(r.format),r.width,r.height,0,this.getGLInternalFormat(r.format),this.getGLPixelDataType(r.type),null)}o&&r.generateMipmaps&&!o.isCompressed&&t.generateMipmap(y.TEXTURE_CUBE_MAP)}},g.prototype.checkRescale=function(t,r,i,n,o,a){e.scaleImage(t,r,i,n,o,a)},g.prototype.getGLWrap=function(t){switch(t){case"Repeat":return y.REPEAT;case"MirroredRepeat":return y.MIRRORED_REPEAT;case"EdgeClamp":return y.CLAMP_TO_EDGE}throw"invalid WrapMode type: "+t},g.prototype.getGLInternalFormat=function(t){switch(t){case"RGBA":return y.RGBA;case"RGB":return y.RGB;case"Alpha":return y.ALPHA;case"Luminance":return y.LUMINANCE;case"LuminanceAlpha":return y.LUMINANCE_ALPHA;default:throw"Unsupported format: "+t}},g.prototype.getGLPixelDataType=function(t){switch(t){case"UnsignedByte":return y.UNSIGNED_BYTE;case"UnsignedShort565":return y.UNSIGNED_SHORT_5_6_5;case"UnsignedShort4444":return y.UNSIGNED_SHORT_4_4_4_4;case"UnsignedShort5551":return y.UNSIGNED_SHORT_5_5_5_1;case"Float":return y.FLOAT;default:throw"Unsupported type: "+t}},g.prototype.getFilterFallback=function(t){switch(t){case"NearestNeighborNoMipMaps":case"NearestNeighborNearestMipMap":case"NearestNeighborLinearMipMap":return"NearestNeighborNoMipMaps";case"BilinearNoMipMaps":case"Trilinear":case"BilinearNearestMipMap":return"BilinearNoMipMaps";default:return"NearestNeighborNoMipMaps"}},g.prototype.getGLMagFilter=function(t){switch(t){case"Bilinear":return y.LINEAR;case"NearestNeighbor":return y.NEAREST}throw"invalid MagnificationFilter type: "+t},g.prototype.getGLMinFilter=function(t){switch(t){case"BilinearNoMipMaps":return y.LINEAR;case"Trilinear":return y.LINEAR_MIPMAP_LINEAR;case"BilinearNearestMipMap":return y.LINEAR_MIPMAP_NEAREST;case"NearestNeighborNoMipMaps":return y.NEAREST;case"NearestNeighborNearestMipMap":return y.NEAREST_MIPMAP_NEAREST;case"NearestNeighborLinearMipMap":return y.NEAREST_MIPMAP_LINEAR}throw"invalid MinificationFilter type: "+t},g.prototype.getGLBufferTarget=function(t){return"ElementArrayBuffer"===t?y.ELEMENT_ARRAY_BUFFER:y.ARRAY_BUFFER},g.prototype.getGLArrayType=function(t){return t instanceof Uint8Array?y.UNSIGNED_BYTE:t instanceof Uint16Array?y.UNSIGNED_SHORT:t instanceof Uint32Array?y.UNSIGNED_INT:t instanceof Int8Array?y.UNSIGNED_BYTE:t instanceof Int16Array?y.UNSIGNED_SHORT:t instanceof Int32Array?y.UNSIGNED_INT:null},g.prototype.getGLByteSize=function(t){return t instanceof Uint8Array?1:t instanceof Uint16Array?2:t instanceof Uint32Array?4:t instanceof Int8Array?1:t instanceof Int16Array?2:t instanceof Int32Array?4:1},g.prototype.getGLCubeMapFace=function(t){switch(t){case"PositiveX":return y.TEXTURE_CUBE_MAP_POSITIVE_X;case"NegativeX":return y.TEXTURE_CUBE_MAP_NEGATIVE_X;case"PositiveY":return y.TEXTURE_CUBE_MAP_POSITIVE_Y;case"NegativeY":return y.TEXTURE_CUBE_MAP_NEGATIVE_Y;case"PositiveZ":return y.TEXTURE_CUBE_MAP_POSITIVE_Z;case"NegativeZ":return y.TEXTURE_CUBE_MAP_NEGATIVE_Z}throw"Invalid cubemap face: "+t},g.prototype.getGLBufferUsage=function(t){var e=y.STATIC_DRAW;switch(t){case"StaticDraw":e=y.STATIC_DRAW;break;case"DynamicDraw":e=y.DYNAMIC_DRAW;break;case"StreamDraw":e=y.STREAM_DRAW}return e},g.prototype.getGLIndexMode=function(t){var e=y.TRIANGLES;switch(t){case"Triangles":e=y.TRIANGLES;break;case"TriangleStrip":e=y.TRIANGLE_STRIP;break;case"TriangleFan":e=y.TRIANGLE_FAN;break;case"Lines":e=y.LINES;break;case"LineStrip":e=y.LINE_STRIP;break;case"LineLoop":e=y.LINE_LOOP;break;case"Points":e=y.POINTS}return e},g.prototype.updateBlending=function(t){var e=this.rendererRecord.blendRecord,r=this.context,i=t.blendState.blending;if(i!==e.blending&&("NoBlending"===i?r.disable(y.BLEND):"AdditiveBlending"===i?(r.enable(y.BLEND),r.blendEquation(y.FUNC_ADD),r.blendFunc(y.SRC_ALPHA,y.ONE)):"SubtractiveBlending"===i?(r.enable(y.BLEND),r.blendEquation(y.FUNC_REVERSE_SUBTRACT),r.blendFunc(y.SRC_ALPHA,y.ONE)):"MultiplyBlending"===i?(r.enable(y.BLEND),r.blendEquation(y.FUNC_ADD),r.blendFunc(y.DST_COLOR,y.ONE_MINUS_SRC_ALPHA)):"AlphaBlending"===i?(r.enable(y.BLEND),r.blendEquation(y.FUNC_ADD),r.blendFunc(y.SRC_ALPHA,y.ONE_MINUS_SRC_ALPHA)):"CustomBlending"===i?r.enable(y.BLEND):"SeparateBlending"===i?(r.enable(y.BLEND),r.blendEquationSeparate(this.getGLBlendParam(t.blendState.blendEquationColor),this.getGLBlendParam(t.blendState.blendEquationAlpha)),r.blendFuncSeparate(this.getGLBlendParam(t.blendState.blendSrcColor),this.getGLBlendParam(t.blendState.blendDstColor),this.getGLBlendParam(t.blendState.blendSrcAlpha),this.getGLBlendParam(t.blendState.blendDstAlpha))):(r.enable(y.BLEND),r.blendEquationSeparate(y.FUNC_ADD,y.FUNC_ADD),r.blendFuncSeparate(y.SRC_ALPHA,y.ONE_MINUS_SRC_ALPHA,y.ONE,y.ONE_MINUS_SRC_ALPHA)),e.blending=i),"CustomBlending"===i){var n=t.blendState.blendEquation,o=t.blendState.blendSrc,a=t.blendState.blendDst;n!==e.blendEquation&&(r.blendEquation(this.getGLBlendParam(n)),e.blendEquation=n),(o!==e.blendSrc||a!==e.blendDst)&&(r.blendFunc(this.getGLBlendParam(o),this.getGLBlendParam(a)),e.blendSrc=o,e.blendDst=a)}else e.blendEquation=null,e.blendSrc=null,e.blendDst=null},g.prototype.updateOffset=function(t){var e=this.rendererRecord.offsetRecord,r=this.context,i=t.offsetState.enabled,n=t.offsetState.factor,o=t.offsetState.units;e.enabled!==i&&(i?r.enable(y.POLYGON_OFFSET_FILL):r.disable(y.POLYGON_OFFSET_FILL),e.enabled=i),!i||e.factor===n&&e.units===o||(r.polygonOffset(n,o),e.factor=n,e.units=o)},g.prototype.setBoundBuffer=function(t,e){var r=this.rendererRecord.currentBuffer[e];r.valid&&r.buffer===t||(this.context.bindBuffer(this.getGLBufferTarget(e),t),r.buffer=t,r.valid=!0)},g.prototype.bindVertexAttribute=function(t,e){this.context.vertexAttribPointer(t,e.count,this.getGLDataType(e.type),e.normalized,e.stride,e.offset)},g.prototype.getGLDataType=function(t){switch(t){case"Float":case"HalfFloat":case"Double":return y.FLOAT;case"Byte":return y.BYTE;case"UnsignedByte":return y.UNSIGNED_BYTE;case"Short":return y.SHORT;case"UnsignedShort":return y.UNSIGNED_SHORT;case"Int":return y.INT;case"UnsignedInt":return y.UNSIGNED_INT;default:throw"Unknown datatype: "+t}},g.prototype.getGLBlendParam=function(t){switch(t){case"AddEquation":return y.FUNC_ADD;case"SubtractEquation":return y.FUNC_SUBTRACT;case"ReverseSubtractEquation":return y.FUNC_REVERSE_SUBTRACT;case"ZeroFactor":return y.ZERO;case"OneFactor":return y.ONE;case"SrcColorFactor":return y.SRC_COLOR;case"OneMinusSrcColorFactor":return y.ONE_MINUS_SRC_COLOR;case"SrcAlphaFactor":return y.SRC_ALPHA;case"OneMinusSrcAlphaFactor":return y.ONE_MINUS_SRC_ALPHA;case"DstAlphaFactor":return y.DST_ALPHA;case"OneMinusDstAlphaFactor":return y.ONE_MINUS_DST_ALPHA;case"DstColorFactor":return y.DST_COLOR;case"OneMinusDstColorFactor":return y.ONE_MINUS_DST_COLOR;case"SrcAlphaSaturateFactor":return y.SRC_ALPHA_SATURATE;default:throw"Unknown blend param: "+t}},g.prototype.clear=function(t,e,r){var i=0;(void 0===t||t)&&(i|=y.COLOR_BUFFER_BIT),(void 0===e||e)&&(i|=y.DEPTH_BUFFER_BIT),(void 0===r||r)&&(i|=y.STENCIL_BUFFER_BIT);var n=this.rendererRecord.depthRecord;n.write!==!0&&(this.context.depthMask(!0),n.write=!0),i&&this.context.clear(i)},g.prototype.flush=function(){this.context.flush()},g.prototype.finish=function(){this.context.finish()},g.prototype.setupFrameBuffer=function(t,e,r){this.context.bindFramebuffer(y.FRAMEBUFFER,t),this.context.framebufferTexture2D(y.FRAMEBUFFER,y.COLOR_ATTACHMENT0,r,e.glTexture,0)},g.prototype.setupRenderBuffer=function(t,e){this.context.bindRenderbuffer(y.RENDERBUFFER,t),e.depthBuffer&&!e.stencilBuffer?(this.context.renderbufferStorage(y.RENDERBUFFER,y.DEPTH_COMPONENT16,e.width,e.height),this.context.framebufferRenderbuffer(y.FRAMEBUFFER,y.DEPTH_ATTACHMENT,y.RENDERBUFFER,t)):e.depthBuffer&&e.stencilBuffer?(this.context.renderbufferStorage(y.RENDERBUFFER,y.DEPTH_STENCIL,e.width,e.height),this.context.framebufferRenderbuffer(y.FRAMEBUFFER,y.DEPTH_STENCIL_ATTACHMENT,y.RENDERBUFFER,t)):this.context.renderbufferStorage(y.RENDERBUFFER,y.RGBA4,e.width,e.height)},g.prototype.setRenderTarget=function(t){if(t&&!t._glFrameBuffer){void 0===t.depthBuffer&&(t.depthBuffer=!0),void 0===t.stencilBuffer&&(t.stencilBuffer=!0),t.glTexture=this.context.createTexture();var r=e.isPowerOfTwo(t.width)&&e.isPowerOfTwo(t.height),i=this.getGLInternalFormat(t.format),n=this.getGLDataType(t.type);t._glFrameBuffer=this.context.createFramebuffer(),t._glRenderBuffer=this.context.createRenderbuffer(),this.context.bindTexture(y.TEXTURE_2D,t.glTexture),this.updateTextureParameters(t,r),this.context.texImage2D(y.TEXTURE_2D,0,i,t.width,t.height,0,i,n,null),this.setupFrameBuffer(t._glFrameBuffer,t,y.TEXTURE_2D),this.setupRenderBuffer(t._glRenderBuffer,t),t.generateMipmaps&&r&&this.context.generateMipmap(y.TEXTURE_2D),this.context.bindTexture(y.TEXTURE_2D,null),this.context.bindRenderbuffer(y.RENDERBUFFER,null),this.context.bindFramebuffer(y.FRAMEBUFFER,null)}var o,a,s,h,d;t?(o=t._glFrameBuffer,h=0,d=0,a=t.width,s=t.height):(o=null,h=this.viewportX,d=this.viewportY,a=this.viewportWidth,s=this.viewportHeight),o!==this.rendererRecord.currentFrameBuffer&&(this.context.bindFramebuffer(y.FRAMEBUFFER,o),this.context.viewport(h,d,a,s),this.rendererRecord.currentFrameBuffer=o,this.rendererRecord.textureRecord=[]),this.currentWidth=a,this.currentHeight=s},g.prototype.updateRenderTargetMipmap=function(t){this.context.bindTexture(y.TEXTURE_2D,t.glTexture),this.context.generateMipmap(y.TEXTURE_2D),this.context.bindTexture(y.TEXTURE_2D,null)},g.prototype.getCapabilitiesString=function(){var t=[],e=function(t){return t&&t.buffer instanceof ArrayBuffer&&void 0!==t.byteLength};for(var r in this.capabilities){var i=this.capabilities[r],n="";if(e(i)){n+="[";for(var o=0;o<i.length;o++)n+=i[o],o<i.length-1&&(n+=",");n+="]"}else n=i;t.push(r+": "+n)}return t.join("\n")},g.prototype._deallocateMeshData=function(t){t.destroy(this.context)},g.prototype._deallocateTexture=function(t){t.destroy(this.context)},g.prototype._deallocateRenderTarget=function(t){t.destroy(this.context)},g.prototype._deallocateShader=function(t){t.destroy()},g}),define("goo/entities/systems/TransformSystem",["goo/entities/systems/System"],function(t){"use strict";function e(){t.call(this,"TransformSystem",["TransformComponent"]),this.numUpdates=0}function r(t){if(t.transformComponent._dirty){t.transformComponent.updateWorldTransform(),i++;for(var e=t.transformComponent.children,r=0;r<e.length;r++)e[r]._dirty=!0}}var i;return e.prototype=Object.create(t.prototype),e.prototype.process=function(t){i=0;var e,n;for(e=0;e<t.length;e++)n=t[e].transformComponent,n._updated=!1,n._dirty&&n.updateTransform();for(e=0;e<t.length;e++){var o=t[e];n=o.transformComponent,null===n.parent&&o.traverse(r)}this.numUpdates=i},e}),define("goo/renderer/SimplePartitioner",["goo/renderer/Camera"],function(t){"use strict";function e(){}return e.prototype.added=function(){},e.prototype.removed=function(){},e.prototype.process=function(e,r,i){for(var n=0,o=0;o<r.length;o++){var a=r[o];if(!a.skip&&!a.meshRendererComponent.hidden)if("Never"===a.meshRendererComponent.cullMode)i[n++]=a,a.isVisible=!0;else{var s=a.meshRendererComponent.worldBound,h=e.contains(s);h!==t.Outside?(i[n++]=a,a.isVisible=!0):a.isVisible=!1}}i.length=n},e}),define("goo/entities/systems/RenderSystem",["goo/entities/systems/System","goo/entities/SystemBus","goo/renderer/SimplePartitioner","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/renderer/Util"],function(t,e,r,i,n,o){"use strict";function a(){t.call(this,"RenderSystem",["MeshRendererComponent","MeshDataComponent"]),this.entities=[],this.renderList=[],this.postRenderables=[],this.partitioner=new r,this.preRenderers=[],this.composers=[],this._composersActive=!0,this.doRender=!0,this._debugMaterials={},this.overrideMaterials=[],this.camera=null,this.lights=[],this.currentTpf=0;var i=this;e.addListener("goo.setCurrentCamera",function(t){i.camera=t.camera}),e.addListener("goo.setLights",function(t){i.lights=t}),this.picking={doPick:!1,x:0,y:0,pickingStore:{},pickingCallback:function(t,e){console.log(t,e)},skipUpdateBuffer:!1}}return a.prototype=Object.create(t.prototype),a.prototype.pick=function(t,e,r,i){this.picking.x=t,this.picking.y=e,this.picking.skipUpdateBuffer=void 0===i?!1:i,r&&(this.picking.pickingCallback=r),this.picking.doPick=!0},a.prototype.inserted=function(t){this.partitioner&&this.partitioner.added(t)},a.prototype.deleted=function(t){this.partitioner&&this.partitioner.removed(t)},a.prototype.process=function(t,e){this.entities=t,this.currentTpf=e},a.prototype.render=function(t){if(this.doRender&&this.camera){t.updateShadows(this.partitioner,this.entities,this.lights);for(var e=0;e<this.preRenderers.length;e++){var r=this.preRenderers[e];r.process(t,this.entities,this.partitioner,this.camera,this.lights)}if(this.partitioner.process(this.camera,this.entities,this.renderList),this.composers.length>0&&this._composersActive)for(var e=0;e<this.composers.length;e++){var i=this.composers[e];i.render(t,this.currentTpf,this.camera,this.lights,null,!0,this.overrideMaterials)}else t.render(this.renderList,this.camera,this.lights,null,!0,this.overrideMaterials)}},a.prototype.renderToPick=function(t,e){t.renderToPick(this.renderList,this.camera,!0,e)},a.prototype.enableComposers=function(t){this._composersActive=!!t},a.prototype._createDebugMaterial=function(t){if(""!==t){var e;switch(t){case"wireframe":case"color":e=o.clone(n.simpleColored.fshader);break;case"lit":e=o.clone(n.simpleLit.fshader);break;case"texture":e=o.clone(n.textured.fshader);break;case"normals":e=o.clone(n.showNormals.fshader);break;case"simple":e=o.clone(n.simple.fshader)}var r=o.clone(n.uber);r.fshader=e,"flat"!==t?(this._debugMaterials[t]=new i(r,t),"wireframe"===t&&(this._debugMaterials[t].wireframe=!0),"lit"===t&&(this._debugMaterials[t]._textureMaps={EMISSIVE_MAP:null,DIFFUSE_MAP:null,SPECULAR_MAP:null,NORMAL_MAP:null,AO_MAP:null,LIGHT_MAP:null,TRANSPARENCY_MAP:null})):(this._debugMaterials[t]=i.createEmptyMaterial(null,t),this._debugMaterials[t].flat=!0)}},a.prototype.setDebugMaterial=function(t){if(!t||""===t)return void(this.overrideMaterials=[]);var e=t.split("+");this.overrideMaterials=[];for(var r=0;r<e.length;r++){var t=e[r];this._debugMaterials[t]||this._createDebugMaterial(t),this.overrideMaterials.push(""===t?null:this._debugMaterials[t])}},a}),define("goo/entities/systems/BoundingUpdateSystem",["goo/entities/systems/System","goo/renderer/bounds/BoundingBox"],function(t,e){"use strict";function r(){t.call(this,"BoundingUpdateSystem",["TransformComponent","MeshRendererComponent","MeshDataComponent"]),this._worldBound=new e,this._computeWorldBound=null}return r.prototype=Object.create(t.prototype),r.prototype.process=function(t){for(var e=0;e<t.length;e++){var r=t[e],i=r.meshDataComponent,n=r.transformComponent,o=r.meshRendererComponent;i.autoCompute?(i.computeBoundFromPoints(),o.updateBounds(i.modelBound,n.worldTransform)):n._updated&&o.updateBounds(i.modelBound,n.worldTransform)}if(this._computeWorldBound&&this._computeWorldBound instanceof Function){if(0===t.length)return void(this._computeWorldBound=null);for(var e=0;e<t.length;e++)if(!t[e].particleComponent){this._worldBound=t[e].meshRendererComponent.worldBound.clone();break}for(;e<t.length;e++)if(!t[e].particleComponent){var a=t[e].meshRendererComponent;this._worldBound=this._worldBound.merge(a.worldBound)}this._computeWorldBound(this._worldBound),this._computeWorldBound=null}},r.prototype.getWorldBound=function(t){this._computeWorldBound=t},r.prototype.deleted=function(t){t.meshRendererComponent&&(t.meshRendererComponent.worldBound=new e)},r}),define("goo/entities/systems/ScriptSystem",["goo/entities/systems/System","goo/entities/SystemBus","goo/util/ObjectUtil","goo/scripts/Scripts"],function(t,e,r,i){"use strict";function n(r){t.call(this,"ScriptSystem",["ScriptComponent"]),this._world=r;var i=this._world.gooRunner.renderer;this.context={domElement:i.domElement,viewportWidth:i.viewportWidth,viewportHeight:i.viewportHeight,world:r,activeCameraEntity:null,worldData:{}},e.addListener("goo.setCurrentCamera",function(t){this.context.activeCameraEntity=t.entity}.bind(this)),e.addListener("goo.viewportResize",function(t){this.context.viewportWidth=t.width,this.context.viewportHeight=t.height}.bind(this)),this.manualSetup=!1,this.priority=500}return n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n.prototype.process=function(t,e){for(var r=0;r<t.length;r++){var i=t[r].scriptComponent;i.run(t[r],e)}},n.prototype.addedComponent=function(t,e){"ScriptComponent"!==e.type||this.manualSetup||e.setup(t)},n.prototype.removedComponent=function(t,e){"ScriptComponent"!==e.type||this.manualSetup||e.cleanup()},n.prototype.clear=function(){for(var e=0;e<this._activeEntities.length;e++){var r=this._activeEntities[e];r.scriptComponent.cleanup()}this._world=null,this.context=null,t.prototype.clear.call(this)},i.addClass("ScriptSystem",n),n}),define("goo/entities/systems/LightingSystem",["goo/entities/systems/System","goo/entities/SystemBus"],function(t,e){"use strict";function r(){t.call(this,"LightingSystem",["LightComponent","TransformComponent"]),this.overrideLights=null,this._needsUpdate=!0,this.lights=[]}return r.prototype=Object.create(t.prototype),r.prototype.setOverrideLights=function(t){this.overrideLights=t,e.emit("goo.setLights",this.overrideLights),this._needsUpdate=!0},r.prototype.clearOverrideLights=function(){this.overrideLights=void 0,this._needsUpdate=!0},r.prototype.process=function(t){if(!this.overrideLights){this.lights.length=0;for(var r=0;r<t.length;r++){var i=t[r],n=i.transformComponent,o=i.lightComponent;(n._updated||this._needsUpdate)&&o.updateLight(n.worldTransform),o.hidden||this.lights.push(o.light)}this._needsUpdate=!1,e.emit("goo.setLights",this.lights)}},r}),define("goo/entities/systems/CameraSystem",["goo/entities/systems/System","goo/entities/SystemBus","goo/renderer/Renderer"],function(t,e,r){"use strict";function i(){t.call(this,"CameraSystem",["TransformComponent","CameraComponent"]),this.mainCamera=null}return i.prototype=Object.create(t.prototype),i.prototype.constructor=i,i.prototype.findMainCamera=function(){if(this._activeEntities.length){var t=this._activeEntities[0];e.emit("goo.setCurrentCamera",{camera:t.cameraComponent.camera,entity:t})}},i.prototype.inserted=function(t){r.mainCamera||e.emit("goo.setCurrentCamera",{camera:t.cameraComponent.camera,entity:t})},i.prototype.deleted=function(){},i.prototype.process=function(){for(var t=0;t<this._activeEntities.length;t++){var e=this._activeEntities[t],r=e.transformComponent,i=e.cameraComponent;r._updated&&i.updateCamera(r.worldTransform)}},i}),define("goo/entities/systems/ParticlesSystem",["goo/entities/systems/System"],function(t){"use strict";function e(){t.call(this,"ParticlesSystem",["TransformComponent","MeshRendererComponent","MeshDataComponent","ParticleComponent"]),this.passive=!1}return e.prototype=Object.create(t.prototype),e.prototype.process=function(t,e){if(!(e>1))for(var r=0,i=t.length;i>r;r++){var n=t[r],o=n.particleComponent;o.enabled&&this.updateParticles(n,o,e)}},e.prototype.updateParticles=function(t,e,r){for(var i,n=0,o=-1,a=!1,s=!1;n<e.particleCount;){for(;void 0===i;)if(o++,e.emitters.length>o){if(i=e.emitters[o],i.influences.length)for(var h=0,d=i.influences.length;d>h;h++)i.influences[h].prepare(t,i);if(!i.enabled){i=void 0;
continue}if(0!==i.totalParticlesToSpawn&&(i.particlesWaitingToRelease+=i.releaseRatePerSecond*r,i.particlesWaitingToRelease=Math.max(i.particlesWaitingToRelease,0),s=!0),i.particlesWaitingToRelease<1){i=void 0;continue}}else i=null;var l=e.particles[n];if(l.alive&&l.emitter&&l.emitter.influences.length)for(var h=0,d=l.emitter.influences.length;d>h;h++)l.emitter.influences[h].enabled&&l.emitter.influences[h].apply(r,l,n);l.alive&&(l.update(r,t),a=!0,s=!0),!l.alive&&i&&(i.particlesWaitingToRelease--,i.totalParticlesToSpawn>=1&&i.totalParticlesToSpawn--,l.respawnParticle(i),i.getEmissionPoint(l,t),i.getEmissionVelocity(l,t),(i.particlesWaitingToRelease<1||0===i.totalParticlesToSpawn)&&(i=void 0)),n++}a&&(e.meshData.vertexData._dataNeedsRefresh=!0,t.meshDataComponent.autoCompute=!0),s||(e.enabled=!1)},e}),define("goo/util/Stats",[],function(){"use strict";function t(){var t=Date.now(),e=t,r=t,i=0,n=1/0,o=0,a=0,s=1/0,h=0,d=0,l=0,u=document.createElement("div");u.id="stats",u.addEventListener("mousedown",function(t){t.preventDefault(),w(++l%2)},!1),u.style.cssText="width:80px;cursor:pointer;z-index:1000;-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;";var c=document.createElement("div");c.id="fps",c.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",u.appendChild(c);var p=document.createElement("div");p.id="fpsText",p.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:8px;font-weight:bold;line-height:13px",p.innerHTML="FPS",c.appendChild(p);var f=document.createElement("div");for(f.id="fpsGraph",f.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",c.appendChild(f);f.children.length<74;){var m=document.createElement("span");m.style.cssText="width:1px;height:30px;float:left;background-color:#113",f.appendChild(m)}var g=document.createElement("div");g.id="ms",g.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",u.appendChild(g);var v=document.createElement("div");v.id="msText",v.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:8px;font-weight:bold;line-height:13px",v.innerHTML="MS",g.appendChild(v);var y=document.createElement("div");for(y.id="msGraph",y.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",g.appendChild(y);y.children.length<74;){var m=document.createElement("span");m.style.cssText="width:1px;height:30px;float:left;background-color:#131",y.appendChild(m)}var x=document.createElement("div");x.id="info",x.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#200",u.appendChild(x);var _=document.createElement("div");_.id="infoText",_.style.cssText="color:#f66;font-family:Helvetica,Arial,sans-serif;font-size:8px;font-weight:bold;line-height:13px",_.innerHTML="INFO",x.appendChild(_);var w=function(t){switch(l=t){case 0:c.style.display="block",g.style.display="none";break;case 1:c.style.display="none",g.style.display="block"}},b=function(t,e){var r=t.appendChild(t.firstChild);r.style.height=e+"px"};this.domElement=u,this.setMode=w,this.begin=function(){t=Date.now()},this.end=function(l){var u=Date.now();return u>r+100&&(i=u-t,n=Math.min(n,i),o=Math.max(o,i),v.textContent=i+" MS ("+n+"-"+o+")",b(y,Math.min(30,30-i/200*30)),r=u,l&&(_.innerHTML=l)),d++,u>e+1e3&&(a=Math.round(1e3*d/(u-e)),s=Math.min(s,a),h=Math.max(h,a),p.textContent=a+" FPS ("+s+"-"+h+")",b(f,Math.min(30,30-a/(Math.min(500,h)+10)*30)),e=u,d=0),u},this.update=function(e){t=this.end(e)}}return t}),define("goo/entities/systems/SoundSystem",["goo/entities/systems/System","goo/sound/AudioContext","goo/math/Vector3","goo/math/MathUtils","goo/entities/SystemBus","goo/util/ObjectUtil","goo/math/Matrix4x4"],function(t,e,r,i,n,o,a){"use strict";function s(){if(!e)return void console.warn("Cannot create soundsystem, webaudio not supported");t.call(this,"SoundSystem",["SoundComponent","TransformComponent"]),this.entities=[],this._outNode=e.createGain(),this._outNode.connect(e.destination),this._wetNode=e.createGain(),this._wetNode.connect(this._outNode),this._convolver=e.createConvolver(),this._convolver.connect(this._wetNode),this._listener=e.listener,this._listener.dopplerFactor=0,this._relativeTransform=new a,this._camera=null,this._settings={rolloffFactor:.4,maxDistance:100},this._wetNode.gain.value=.2,this._pausedSounds={},this._listener.setPosition(0,0,0),this._listener.setVelocity(0,0,0),this._listener.setOrientation(0,0,-1,0,1,0);var r=this;n.addListener("goo.setCurrentCamera",function(t){r._camera=t.camera})}return s.prototype=Object.create(t.prototype),s.prototype.constructor=s,s.prototype.inserted=function(t){t.soundComponent.connectTo({dry:this._outNode,wet:this._convolver})},s.prototype.deleted=function(t){if(t.soundComponent){for(var e=t.soundComponent.sounds,r=0;r<e.length;r++)e[r].stop();t.soundComponent.connectTo(this._outNode)}},s.prototype.updateConfig=function(t){return e?(o.extend(this._settings,t),void 0!==t.dopplerFactor&&(this._listener.dopplerFactor=.05*t.dopplerFactor),void 0!==t.volume&&(this._outNode.gain.value=i.clamp(t.volume,0,1)),void(void 0!==t.reverb&&(this._wetNode.gain.value=i.clamp(t.reverb,0,1)))):void console.warn("Webaudio not supported")},s.prototype.setReverb=function(t){return e?(this._wetNode.disconnect(),void(!t&&this._wetNode?this._convolver.buffer=null:(this._convolver.buffer=t,this._wetNode.connect(this._outNode)))):void console.warn("Webaudio not supported")},s.prototype.pause=function(){if(!this._pausedSounds){this._pausedSounds={};for(var t=0;t<this.entities.length;t++)for(var e=this.entities[t].soundComponent.sounds,r=0;r<e.length;r++){var i=e[r];i.isPlaying()&&(i.pause(),this._pausedSounds[i.id]=!0)}}},s.prototype.stop=function(){for(var t=0;t<this.entities.length;t++)for(var e=this.entities[t].soundComponent.sounds,r=0;r<e.length;r++){var i=e[r];i.stop()}this._pausedSounds=null},s.prototype.resume=function(){if(this._pausedSounds){for(var t=0;t<this.entities.length;t++)for(var e=this.entities[t].soundComponent.sounds,r=0;r<e.length;r++){var i=e[r];this._pausedSounds[i.id]&&i.play()}this._pausedSounds=null}},s.prototype.process=function(t,r){if(e){this.entities=t;var i,n=this._relativeTransform;this._camera&&(i=this._camera.getViewMatrix());for(var o=0;o<t.length;o++){var s=t[o],h=s.soundComponent;h._attachedToCamera=!(!s.cameraComponent||s.cameraComponent.camera!==this._camera),this._camera&&!h._attachedToCamera?(a.combine(i,s.transformComponent.worldTransform.matrix,n),h.process(this._settings,n,r)):h.process(this._settings,null,r)}}},s}),define("goo/entities/components/MeshDataComponent",["goo/renderer/bounds/BoundingBox","goo/entities/components/Component","goo/renderer/MeshData"],function(t,e,r){"use strict";function i(e){this.type="MeshDataComponent",this.meshData=e,this.modelBound=new t,this.autoCompute=!0,this.currentPose=null}return i.type="MeshDataComponent",i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.setModelBound=function(t,e){this.modelBound=t,this.autoCompute=e},i.prototype.computeBoundFromPoints=function(){if(this.autoCompute&&null!==this.modelBound&&this.meshData){var t=this.meshData.getAttributeBuffer("POSITION");void 0!==t&&(this.modelBound.computeFromPoints(t),this.autoCompute=!1)}},i.applyOnEntity=function(t,e){if(t instanceof r){var n=new i(t);return e.setComponent(n),!0}},i}),define("goo/entities/components/MeshRendererComponent",["goo/entities/components/Component","goo/renderer/Material"],function(t,e){"use strict";function r(t){this.type="MeshRendererComponent",this.materials=Array.isArray(t)?t:t?[t]:[],this.worldBound=null,this.cullMode="Dynamic",this.castShadows=!0,this.receiveShadows=!0,this.isPickable=!0,this.isReflectable=!0,this.hidden=!1,this._renderDistance=0}return r.prototype=Object.create(t.prototype),r.prototype.constructor=r,r.prototype.api={setDiffuse:function(){var t=this.meshRendererComponent.materials[0];t.uniforms.materialDiffuse||(t.uniforms.materialDiffuse=[0,0,0,1]);var e=t.uniforms.materialDiffuse;if(arguments.length>=3)e[0]=arguments[0],e[1]=arguments[1],e[2]=arguments[2],e[3]=3===arguments.length?1:arguments[3];else{var r=arguments[0];r instanceof Array?(e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=3===r.length?1:r[3]):void 0!==r.r&&void 0!==r.g&&void 0!==typeof r.b&&(e[0]=r.r,e[1]=r.g,e[2]=r.b,e[3]=void 0===r.a?1:r.a)}},getDiffuse:function(){return this.meshRendererComponent.materials[0].uniforms.materialDiffuse}},r.prototype.updateBounds=function(t,e){this.worldBound=t.transform(e,this.worldBound)},r.applyOnEntity=function(t,i){var n=i.meshRendererComponent;n||(n=new r);var o=!1;return t instanceof e&&(n.materials.push(t),o=!0),o?(i.setComponent(n),!0):void 0},r}),define("goo/entities/components/CameraComponent",["goo/entities/components/Component","goo/math/Vector3","goo/renderer/Camera","goo/entities/SystemBus"],function(t,e,r,i){"use strict";function n(t){this.type="CameraComponent",this.camera=t,this.leftVec=new e(-1,0,0),this.upVec=new e(0,1,0),this.dirVec=new e(0,0,-1)}return n.type="CameraComponent",n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n.prototype.api={setAsMainCamera:function(){return i.emit("goo.setCurrentCamera",{camera:this.cameraComponent.camera,entity:this}),this}},n.prototype.setUpVector=function(t){0===t?(this.leftVec.setd(0,-1,0),this.upVec.setd(1,0,0),this.dirVec.setd(0,0,-1)):2===t?(this.leftVec.setd(-1,0,0),this.upVec.setd(0,0,1),this.dirVec.setd(0,-1,0)):(this.leftVec.setd(-1,0,0),this.upVec.setd(0,1,0),this.dirVec.setd(0,0,-1))},n.prototype.updateCamera=function(t){this.camera._left.setv(this.leftVec),t.rotation.applyPost(this.camera._left),this.camera._up.setv(this.upVec),t.rotation.applyPost(this.camera._up),this.camera._direction.setv(this.dirVec),t.rotation.applyPost(this.camera._direction),t.matrix.getTranslation(this.camera.translation),this.camera.update()},n.applyOnEntity=function(t,e){if(t instanceof r){var i=new n(t);return e.setComponent(i),!0}},n}),define("goo/entities/components/LightComponent",["goo/entities/components/Component","goo/renderer/light/Light"],function(t,e){"use strict";function r(t){this.type="LightComponent",this.light=t,this.hidden=!1}return r.prototype=Object.create(t.prototype),r.prototype.updateLight=function(t){this.light.update(t)},r.applyOnEntity=function(t,i){if(t instanceof e){var n=new r(t);return i.setComponent(n),!0}},r}),define("goo/entities/components/ScriptComponent",["goo/entities/components/Component","goo/entities/SystemBus","goo/scripts/Scripts","goo/util/ObjectUtil"],function(t,e,r,i){"use strict";function n(t){this.type="ScriptComponent",this._gooClasses=r.getClasses(),this.scripts=t instanceof Array?t:t?[t]:[]}return n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n.prototype.setup=function(t){var e=t._world.getSystem("ScriptSystem").context,r=Object.create(e);i.extend(r,{entity:t,entityData:{}});for(var n=0;n<this.scripts.length;n++){var o=this.scripts[n];if(!o.context&&(o.context=Object.create(r),o.enabled=o.parameters&&void 0!==o.parameters.enabled?o.parameters.enabled:!0,o.setup&&o.enabled))try{o.setup(o.parameters,o.context,this._gooClasses)}catch(a){this._handleError(o,a,"setup")}}},n.prototype.run=function(t){for(var e=0;e<this.scripts.length;e++){var r=this.scripts[e];if(r&&r.run&&(void 0===r.enabled||r.enabled))try{r.run(t,t._world.tpf,r.context,r.parameters)}catch(i){}else if(r.update&&(void 0===r.enabled||r.enabled))try{r.update(r.parameters,r.context,this._gooClasses)}catch(i){this._handleError(r,i,"update")}}},n.prototype.cleanup=function(){for(var t=0;t<this.scripts.length;t++){var e=this.scripts[t];if(e.context){if(e.cleanup)try{e.cleanup(e.parameters,e.context,this._gooClasses)}catch(r){this._handleError(e,r,"cleanup")}e.enabled=!1,e.context=null}}},n.prototype._handleError=function(t,r,i){t.enabled=!1;var n={id:t.id,errors:[{message:r.message||r,phase:i}]},o=r.stack.split("\n")[1].match(/(\d+):\d+\)$/);o&&(n.errors[0].line=parseInt(o[1],10)-1),console.error(n.errors[0].message,n),e.emit("goo.scriptError",n)},n.applyOnEntity=function(t,e){if(t instanceof Function||t&&t.run instanceof Function||t&&t.update instanceof Function){var r;return e.scriptComponent?r=e.scriptComponent:(r=new n,e.setComponent(r)),r.scripts.push(t.run instanceof Function||t.update instanceof Function?t:{run:t}),!0}},n}),define("goo/entities/components/SoundComponent",["goo/entities/components/Component","goo/sound/AudioContext","goo/math/Vector3","goo/math/MathUtils"],function(t,e,r,i){"use strict";function n(){this.type="SoundComponent",this.sounds=[],this._isPanned=!0,this._outDryNode=e.createGain(),this._outWetNode=e.createGain(),this.connectTo(),this._pannerNode=e.createPanner(),this._pannerNode.connect(this._outDryNode),this._inNode=e.createGain(),this._inNode.connect(this._pannerNode),this._oldPosition=new r,this._position=new r,this._orientation=new r,this._velocity=new r,this._attachedToCamera=!1}return n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n.prototype.addSound=function(t){-1===this.sounds.indexOf(t)&&(t.connectTo([this._inNode,this._outWetNode]),this.sounds.push(t))},n.prototype.removeSound=function(t){var e=this.sounds.indexOf(t);e>-1&&(t.stop(),this.sounds.splice(e,1),t.connectTo())},n.prototype.getSoundById=function(t){for(var e=0;e<this.sounds.length;e++)if(this.sounds[e].id===t)return this.sounds[e]},n.prototype.connectTo=function(t){this._outDryNode.disconnect(),this._outWetNode.disconnect(),t&&t.dry&&this._outDryNode.connect(t.dry),t&&t.wet&&this._outWetNode.connect(t.wet)},n.prototype.updateConfig=function(t){void 0!==t.volume&&(this._outDryNode.gain.value=i.clamp(t.volume,0,1)),void 0!==t.reverb&&(this._outWetNode.gain.value=i.clamp(t.reverb,0,1))},n.prototype.process=function(t,e,r){if(this._pannerNode.rolloffFactor=t.rolloffFactor,this._pannerNode.maxDistance=t.maxDistance,this._attachedToCamera||!e)return this._isPanned&&(this._inNode.disconnect(),this._inNode.connect(this._outDryNode),this._isPanned=!1),this._pannerNode.setPosition(0,0,0),this._pannerNode.setVelocity(0,0,0),void this._pannerNode.setOrientation(0,0,0);this._isPanned||(this._inNode.disconnect(),this._inNode.connect(this._pannerNode),this._isPanned=!0),e.getTranslation(this._position),this._velocity.setv(this._position).subv(this._oldPosition).div(r),this._oldPosition.setv(this._position),this._orientation.setd(0,0,-1),e.applyPostVector(this._orientation);var i=this._position.data;this._pannerNode.setPosition(i[0],i[1],i[2]);var n=this._velocity.data;this._pannerNode.setVelocity(n[0],n[1],n[2]);var o=this._orientation.data;this._pannerNode.setOrientation(o[0],o[1],o[2])},n}),define("goo/util/GameUtils",[],function(){"use strict";function t(){}t.supported={fullscreen:!0,pointerLock:!0},t.toggleFullScreen=function(){document.fullscreenElement?document.cancelFullScreen&&document.cancelFullScreen():document.documentElement.requestFullScreen&&document.documentElement.requestFullScreen()},t.requestPointerLock=function(){document.documentElement.requestPointerLock&&document.documentElement.requestPointerLock()},t.exitPointerLock=function(){document.exitPointerLock&&document.exitPointerLock()},t.togglePointerLock=function(){document.pointerLockElement?document.exitPointerLock&&document.exitPointerLock():document.documentElement.requestPointerLock&&document.documentElement.requestPointerLock()};var e=[];return t.addVisibilityChangeListener=function(t){if("function"==typeof t){for(var r,i,n=["","ms","moz","webkit"],o=0;o<n.length;++o){var a=n[o]+(0===n[o].length?"hidden":"Hidden"),s=n[o]+"visibilitychange";if("undefined"!=typeof document[a]){r=a,i=s;break}}if("undefined"!=typeof document.addEventListener&&"undefined"!=typeof r){var h=function(){t(document[r]?!0:!1)};e.push({eventName:i,eventListener:h}),document.addEventListener(i,h)}}},t.clearVisibilityChangeListeners=function(){e.forEach(function(t){document.removeEventListener(t.eventName,t.eventListener)}),e=[]},t.initAllShims=function(e){t.initWebGLShims(),t.initAnimationShims(),t.initFullscreenShims(e),t.initPointerLockShims(e)},t.initWebGLShims=function(){window.Uint8ClampedArray=window.Uint8ClampedArray||window.Uint8Array},t.initAnimationShims=function(){for(var t=0,e=["ms","moz","webkit","o"],r=0;r<e.length&&!window.requestAnimationFrame;++r)window.requestAnimationFrame=window[e[r]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[r]+"CancelAnimationFrame"]||window[e[r]+"CancelRequestAnimationFrame"];void 0===window.requestAnimationFrame&&(window.requestAnimationFrame=function(e){var r=Date.now(),i=Math.max(0,16-(r-t)),n=window.setTimeout(function(){e(r+i)},i);return t=r+i,n}),void 0===window.cancelAnimationFrame&&(window.cancelAnimationFrame=function(t){clearTimeout(t)})},t.initFullscreenShims=function(e){function r(){var t=document.createEvent("CustomEvent");t.initCustomEvent("fullscreenchange",!0,!1,null),document.dispatchEvent(t)}function i(){var t=document.createEvent("CustomEvent");t.initCustomEvent("fullscreenerror",!0,!1,null),document.dispatchEvent(t)}e=e||window;var n=(e.HTMLElement||e.Element).prototype;if(!document.hasOwnProperty("fullscreenEnabled")){var o=function(){return"webkitIsFullScreen"in document?function(){return document.webkitFullscreenEnabled}:"mozFullScreenEnabled"in document?function(){return document.mozFullScreenEnabled}:(t.supported.fullscreen=!1,function(){return!1})}();Object.defineProperty(document,"fullscreenEnabled",{enumerable:!0,configurable:!1,writeable:!1,get:o})}if(!document.hasOwnProperty("fullscreenElement")){var o=function(){for(var t=["webkitCurrentFullScreenElement","webkitFullscreenElement","mozFullScreenElement"],e=function(e){return function(){return document[t[e]]}},r=0;r<t.length;r++)if(t[r]in document)return e(r);return function(){return null}}();Object.defineProperty(document,"fullscreenElement",{enumerable:!0,configurable:!1,writeable:!1,get:o})}document.addEventListener("webkitfullscreenchange",r,!1),document.addEventListener("mozfullscreenchange",r,!1),document.addEventListener("webkitfullscreenerror",i,!1),document.addEventListener("mozfullscreenerror",i,!1),n.requestFullScreen||(n.requestFullScreen=function(){return n.webkitRequestFullScreen?function(){this.webkitRequestFullScreen(e.Element.ALLOW_KEYBOARD_INPUT)}:n.mozRequestFullScreen?function(){this.mozRequestFullScreen()}:function(){}}()),document.cancelFullScreen||(document.cancelFullScreen=function(){return document.webkitCancelFullScreen||document.mozCancelFullScreen||function(){}}())},t.initPointerLockShims=function(e){function r(){var t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockchange",!0,!1,null),document.dispatchEvent(t)}function i(){var t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockerror",!0,!1,null),document.dispatchEvent(t)}e=e||window;var n=(e.HTMLElement||e.Element).prototype;if(e.MouseEvent){var o=e.MouseEvent.prototype;if("movementX"in o||Object.defineProperty(o,"movementX",{enumerable:!0,configurable:!1,writeable:!1,get:function(){return this.webkitMovementX||this.mozMovementX||0}}),"movementY"in o||Object.defineProperty(o,"movementY",{enumerable:!0,configurable:!1,writeable:!1,get:function(){return this.webkitMovementY||this.mozMovementY||0}}),navigator.pointer||(navigator.pointer=navigator.webkitPointer||navigator.mozPointer),document.addEventListener("webkitpointerlockchange",r,!1),document.addEventListener("webkitpointerlocklost",r,!1),document.addEventListener("mozpointerlockchange",r,!1),document.addEventListener("mozpointerlocklost",r,!1),document.addEventListener("webkitpointerlockerror",i,!1),document.addEventListener("mozpointerlockerror",i,!1),!document.hasOwnProperty("pointerLockElement")){var a=function(){return"webkitPointerLockElement"in document?function(){return document.webkitPointerLockElement}:"mozPointerLockElement"in document?function(){return document.mozPointerLockElement}:function(){return null}}();Object.defineProperty(document,"pointerLockElement",{enumerable:!0,configurable:!1,writeable:!1,get:a})}n.requestPointerLock||(n.requestPointerLock=function(){return n.webkitRequestPointerLock?function(){this.webkitRequestPointerLock()}:n.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:navigator.pointer?function(){var t=this;navigator.pointer.lock(t,r,i)}:(t.supported.pointerLock=!1,function(){})}()),document.exitPointerLock||(document.exitPointerLock=function(){return document.webkitExitPointerLock||document.mozExitPointerLock||function(){navigator.pointer&&navigator.pointer.unlock()}}())}},t}),define("goo/util/Logo",[],function(){"use strict";function t(){}t.blue="#2A3276",t.white="#FFFFFF";var e={color:t.white,shadow:!1};return t.getLogo=function(t){t=t||{};for(var r in e)void 0===t[r]&&(t[r]=e[r]);if(!document.createElementNS)return"";var i="http://www.w3.org/2000/svg",n=document.createElementNS(i,"svg");n.setAttribute("version","1.1"),n.setAttribute("xmlns",i),n.setAttribute("x","0px"),n.setAttribute("y","0px"),n.setAttribute("viewBox","0 0 396.603 277.343"),n.setAttribute("enable-background","new 0 0 396.603 277.343"),n.setAttribute("xml:space","preserve"),t.width&&n.setAttribute("width",t.width),t.height&&n.setAttribute("height",t.height);var o=document.createElementNS(i,"g");n.appendChild(o);var a=document.createElementNS(i,"filter");a.setAttribute("id","insetShadow");var s=document.createElementNS(i,"feGaussianBlur");s.setAttribute("in","SourceAlpha"),s.setAttribute("stdDeviation","0");var h=document.createElementNS(i,"feOffset");h.setAttribute("dx","0"),h.setAttribute("dy","-5"),h.setAttribute("result","offsetblur");var d=document.createElementNS(i,"feComponentTransfer"),l=document.createElementNS(i,"feFuncA");l.setAttribute("type","linear"),l.setAttribute("slope","0.5"),d.appendChild(l);var u=document.createElementNS(i,"feMerge"),c=document.createElementNS(i,"feMergeNode"),p=document.createElementNS(i,"feMergeNode");p.setAttribute("in","SourceGraphic"),u.appendChild(c),u.appendChild(p),a.appendChild(s),a.appendChild(h),a.appendChild(d),a.appendChild(u),o.appendChild(a);var f=document.createElementNS(i,"path");f.setAttribute("d","M303.337,46.286c-13.578,0-25.784,5.744-34.396,14.998c-9.86,10.59-26.319,10.59-36.172,0c-8.605-9.254-20.818-14.998-34.402-14.998c-25.936,0-46.971,21.034-46.971,46.978c0,25.936,21.035,46.972,46.971,46.972c13.584,0,25.797-5.744,34.402-14.998c9.853-10.598,26.325-10.598,36.172,0c8.612,9.254,20.818,14.998,34.396,14.998c25.941,0,46.977-21.036,46.977-46.972C350.313,67.32,329.278,46.286,303.337,46.286z M198.296,116.39c-12.785,0-23.146-10.359-23.146-23.144s10.361-23.151,23.146-23.151c12.795,0,23.156,10.367,23.156,23.151S211.091,116.39,198.296,116.39z M303.337,116.407c-12.785,0-23.146-10.36-23.146-23.144c0-12.784,10.36-23.151,23.146-23.151c12.795,0,23.156,10.367,23.156,23.151C326.493,106.047,316.132,116.407,303.337,116.407z M156.18,138.347c-14.087-3.23-22.316-17.482-18.068-31.305c3.704-12.072,2.568-25.511-4.22-37.256C120.927,47.323,92.22,39.63,69.766,52.587C47.317,65.552,39.624,94.26,52.581,116.713c6.795,11.761,17.853,19.462,30.17,22.282c14.084,3.235,22.314,17.497,18.074,31.317c-3.711,12.08-2.582,25.504,4.213,37.264c12.965,22.455,41.666,30.148,64.127,17.178c22.447-12.945,30.148-41.658,17.185-64.111C179.554,148.881,168.497,141.181,156.18,138.347z M104.802,113.287c-11.064,6.387-25.219,2.599-31.604-8.474c-6.397-11.07-2.604-25.225,8.474-31.609c11.057-6.398,25.22-2.598,31.611,8.46C119.673,92.741,115.872,106.897,104.802,113.287z M145.687,207.256c-12.785,0-23.145-10.361-23.145-23.145s10.359-23.15,23.145-23.15c12.797,0,23.156,10.367,23.156,23.15S158.483,207.256,145.687,207.256z"),f.setAttribute("fill",t.color),t.shadow&&(o.appendChild(a),f.setAttribute("style","filter:url(#insetShadow)")),o.appendChild(f);var m=new XMLSerializer,g=m.serializeToString(n);return g},t}),define("goo/entities/GooRunner",["goo/entities/World","goo/renderer/Renderer","goo/entities/systems/TransformSystem","goo/entities/systems/RenderSystem","goo/entities/systems/BoundingUpdateSystem","goo/entities/systems/ScriptSystem","goo/entities/systems/LightingSystem","goo/entities/systems/CameraSystem","goo/entities/systems/ParticlesSystem","goo/util/Stats","goo/sound/AudioContext","goo/entities/systems/SoundSystem","goo/entities/components/TransformComponent","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/entities/components/CameraComponent","goo/entities/components/LightComponent","goo/entities/components/ScriptComponent","goo/entities/components/SoundComponent","goo/util/GameUtils","goo/util/Logo","goo/entities/SystemBus","goo/renderer/Material"],function(t,e,r,i,n,o,a,s,h,d,l,u,c,p,f,m,g,v,y,x,_,w,b){"use strict";function S(r){if(r=r||{},x.initAllShims(),this.world=new t(this),this.renderer=new e(r),this.useTryCatch=void 0!==r.useTryCatch?r.useTryCatch:!0,this._setBaseSystems(),this._registerBaseComponents(),this.doProcess=!0,this.doRender=!0,this.tpfSmoothingCount=void 0!==r.tpfSmoothingCount?r.tpfSmoothingCount:10,r.showStats&&(this.stats=new d,this.stats.domElement.style.position="absolute",this.stats.domElement.style.left="10px",this.stats.domElement.style.top="10px",document.body.appendChild(this.stats.domElement)),void 0===r.logo||r.logo){var i=this._buildLogo(r.logo);i&&document.body.appendChild(i)}this.callbacksPreProcess=[],this.callbacksPreRender=[],this.callbacks=[],this.callbacksNextFrame=[],this._takeSnapshots=[],this.start=-1,this.animationId=0,r.manuallyStartGameLoop||this.startGameLoop(),r.debugKeys&&this._addDebugKeys(),this._events={click:null,mousedown:null,mouseup:null,mousemove:null,touchstart:null,touchend:null,touchmove:null},this._eventListeners={click:[],mousedown:[],mouseup:[],mousemove:[],touchstart:[],touchend:[],touchmove:[]},this._eventTriggered={click:null,mousedown:null,mouseup:null,mousemove:null,touchstart:null,touchend:null,touchmove:null},x.addVisibilityChangeListener(function(t){t?this._stopGameLoop():this.manuallyPaused||this._startGameLoop()}.bind(this)),this._picking={x:0,y:0,skipUpdateBuffer:!1,doPick:!1,pickingCallback:null,pickingStore:{},clearColorStore:[]},this.manuallyPaused=!!r.manuallyStartGameLoop}S.prototype._setBaseSystems=function(){this.world.setSystem(new o(this.world)),this.world.setSystem(new r),this.world.setSystem(new s),this.world.setSystem(new h),this.world.setSystem(new n),this.world.setSystem(new a),l&&this.world.setSystem(new u),this.renderSystem=new i,this.renderSystems=[this.renderSystem],this.world.setSystem(this.renderSystem)},S.prototype._registerBaseComponents=function(){this.world.registerComponent(c),this.world.registerComponent(p),this.world.registerComponent(f),this.world.registerComponent(m),this.world.registerComponent(g),this.world.registerComponent(v)},S.prototype.run=function(t){this.useTryCatch?this._callSafe(this._updateFrame,t):this._updateFrame(t)},S.prototype._callSafe=function(t){try{t.apply(this,Array.prototype.slice.call(arguments,1))}catch(e){e instanceof Error?console.error(e.stack):console.log(e)}},S.prototype.setRenderSystem=function(t,e){this.world.setSystem(t),void 0!==e?this.renderSystems.splice(e,0,t):this.renderSystems.push(t)};var E=[],C=0;return S.prototype._updateFrame=function(r){this.start<0&&(this.start=r);var i=(r-this.start)/1e3;if(0>i||i>1)return this.start=r,void(this.animationId=window.requestAnimationFrame(this.run.bind(this)));i=Math.max(Math.min(i,.5),1e-4),E[C]=i,C=(C+1)%this.tpfSmoothingCount;for(var n=0,o=0;o<E.length;o++)n+=E[o];if(n/=E.length,this.world.tpf=n,this.world.time+=this.world.tpf,t.time=this.world.time,t.tpf=this.world.tpf,this.start=r,this.callbacksNextFrame.length>0){var a=this.callbacksNextFrame;if(this.callbacksNextFrame=[],this.useTryCatch)for(var o=0;o<a.length;o++){var s=a[o];this._callSafe(s,this.world.tpf)}else for(var o=0;o<a.length;o++){var s=a[o];s(this.world.tpf)}}if(this.useTryCatch)for(var o=0;o<this.callbacksPreProcess.length;o++){var s=this.callbacksPreProcess[o];this._callSafe(s,this.world.tpf)}else for(var o=0;o<this.callbacksPreProcess.length;o++){var s=this.callbacksPreProcess[o];s(this.world.tpf)}if(this.doProcess&&this.world.process(),this.renderer.info.reset(),this.doRender){this.renderer.checkResize(e.mainCamera),this.renderer.setRenderTarget();for(var o=0;o<this.callbacksPreRender.length;o++)this.callbacksPreRender[o](this.world.tpf);for(var o=0;o<this.renderSystems.length;o++)this.renderSystems[o].passive||this.renderSystems[o].render(this.renderer);if(this._picking.doPick&&e.mainCamera){var h=this.renderer.clearColor.data;this._picking.clearColorStore[0]=h[0],this._picking.clearColorStore[1]=h[1],this._picking.clearColorStore[2]=h[2],this._picking.clearColorStore[3]=h[3],this.renderer.setClearColor(0,0,0,1);for(var o=0;o<this.renderSystems.length;o++)this.renderSystems[o].renderToPick&&!this.renderSystems[o].passive&&this.renderSystems[o].renderToPick(this.renderer,this._picking.skipUpdateBuffer);this.renderer.pick(this._picking.x,this._picking.y,this._picking.pickingStore,e.mainCamera),this.useTryCatch?this._callSafe(this._picking.pickingCallback,this._picking.pickingStore.id,this._picking.pickingStore.depth):this._picking.pickingCallback(this._picking.pickingStore.id,this._picking.pickingStore.depth),this._picking.doPick=!1,this.renderer.setClearColor.apply(this.renderer,this._picking.clearColorStore)}}if(this.useTryCatch)for(var o=0;o<this.callbacks.length;o++){var s=this.callbacks[o];this._callSafe(s,this.world.tpf)}else for(var o=0;o<this.callbacks.length;o++){var s=this.callbacks[o];s(this.world.tpf)}if(this.stats&&this.stats.update(this.renderer.info.toString()+"<br>Transform updates: "+this.world.getSystem("TransformSystem").numUpdates+"<br>Cached shaders: "+Object.keys(this.renderer.rendererRecord.shaderCache).length),this._takeSnapshots.length){var d=this.renderer.domElement.toDataURL();if(this.useTryCatch)for(var o=this._takeSnapshots.length-1;o>=0;o--){var s=this._takeSnapshots[o];this._callSafe(s,d)}else for(var o=this._takeSnapshots.length-1;o>=0;o--){var s=this._takeSnapshots[o];s(d)}this._takeSnapshots=[]}this.animationId&&(this.animationId=window.requestAnimationFrame(this.run.bind(this)))},S.prototype._buildLogo=function(t){var e=document.createElement("div"),r=t&&t.color?t.color:_.white,i=_.getLogo({width:"70px",height:"50px",color:r});return""!==i?(e.innerHTML='<a style="text-decoration: none;" href="http://www.goocreate.com" target="_blank">'+i+"</a>",e.style.position="absolute",e.style.zIndex="2000",t?"topright"===t||"topright"===t.position?(e.style.top="10px",e.style.right="10px"):"topleft"===t||"topleft"===t.position?(e.style.top="10px",e.style.left="10px"):"bottomright"===t||"bottomright"===t.position?(e.style.bottom="10px",e.style.right="10px"):(e.style.bottom="10px",e.style.left="10px"):(e.style.top="10px",e.style.right="10px"),e.id="goologo",e.style.webkitTouchCallout="none",e.style.webkitUserSelect="none",e.style.khtmlUserSelect="none",e.style.mozUserSelect="none",e.style.msUserSelect="none",e.style.userSelect="none",e.ondragstart=function(){return!1},e):void 0},S.prototype._addDebugKeys=function(){var t="shiftKey";document.addEventListener("keydown",function(e){32===e.which&&e[t]?x.toggleFullScreen():13===e.which&&e[t]?x.togglePointerLock():49===e.which&&e[t]?this.renderSystem.setDebugMaterial():50!==e.which&&222!==e.which||!e[t]?51===e.which&&e[t]?this.renderSystem.setDebugMaterial("lit"):52===e.which&&e[t]?this.renderSystem.setDebugMaterial("color"):53===e.which&&e[t]?this.renderSystem.setDebugMaterial("wireframe"):54===e.which&&e[t]?this.renderSystem.setDebugMaterial("flat"):55!==e.which&&191!==e.which||!e[t]?56===e.which&&e[t]&&this.renderSystem.setDebugMaterial("+wireframe"):this.renderSystem.setDebugMaterial("texture"):this.renderSystem.setDebugMaterial("normals")}.bind(this),!1),document.addEventListener("mousedown",function(e){if(e[t]){var r=e.clientX,i=e.clientY;this.pick(r,i,function(t,e){var r=this.world.entityManager.getEntityById(t);
console.log("Picked entity:",r,"At depth:",e)}.bind(this))}}.bind(this),!1)},S.prototype.addEventListener=function(t,e){!this._eventListeners[t]||this._eventListeners[t].indexOf(e)>-1||"function"==typeof e&&(this._eventListeners[t].push(e),1===this._eventListeners[t].length&&this._enableEvent(t))},S.prototype.removeEventListener=function(t,e){if(this._eventListeners[t]){var r=this._eventListeners[t].indexOf(e);r>-1&&this._eventListeners[t].splice(r,1),0===this._eventListeners[t].length&&this._disableEvent(t)}},S.prototype.triggerEvent=function(t,e){e.type=t,this._eventTriggered[t]=e.domEvent,this._dispatchEvent(e)},S.prototype._dispatchEvent=function(t){for(var e=Object.keys(this._eventTriggered),r=0;r<e.length;r++){var i=e[r];if(this._eventTriggered[i]&&this._eventListeners[i]){var n={entity:t.entity,depth:t.depth,x:t.x,y:t.y,type:i,domEvent:this._eventTriggered[i],id:t.id,intersection:t.intersection};try{for(var o=0;o<this._eventListeners[i].length&&this._eventListeners[i][o](n)!==!1;o++);}catch(a){console.error(a)}this._eventTriggered[i]=null}}},S.prototype._enableEvent=function(t){if(!this._events[t]){var r=function(r){var i,n;"touchstart"===r.type||"touchend"===r.type||"touchmove"===r.type?(i=r.changedTouches[0].pageX-r.changedTouches[0].target.getBoundingClientRect().left,n=r.changedTouches[0].pageY-r.changedTouches[0].target.getBoundingClientRect().top):(i=void 0!==r.offsetX?r.offsetX:r.layerX,n=void 0!==r.offsetY?r.offsetY:r.layerY),this._eventTriggered[t]=r,this.pick(i,n,function(t,r){var o=this.renderer.devicePixelRatio,a=this.world.entityManager.getEntityByIndex(t),s=e.mainCamera.getWorldPosition(i*o,n*o,this.renderer.viewportWidth,this.renderer.viewportHeight,r);this._dispatchEvent({entity:a,depth:r,x:i,y:n,id:t,intersection:s})}.bind(this))}.bind(this);this.renderer.domElement.addEventListener(t,r),this._events[t]=r}},S.prototype._disableEvent=function(t){this._events[t]&&this.renderer.domElement.removeEventListener(t,this._events[t]),this._events[t]=null},S.prototype._startGameLoop=function(){this.animationId||(this.start=-1,this.animationId=window.requestAnimationFrame(this.run.bind(this)))},S.prototype.startGameLoop=function(){this.manuallyPaused=!1,this._startGameLoop()},S.prototype._stopGameLoop=function(){window.cancelAnimationFrame(this.animationId),this.animationId=0},S.prototype.stopGameLoop=function(){this.manuallyPaused=!0,this._stopGameLoop()},S.prototype.takeSnapshot=function(t){this._takeSnapshots.push(t)},S.prototype.pick=function(t,e,r,i){this._picking.x=t,this._picking.y=e,this._picking.skipUpdateBuffer=void 0===i?!1:i,r&&(this._picking.pickingCallback=r),this._picking.doPick=!0},S.prototype.pickSync=function(t,r,i){var n=this.renderer.clearColor.data;this._picking.skipUpdateBuffer=void 0===i?!1:i;var o=[n[0],n[1],n[2],n[3]];this.renderer.setClearColor(0,0,0,1),this.renderSystem.renderToPick(this.renderer,!1),this.renderer.setClearColor.apply(this.renderer,o);var a={};return this.renderer.pick(t,r,a,e.mainCamera),a},S.prototype.clear=function(){this.stopGameLoop(),this.world.clear();var t=this.renderer.domElement;t.parentNode&&t.parentNode.removeChild(t),w.clear(),b.store=[],b.hash=[],e.mainCamera=null,x.clearVisibilityChangeListeners(),this.world=null,this.renderer=null,this.renderSystem=null,this.renderSystems=null,this.callbacks=null,this.callbacksPreProcess=null,this.callbacksPreRender=null,this.callbacksNextFrame=null,this._takeSnapshots=null,this._events=null},S}),define("goo/entities/components/CSSTransformComponent",["goo/entities/components/Component"],function(t){"use strict";function e(e,r){t.call(this),this.type="CSSTransformComponent",this.domElement=e,this.scale=1,this.faceCamera="undefined"==typeof r?!1:r}return e.prototype=Object.create(t.prototype),e}),define("goo/entities/components/HtmlComponent",["goo/entities/components/Component"],function(t){"use strict";function e(e){t.call(this),this.type="HtmlComponent",this.domElement=e,this.hidden=!1,this.useTransformComponent=!0}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e}),define("goo/entities/components/MovementComponent",["goo/math/Vector3","goo/entities/components/Component"],function(t,e){"use strict";function r(){this.type="MovementComponent",this.velocity=new t,this.rotationVelocity=new t}return r.prototype=Object.create(e.prototype),r.prototype.addVelocity=function(t){this.velocity.add(t)},r.prototype.setVelocity=function(t){this.velocity.set(t)},r.prototype.getVelocity=function(){return this.velocity},r.prototype.addRotationVelocity=function(t){this.rotationVelocity.add(t)},r.prototype.setRotationVelocity=function(t){this.rotationVelocity.set(t)},r.prototype.getRotationVelocity=function(){return this.rotationVelocity},r}),define("goo/particles/ParticleUtils",["goo/math/Vector3"],function(t){"use strict";function e(){}return e.getRandomVelocityOffY=function(t,r,i,n,o){var a=r+Math.random()*(i-r),s=2*Math.PI*Math.random();return t.x=Math.cos(s)*Math.sin(a),t.y=Math.cos(a),t.z=Math.sin(s)*Math.sin(a),o&&e.applyEntityTransformVector(t,o),t.mul(n),t},e.randomPointInCube=function(t,e,r,i,n){return t.x=2*Math.random()*e-e+(n?n.x:0),t.y=2*Math.random()*r-r+(n?n.y:0),t.z=2*Math.random()*i-i+(n?n.z:0),t},e.createConstantForce=function(e){var r=new t(e);return{enabled:!0,prepare:function(){},apply:function(t,e){e.velocity.x+=r.x*t,e.velocity.y+=r.y*t,e.velocity.z+=r.z*t}}},e.applyEntityTransformPoint=function(t,e){return e.transformComponent&&e.transformComponent.worldTransform?e.transformComponent.worldTransform.applyForward(t,t):t},e.applyEntityTransformVector=function(t,e){return e.transformComponent&&e.transformComponent.worldTransform?e.transformComponent.worldTransform.applyForwardVector(t,t):t},e.applyTimeline=function(t,e){for(var r=t.age,i=t.lifeSpan,n=0,o=0,a=0,s=0,h=i,d=i,l=i,u=i,c=0,p=0,f=null,m=null,g=null,v=null,y=null,x=null,_=null,w=null,b=null,S=0,E=e.length;E>S;S++){var C=e[S];c+=(C.timeOffset?C.timeOffset:0)*i,null===x&&(c>r?void 0!==C.color&&(h=c,x=C):void 0!==C.color&&(n=c,f=C)),null===_&&(c>r?void 0!==C.mass&&(d=c,_=C):void 0!==C.mass&&(o=c,m=C)),r>=c&&void 0!==C.uvIndex&&(y=C),null===w&&(c>r?void 0!==C.size&&(l=c,w=C):void 0!==C.size&&(a=c,g=C)),null===b&&(c>r?void 0!==C.spin&&(u=c,b=C):void 0!==C.spin&&(s=c,v=C))}p=(r-n)/(h-n);var M=null!==f?f.color:[1,1,1,1],T=null!==x?x.color:M;t.color.data[0]=(1-p)*M[0]+p*T[0],t.color.data[1]=(1-p)*M[1]+p*T[1],t.color.data[2]=(1-p)*M[2]+p*T[2],t.color.data[3]=(1-p)*M[3]+p*T[3],p=(r-o)/(d-o);var M=null!==m?m.mass:1,T=null!==_?_.mass:M;t.mass=(1-p)*M+p*T,t.uvIndex=null!==y?y.uvIndex:0,p=(r-a)/(l-a);var M=null!==g?g.size:1,T=null!==w?w.size:M;t.size=(1-p)*M+p*T,p=(r-s)/(u-s);var M=null!==v?v.spin:0,T=null!==b?b.spin:M;t.spin=(1-p)*M+p*T},e}),define("goo/particles/Particle",["goo/particles/ParticleUtils","goo/math/Vector","goo/math/Vector3","goo/math/Vector4","goo/renderer/MeshData"],function(t,e,r,i,n){"use strict";function o(t,e){this.alive=!1,this.position=new r,this.velocity=new r,this.lifeSpan=0,this.parent=t,this.age=0,this.index=e,this.color=new i(1,0,0,1),this.size=0,this.spin=0,this.mass=1,this.emitter=null,this.uvIndex=0,this.lastUVIndex=-1,this.bbX=new r,this.bbY=new r,this.lastColor=new i}var a=new r;o.prototype.respawnParticle=function(t){this.emitter=t,this.lifeSpan=t.nextParticleLifeSpan(),this.alive=!0,this.age=0};var s=[];return o.prototype.update=function(i,o){if(this.alive){if(this.age+=i,this.age>this.lifeSpan)return void this.kill();if(this.position.add_d(this.velocity.x*i,this.velocity.y*i,this.velocity.z*i),t.applyTimeline(this,this.emitter&&this.emitter.timeline?this.emitter.timeline:this.parent.timeline),!e.equals(this.lastColor,this.color)){var h=this.parent.meshData.getAttributeBuffer(n.COLOR);h.set(this.color.data,16*this.index+0),h.set(this.color.data,16*this.index+4),h.set(this.color.data,16*this.index+8),h.set(this.color.data,16*this.index+12),this.lastColor.setv(this.color)}if(this.emitter&&this.emitter.getParticleBillboardVectors(this,o),0===this.spin)this.bbX.muld(this.size,this.size,this.size),this.bbY.muld(this.size,this.size,this.size);else{var d=Math.cos(this.spin)*this.size,l=Math.sin(this.spin)*this.size,u=this.bbY.x,c=this.bbY.y,p=this.bbY.z;this.bbY.setv(this.bbX),this.bbX.muld(d,d,d).add_d(u*l,c*l,p*l),this.bbY.muld(-l,-l,-l).add_d(u*d,c*d,p*d)}var f=this.parent.meshData.getAttributeBuffer(n.POSITION);if(r.subv(this.position,this.bbX,a).subv(this.bbY),f.set(a.data,12*this.index+0),r.subv(this.position,this.bbX,a).addv(this.bbY),f.set(a.data,12*this.index+3),r.addv(this.position,this.bbX,a).addv(this.bbY),f.set(a.data,12*this.index+6),r.addv(this.position,this.bbX,a).subv(this.bbY),f.set(a.data,12*this.index+9),this.lastUVIndex!==this.uvIndex){var m=this.parent.meshData.getAttributeBuffer(n.TEXCOORD0),g=this.uvIndex%this.parent.uRange/this.parent.uRange,v=1-Math.floor(this.uvIndex/this.parent.vRange)/this.parent.vRange,y=1/this.parent.uRange,x=1/this.parent.vRange;s[0]=g+y,s[1]=v-x,m.set(s,8*this.index+0),s[0]=g+y,s[1]=v,m.set(s,8*this.index+2),s[0]=g,s[1]=v,m.set(s,8*this.index+4),s[0]=g,s[1]=v-x,m.set(s,8*this.index+6),this.lastUVIndex=this.uvIndex}}},o.prototype.kill=function(){this.alive=!1;var t=this.parent.meshData.getAttributeBuffer(n.POSITION),e=t.subarray(12*this.index,12*this.index+3);t.set(e,12*this.index+3),t.set(e,12*this.index+6),t.set(e,12*this.index+9)},o}),define("goo/particles/ParticleEmitter",["goo/particles/ParticleUtils","goo/renderer/Renderer"],function(t,e){"use strict";function r(e){e=e||{},this.totalParticlesToSpawn=isNaN(e.totalParticlesToSpawn)?-1:e.totalParticlesToSpawn,this.maxLifetime=isNaN(e.maxLifetime)?3:e.maxLifetime,this.minLifetime=isNaN(e.minLifetime)?2:e.minLifetime,this.timeline=e.timeline?e.timeline:void 0,this.influences=e.influences?e.influences:[],this.getEmissionPoint=e.getEmissionPoint?e.getEmissionPoint:function(e,r){var i=e.position;return i.setd(0,0,0),t.applyEntityTransformPoint(i,r)},this.getEmissionVelocity=e.getEmissionVelocity?e.getEmissionVelocity:function(e,r){var i=e.velocity;return i.setd(0,1,0),t.applyEntityTransformVector(i,r)},this.getParticleBillboardVectors=e.getParticleBillboardVectors?e.getParticleBillboardVectors:r.CAMERA_BILLBOARD_FUNC,this.releaseRatePerSecond=isNaN(e.releaseRatePerSecond)?10:e.releaseRatePerSecond,this.particlesWaitingToRelease=0,this.enabled=void 0!==e.enabled?e.enabled===!0:!0}return r.CAMERA_BILLBOARD_FUNC=function(t){var r=e.mainCamera;r&&(t.bbX.setv(r._left),t.bbY.setv(r._up))},r.prototype.nextParticleLifeSpan=function(){return this.minLifetime+(this.maxLifetime-this.minLifetime)*Math.random()},r}),define("goo/entities/components/ParticleComponent",["goo/entities/components/Component","goo/particles/Particle","goo/particles/ParticleEmitter","goo/renderer/MeshData"],function(t,e,r,i){"use strict";function n(e){if(this.type="ParticleComponent",t.call(this),e=e||{},this.emitters=[],e.emitters)for(var i=0,n=e.emitters.length;n>i;i++)this.emitters.push(new r(e.emitters[i]));this.timeline=e.timeline?e.timeline:[],this.uRange=isNaN(e.uRange)?1:e.uRange,this.vRange=isNaN(e.vRange)?1:e.vRange;var o=isNaN(e.particleCount)?100:e.particleCount;this.recreateParticles(o),this.enabled=!0}return n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n.prototype.generateMeshData=function(){var t=i.defaultMap([i.POSITION,i.COLOR,i.TEXCOORD0]);this.meshData=new i(t,4*this.particleCount,6*this.particleCount),this.meshData.vertexData.setDataUsage("DynamicDraw");for(var e=this.meshData.getAttributeBuffer(i.TEXCOORD0),r=this.meshData.getIndexBuffer(),n=0,o=this.particleCount;o>n;n++)e.set([1,0],8*n+0),e.set([1,1],8*n+2),e.set([0,1],8*n+4),e.set([0,0],8*n+6),r.set([4*n+0,4*n+3,4*n+1,4*n+1,4*n+3,4*n+2],6*n)},n.prototype.recreateParticles=function(t){this.particleCount=t,this.particles=[];for(var r=0;r<this.particleCount;r++)this.particles[r]=new e(this,r);this.generateMeshData()},n}),define("goo/entities/components/PortalComponent",["goo/entities/components/Component","goo/renderer/pass/RenderTarget"],function(t,e){"use strict";function r(t,r,i,n){r=r||200,this.options=i||{},this.options.preciseRecursion=!!this.options.preciseRecursion,this.options.autoUpdate=this.options.autoUpdate!==!1,this.options.alwaysRender=!!this.options.alwaysRender,this.overrideMaterial=n,this.doUpdate=!0;var o=t.aspect;this.type="PortalComponent",this.camera=t,this.target=new e(r,r/o),this.options.preciseRecursion&&(this.secondaryTarget=new e(r,r/o))}return r.prototype=Object.create(t.prototype),r.prototype.requestUpdate=function(){this.doUpdate=!0},r}),define("goo/shapes/TextureGrid",["goo/renderer/MeshData"],function(t){"use strict";function e(e,i){this.matrix=e,this.textureUnitsPerLine=i||8;var n=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]),o=r(e);t.call(this,n,4*o,6*o),this.rebuild()}function r(t){for(var e=0,r=0;r<t.length;r++)e+=t[r].length;return e}function i(t){var e=[],r=t.split("\n");return r.forEach(function(t){var r=t.split(""),i=r.map(function(t){return t.charCodeAt(0)});e.push(i)}),e}return e.prototype=Object.create(t.prototype),e.prototype.rebuild=function(){for(var e=[],r=[],i=[],n=[],o=0,a=0;a<this.matrix.length;a++)for(var s=0;s<this.matrix[a].length;s++){e.push(s,-a-1,0,s,-a,0,s+1,-a,0,s+1,-a-1,0),r.push(0,0,1,0,0,1,0,0,1,0,0,1);var h=this.matrix[a][s]%this.textureUnitsPerLine/this.textureUnitsPerLine,d=Math.floor(this.matrix[a][s]/this.textureUnitsPerLine)/this.textureUnitsPerLine;d=1-d,n.push(h,d-1/this.textureUnitsPerLine,h,d,h+1/this.textureUnitsPerLine,d,h+1/this.textureUnitsPerLine,d-1/this.textureUnitsPerLine),i.push(o+3,o+1,o+0,o+2,o+1,o+3),o+=4}return this.getAttributeBuffer(t.POSITION).set(e),this.getAttributeBuffer(t.NORMAL).set(r),this.getAttributeBuffer(t.TEXCOORD0).set(n),this.getIndexBuffer().set(i),this},e.fromString=function(t){return new e(i(t),16)},e}),define("goo/entities/components/TextComponent",["goo/entities/components/Component","goo/shapes/TextureGrid","goo/entities/components/MeshDataComponent"],function(t){"use strict";function e(t){this.type="TextComponent",this.text=t||"",this.dirty=!0}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.setText=function(t){return this.text=t,this.dirty=!0,this},e}),define("goo/entities/systems/CSSTransformSystem",["goo/entities/systems/System","goo/renderer/Renderer","goo/math/Matrix4x4","goo/math/MathUtils","goo/math/Vector3"],function(t,e,r,i,n){"use strict";function o(e){t.call(this,"CSSTransformSystem",["TransformComponent","CSSTransformComponent"]),this.renderer=e,document.querySelector&&(this.viewDom=document.querySelector("#view"),this.containerDom=document.querySelector("#cam1"),this.containerDom2=document.querySelector("#cam2"))}var a=new r,s=new r,h=new n;o.prototype=Object.create(t.prototype);var d=function(t){return Math.abs(t)<1e-6?0:t},l=["","-webkit-","-moz-","-ms-","-o-"],u=function(t,e,r){for(var i=0;i<l.length;i++)t.style[l[i]+e]=r},c=function(t){var e=t.data;return"matrix3d("+d(e[0])+","+d(-e[1])+","+d(e[2])+","+d(e[3])+","+d(e[4])+","+d(-e[5])+","+d(e[6])+","+d(e[7])+","+d(e[8])+","+d(-e[9])+","+d(e[10])+","+d(e[11])+","+d(e[12])+","+d(-e[13])+","+d(e[14])+","+d(e[15])+")"};return o.prototype.process=function(t){if(0!==t.length){var r=e.mainCamera;if(r){var o=.5/Math.tan(i.DEG_TO_RAD*r.fov*.5)*this.renderer.domElement.offsetHeight;u(this.viewDom,"perspective",o+"px"),a.copy(r.getViewInverseMatrix()),s.copy(a),a.invert(),a.setTranslation(new n(0,0,o));var d=c(a);u(this.containerDom,"transform",d),s.e03=-s.e03,s.e23=-s.e23,s.setRotationFromVector(new n(0,0,0)),d=c(s),u(this.containerDom2,"transform",d);for(var l=0;l<t.length;l++){var p=t[l],f=p.getComponent("CSSTransformComponent"),m=f.domElement,g=f.scale;g=[g,-g,g].join(","),f.faceCamera?(p.transformComponent.worldTransform.matrix.getTranslation(h),a.copy(r.getViewInverseMatrix()),a.setTranslation(h)):a.copy(p.transformComponent.worldTransform.matrix),d="translate3d(-50%,-50%,0) "+c(a)+"scale3d("+g+")",u(m,"transform",d),m.parentNode!==this.containerDom2&&this.containerDom2.appendChild(m)}}}},o}),define("goo/shapes/Grid",["goo/renderer/MeshData"],function(t){"use strict";function e(e,r,i,n){if(1===arguments.length&&arguments[0]instanceof Object){var o=arguments[0];e=o.xSegments,r=o.ySegments,i=o.width,n=o.height}this.xSegments=e||10,this.ySegments=r||10,this.width=i||1,this.height=n||1;var a=t.defaultMap([t.POSITION]),s=4+2*(this.xSegments-1)+2*(this.ySegments-1),h=8+2*(this.xSegments-1)+2*(this.ySegments-1);t.call(this,a,s,h),this.indexModes[0]="Lines",this.rebuild()}return e.prototype=Object.create(t.prototype),e.prototype.rebuild=function(){var e=this.width/2,r=this.height/2,i=[],n=[];i.push(-e,-r,0,-e,r,0,e,r,0,e,-r,0),n.push(0,1,1,2,2,3,3,0);for(var o,a=this.width/this.xSegments,s=1;s<this.xSegments;s++)o=s*a-e,i.push(o,-r,0,o,r,0);var h;a=this.height/this.ySegments;for(var s=1;s<this.ySegments;s++)h=s*a-r,i.push(-e,h,0,e,h,0);for(var s=n.length/2;s<i.length/3;s+=2)n.push(s,s+1);this.getAttributeBuffer(t.POSITION).set(i),this.getIndexBuffer().set(n)},e}),define("goo/entities/systems/GridRenderSystem",["goo/entities/systems/System","goo/entities/SystemBus","goo/renderer/SimplePartitioner","goo/renderer/MeshData","goo/renderer/Material","goo/renderer/Shader","goo/renderer/shaders/ShaderLib","goo/renderer/Util","goo/math/Transform","goo/shapes/Grid","goo/shapes/Quad"],function(t,e,r,i,n,o,a,s,h,d,l){"use strict";function u(){t.call(this,"GridRenderSystem",[]),this.renderList=[],this.doRender={grid:!0,surface:!0},this.camera=null,this.lights=[],this.transform=new h,this.transform.rotation.rotateX(-Math.PI/2),this.transform.scale.setd(1e3,1e3,1e3),this.transform.update();var r=new n(c,"Grid Material");r.depthState.write=!0,r.depthState.enabled=!0,this.grid={meshData:new d(100,100),materials:[r],transform:this.transform};var i=s.clone(a.simpleColored),o=new n(i,"Surface Material");o.uniforms.color=[.4,.4,.4],o.uniforms.opacity=.9,o.blendState.blending="CustomBlending",o.cullState.enabled=!1,o.depthState.write=!0,o.depthState.enabled=!0,o.offsetState.enabled=!0,o.offsetState.units=10,o.offsetState.factor=.8,this.surface={meshData:new l,materials:[o],transform:this.transform};var u=this;e.addListener("goo.setCurrentCamera",function(t){u.camera=t.camera}),e.addListener("goo.setLights",function(t){u.lights=t})}u.prototype=Object.create(t.prototype),u.prototype.inserted=function(){},u.prototype.deleted=function(){},u.prototype.process=function(){var t=this.renderList.length=0;this.doRender.surface&&(this.renderList[t++]=this.surface),this.doRender.grid&&(this.renderList[t++]=this.grid),this.renderList.length=t},u.prototype.render=function(t){t.checkResize(this.camera),this.camera&&t.render(this.renderList,this.camera,this.lights,null,!1)};var c={attributes:{vertexPosition:i.POSITION},uniforms:{viewMatrix:o.VIEW_MATRIX,projectionMatrix:o.PROJECTION_MATRIX,worldMatrix:o.WORLD_MATRIX,color:[.55,.55,.55,1],fogOn:!1,fogColor:[.1,.1,.1,1],fogNear:o.NEAR_PLANE,fogFar:o.FAR_PLANE},vshader:["attribute vec3 vertexPosition;","uniform mat4 worldMatrix;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","varying float depth;","void main(void)","{","vec4 viewPosition = viewMatrix * worldMatrix * vec4(vertexPosition, 1.0);","depth = viewPosition.z;","gl_Position = projectionMatrix * viewPosition;","}"].join("\n"),fshader:["precision mediump float;","uniform vec4 fogColor;","uniform vec4 color;","uniform float fogNear;","uniform float fogFar;","uniform bool fogOn;","varying float depth;","void main(void)","{","if (fogOn) {","float lerpVal = clamp(depth / (-fogFar + fogNear), 0.0, 1.0);","lerpVal = pow(lerpVal, 1.5);","gl_FragColor = mix(color, fogColor, lerpVal);","} else {","gl_FragColor = color;","}","}"].join("\n")};return u}),define("goo/entities/systems/HtmlSystem",["goo/entities/systems/System","goo/renderer/Renderer","goo/math/Matrix4x4","goo/math/MathUtils","goo/math/Vector3"],function(t,e,r,i,n){"use strict";function o(e){t.call(this,"HtmlSystem",["TransformComponent","HtmlComponent"]),this.renderer=e}o.prototype=Object.create(t.prototype);var a=2147483647,s=new n,h=["","-webkit-","-moz-","-ms-","-o-"],d=function(t,e,r){for(var i=0;i<h.length;i++)t.style[h[i]+e]=r};return o.prototype.process=function(t){if(0!==t.length)for(var r=e.mainCamera,i=this.renderer.domElement.width,n=this.renderer.domElement.height,o=0;o<t.length;o++){var h=t[o],l=h.htmlComponent;if(l.useTransformComponent)if(l.hidden)l.domElement.style.display="none";else if(s.setv(r.translation).subv(h.transformComponent.worldTransform.translation),r._direction.dot(s)>0)l.domElement.style.display="none";else if(r.getScreenCoordinates(h.transformComponent.worldTransform.translation,i,n,s),s.z<0)l.hidden!==!0&&(l.domElement.style.display="none");else{l.domElement.style.display="";var u=this.renderer,c=u._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/u.svg.currentScale:1,p=Math.floor(s.x/c),f=Math.floor(s.y/c);d(l.domElement,"transform","translate(-50%, -50%) translate("+p+"px, "+f+"px)translate("+u.domElement.offsetLeft+"px, "+u.domElement.offsetTop+"px)"),l.domElement.style.zIndex=a-Math.round(s.z*a)}else l.domElement.style.display=l.hidden?"none":"",d(l.domElement,"transform","")}},o}),define("goo/entities/systems/MovementSystem",["goo/entities/systems/System"],function(t){"use strict";function e(){t.call(this,"MovementSystem",["MovementComponent"])}return e.prototype=Object.create(t.prototype),e.prototype.addVelocityToTransform=function(t,e,r){e.translation.add_d(t.data[0]*r,t.data[1]*r,t.data[2]*r)},e.prototype.addRotToTransform=function(t,e,r){e.rotation.rotateX(t.data[0]*r),e.rotation.rotateY(t.data[1]*r),e.rotation.rotateZ(t.data[2]*r)},e.prototype.applyMovementToEntity=function(t){var e=t._world.tpf,r=t.movementComponent.getRotationVelocity(),i=t.movementComponent.getVelocity(),n=t.transformComponent.transform;this.addVelocityToTransform(i,n,e),this.addRotToTransform(r,n,e),t.transformComponent.setUpdated()},e.prototype.process=function(t){var e,r;for(e=0;e<t.length;e++)r=t[e].movementComponent,this.applyMovementToEntity(t[e])},e}),define("goo/entities/systems/PickingSystem",["goo/entities/systems/System"],function(t){"use strict";function e(e){t.call(this,"PickingSystem",["MeshRendererComponent","TransformComponent"]),this.passive=!0,this.pickRay=null,this.onPick=null,e=e||{},this.setPickLogic(e.pickLogic||null)}return e.prototype=Object.create(t.prototype),e.prototype.setPickLogic=function(t){this.pickLogic=t,t&&-1===this.interests.indexOf("MeshDataComponent")&&this.interests.push("MeshDataComponent")},e.prototype.inserted=function(t){t.meshRendererComponent.isPickable&&this.pickLogic&&this.pickLogic.added(t)},e.prototype.deleted=function(t){this.pickLogic&&this.pickLogic.removed(t)},e.prototype.process=function(t){if(this.pickRay&&this.onPick){for(var e=[],r=0;r<t.length;r++){var i=t[r],n=i.meshRendererComponent;if(n.isPickable)if(this.pickLogic){this.pickLogic.isConstructed(i)||this.pickLogic.added(i);var o=this.pickLogic.getPickResult(this.pickRay,i);o&&o.distances&&o.distances.length&&e.push({entity:i,intersection:o})}else if(n.worldBound){var o=n.worldBound.intersectsRayWhere(this.pickRay);o&&o.distances.length&&e.push({entity:i,intersection:o})}}e.sort(function(t,e){return t.intersection.distances[0]-e.intersection.distances[0]}),this.onPick(e)}},e}),define("goo/entities/systems/PortalSystem",["goo/entities/systems/System"],function(t){"use strict";function e(e,r){t.call(this,"PortalSystem",["MeshRendererComponent","MeshDataComponent","PortalComponent"]),this.renderer=e,this.renderSystem=r,this.renderList=[]}return e.prototype=Object.create(t.prototype),e.prototype.process=function(t){for(var e=0;e<t.length;e++){var r=t[e],i=r.portalComponent;if(i.options.autoUpdate||i.doUpdate){i.doUpdate=!1;var n=i.camera,o=i.target,a=i.secondaryTarget,s=i.overrideMaterial;if(i.alwaysRender||r.isVisible){this.render(this.renderer,n,o,s);var h=r.meshRendererComponent.materials[0];if(h.setTexture("DIFFUSE_MAP",o),i.options.preciseRecursion){var d=o;i.target=a,i.secondaryTarget=d}}}}},e.prototype.render=function(t,e,r,i){t.updateShadows(this.renderSystem.partitioner,this.renderSystem.entities,this.renderSystem.lights);for(var n=0;n<this.renderSystem.preRenderers.length;n++){var o=this.renderSystem.preRenderers[n];o.process(t,this.renderSystem.entities,this.renderSystem.partitioner,e,this.renderSystem.lights)}if(this.renderSystem.partitioner.process(e,this.renderSystem.entities,this.renderList),this.renderSystem.composers.length>0)for(var n=0;n<this.renderSystem.composers.length;n++){var a=this.renderSystem.composers[n];a.render(t,this.renderSystem.currentTpf,e,this.renderSystem.lights,null,!0)}else t.render(this.renderList,e,this.renderSystem.lights,r,!0,i)},e}),define("goo/entities/systems/TextSystem",["goo/entities/systems/System","goo/shapes/TextureGrid","goo/entities/components/MeshDataComponent"],function(t,e,r){"use strict";function i(){t.call(this,"TextSystem",["TextComponent"])}return i.prototype=Object.create(t.prototype),i.prototype.process=function(t){for(var i=0;i<t.length;i++){var n=t[i],o=n.textComponent;if(o.dirty){if(n.hasComponent("MeshDataComponent"))n.getComponent("MeshDataComponent").meshData=e.fromString(o.text);else{var a=e.fromString(o.text),s=new r(a);n.setComponent(s)}this.dirty=!1}}},i}),define("goo/loaders/handlers/ComponentHandler",["goo/util/PromiseUtil"],function(t){"use strict";function e(t,e,r,i){this.world=t,this.getConfig=e,this.updateObject=r,this.loadObject=i}return e.prototype._prepare=function(){},e.prototype._create=function(){throw new Error("ComponentHandler._create is abstract, use ComponentHandler.getHandler(type)")},e.prototype._remove=function(t){t.clearComponent(this._type)},e.prototype._load=function(t,e){return this.loadObject(t,e)},e.prototype.update=function(e,r){if(!e)return t.reject("Entity is missing");if(!r)return this._remove(e),t.resolve();var i=e.getComponent(this._type);return i||(i=this._create(),e.setComponent(i)),this._prepare(r),t.resolve(i)},e.handlerClasses={},e.getHandler=function(t){return e.handlerClasses[t]},e._registerClass=function(t,r){e.handlerClasses[t]=r},e}),define("goo/util/Enum",[],function(){"use strict";function t(t,e){return Object.getOwnPropertyNames(e).forEach(function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(e,r))}),t}function e(e,r){this.name=e,r&&t(this,r),Object.freeze(this)}function r(t){1===arguments.length&&null!==t&&"object"==typeof t?Object.keys(t).forEach(function(r){this[r]=new e(r,t[r])},this):Array.prototype.forEach.call(arguments,function(t){this[t]=new e(t)},this),Object.freeze(this)}return e.prototype=Object.create(null),e.prototype.constructor=e,e.prototype.toString=function(){return"|"+this.name+"|"},Object.freeze(e.prototype),r.prototype.symbols=function(){return Object.keys(this).map(function(t){return this[t]},this)},r.prototype.contains=function(t){return!t instanceof e?!1:this[t.name]===t},r}),define("goo/shapes/Box",["goo/renderer/MeshData","goo/util/Enum"],function(t,e){"use strict";function r(e,i,n,o,a,s){if(1===arguments.length&&arguments[0]instanceof Object){var h=arguments[0];e=h.width,i=h.height,n=h.length,o=h.tileX,a=h.tileY,s=h.textureMode}this.xExtent=void 0!==e?.5*e:.5,this.yExtent=void 0!==i?.5*i:.5,this.zExtent=void 0!==n?.5*n:.5,this.tileX=o||1,this.tileY=a||1,"string"==typeof s&&(s=r.TextureModes[s]),this.textureMode=void 0!==s?s:r.TextureModes.Uniform;var d=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]);t.call(this,d,24,36),this.rebuild()}return r.prototype=Object.create(t.prototype),r.prototype.rebuild=function(){function e(t){for(var e=0;e<t.length;e++){var r=3*t[e];l.push(d[r]),l.push(d[r+1]),l.push(d[r+2])}}function i(){for(var t=0;t<u.length/3;t++)for(var e=0;4>e;e++){var r=3*t;c.push(u[r]),c.push(u[r+1]),c.push(u[r+2])}}var n=this.xExtent,o=this.yExtent,a=this.zExtent,s=this.tileX,h=this.tileY,d=[-n,-o,-a,n,-o,-a,n,o,-a,-n,o,-a,n,-o,a,-n,-o,a,n,o,a,-n,o,a],l=[];e([0,1,2,3,1,4,6,2,4,5,7,6,5,0,3,7,2,6,7,3,0,5,4,1]),this.getAttributeBuffer(t.POSITION).set(l);var u=[0,0,-1,1,0,0,0,0,1,-1,0,0,0,1,0,0,-1,0],c=[];i(),this.getAttributeBuffer(t.NORMAL).set(c);var p=[];if(this.textureMode===r.TextureModes.Uniform)for(var f=0;6>f;f++)p.push(s),p.push(0),p.push(0),p.push(0),p.push(0),p.push(h),p.push(s),p.push(h);else p.push(1,1/3,.75,1/3,.75,2/3,1,2/3),p.push(.75,1/3,.5,1/3,.5,2/3,.75,2/3),p.push(.5,1/3,.25,1/3,.25,2/3,.5,2/3),p.push(.25,1/3,0,1/3,0,2/3,.25,2/3),p.push(.5,1,.5,2/3,.25,2/3,.25,1),p.push(.25,0,.25,1/3,.5,1/3,.5,0);return this.getAttributeBuffer(t.TEXCOORD0).set(p),this.getIndexBuffer().set([2,1,0,3,2,0,6,5,4,7,6,4,10,9,8,11,10,8,14,13,12,15,14,12,18,17,16,19,18,16,22,21,20,23,22,20]),this},r.TextureModes=new e("Uniform","Unfolded"),r}),define("goo/shapes/Sphere",["goo/renderer/MeshData","goo/util/Enum","goo/math/Vector3","goo/math/MathUtils"],function(t,e,r,i){"use strict";function n(e,r,i,o){if(1===arguments.length&&arguments[0]instanceof Object){var a=arguments[0];e=a.zSamples,r=a.radialSamples,i=a.radius,o=a.textureMode}this.zSamples=(void 0!==e?e:8)+1,this.radialSamples=void 0!==r?r:8,this.radius=void 0!==i?i:.5,"string"==typeof o&&(o=n.TextureModes[o]),this.textureMode=void 0!==o?o:n.TextureModes.Polar,this.viewInside=!1;var s=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]),h=this.textureMode===n.TextureModes.Chromeball?this.zSamples+1:this.zSamples;this._useSharedPoleVertices=this.textureMode!==n.TextureModes.Projected&&this.textureMode!==n.TextureModes.Linear;var d=this._useSharedPoleVertices?2:0,l=(h-d)*(this.radialSamples+1)+d,u=6*(h-2)*this.radialSamples;t.call(this,s,l,u),this.rebuild()}function o(t,e,r){t[3*r+0]=t[3*e+0],t[3*r+1]=t[3*e+1],t[3*r+2]=t[3*e+2]}return n.prototype=Object.create(t.prototype),n.prototype.rebuild=function(){for(var e=this.getAttributeBuffer(t.POSITION),a=this.getAttributeBuffer(t.NORMAL),s=this.getAttributeBuffer(t.TEXCOORD0),h=this.getIndexBuffer(),d=1/this.radialSamples,l=2/(this.zSamples-1),u=[],c=[],p=0;p<this.radialSamples;p++){var f=i.TWO_PI*d*p;c[p]=Math.cos(f),u[p]=Math.sin(f)}u[this.radialSamples]=u[0],c[this.radialSamples]=c[0];var m=0,g=this.zSamples;this._useSharedPoleVertices&&(m=1,g=this.zSamples-1);for(var v=0,y=new r,x=new r,_=new r,w=m;g>w;w++){var b=i.HALF_PI*(-1+l*w),S=Math.sin(b),E=this.radius*S,C=x.set(0,0,0);C.z+=E;for(var M,T=Math.sqrt(Math.abs(this.radius*this.radius-E*E)),P=v,p=0;p<this.radialSamples;p++){var R=p*d,A=_.set(c[p],u[p],0);r.mul(A,T,y),e[3*v+0]=C.x+y.x,e[3*v+1]=C.y+y.y,e[3*v+2]=C.z+y.z,M=y.set(e[3*v+0],e[3*v+1],e[3*v+2]),M.normalize(),this.viewInside?(a[3*v+0]=-M.x,a[3*v+1]=-M.y,a[3*v+2]=-M.z):(a[3*v+0]=M.x,a[3*v+1]=M.y,a[3*v+2]=M.z);var D=0;if(this._useSharedPoleVertices||w!==m&&w!==g-1||(D=.5*d),this.textureMode===n.TextureModes.Linear)s[2*v+0]=R+D,s[2*v+1]=.5*(S+1);else if(this.textureMode===n.TextureModes.Projected)s[2*v+0]=R+D,s[2*v+1]=(i.HALF_PI+Math.asin(S))/Math.PI;else if(this.textureMode===n.TextureModes.Polar){var I=(i.HALF_PI-Math.abs(b))/Math.PI,O=I*c[p]+.5,L=I*u[p]+.5;s[2*v+0]=O,s[2*v+1]=L}else if(this.textureMode===n.TextureModes.Chromeball){var I=Math.sin((i.HALF_PI+b)/2);I/=2;var O=I*c[p]+.5,L=I*u[p]+.5;s[2*v+0]=O,s[2*v+1]=L}v++}if(o(e,P,v),o(a,P,v),this.textureMode===n.TextureModes.Linear)s[2*v+0]=1,s[2*v+1]=.5*(S+1);else if(this.textureMode===n.TextureModes.Projected)s[2*v+0]=1,s[2*v+1]=(i.HALF_PI+Math.asin(S))/Math.PI;else if(this.textureMode===n.TextureModes.Polar){var I=(i.HALF_PI-Math.abs(b))/Math.PI;s[2*v+0]=I+.5,s[2*v+1]=.5}else if(this.textureMode===n.TextureModes.Chromeball){var I=Math.sin((i.HALF_PI+b)/2);I/=2,s[2*v+0]=I+.5,s[2*v+1]=.5}v++}if(this.textureMode===n.TextureModes.Chromeball){for(var N=i.HALF_PI-.001,B=this.radius*Math.sin(N),F=Math.sqrt(Math.abs(this.radius*this.radius-B*B)),P=v,p=0;p<this.radialSamples;p++){e[3*v+0]=F*c[p],e[3*v+1]=F*u[p],e[3*v+2]=B;var M=y.set(e[3*v+0],e[3*v+1],e[3*v+2]);M.normalize(),this.viewInside?(a[3*v+0]=-M.x,a[3*v+1]=-M.y,a[3*v+2]=-M.z):(a[3*v+0]=M.x,a[3*v+1]=M.y,a[3*v+2]=M.z);
var I=Math.sin((i.HALF_PI+N)/2);I/=2;var O=I*c[p]+.5,L=I*u[p]+.5;s[2*v+0]=O,s[2*v+1]=L,v++}o(e,P,v),o(a,P,v);var I=Math.sin((i.HALF_PI+N)/2);I/=2,s[2*v+0]=I+.5,s[2*v+1]=.5,v++}this._useSharedPoleVertices&&(e[3*v+0]=0,e[3*v+1]=0,e[3*v+2]=-this.radius,this.viewInside?(a[3*v+0]=0,a[3*v+1]=0,a[3*v+2]=1):(a[3*v+0]=0,a[3*v+1]=0,a[3*v+2]=-1),this.textureMode===n.TextureModes.Polar||this.textureMode===n.TextureModes.Chromeball?(s[2*v+0]=.5,s[2*v+1]=.5):(s[2*v+0]=.5,s[2*v+1]=0),v++,e[3*v+0]=0,e[3*v+1]=0,e[3*v+2]=this.radius,this.viewInside?(a[3*v+0]=0,a[3*v+1]=0,a[3*v+2]=-1):(a[3*v+0]=0,a[3*v+1]=0,a[3*v+2]=1),this.textureMode===n.TextureModes.Polar?(s[2*v+0]=.5,s[2*v+1]=.5):this.textureMode===n.TextureModes.Chromeball?(s[2*v+0]=1,s[2*v+1]=-.5):(s[2*v+0]=.5,s[2*v+1]=1));var k=0,U=this.textureMode===n.TextureModes.Chromeball?this.zSamples+1:this.zSamples,z=0;this._useSharedPoleVertices||(z=this.radialSamples+1);for(var w=0;U-3>w;w++){var V=z,j=V+1;z+=this.radialSamples+1;for(var H=z,G=H+1,v=0;v<this.radialSamples;v++)this.viewInside?(h[k++]=V++,h[k++]=H,h[k++]=j,h[k++]=j++,h[k++]=H++,h[k++]=G++):(h[k++]=V++,h[k++]=j,h[k++]=H,h[k++]=j++,h[k++]=G++,h[k++]=H++)}for(var v=0;v<this.radialSamples;v++){var V,j,H;this._useSharedPoleVertices?(V=v,j=this.vertexCount-2,H=v+1):(V=v,j=v+this.radialSamples+2,H=v+this.radialSamples+1),this.viewInside?(h[k++]=V,h[k++]=H,h[k++]=j):(h[k++]=V,h[k++]=j,h[k++]=H)}for(var X=(g-m-1)*(this.radialSamples+1),v=0;v<this.radialSamples;v++){var V,j,H;this._useSharedPoleVertices?(V=v+X,j=v+1+X,H=this.vertexCount-1):(V=v+X-this.radialSamples-1,j=v+X-this.radialSamples,H=v+X),this.viewInside?(h[k++]=V,h[k++]=H,h[k++]=j):(h[k++]=V,h[k++]=j,h[k++]=H)}return this},n.TextureModes=new e("Linear","Projected","Polar","Chromeball"),n}),define("goo/shapes/Cylinder",["goo/renderer/MeshData","goo/math/Vector3"],function(t,e){"use strict";function r(e,r,i,n){if(1===arguments.length&&arguments[0]instanceof Object){var o=arguments[0];e=o.radialSamples,r=o.radiusTop,i=o.radiusBottom,n=o.height}this.radialSamples=e||8,this.radiusTop="undefined"==typeof r?.5:r,this.radiusBottom="undefined"==typeof i?r:i,this.height="undefined"==typeof n?1:n,this.radius=this.radiusTop;var a=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]);t.call(this,a,4*this.radialSamples+2+2,3*this.radialSamples*4),this.indexModes=["Triangles"],this.rebuild()}return r.prototype=Object.create(t.prototype),r.prototype.rebuild=function(){var r=[],i=[],n=[],o=[],a=this.height,s=a/2,h=this.radiusTop,d=this.radiusBottom,l=this.radialSamples,u=2*Math.PI/l,c=1/l,p=4*l+2+2-1,f=new e,m=0;a&&(m=Math.tan((d-h)/a));for(var g=0,v=0,y=0;l>g;g++,v+=u,y+=c){var x=Math.cos(v),_=Math.sin(v),w=x*h,b=_*h,S=x*d,E=_*d;r.push(w,b,s,S,E,-s,w,b,s,S,E,-s),f.setd(x,_,m),f.normalize(),i.push(0,0,1,0,0,-1,f.x,f.y,f.z,f.x,f.y,f.z),n.push(x/4+.25,_/4+.75,x/4+.25,_/4+.25,.5,y,1,y)}r.push(h,0,s,d,0,-s),i.push(1,0,0,1,0,0),n.push(.5,1,1,1);for(var g=0;l-1>g;g++)o.push(p,4*g+0,4*g+4,4*g+1,p-1,4*g+5,4*g+4+2,4*g+2,4*g+4+3,4*g+2,4*g+3,4*g+4+3);return o.push(p,4*g+0,0,4*g+1,p-1,1,4*g+4,4*g+2,4*g+5,4*g+2,4*g+3,4*g+5),r.push(0,0,-s,0,0,s),i.push(0,0,-.5,0,0,.5),n.push(.25,.25,.25,.75),this.getAttributeBuffer(t.POSITION).set(r),this.getAttributeBuffer(t.NORMAL).set(i),this.getAttributeBuffer(t.TEXCOORD0).set(n),this.getIndexBuffer().set(o),this},r}),define("goo/shapes/Torus",["goo/renderer/MeshData","goo/math/Vector3","goo/math/MathUtils"],function(t,e,r){"use strict";function i(e,r,i,n){if(1===arguments.length&&arguments[0]instanceof Object){var o=arguments[0];e=o.circleSamples,r=o.radialSamples,i=o.tubeRadius,n=o.centerRadius}this._circleSamples=void 0!==e?e:8,this._radialSamples=void 0!==r?r:8,this._tubeRadius=void 0!==i?i:1,this._centerRadius=void 0!==n?n:2,this.viewInside=!1;var a=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]),s=(this._circleSamples+1)*(this._radialSamples+1),h=6*this._circleSamples*this._radialSamples;t.call(this,a,s,h),this.rebuild()}function n(t,e,r){t[3*r+0]=t[3*e+0],t[3*r+1]=t[3*e+1],t[3*r+2]=t[3*e+2]}function o(t,e,r){t[2*r+0]=t[2*e+0],t[2*r+1]=t[2*e+1]}return i.prototype=Object.create(t.prototype),i.prototype.rebuild=function(){for(var i=this.getAttributeBuffer(t.POSITION),a=this.getAttributeBuffer(t.NORMAL),s=this.getAttributeBuffer(t.TEXCOORD0),h=this.getIndexBuffer(),d=1/this._circleSamples,l=1/this._radialSamples,u=0,c=new e,p=new e,f=new e,m=0;m<this._circleSamples;m++){var g=m*d,v=r.TWO_PI*g,y=Math.cos(v),x=Math.sin(v);c.set(y,x,0),e.mul(c,this._centerRadius,p);for(var _=u,w=0;w<this._radialSamples;w++){var b=w*l,S=r.TWO_PI*b,E=Math.cos(S),C=Math.sin(S);f.copy(c).mul(E),f.z=f.z+C,f.normalize(),this.viewInside?(a[3*u+0]=-f.x,a[3*u+1]=-f.y,a[3*u+2]=-f.z):(a[3*u+0]=f.x,a[3*u+1]=f.y,a[3*u+2]=f.z),f.mul(this._tubeRadius).add(p),i[3*u+0]=f.x,i[3*u+1]=f.y,i[3*u+2]=f.z,s[2*u+0]=b,s[2*u+1]=g,u++}n(i,_,u),n(a,_,u),s[2*u+0]=1,s[2*u+1]=g,u++}for(var M=0;M<=this._radialSamples;M++,u++)n(i,M,u),n(a,M,u),o(s,M,u),s[2*u+1]=1;for(var T=0,P=0,m=0;m<this._circleSamples;m++){var R=P,A=R+1;P+=this._radialSamples+1;var D=P,I=D+1;for(u=0;u<this._radialSamples;u++)this.viewInside?(h[T++]=R++,h[T++]=A,h[T++]=D,h[T++]=A++,h[T++]=I++,h[T++]=D++):(h[T++]=R++,h[T++]=D,h[T++]=A,h[T++]=A++,h[T++]=D++,h[T++]=I++)}return this},i}),define("goo/shapes/Disk",["goo/renderer/MeshData"],function(t){"use strict";function e(e,r,i){if(1===arguments.length&&arguments[0]instanceof Object){var n=arguments[0];e=n.nSegments,r=n.radius,i=n.pointiness}this.nSegments=e||8,this.radius=r||1,this.pointiness=i||0;var o=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]);t.call(this,o,this.nSegments+1,3*this.nSegments),this.indexModes=["Triangles"],this.rebuild()}return e.prototype=Object.create(t.prototype),e.prototype.rebuild=function(){for(var e=[],r=[],i=[],n=[],o=Math.atan2(this.radius,this.pointiness),a=2*Math.PI/this.nSegments,s=0,h=0;s<this.nSegments;s++,h+=a)e.push(Math.cos(h)*this.radius,Math.sin(h)*this.radius,0),r.push(Math.cos(h)*Math.cos(o),Math.sin(h)*Math.cos(o),Math.sin(o)),i.push(.5*Math.cos(h)+.5,.5*Math.sin(h)+.5),n.push(this.nSegments,s,(s+1)%this.nSegments);return e.push(0,0,this.pointiness),r.push(0,0,1),i.push(.5,.5),this.getAttributeBuffer(t.POSITION).set(e),this.getAttributeBuffer(t.NORMAL).set(r),this.getAttributeBuffer(t.TEXCOORD0).set(i),this.getIndexBuffer().set(n),this},e}),define("goo/shapes/Cone",["goo/renderer/MeshData"],function(t){"use strict";function e(e,r,i){if(1===arguments.length&&arguments[0]instanceof Object){var n=arguments[0];e=n.radialSamples,r=n.radius,i=n.height}this.radialSamples=e||8,this.radius=r||1,this.height="undefined"==typeof i?2:i;var o=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]);t.call(this,o,3*this.radialSamples+this.radialSamples+1,3*this.radialSamples*2),this.indexModes=["Triangles"],this.rebuild()}return e.prototype=Object.create(t.prototype),e.prototype.rebuild=function(){for(var e=[],r=[],i=[],n=[],o=Math.atan2(this.radius,this.height),a=2*Math.PI/this.radialSamples,s=1/this.radialSamples,h=0,d=0,l=0;h<this.radialSamples;h++,d+=a,l+=s)e.push(0,0,this.height,Math.cos(d)*this.radius,Math.sin(d)*this.radius,0,Math.cos(d+a)*this.radius,Math.sin(d+a)*this.radius,0),r.push(0,0,1,Math.cos(d)*Math.cos(o),Math.sin(d)*Math.cos(o),Math.sin(o),Math.cos(d+a)*Math.cos(o),Math.sin(d+a)*Math.cos(o),Math.sin(o)),i.push(l+s/2,1,l,.5,l+s,.5),n.push(3*h+0,3*h+1,3*h+2);var u=3*h+0;e.push(0,0,0),r.push(0,0,-1),i.push(.25,.25);for(var h=1,d=0;h<=this.radialSamples-1;h++,d+=a)e.push(Math.cos(d)*this.radius,Math.sin(d)*this.radius,0),r.push(0,0,-1),i.push(.25*Math.cos(d)+.25,.25*Math.sin(d)+.25),n.push(u+h,u,u+h+1);return e.push(Math.cos(d)*this.radius,Math.sin(d)*this.radius,0),r.push(0,0,-1),i.push(.25*Math.cos(d)+.25,.25*Math.sin(d)+.25),n.push(u+this.radialSamples,u,u+1),this.getAttributeBuffer(t.POSITION).set(e),this.getAttributeBuffer(t.NORMAL).set(r),this.getAttributeBuffer(t.TEXCOORD0).set(i),this.getIndexBuffer().set(n),this},e}),define("goo/util/ShapeCreatorMemoized",["goo/shapes/Box","goo/shapes/Quad","goo/shapes/Sphere","goo/shapes/Cylinder","goo/shapes/Torus","goo/shapes/Disk","goo/shapes/Cone"],function(t,e,r,i,n,o,a){"use strict";function s(){}function h(t,e){var r=Object.keys(e),i=r.map(function(t){return t+""+e[t]}).join("");return t+i}function d(t,e,r){var i=h(t,e);if(l[i])return l[i];var n=r();return l[i]=n,n}var l={};return s.createQuad=function(t,r){var i=1,n=1,o=1,a=1;return r&&i===r.xExtent&&n===r.yExtent&&o===r.tileX&&a===r.tileY?r:d("quad",{},function(){return new e(i,n,o,a)})},s.createBox=function(e,r){e=e||{},e.textureMode=e.textureMode||"Uniform";var i=1,n=1,o=1,a=1,s=1;return r&&i===r.xExtent&&n===r.yExtent&&o===r.zExtent&&a===r.tileX&&s===r.tileY&&e.textureMode===r.textureMode.name?r:d("box",e,function(){return new t(i,n,o,a,s,e.textureMode)})},s.createSphere=function(t,e){t=t||{},t.zSamples=t.zSamples||8,t.radialSamples=t.radialSamples||8,t.textureMode=t.textureMode||"Projected";var i=1;return e&&t.zSamples===e.zSamples-1&&t.radialSamples===e.radialSamples&&t.textureMode===e.textureMode.name&&i===e.radius?e:d("sphere",t,function(){return new r(t.zSamples,t.radialSamples,i,t.textureMode)})},s.createCylinder=function(t,e){t=t||{},t.radialSamples=t.radialSamples||8;var r=1;return e&&t.radialSamples===e.radialSamples&&r===e.radius?e:d("cylinder",t,function(){return new i(t.radialSamples,r)})},s.createTorus=function(t,e){t=t||{},t.radialSamples=t.radialSamples||8,t.circleSamples=t.circleSamples||12,t.tubeRadius=t.tubeRadius||.2;var r=1;return e&&t.radialSamples===e._radialSamples&&t.circleSamples===e._circleSamples&&t.tubeRadius===e._tubeRadius&&r===e._centerRadius?e:new n(t.circleSamples,t.radialSamples,t.tubeRadius,r)},s.createDisk=function(t,e){t=t||{},t.radialSamples=t.radialSamples||8,t.pointiness="undefined"==typeof t.pointiness?0:t.pointiness;var r=1;return e&&t.radialSamples===e.nSegments&&t.pointiness===e.pointiness&&r===e.radius?e:t.pointiness===Math.floor(t.pointiness)?d("disk",t,function(){return new o(t.radialSamples,r,t.pointiness)}):new o(t.radialSamples,r,t.pointiness)},s.createCone=function(t,e){t=t||{},t.radialSamples=t.radialSamples||8,t.height="undefined"==typeof t.height?0:t.height;var r=1;return e&&t.radialSamples===e.radialSamples&&t.height===e.height&&r===e.radius?e:t.height===Math.floor(t.height)?d("cone",t,function(){return new a(t.radialSamples,r,t.height)}):new a(t.radialSamples,r,t.height)},s.clearCache=function(t){for(var e=Object.keys(l),r=0;r<e[r];r++){var i=e[r],n=l[i];t&&n.destroy(t),delete l[i]}},s}),define("goo/loaders/handlers/CameraComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/CameraComponent","goo/renderer/Camera","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e,r,i,n,o){"use strict";function a(){t.apply(this,arguments),this._type="CameraComponent"}return a.prototype=Object.create(t.prototype),t._registerClass("camera",a),a.prototype.constructor=a,a.prototype._prepare=function(t){o.defaults(t,{near:1,far:1e4,projectionMode:"Perspective",aspect:1,lockedRatio:!1}),"Perspective"===t.projectionMode&&void 0===t.fov&&(t.fov=45),"Parallel"===t.projectionMode&&void 0===t.size&&(t.size=100),"Perspective"!==t.projectionMode&&"Parallel"!==t.projectionMode&&(t.projectionMode="Perspective")},a.prototype._create=function(){var t=new r(45,1,1,1e3),i=new e(t);return i},a.prototype.update=function(e,i,n){return t.prototype.update.call(this,e,i,n).then(function(t){if(t){if(t.camera.setProjectionMode(r[i.projectionMode]),t.camera.lockedRatio=!1,"Perspective"===i.projectionMode)t.camera.setFrustumPerspective(i.fov,null,i.near,i.far);else{var e=i.size;t.camera.setFrustum(i.near,i.far,-e,e,e,-e,null),t.camera.size=e}return t}})},a}),define("goo/loaders/handlers/EntityHandler",["goo/loaders/handlers/ConfigHandler","goo/loaders/handlers/ComponentHandler","goo/util/rsvp","goo/util/StringUtil","goo/util/PromiseUtil"],function(t,e,r,i,n){"use strict";function o(){t.apply(this,arguments),this._componentHandlers={}}function a(t,e){if(t._tags={},e)for(var r in e)t.setTag(r)}function s(t,e){if(t._attributes={},e)for(var r in e)t.setAttribute(r,e[r])}return o.prototype=Object.create(t.prototype),o.prototype.constructor=o,t._registerClass("entity",o),o.prototype._create=function(){return this.world.createEntity()},o.prototype._remove=function(t){var e=this._objects[t],i=this;if(e){for(var n=[],o=e._components.slice(0),a=0;a<o.length;a++){var s=this._getComponentType(o[a]),h=this._updateComponent(e,s,null);h instanceof r.Promise&&n.push(h)}return r.all(n).then(function(){e.removeFromWorld(),delete i._objects[t]})}},o.prototype._update=function(e,r,i){var o=this;return t.prototype._update.call(this,e,r,i).then(function(t){if(t){t.id=e,t.name=r.name,window.entities=window.entities||{},t.static=!!r.static,a(t,r.tags),s(t,r.attributes);var h=[];for(var d in r.components)if(r.components[d]){var l=o._updateComponent(t,d,r.components[d],i);l?h.push(l):console.error("Error handling component "+d)}for(var u=t._components,c=0;c<u.length;c++){var d=o._getComponentType(u[c]);r.components[d]||o._updateComponent(t,d,null,i)}return n.optimisticAll(h).then(function(){return r.hidden?t.hide():t.show(),t})}})},o.prototype._updateComponent=function(t,e,r,i){var n=this._getHandler(e);if(!n)return null;var o=n.update(t,r,i);return o&&o.then?o:null},o.prototype._getComponentType=function(t){var e=t.type;return e=e.slice(0,e.lastIndexOf("Component")),e=i.uncapitalize(e),"howler"===e&&(e="sound"),e},o.prototype._getHandler=function(t){if(!this._componentHandlers[t]){var r=e.getHandler(t);r&&(this._componentHandlers[t]=new r(this.world,this.getConfig,this.updateObject,this.loadObject))}return this._componentHandlers[t]},o}),define("goo/loaders/handlers/LightComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/LightComponent","goo/renderer/light/PointLight","goo/renderer/light/SpotLight","goo/renderer/light/DirectionalLight","goo/math/Vector","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e,r,i,n,o,a,s,h){"use strict";function d(){t.apply(this,arguments),this._type="LightComponent"}return d.prototype=Object.create(t.prototype),d.prototype.constructor=d,t._registerClass("light",d),d.prototype._prepare=function(t){if(h.defaults(t,{direction:[0,0,0],color:[1,1,1],shadowCaster:!1,lightCookie:null}),"DirectionalLight"!==t.type&&(t.range=void 0!==t.range?t.range:1e3),t.shadowCaster){t.shadowSettings=t.shadowSettings||{},h.defaults(t.shadowSettings,{shadowType:"Basic",near:1,far:1e3,resolution:[512,512],darkness:.5});var e=t.shadowSettings;"Parallel"===e.projection?e.size=void 0!==e.size?e.size:400:e.fov=void 0!==e.fov?e.fov:55}},d.prototype._create=function(){return new e},d.prototype.update=function(e,a,s){var d=this,l={SpotLight:i,DirectionalLight:n,PointLight:r};return t.prototype.update.call(this,e,a,s).then(function(t){if(t){var e=t.light;e&&l[a.type]===e.constructor||(e=new l[a.type],t.light=e);for(var r in a){var i=a[r];if(e.hasOwnProperty(r))if("shadowSettings"===r)for(var r in i){var n=i[r];e.shadowSettings[r]instanceof o?e.shadowSettings[r].set(n):e.shadowSettings[r]=h.clone(n)}else e[r]instanceof o?e[r].set(i):e[r]=h.clone(i)}if("PointLight"===a.type&&(e.shadowCaster=!1),a.lightCookie&&"PointLight"!==a.type){var u=a.lightCookie;return u&&u.textureRef&&u.enabled!==!1?d._load(u.textureRef,s).then(function(r){return e.lightCookie=r,t}):(e.lightCookie=null,t)}return e.lightCookie=null,t}})},d}),define("goo/loaders/handlers/MaterialHandler",["goo/loaders/handlers/ConfigHandler","goo/renderer/Material","goo/renderer/Util","goo/renderer/shaders/ShaderLib","goo/renderer/RenderQueue","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e,r,i,n,o,a,s){"use strict";function h(){t.apply(this,arguments)}return h.prototype=Object.create(t.prototype),h.prototype.constructor=h,t._registerClass("material",h),h.ENGINE_SHADER_PREFIX="GOO_ENGINE_SHADERS/",h.prototype._prepare=function(t){t.blendState||(t.blendState={}),s.defaults(t.blendState,{blending:"NoBlending",blendEquation:"AddEquation",blendSrc:"SrcAlphaFactor",blendDst:"OneMinusSrcAlphaFactor"}),t.cullState||(t.cullState={}),s.defaults(t.cullState,{enabled:!0,cullFace:"Back",frontFace:"CCW"}),t.depthState||(t.depthState={}),s.defaults(t.depthState,{enabled:!0,write:!0}),(null===t.renderQueue||void 0===t.renderQueue)&&(t.renderQueue=-1),(null===t.dualTransparency||void 0===t.dualTransparency)&&(t.dualTransparency=!1),(null===t.wireframe||void 0===t.wireframe)&&(t.wireframe=!1),(null===t.flat||void 0===t.flat)&&(t.flat=!1)},h.prototype._create=function(){return new e},h.prototype._remove=function(t){var e=this._objects[t];e&&(e.shader.destroy(),e.empty(),delete this._objects[t])},h.prototype._update=function(r,a,d){var l=this;return t.prototype._update.call(this,r,a,d).then(function(t){function r(e,r,i){return l._load(r,i).then(function(r){t.setTexture(e,r)}).then(null,function(t){throw new Error("Error loading texture: "+r+" - "+t)})}if(t){var u=[];s.extend(t.blendState,a.blendState),s.extend(t.cullState,a.cullState),s.extend(t.depthState,a.depthState),t.id=a.id,t.name=a.name,t.wireframe=a.wireframe,t.flat=a.flat,t.dualTransparency=a.dualTransparency,t.renderQueue=-1===a.renderQueue?"NoBlending"!==a.blendState.blending?n.TRANSPARENT:null:a.renderQueue,t.uniforms={};for(var c in a.uniforms)void 0===a.uniforms[c].enabled?t.uniforms[c]=s.clone(a.uniforms[c]):a.uniforms[c].enabled&&(t.uniforms[c]=s.clone(a.uniforms[c].value));var p=a.shaderRef;if(p)if(0===p.indexOf(h.ENGINE_SHADER_PREFIX)){var f=p.slice(h.ENGINE_SHADER_PREFIX.length);t.shader=e.createShader(i[f])}else{var m=l._load(p,d).then(function(e){t.shader=e}).then(null,function(t){throw new Error("Error loading shader: "+t)});u.push(m)}else t.shader=e.createShader(i.texturedLit,"DefaultShader");var g;for(var v in a.texturesMapping)g=a.texturesMapping[v],g&&g.textureRef&&g.enabled!==!1?u.push(r(v,g.textureRef,d)):t.removeTexture(v);for(var v in t._textureMaps)a.texturesMapping[v]||t.removeTexture(v);return o.all(u).then(function(){return t})}})},h}),define("goo/loaders/handlers/MeshDataComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/MeshDataComponent","goo/renderer/bounds/BoundingBox","goo/util/ShapeCreatorMemoized","goo/util/rsvp","goo/util/ObjectUtil","goo/util/StringUtil"],function(t,e,r,i,n,o,a){"use strict";function s(){t.apply(this,arguments),this._type="MeshDataComponent"}return s.prototype=Object.create(t.prototype),s.prototype.constructor=s,t._registerClass("meshData",s),s.prototype._prepare=function(t){return o.defaults(t,{})},s.prototype._create=function(){return new e},s.prototype._remove=function(t){t.meshDataComponent&&t.meshDataComponent.meshData&&this.world.gooRunner&&t.meshDataComponent.meshData.destroy(this.world.gooRunner.renderer.context),t.clearComponent("MeshDataComponent")},s.prototype.update=function(e,o,s){var h=this;return t.prototype.update.call(this,e,o,s).then(function(t){if(t)if(o.shape){var e=i["create"+a.capitalize(o.shape)];if(e)return t.meshData=e(o.shapeOptions,t.meshData),t.autoCompute=!0,t}else{if(o.meshRef){var d=[];return d.push(h._load(o.meshRef,s).then(function(e){if(t.meshData=e,e.boundingBox){var i=e.boundingBox.min,n=e.boundingBox.max,o=[n[0]-i[0],n[1]-i[1],n[2]-i[2]],a=[.5*(n[0]+i[0]),.5*(n[1]+i[1]),.5*(n[2]+i[2])],s=new r;s.xExtent=o[0]/2,s.yExtent=o[1]/2,s.zExtent=o[2]/2,s.center.seta(a),t.modelBound=s,t.autoCompute=!1}})),o.poseRef?d.push(h._load(o.poseRef,s).then(function(e){t.currentPose=e})):t.currentPose=null,n.all(d).then(function(){return t})}console.warn("MeshDataComponent config does not contain a primitive spec or a reference to a mesh")}})},s}),define("goo/loaders/handlers/MeshDataHandler",["goo/loaders/handlers/ConfigHandler","goo/renderer/MeshData","goo/renderer/BufferUtils","goo/util/PromiseUtil","goo/util/ArrayUtil"],function(t,e,r,i,n){"use strict";function o(){t.apply(this,arguments)}var a=4;return o.prototype=Object.create(t.prototype),o.prototype.constructor=o,t._registerClass("mesh",o),o.prototype._remove=function(t){this._objects[t]&&this._objects[t].destroy&&this.world.gooRunner&&this._objects[t].destroy(this.world.gooRunner.renderer.context),delete this._objects[t]},o.prototype._update=function(t,e,r){if(!e)return this._remove(t),i.resolve();if(this._objects[t])return i.resolve(this._objects[t]);var n=this;return this.loadObject(e.binaryRef,r).then(function(r){if(!r)throw new Error("Binary mesh data was empty");var i=n._createMeshData(e,r);return n._fillMeshData(i,e,r),n._objects[t]=i,i})},o.prototype._createMeshData=function(t){var i="SkinnedMesh"===t.type,n=t.vertexCount;if(0===n)return null;var o=0;t.indexLengths?o=t.indexLengths.reduce(function(t,e){return t+e}):t.indices&&(o=t.indices.wordLength);var a={float32:"Float",uint8:"UnsignedByte",uint16:"UnsignedShort",uint32:"UnsignedInt"};"Trident"===r.browserType&&(a.uint8="UnsignedShort");var s={};for(var h in t.attributes){var d=t.attributes[h],l=d.value[2];s[h]=e.createAttribute(d.dimensions,a[l])}var u=new e(s,n,o);return u.type=i?e.SKINMESH:e.MESH,u},o.prototype._fillMeshData=function(t,r,i){var o=t.type===e.SKINMESH;for(var s in r.attributes)if("JOINTIDS"!==s){var h=r.attributes[s].value;t.getAttributeBuffer(s).set(n.getTypedArray(i,h))}if(o&&r.attributes.JOINTIDS){for(var d=t.getAttributeBuffer(e.JOINTIDS),l=n.getTypedArray(i,r.attributes.JOINTIDS.value),u=[],c=0,p=0;p<l.length;p++){var f=l[p];void 0===u[f]&&(u[f]=c++),d.set([u[f]],p)}for(var m=[],f=0;f<u.length;f++){var c=u[f];null!==c&&(m[c]=f)}t.paletteMap=m,t.weightsPerVertex=a}if(t.getIndexBuffer().set(n.getTypedArray(i,r.indices)),t.indexModes=r.indexModes.slice(),t.indexLengths=r.indexLengths.slice(),r.boundingVolume){if("BoundingBox"!==r.boundingVolume.type)throw new Error("Bounding volume was not BoundingBox");t.boundingBox={min:r.boundingVolume.min,max:r.boundingVolume.max}}return t},o}),define("goo/loaders/handlers/MeshRendererComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/MeshRendererComponent","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e,r,i,n,o,a){"use strict";function s(){t.apply(this,arguments),this._type="MeshRendererComponent"}return s.prototype=Object.create(t.prototype),s.prototype.constructor=s,t._registerClass("meshRenderer",s),s.DEFAULT_MATERIAL=new r(i.uber,"Default material"),s.prototype._prepare=function(t){return a.defaults(t,{cullMode:"Dynamic",castShadows:!0,receiveShadows:!0,reflectable:!0})},s.prototype._create=function(){return new e},s.prototype.update=function(e,r,i){var o=this;return t.prototype.update.call(this,e,r,i).then(function(t){if(t){t.cullMode=r.cullMode,t.castShadows=r.castShadows,t.receiveShadows=r.receiveShadows,t.isReflectable=r.reflectable;var e=r.materials;if(!e||!Object.keys(e).length){var h=t.materials.filter(function(t){return"gooSelectionIndicator"===t.name});return t.materials=[s.DEFAULT_MATERIAL].concat(h),t}var d=[];return a.forEach(e,function(t){d.push(o._load(t.materialRef,i))},null,"sortValue"),n.all(d).then(function(e){var r=t.materials.filter(function(t){return"gooSelectionIndicator"===t.name});return t.materials=e.concat(r),t})}})},s}),define("goo/loaders/handlers/SceneHandler",["goo/loaders/handlers/ConfigHandler","goo/entities/SystemBus","goo/util/ArrayUtil","goo/util/ObjectUtil","goo/util/rsvp"],function(t,e,r,i,n){"use strict";function o(){t.apply(this,arguments)}return o.prototype=Object.create(t.prototype),o.prototype.constructor=o,t._registerClass("scene",o),o.prototype._remove=function(t){var e=this._objects[t];if(e)for(var r=0;r<e.entities.length;r++)e.entities[r].removeFromWorld();delete this._objects[t]},o.prototype._create=function(){return{id:null,entities:{},posteffects:[],environment:null,initialCameraRef:null}},o.prototype._update=function(r,i,o){var a=this;return t.prototype._update.call(this,r,i,o).then(function(t){if(t){t.id=r;var s=[];return s.push(a._handleEntities(i,t,o)),i.posteffectsRef&&s.push(a._load(i.posteffectsRef,o)),i.environmentRef&&s.push(a._load(i.environmentRef,o)),o.scene&&o.scene.dontSetCamera||i.initialCameraRef&&i.initialCameraRef!==t.initialCameraRef&&s.push(a._load(i.initialCameraRef,o).then(function(r){r&&r.cameraComponent&&e.emit("goo.setCurrentCamera",{camera:r.cameraComponent.camera,entity:r}),t.initialCameraRef=i.initialCameraRef})),n.all(s).then(function(){return t})}})},o.prototype._handleEntities=function(t,e,r){var o=this,a=[],s=i.clone(t.entities),h=[];for(var d in e.entities)s[d]?delete s[d]:h[d]=d;return i.forEach(t.entities,function(t){a.push(o._load(t.entityRef,r))},null,"sortValue"),n.all(a).then(function(t){for(var r=0;r<t.length;r++){var i=t[r];s[i.id]&&i.addToWorld(),e.entities[i.id]=i}for(var n in h)delete e.entities[n]})},o.prototype._handlePosteffects=function(t,e,r){return this._load(t.posteffectsRef,r)},o.prototype._handleEnvironment=function(t,e,r){return this._load(t.environmentRef,r)},o}),define("goo/loaders/handlers/ShaderHandler",["goo/loaders/handlers/ConfigHandler","goo/renderer/Material","goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/shaders/ShaderBuilder","goo/util/rsvp","goo/util/PromiseUtil"],function(t,e,r,i,n,o,a){"use strict";function s(){t.apply(this,arguments)}return s.prototype=Object.create(t.prototype),s.prototype.constructor=s,t._registerClass("shader",s),s.prototype._remove=function(t){this._objects[t]&&this._objects[t].destroy&&this._objects[t].destroy(),delete this._objects[t]},s.prototype._update=function(t,r,i){if(!r)return this._remove(t),a.resolve();if(!r.vshaderRef)return a.reject("Shader error, missing vertex shader ref");if(!r.fshaderRef)return a.reject("Shader error, missing fragment shader ref");var s=[this.loadObject(r.vshaderRef,i),this.loadObject(r.fshaderRef,i)],h=this;return o.all(s).then(function(i){var o=i[0],s=i[1];if(!o)return a.reject("Vertex shader"+r.vshaderRef+"in shader"+t+"not found");if(!s)return a.reject("Fragment shader"+r.fshaderRef+"in shader"+t+"not found");var d={defines:r.defines||{},attributes:r.attributes||{},uniforms:r.uniforms||{},vshader:o,fshader:s};if(r.processors){d.processors=[];for(var l=0;l<r.processors.length;l++){var u=r.processors[l];n[u]?d.processors.push(n[u].processor):console.error("Unknown processor "+u)}}var c=e.createShader(d,t);return h._objects[t]=c,c})},s}),define("goo/loaders/handlers/TransformComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/TransformComponent","goo/math/MathUtils","goo/util/ObjectUtil","goo/util/rsvp"],function(t,e,r,i,n){"use strict";function o(){t.apply(this,arguments),this._type="TransformComponent"}return o.prototype=Object.create(t.prototype),o.prototype.constructor=o,t._registerClass("transform",o),o.prototype._prepare=function(t){return i.defaults(t,{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]})},o.prototype._create=function(){return new e},o.prototype._remove=function(t){var e=t.transformComponent;e.transform.translation.setd(0,0,0),e.transform.setRotationXYZ(0,0,0),e.transform.scale.setd(1,1,1);for(var r=0;r<e.children.length;r++){var i=e.children[r];e.detachChild(i)}e.setUpdated()},o.prototype.update=function(e,i,o){function a(t,e){return s.loadObject(e,o).then(function(e){if(e&&e.transformComponent){t.attachChild(e.transformComponent);var r=s.world.entityManager.containsEntity(e)||-1!==s.world._addedEntities.indexOf(e),i=s.world.entityManager.containsEntity(t.entity)||s.world._addedEntities.indexOf(t.entity)>-1;!r&&i&&e.addToWorld()}else console.error("Failed to add child to transform component");return t})}var s=this;return t.prototype.update.call(this,e,i,o).then(function(t){if(t){t.transform.translation.seta(i.translation),t.transform.setRotationXYZ(r.DEG_TO_RAD*i.rotation[0],r.DEG_TO_RAD*i.rotation[1],r.DEG_TO_RAD*i.rotation[2]),t.transform.scale.seta(i.scale);var e=[];if(i.children){for(var o=Object.keys(i.children),s=0;s<o.length;s++){var h=i.children[o[s]].entityRef;e.push(a(t,h))}for(var s=0;s<t.children.length;s++){var d=t.children[s],l=d.entity.id;i.children[l]||t.detachChild(d)}}else for(var s=0;s<t.children.length;s++){var d=t.children[s];t.detachChild(d)}return n.all(e).then(function(){return t.setUpdated(),t})}})},o}),define("goo/loaders/handlers/ProjectHandler",["goo/loaders/handlers/ConfigHandler"],function(t){"use strict";function e(){t.apply(this,arguments)}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,t._registerClass("project",e),e.prototype._remove=function(t,e){var r=this._objects[t];r&&this.updateObject(r.mainScene.id,null,e)},e.prototype._create=function(){return{mainScene:null}},e.prototype._update=function(e,r,i){var n=this;return t.prototype._update.call(this,e,r,i).then(function(t){function e(){return n._load(r.mainSceneRef,i).then(function(e){return t.mainScene=e,t})}if(t)return t.mainScene&&r.mainSceneRef!==t.mainScene.id?n.updateObject(t.mainScene.id,null,i).then(e):e()})},e}),define("goo/loaders/handlers/SoundComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/SoundComponent","goo/sound/AudioContext","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e,r,i,n,o){"use strict";function a(){t.apply(this,arguments),this._type="SoundComponent"}return a.prototype=Object.create(t.prototype),a.prototype.constructor=a,t._registerClass("sound",a),a.prototype._remove=function(t){var e=t.soundComponent;if(e&&e.sounds)for(var r=e.sounds,i=0;i<r.length;i++)r[i].stop()},a.prototype._prepare=function(t){o.defaults(t,{volume:1,reverb:0})},a.prototype._create=function(){return new e},a.prototype.update=function(e,a,s){if(!r)return n.resolve();var h=this;return t.prototype.update.call(this,e,a,s).then(function(t){if(t){t.updateConfig(a);for(var e=0;e<t.sounds.length;e++){var r=t.sounds[e];a.sounds[r.id]||t.removeSound(r)}var n=[];return o.forEach(a.sounds,function(t){n.push(h._load(t.soundRef,s))},null,"sortValue"),i.all(n).then(function(e){for(var r=0;r<e.length;r++)-1===t.sounds.indexOf(e[r])&&t.addSound(e[r]);return t})}})},a}),define("goo/sound/Sound",["goo/sound/AudioContext","goo/math/MathUtils","goo/util/rsvp"],function(t,e,r){"use strict";function i(){this.id=null,this.name=null,this._loop=!1,this._rate=1,this._offset=0,this._duration=null,this._volume=1,this._buffer=null,this._stream=null,this._streamSource=null,this._currentSource=null,this._outNode=t.createGain(),this.connectTo(),this._playStart=0,this._pausePos=0,this._endPromise=null,this._paused=!1}return i.prototype.play=function(){if(this._currentSource)return this._endPromise;if(this._endPromise=new r.Promise,!this._buffer||this._stream)return this._endPromise;var e=this._currentSource=t.createBufferSource();this._paused=!1,this._currentSource.onended=function(){this._currentSource!==e||this._paused||this.stop()}.bind(this),this._currentSource.playbackRate.value=this._rate,this._currentSource.connect(this._outNode),this._currentSource.buffer=this._buffer,this._currentSource.loop=this._loop,this._loop&&(this._currentSource.loopStart=this._offset,this._currentSource.loopEnd=this._duration+this._offset),this._playStart=t.currentTime-this._pausePos;var i=this._duration-this._pausePos;return this._currentSource.start(0,this._pausePos+this._offset,i),this._endPromise},i.prototype.pause=function(){this._currentSource&&(this._paused=!0,this._pausePos=(t.currentTime-this._playStart)%this._duration,this._pausePos/=this._rate,this._stop())},i.prototype.stop=function(){this._paused=!1,this._pausePos=0,this._endPromise&&this._endPromise.resolve(),this._currentSource&&this._stop()},i.prototype.fadeIn=function(t){this.stop();var e=this._volume;this._outNode.gain.value=0;var r=this.fade(e,t);return this.play(),r},i.prototype.fadeOut=function(t){return this.fade(0,t)},i.prototype.fade=function(e,i){this._outNode.gain.setValueAtTime(this._outNode.gain.value,t.currentTime),this._outNode.gain.linearRampToValueAtTime(e,t.currentTime+i);var n=new r.Promise;
return setTimeout(function(){n.resolve()},1e3*i),n},i.prototype.isPlaying=function(){return!!this._currentSource},i.prototype._stop=function(){this._currentSource.stop(0),this._currentSource=null},i.prototype.update=function(t){t=t||{},void 0!==t.id&&(this.id=t.id),void 0!==t.name&&(this.name=t.name),void 0!==t.loop&&(this._loop=!!t.loop,this._currentSource&&(this._currentSource.loop=this._loop)),void 0!==t.volume&&(this._volume=e.clamp(t.volume,0,1),this._outNode.gain.value=this._volume),void 0!==t.offset&&(this._offset=t.offset),void 0!==t.duration&&(this._duration=t.duration),void 0!==t.timeScale&&(this._rate=t.timeScale,this._currentSource&&(this._currentSource.playbackRate.value=t.timeScale)),this._buffer&&this._clampInterval()},i.prototype._clampInterval=function(){this._offset=Math.min(this._offset,this._buffer.duration),this._duration=null!==this._duration?Math.min(this._buffer.duration-this._offset,this._duration):this._buffer.duration-this._offset,this._pausePos=e.clamp(this._pausePos,0,this._duration)},i.prototype.connectTo=function(t){if(this._outNode.disconnect(),t){t instanceof Array||(t=[t]);for(var e=0;e<t.length;e++)this._outNode.connect(t[e])}},i.prototype.setAudioBuffer=function(t){this.setAudioStream(null),this._buffer=t,this._clampInterval()},i.prototype.setAudioStream=function(e){return e?(this.stop(),this._stream=e,this._streamSource=t.createMediaStreamSource(e),void this._streamSource.connect(this._outNode)):void(this._streamSource&&(this._streamSource.disconnect(),this._streamSource=null))},i}),define("goo/loaders/handlers/SoundHandler",["goo/loaders/handlers/ConfigHandler","goo/sound/AudioContext","goo/sound/Sound","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e,r,i,n,o){"use strict";function a(){if(t.apply(this,arguments),this._audioCache={},void 0!==window.Audio){var e=new Audio;this._codecs=[{type:"mp3",enabled:!!e.canPlayType("audio/mpeg;")},{type:"ogg",enabled:!!e.canPlayType('audio/ogg; codecs="vorbis"')},{type:"wav",enabled:!!e.canPlayType('audio/wav; codecs="1"')}]}else this._codecs=[]}return a.prototype=Object.create(t.prototype),a.prototype.constructor=a,t._registerClass("sound",a),a.prototype._remove=function(t){var e=this._objects[t];e&&e.stop(),delete this._objects[t]},a.prototype._prepare=function(t){o.defaults(t,{loop:!1,audioRefs:{},volume:1,name:"A Sound"})},a.prototype._create=function(){return new r},a.prototype._update=function(r,i,o){if(!e)return n.resolve();var a=this;return t.prototype._update.call(this,r,i,o).then(function(t){if(t){t.update(i);for(var r=0;r<a._codecs.length;r++){var o=a._codecs[r],s=i.audioRefs[o.type];if(s&&o.enabled)return a._audioCache[s]?(t.setAudioBuffer(a._audioCache[s]),t):a.loadObject(s).then(function(t){return n.createPromise(function(r){e.decodeAudioData(t,function(t){r(t)},function(){console.error("Could not decode audio "+s),r(null)})})}).then(function(e){return e&&(a._audioCache[s]=e,t.setAudioBuffer(e)),t})}return console.warn("No supported audioformat was found"),t}})},a}),define("goo/particles/ParticleLib",[],function(){"use strict";var t={};return t.getSmoke=function(t){return t=t||{},t.scale="undefined"!=typeof t.scale?t.scale:1,t.spread="undefined"!=typeof t.spread?t.spread:2,t.rate="undefined"!=typeof t.spread?t.rate:25,t.velocity="undefined"!=typeof t.velocity?t.velocity:function(e){var r=e.velocity;return r.data[0]=2*(Math.random()-.5)*t.spread*t.scale,r.data[1]=2*(Math.random()+4)*t.scale,r.data[2]=2*(Math.random()-.5)*t.spread*t.scale,r},t.color=t.color||[0,0,0],{totalParticlesToSpawn:-1,releaseRatePerSecond:t.rate,minLifetime:.5,maxLifetime:4,getEmissionVelocity:t.velocity,timeline:[{timeOffset:0,spin:0,mass:1,size:3*t.scale,color:[t.color[0],t.color[1],t.color[2],1]},{timeOffset:1,size:6*t.scale,color:[t.color[0],t.color[1],t.color[2],0]}]}},t.getFire=function(t){return t=t||{},t.scale="undefined"!=typeof t.scale?t.scale:1,t.spread="undefined"!=typeof t.spread?t.spread:2,t.velocity="undefined"!=typeof t.velocity?t.velocity:10,t.startColor=t.startColor||[1,1,0],t.endColor=t.endColor||[1,0,0],{totalParticlesToSpawn:-1,releaseRatePerSecond:30,minLifetime:.5,maxLifetime:2,getEmissionVelocity:function(e){var r=e.velocity;return r.data[0]=2*(Math.random()-.5)*t.spread*t.scale,r.data[1]=(Math.random()+1)*t.velocity*t.scale,r.data[2]=2*(Math.random()-.5)*t.spread*t.scale,r},timeline:[{timeOffset:0,spin:0,mass:1,size:2*t.scale,color:[t.startColor[0],t.startColor[1],t.startColor[2],0]},{timeOffset:.05,color:[t.startColor[0],t.startColor[1],t.startColor[2],1]},{timeOffset:.45,color:[t.endColor[0],t.endColor[1],t.endColor[2],.8]},{timeOffset:.5,size:3*t.scale,color:[0,0,0,0]}]}},t.getSnow=function(t){return t=t||{},t.scale="undefined"!=typeof t.scale?t.scale:2,t.spread="undefined"!=typeof t.spread?t.spread:50,t.velocity="undefined"!=typeof t.velocity?t.velocity:3,t.color=t.color||[1,1,1],{particleCount:1e3,totalParticlesToSpawn:-1,releaseRatePerSecond:50,minLifetime:15,maxLifetime:25,getEmissionPoint:function(e){var r=e.position;return t.getEmissionPoint(r),r},getEmissionVelocity:function(e){var r=e.velocity;return t.getEmissionVelocity(r),r},timeline:[{timeOffset:0,spin:0,mass:1,size:1*t.scale,color:[t.color[0],t.color[1],t.color[2],0]},{timeOffset:.05,color:[t.color[0],t.color[1],t.color[2],1]},{timeOffset:.7,color:[t.color[0],t.color[1],t.color[2],.8]},{timeOffset:.25,spin:5,size:.5*t.scale,color:[t.color[0],t.color[1],t.color[2],0]}]}},t}),define("goo/util/ParticleSystemUtils",["goo/entities/components/ParticleComponent","goo/entities/components/MeshRendererComponent","goo/entities/components/MeshDataComponent","goo/renderer/Texture","goo/particles/ParticleEmitter"],function(t,e,r,i,n){"use strict";function o(){}return o.createParticleSystemEntity=function(i,o,a){var s=i.createEntity(),h=new t({particleCount:o.particleCount||500});h.emitters.push(new n(o)),s.setComponent(h);var d=new r(h.meshData);s.setComponent(d);var l=new e;return l.materials.push(a),l.cullMode="Never",s.setComponent(l),s},o.createFlareTexture=function(t,e){t=t||64,e=e||{},e.startRadius="undefined"!=typeof e.startRadius?e.startRadius:0,e.endRadius="undefined"!=typeof e.endRadius?e.endRadius:t/2,e.steps=e.steps||[{fraction:0,value:1},{fraction:1,value:0}];var r=document.createElement("canvas");r.width=t,r.height=t;for(var n=r.getContext("2d"),o=n.createRadialGradient(t/2,t/2,e.startRadius,t/2,t/2,e.endRadius),a=0;a<e.steps.length;a++){var s=e.steps[a];o.addColorStop(s.fraction,"rgba(255, 255, 255, "+s.value+")")}n.fillStyle=o,n.fillRect(0,0,t,t);var h=n.getImageData(0,0,t,t).data;h=new Uint8Array(h);var d=new i(h,null,t,t);return d},o.createSplashTexture=function(t,e){function r(t,e,r){var i=s.createRadialGradient(t,e,0,t,e,r);i.addColorStop(0,"rgba(255, 255, 255, 0.5)"),i.addColorStop(1,"rgba(255, 255, 255, 0)"),s.fillStyle=i,s.fillRect(t-r,e-r,2*r,2*r)}function n(t,e,i,n,o,a){for(var s=(i-t)/h,d=(n-e)/h,l=(a-o)/h,u=0,c=t,p=e,f=o;h>u;u++,c+=s,p+=d,f+=l)r(c,p,f)}function o(t,e,r,i,o,a,s){for(var h=0;s>h;h++){var d=Math.random()*Math.PI*2,l=4*Math.random()+r,u=4*Math.random()-i;n(t+Math.cos(d)*l,e+Math.sin(d)*l,t+Math.cos(d)*u,e+Math.sin(d)*u,o,a)}}t=t||64,e=e||{},e.nTrails="undefined"!=typeof e.nTrails?e.nTrails:8,e.trailStartRadius="undefined"!=typeof e.trailStartRadius?e.trailStartRadius:1,e.trailEndRadius="undefined"!=typeof e.trailEndRadius?e.trailEndRadius:4;var a=document.createElement("canvas");a.width=t,a.height=t;var s=a.getContext("2d"),h=30;o(t/2,t/2,t/2/10*1,t/2/10*9,e.trailStartRadius,e.trailEndRadius,e.nTrails);var d=s.getImageData(0,0,t,t).data;d=new Uint8Array(d);var l=new i(d,null,t,t);return l},o.createPlanktonTexture=function(t,e){function r(t,e,r){var i=a.createRadialGradient(t,e,0,t,e,r);i.addColorStop(0,"rgba(255, 255, 255, 1)"),i.addColorStop(.3,"rgba(255, 255, 255, 1)"),i.addColorStop(1,"rgba(255, 255, 255, 0)"),a.fillStyle=i,a.fillRect(t-r,e-r,2*r,2*r)}function n(i){for(var n=0;i>n;n++){var o=Math.random()*(t-2*e.maxRadius)+e.maxRadius,a=Math.random()*(t-2*e.maxRadius)+e.maxRadius;r(o,a,Math.random()*(e.maxRadius-e.minRadius)+e.minRadius)}}t=t||64,e=e||{},e.nPoints="undefined"!=typeof e.nPoints?e.nPoints:10,e.minRadius="undefined"!=typeof e.minRadius?e.minRadius:2,e.maxRadius="undefined"!=typeof e.maxRadius?e.maxRadius:5;var o=document.createElement("canvas");o.width=t,o.height=t;var a=o.getContext("2d");n(e.nPoints);var s=a.getImageData(0,0,t,t).data;s=new Uint8Array(s);var h=new i(s,null,t,t);return h},o.createSnowflakeTexture=function(t,e){function r(t,e){for(var r=2*Math.PI/t,i=0;t>i;i++)a.rotate(r),e()}function n(){a.beginPath(),a.moveTo(0,0),a.lineTo(0,90);for(var t=0;6>t;t++)a.moveTo(0,25+10*t),a.lineTo(16-1.5*t,35+10*t),a.moveTo(0,25+10*t),a.lineTo(-(16-1.5*t),35+10*t);a.stroke()}t=t||64,e=e||{};var o=document.createElement("canvas");o.width=t,o.height=t;var a=o.getContext("2d");a.strokeStyle="#FFF",a.lineWidth=4,a.lineCap="round",a.translate(t/2,t/2),a.scale(t/100/2,t/100/2),r(7,n);var s=a.getImageData(0,0,t,t).data;s=new Uint8Array(s);var h=new i(s,null,t,t);return h},o}),define("goo/util/Snow",["goo/entities/SystemBus","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/renderer/TextureCreator","goo/particles/ParticleLib","goo/util/ParticleSystemUtils","goo/renderer/Renderer","goo/math/Vector3"],function(t,e,r,i,n,o,a,s){"use strict";function h(t){this.velocity=10,this.height=25,this.material=new e(r.particles);var i=o.createFlareTexture(64);i.generateMipmaps=!0,this.material.setTexture("DIFFUSE_MAP",i),this.material.blendState.blending="AdditiveBlending",this.material.cullState.enabled=!1,this.material.depthState.write=!1,this.material.renderQueue=2002;var h=this;this.particleCloudEntity=o.createParticleSystemEntity(t.world,n.getSnow({getEmissionPoint:function(t){t.copy(a.mainCamera?a.mainCamera.translation:new s),t.data[0]+=1e3*Math.random()-500,t.data[1]+=h.height,t.data[2]+=1e3*Math.random()-500},getEmissionVelocity:function(t){t.data[0]=2*(Math.random()-.5),t.data[1]=-(Math.random()+1)*h.velocity,t.data[2]=2*(Math.random()-.5)}}),this.material),this.particleCloudEntity.name="_ParticleSystemSnow",this.onCameraChange=function(t){t.entity.attachChild(this.particleCloudEntity)}.bind(this),this.particleCloudEntity.transformComponent.transform.translation.copy(a.mainCamera?a.mainCamera.translation:new s),this.particleCloudEntity.addToWorld()}return h.prototype.setEmissionVelocity=function(t){if(t){this.velocity=t;for(var e=this.particleCloudEntity.particleComponent,r=e.particles,i=0;i<r.length;i++)r[i].velocity[1]=-(Math.random()+1)*this.velocity}},h.prototype.setEmissionHeight=function(t){t&&(this.height=t)},h.prototype.setReleaseRatePerSecond=function(t){if(t){var e=this.particleCloudEntity.particleComponent,r=e.emitters[0];r.releaseRatePerSecond=t}},h.prototype.remove=function(){this.particleCloudEntity.removeFromWorld()},h}),define("goo/loaders/handlers/EnvironmentHandler",["goo/loaders/handlers/ConfigHandler","goo/util/ObjectUtil","goo/entities/SystemBus","goo/renderer/shaders/ShaderBuilder","goo/util/Snow","goo/util/rsvp"],function(t,e,r,i,n,o){"use strict";function a(){t.apply(this,arguments)}var s={backgroundColor:[.3,.3,.3,1],globalAmbient:[0,0,0],fog:{enabled:!1,color:[1,1,1],near:10,far:1e3}},h={volume:1,reverb:0,dopplerFactor:1,rolloffFactor:.4,maxDistance:100};return a.prototype=Object.create(t.prototype),a.prototype.constructor=a,t._registerClass("environment",a),a.prototype._prepare=function(t){e.defaults(t,s)},a.prototype._create=function(){return{weatherState:{}}},a.prototype._remove=function(t){var e=this._objects[t];delete this._objects[t];for(var n in e.weatherState)a.weatherHandlers[n].remove(e.weatherState);r.emit("goo.setClearColor",s.backgroundColor),i.CLEAR_COLOR=s.backgroundColor,i.GLOBAL_AMBIENT=s.globalAmbient.slice(0,3),i.USE_FOG=s.fog.enabled,i.FOG_COLOR=s.fog.color.slice(0,3),i.FOG_SETTINGS=[s.fog.near,s.fog.far];var o=this.world.getSystem("SoundSystem");o&&(o.updateConfig(h),o.setReverb(null))},a.prototype._update=function(n,s,h){var d=this;return t.prototype._update.call(this,n,s,h).then(function(t){if(t){t.backgroundColor=s.backgroundColor.slice(0),t.globalAmbient=s.globalAmbient.slice(0,3),t.fog=e.deepClone(s.fog),r.emit("goo.setClearColor",t.backgroundColor),i.CLEAR_COLOR=t.backgroundColor,i.GLOBAL_AMBIENT=t.globalAmbient,i.USE_FOG=t.fog.enabled,i.FOG_COLOR=t.fog.color.slice(0,3),i.FOG_SETTINGS=[t.fog.near,s.fog.far];for(var n in s.weather){var l=a.weatherHandlers[n];l&&l.update.call(d,s.weather[n],t.weatherState)}var u=[];if(s.skyboxRef)t.skyboxRef=s.skyboxRef,u.push(d._load(s.skyboxRef,{reload:!0}));else if(t.skyboxRef){var c=d.updateObject(t.skyboxRef,null).then(function(){delete t.skyboxRef});u.push(c)}var p=d.world.getSystem("SoundSystem");if(s.sound&&p)if(p.updateConfig(s.sound),s.sound.reverbRef){var c=d._load(s.sound.reverbRef,h).then(function(t){p.setReverb(t._buffer)});u.push(c)}else p.setReverb(null);return o.all(u).then(function(){return t})}})},a.weatherHandlers={snow:{update:function(t,e){t.enabled?e.snow&&e.snow.enabled?(e.snow.snow.setEmissionVelocity(t.velocity),e.snow.snow.setReleaseRatePerSecond(t.rate),e.snow.snow.setEmissionHeight(t.height)):(e.snow=e.snow||{},e.snow.enabled=!0,e.snow.snow=new n(this.world.gooRunner)):e.snow&&e.snow.enabled&&(e.snow.snow.remove(),e.snow.enabled=!1,delete e.snow.snow)},remove:function(t){t.snow.snow&&(t.snow.snow.remove(),t.snow.enabled=!1,delete t.snow.snow)}}},a}),define("goo/util/Skybox",["goo/shapes/Box","goo/shapes/Sphere","goo/renderer/MeshData","goo/renderer/Material","goo/renderer/Shader","goo/renderer/TextureCreator","goo/math/Transform"],function(t,e,r,i,n,o,a){"use strict";function s(r,d,l,u){var c;if(r===s.SPHERE)this.meshData=new e(48,48,1,l||e.TextureModes.Projected),d instanceof Array&&(d=d[0]),d&&(c=(new o).loadTexture2D(d));else{if(r!==s.BOX)throw new Error("Unknown geometry type");this.meshData=new t(1,1,1),d.length&&(c=(new o).loadTextureCube(d,{flipY:!1}))}var p=new i(h[r],"Skybox material");p.setTexture(n.DIFFUSE_MAP,c),p.cullState.cullFace="Front",p.depthState.enabled=!1,p.renderQueue=1,this.materials=[p],this.transform=new a;var f=r===s.SPHERE?Math.PI/2:0;this.transform.rotation.fromAngles(f,u,0),this.transform.update(),this.active=!0}s.SPHERE="sphere",s.BOX="box";var h={};return h.box={attributes:{vertexPosition:r.POSITION},uniforms:{viewMatrix:n.VIEW_MATRIX,projectionMatrix:n.PROJECTION_MATRIX,worldMatrix:n.WORLD_MATRIX,cameraPosition:n.CAMERA,near:n.NEAR_PLANE,diffuseMap:n.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;","uniform float near;","varying vec3 eyeVec;","void main(void) {","	vec4 worldPos = worldMatrix * vec4(vertexPosition * near * 10.0, 1.0);"," worldPos += vec4(cameraPosition, 0.0);","	gl_Position = projectionMatrix * viewMatrix * worldPos;","	eyeVec = worldPos.xyz - cameraPosition;"," eyeVec.x = -eyeVec.x;"," eyeVec = (worldMatrix * vec4(eyeVec, 0.0)).xyz;","}"].join("\n"),fshader:["precision mediump float;","uniform samplerCube diffuseMap;","varying vec3 eyeVec;","void main(void)","{","	vec4 cube = textureCube(diffuseMap, eyeVec);"," if (cube.a < 0.05) discard;","	gl_FragColor = cube;","}"].join("\n")},h.sphere={attributes:{vertexPosition:r.POSITION,vertexUV0:r.TEXCOORD0},uniforms:{viewMatrix:n.VIEW_MATRIX,projectionMatrix:n.PROJECTION_MATRIX,worldMatrix:n.WORLD_MATRIX,cameraPosition:n.CAMERA,near:n.NEAR_PLANE,diffuseMap:n.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;","uniform float near;","varying vec2 texCoord0;","varying vec3 eyeVec;","void main(void) {","	texCoord0 = vertexUV0;","	vec4 worldPos = worldMatrix * vec4(vertexPosition * near * 10.0, 1.0);"," worldPos += vec4(cameraPosition, 0.0);","	gl_Position = projectionMatrix * viewMatrix * worldPos;","	eyeVec = cameraPosition - worldPos.xyz;","}"].join("\n"),fshader:["precision mediump float;","uniform sampler2D diffuseMap;","varying vec2 texCoord0;","void main(void)","{"," vec4 sphere = texture2D(diffuseMap, texCoord0);"," if (sphere.a < 0.05) discard;","	gl_FragColor = sphere;","}"].join("\n")},s}),define("goo/loaders/handlers/SkyboxHandler",["goo/loaders/handlers/ConfigHandler","goo/renderer/Texture","goo/renderer/shaders/ShaderBuilder","goo/util/Skybox","goo/util/rsvp","goo/util/PromiseUtil","goo/entities/SystemBus"],function(t,e,r,i,n,o,a){"use strict";function s(){t.apply(this,arguments),this._activeSkyboxRef=null;var r=new i("box",[],null,0);this._skybox=this.world.createEntity(r.meshData,r.materials[0],r.transform),this._skybox.transformComponent.updateWorldTransform(),this._skybox.isSkybox=!0,this._skybox.name="Skybox_box",this._skyboxTexture=new e(null,{flipY:!1}),this._skyboxTexture.variant="CUBE",this._skybox.meshRendererComponent.materials[0].setTexture("DIFFUSE_MAP",this._skyboxTexture);var n=new i("sphere",[],null,0);this._skysphere=this.world.createEntity(n.meshData,n.materials[0],n.transform),this._skysphere.transformComponent.updateWorldTransform(),this._skysphere.isSkybox=!0,this._skysphere.name="Skybox_sphere",this._skysphereTexture=new e(null,{flipY:!1}),this._skysphere.meshRendererComponent.materials[0].setTexture("DIFFUSE_MAP",this._skysphereTexture),this._activeSkyshape=null}function h(t,e){var r=t.length;if(r!==e.length)return!1;for(;r--;)if(t[r]!==e[r])return!1;return!0}s.prototype=Object.create(t.prototype),s.prototype.constructor=s,t._registerClass("skybox",s),s.prototype._remove=function(t){delete this._objects[t],this._activeSkyboxRef===t&&(this._hide(this._skybox),this._hide(this._skysphere),this._skyboxTexture.setImage(null),this._activeSkyshape=null,r.SKYBOX=null,r.SKYSPHERE=null,this._activeSkyboxRef=null)},s.prototype._create=function(){return{textures:[],enabled:!1}},s.prototype._update=function(e,r,i){var a=this;return t.prototype._update.call(this,e,r,i).then(function(t){if(!t)return o.resolve([]);var s=[];return r.box&&s.push(a._updateBox(r.box,i,t)),r.sphere&&s.push(a._updateSphere(r.sphere,i,t)),n.all(s).then(function(t){return(r.box||r.sphere)&&(a._activeSkyboxRef=e),t})})},s.prototype._updateSphere=function(t,e,r){var i=this;return t.sphereRef?this._load(t.sphereRef,e).then(function(e){if(!e||!e.image)return a.emit("goo.error.skybox",{type:"Sphere",message:"The skysphere needs an image to display."}),void i._hide(i._skysphere);var n=i._skysphereTexture;return r.textures=[e],n.setImage(e.image),t.enabled?i._show(i._skysphere):i._hide(i._skysphere),i._skysphere}):(i._skysphereTexture.setImage(null),i._hide(i._skysphere),o.resolve(i._skysphere))};var d=["rightRef","leftRef","topRef","bottomRef","frontRef","backRef"];return s.prototype._updateBox=function(t,e,r){var i=this,a=d.map(function(r){return t[r]?i._load(t[r],e):o.resolve()});return n.all(a).then(function(e){if(h(e,r.textures)&&i._activeSkyShape===i._skybox)return i._skybox;var n=e.map(function(t){return t?t.image:null});if(0===n.filter(Boolean).length)return i._skyboxTexture.setImage(null),i._hide(i._skybox),i._skybox;for(var o=1,a=1,s=0;s<n.length;s++)n[s]&&(o=Math.max(o,n[s].width),a=Math.max(a,n[s].width));r.textures=e;var d=i._skyboxTexture;return d.setImage(n),d.image.width=o,d.image.height=a,d.image.dataReady=!0,d.setNeedsUpdate(),t.enabled?i._show(i._skybox):i._hide(i._skybox),i._skybox})},s.prototype._hide=function(t){var e=this.world.getSystem("RenderSystem");e.removed(t),t===this._skybox?r.SKYBOX=null:t===this._skysphere&&(r.SKYSPHERE=null)},s.prototype._show=function(t){var e=this.world.getSystem("RenderSystem");e.added(t),this._activeSkyshape=t,r.SKYBOX=t===this._skybox?this._skyboxTexture:null,r.SKYSPHERE=t===this._skysphere?this._skysphereTexture:null},s}),define("goo/loaders/handlers/HtmlComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/HtmlComponent","goo/util/rsvp","goo/util/PromiseUtil"],function(t,e,r,i){"use strict";function n(){t.apply(this,arguments),this._type="HtmlComponent",this._configs={}}return n.prototype=Object.create(t.prototype),t._registerClass("html",n),n.prototype.constructor=n,n.prototype._prepare=function(){},n.prototype._create=function(){return new e},n.prototype.update=function(e,n,o){var a=this;return t.prototype.update.call(this,e,n,o).then(function(t){function s(t,e){return a.loadObject(e,o).then(function(e){return t.src=e.src,t},function(e){return console.error(e),delete t.src,t})}if(t){var h="__"+e.id.replace(".","-"),d=t.domElement;if(!d){d=document.createElement("div"),d.id=h,d.className="goo-entity",d.addEventListener("mousedown",function(t){var r=e._world.gooRunner,i={entity:e,depth:0,x:t.pageX,y:t.pageY,domEvent:t,id:e.id,type:"mousedown"};r.triggerEvent("mousedown",i)}),d.addEventListener("mouseup",function(t){var r=e._world.gooRunner,i={entity:e,depth:0,x:t.pageX,y:t.pageY,domEvent:t,id:e.id,type:"mouseup"};r.triggerEvent("mouseup",i)}),d.addEventListener("click",function(t){var r=e._world.gooRunner,i={entity:e,depth:0,x:t.pageX,y:t.pageY,domEvent:t,id:e.id,type:"click"};r.triggerEvent("click",i)}),t.domElement=d,d.style.position="absolute",d.style.top=0,d.style.left=0,d.style.zIndex=1,d.style.display="none";var l=e._world.gooRunner.renderer.domElement.parentElement||document.body;l.appendChild(d)}var u=n.innerHtml!==d.prevInnerHtml,c=n.style!==d.prevStyle;if(d.prevInnerHtml=n.innerHtml,d.prevStyle=n.style,!u&&!c)return i.resolve();var p="";if(n.style){var f=n.style.replace("__entity","#"+h);p="<style>\n"+f+"\n</style>"}d.innerHTML=p+n.innerHtml,t.useTransformComponent=null==n.useTransformComponent?!0:n.useTransformComponent;for(var m=d.getElementsByTagName("IMG"),g=[],v=0;v<m.length;v++){var y=m[v],x=y.getAttribute("data-id");if(x){var _=s(y,x);g.push(_)}}return r.all(g)}})},n.prototype._remove=function(e){var r=e.htmlComponent;t.prototype._remove.call(this,e),r.domElement&&r.domElement.parentNode.removeChild(r.domElement)},n}),define("goo/loaders/DynamicLoader",["goo/loaders/handlers/ConfigHandler","goo/loaders/handlers/ComponentHandler","goo/util/Ajax","goo/util/rsvp","goo/util/StringUtil","goo/util/PromiseUtil","goo/util/ShapeCreatorMemoized","goo/loaders/handlers/CameraComponentHandler","goo/loaders/handlers/EntityHandler","goo/loaders/handlers/LightComponentHandler","goo/loaders/handlers/MaterialHandler","goo/loaders/handlers/MeshDataComponentHandler","goo/loaders/handlers/MeshDataHandler","goo/loaders/handlers/MeshRendererComponentHandler","goo/loaders/handlers/SceneHandler","goo/loaders/handlers/ShaderHandler","goo/loaders/handlers/TextureHandler","goo/loaders/handlers/TransformComponentHandler","goo/loaders/handlers/ProjectHandler","goo/loaders/handlers/SoundComponentHandler","goo/loaders/handlers/SoundHandler","goo/loaders/handlers/EnvironmentHandler","goo/loaders/handlers/SkyboxHandler","goo/loaders/handlers/HtmlComponentHandler"],function(t,e,r,i,n,o,a){"use strict";function s(t){if(!t.world)throw new Error("World argument cannot be null");if(this._world=t.world,t.ajax)this._ajax=t.ajax;else{if(!t.rootPath)throw new Error("ajax or rootPath must be defined");this._ajax=new r(t.rootPath)}this._objects={},this._handlers={}}s.prototype.preload=function(t,e){this._ajax.prefill(t,e)},s.prototype.clear=function(){var t=[];for(var e in this._handlers)t.push(this._handlers[e].clear());if(this._ajax.clear instanceof Function&&this._ajax.clear(),this._world&&this._world.gooRunner){a.clearCache(this._world.gooRunner.renderer.context);for(var r=0;r<this._world.gooRunner.renderSystems.length;r++){var n=this._world.gooRunner.renderSystems[r].lights;if(n)for(var o=0;o<n.length;o++)n[o].destroy(this._world.gooRunner.renderer)}this._world.gooRunner.renderer.clearShaderCache()}return i.all(t)},s.prototype.load=function(t,e){e=e||{};var r=this._loadObject.bind(this,t,e);return e.preloadBinaries===!0?this._loadBinariesFromRefs(t,e).then(r):r()},s.prototype.update=function(t,e,r){var i=this;return r=r||{},this._ajax.update(t,e).then(function(e){return i._updateObject(t,e,r)}).then(null,function(e){throw console.error("Error updating "+t+" "+e),e})},s.prototype._loadObject=function(t,e){var r=s.getTypeForRef(t),i=this._getHandler(r);return i?i.load(t,e):this._loadRef(t,e)},s.prototype.remove=function(t){return delete this._objects[t],this.update(t,null)},s.prototype._updateObject=function(t,e,r){var i=s.getTypeForRef(t),n=this._getHandler(i);return n?n.update(t,e,r):s._isRefTypeInGroup(t,"binary")||"bundle"!==i?o.resolve(e):(console.warn("No handler for type "+i),o.resolve(e))},s.prototype._loadRef=function(t,e){return this._ajax.load(t,null==e?!1:e.noCache)},s.prototype._loadBinariesFromRefs=function(t,e){function r(t){function r(r){return o._loadRef(r,e).then(function(){n++,e.progressCallback instanceof Function&&e.progressCallback(n,t.length)})}var n=0;return i.all(t.map(function(t){return r(t)}))}function n(t){function r(t){d.push(o._loadRef(t,e).then(n))}function n(t){for(var e=o._getRefsFromConfig(t),i=0,n=Object.keys(e),d=e.length;d>i;i++){var l=e[n[i]];s._isRefTypeInGroup(l,"asset")&&!a[l]?a[l]=!0:s._isRefTypeInGroup(l,"json")&&!h[l]&&(h[l]=!0,r(l))}}var a={},h={},d=[];return n({collectionRefs:t}),i.all(d).then(function(){return Object.keys(a)})}var o=this;return n(t).then(r)},s.prototype._getHandler=function(e){var r=this._handlers[e];if(r)return r;var i=t.getHandler(e);return i?this._handlers[e]=new i(this._world,this._loadRef.bind(this),this._updateObject.bind(this),this._loadObject.bind(this)):null};var h=new RegExp("\\S+refs?$","i");return s.prototype._getRefsFromConfig=function(t){function e(t,i){if(h.test(t)&&"thumbnailRef"!==t)if(i instanceof Object)for(var n=0,o=Object.keys(i),a=o.length;a>n;n++)i[o[n]]&&r.push(i[o[n]]);else i&&r.push(i);else if(i instanceof Object)for(var n=0,o=Object.keys(i),a=o.length;a>n;n++)i.hasOwnProperty(o[n])&&e(o[n],i[o[n]])}var r=[];return e("",t),r},s.getTypeForRef=function(t){return t.substr(t.lastIndexOf(".")+1).toLowerCase()},s._isRefTypeInGroup=function(t,e){var i=s.getTypeForRef(t);return i&&r.types[e]&&r.types[e][i]},s}),define("goo/math/Matrix2x2",["goo/math/MathUtils","goo/math/Matrix"],function(t,e){"use strict";function r(){e.call(this,2,2),0===arguments.length?this.setIdentity():this.set(arguments)}return r.prototype=Object.create(e.prototype),e.setupAliases(r.prototype,[["e00"],["e10"],["e01"],["e11"]]),r.IDENTITY=new r(1,0,0,1),r.add=function(t,e,i){return i||(i=new r),e instanceof r?(i.e00=t.e00+e.e00,i.e10=t.e10+e.e10,i.e01=t.e01+e.e01,i.e11=t.e11+e.e11):(i.e00=t.e00+e,i.e10=t.e10+e,i.e01=t.e01+e,i.e11=t.e11+e),i},r.prototype.add=function(t){return r.add(this,t,this)},r.sub=function(t,e,i){return i||(i=new r),e instanceof r?(i.e00=t.e00-e.e00,i.e10=t.e10-e.e10,i.e01=t.e01-e.e01,i.e11=t.e11-e.e11):(i.e00=t.e00-e,i.e10=t.e10-e,i.e01=t.e01-e,i.e11=t.e11-e),i},r.prototype.sub=function(t){return r.sub(this,t,this)},r.mul=function(t,e,i){return i||(i=new r),e instanceof r?(i.e00=t.e00*e.e00,i.e10=t.e10*e.e10,i.e01=t.e01*e.e01,i.e11=t.e11*e.e11):(i.e00=t.e00*e,i.e10=t.e10*e,i.e01=t.e01*e,i.e11=t.e11*e),i},r.prototype.mul=function(t){return r.mul(this,t,this)},r.div=function(t,e,i){return i||(i=new r),e instanceof r?(i.e00=t.e00/e.e00,i.e10=t.e10/e.e10,i.e01=t.e01/e.e01,i.e11=t.e11/e.e11):(e=1/e,i.e00=t.e00*e,i.e10=t.e10*e,i.e01=t.e01*e,i.e11=t.e11*e),i},r.prototype.div=function(t){return r.div(this,t,this)},r.combine=function(t,i,n){return n||(n=new r),n===t||n===i?e.copy(r.combine(t,i),n):(n.e00=t.e00*i.e00+t.e01*i.e10,n.e10=t.e10*i.e00+t.e11*i.e10,n.e01=t.e00*i.e01+t.e01*i.e11,n.e11=t.e10*i.e01+t.e11*i.e11,n)},r.prototype.combine=function(t){return r.combine(this,t,this)},r.transpose=function(t,i){return i||(i=new r),i===t?e.copy(r.transpose(t),i):(i.e00=t.e00,i.e10=t.e01,i.e01=t.e10,i.e11=t.e11,i)},r.prototype.transpose=function(){return r.transpose(this,this)},r.invert=function(i,n){if(n||(n=new r),n===i)return e.copy(r.invert(i),n);var o=i.determinant();if(Math.abs(o)<t.EPSILON)throw{name:"Singular Matrix",message:"The matrix is singular and cannot be inverted."};return o=1/o,n.e00=i.e11*o,n.e10=0-i.e10*o,n.e01=0-i.e01*o,n.e11=i.e00*o,n},r.prototype.invert=function(){return r.invert(this,this)},r.prototype.isOrthogonal=function(){var e;return e=this.e00*this.e01+this.e10*this.e11,Math.abs(e)>t.EPSILON?!1:!0},r.prototype.isNormal=function(){var e;return e=this.e00*this.e00+this.e10*this.e10,Math.abs(e-1)>t.EPSILON?!1:(e=this.e01*this.e01+this.e11*this.e11,Math.abs(e-1)>t.EPSILON?!1:!0)},r.prototype.isOrthonormal=function(){return this.isOrthogonal()&&this.isNormal()},r.prototype.determinant=function(){return this.e00*this.e11-this.e01*this.e10},r.prototype.setIdentity=function(){return this.set(r.IDENTITY),this},r.prototype.copy=function(t){var e=this.data,r=t.data;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],this},r.prototype.clone=function(){var t=this.data;return new r(t[0],t[1],t[2],t[3])},r}),define("goo/math/Quaternion",["goo/math/Vector","goo/math/Vector3","goo/math/Matrix3x3","goo/math/MathUtils"],function(t,e,r,i){"use strict";function n(){t.call(this,4),0!==arguments.length?this.set(arguments):this.setd(0,0,0,1)}n.prototype=Object.create(t.prototype),t.setupAliases(n.prototype,[["x"],["y"],["z"],["w"]]),n.IDENTITY=new n(0,0,0,1),n.ALLOWED_DEVIANCE=1e-8,n.add=function(t,e,r){return r||(r=new n),r.data[0]=t.data[0]+e.data[0],r.data[1]=t.data[1]+e.data[1],r.data[2]=t.data[2]+e.data[2],r.data[3]=t.data[3]+e.data[3],r},n.sub=function(t,e,r){return r||(r=new n),r.data[0]=t.data[0]-e.data[0],r.data[1]=t.data[1]-e.data[1],r.data[2]=t.data[2]-e.data[2],r.data[3]=t.data[3]-e.data[3],r},n.mul=function(t,e,r){var i=t.data[0],n=t.data[1],o=t.data[2],a=t.data[3],s=e.data[0],h=e.data[1],d=e.data[2],l=e.data[3];return r.data[0]=i*l+a*s+n*d-o*h,r.data[1]=n*l+a*h+o*s-i*d,r.data[2]=o*l+a*d+i*h-n*s,r.data[3]=a*l-i*s-n*h-o*d,r},n.div=function(t,e,r){r||(r=new n);var i=!0;return r.data[0]=(i&=e.data[0]<0||e.data[0]>0)?t.data[0]/e.data[0]:0,r.data[1]=(i&=e.data[1]<0||e.data[1]>0)?t.data[1]/e.data[1]:0,r.data[2]=(i&=e.data[2]<0||e.data[2]>0)?t.data[2]/e.data[2]:0,r.data[3]=(i&=e.data[3]<0||e.data[3]>0)?t.data[3]/e.data[3]:0,i===!1&&console.warn("[Quaternion.div] Attempted to divide by zero!"),r},n.scalarAdd=function(t,e,r){return r||(r=new n),r.data[0]=t.data[0]+e,r.data[1]=t.data[1]+e,r.data[2]=t.data[2]+e,r.data[3]=t.data[3]+e,r},n.scalarSub=function(t,e,r){return r||(r=new n),r.data[0]=t.data[0]-e,r.data[1]=t.data[1]-e,r.data[2]=t.data[2]-e,r.data[3]=t.data[3]-e,r},n.scalarMul=function(t,e,r){return r||(r=new n),r.data[0]=t.data[0]*e,r.data[1]=t.data[1]*e,r.data[2]=t.data[2]*e,r.data[3]=t.data[3]*e,r},n.scalarDiv=function(t,e,r){r||(r=new n);var i=!0;return e=(i&=0>e||e>0)?1/e:0,r.data[0]=t.data[0]*e,r.data[1]=t.data[1]*e,r.data[2]=t.data[2]*e,r.data[3]=t.data[3]*e,i===!1&&console.warn("[Quaternion.scalarDiv] Attempted to divide by zero!"),r},n.slerp=function(t,e,r,i){if(0===r)return i.setv(t);if(1===r)return i.setv(e);if(t.equals(e))return i.setv(t);var n=t.dot(e);i.setv(e),0>n&&(i.negate(),n=-n);var o=1-r,a=r;if(1-n>.1){var s=Math.acos(n),h=1/Math.sin(s);o=Math.sin((1-r)*s)*h,a=Math.sin(r*s)*h}var d=o*t.data[0]+a*i.data[0],l=o*t.data[1]+a*i.data[1],u=o*t.data[2]+a*i.data[2],c=o*t.data[3]+a*i.data[3];return i.setd(d,l,u,c),i},n.prototype.negate=function(){return this.data[0]*=-1,this.data[1]*=-1,this.data[2]*=-1,this.data[3]*=-1,this},n.prototype.dot=function(t){var e=this.data,r=t.data||t,i=0;return i+=e[0]*r[0],i+=e[1]*r[1],i+=e[2]*r[2],i+=e[3]*r[3]},n.prototype.add=function(t){return n.add(this,t,this)},n.prototype.sub=function(t){return n.sub(this,t,this)},n.prototype.mul=function(t){return n.mul(this,t,this)},n.prototype.div=function(t){return n.div(this,t,this)},n.prototype.scalarAdd=function(t){return n.scalarAdd(this,t,this)},n.prototype.scalarSub=function(t){return n.scalarSub(this,t,this)},n.prototype.scalarMul=function(t){return n.scalarMul(this,t,this)},n.prototype.scalarDiv=function(t){return n.scalarDiv(this,t,this)
};var o;return n.prototype.slerp=function(t,e){return o||(o=new n),o.copy(t),n.slerp(this,t,e,o),this.copy(o),this},n.prototype.fromRotationMatrix=function(t){var e,r,i,n,o=t.e00+t.e11+t.e22;if(o>=0){var a=Math.sqrt(o+1);n=.5*a,a=.5/a,e=(t.e21-t.e12)*a,r=(t.e02-t.e20)*a,i=(t.e10-t.e01)*a}else if(t.e00>t.e11&&t.e00>t.e22){var a=Math.sqrt(1+t.e00-t.e11-t.e22);e=.5*a,a=.5/a,r=(t.e10+t.e01)*a,i=(t.e02+t.e20)*a,n=(t.e21-t.e12)*a}else if(t.e11>t.e22){var a=Math.sqrt(1+t.e11-t.e00-t.e22);r=.5*a,a=.5/a,e=(t.e10+t.e01)*a,i=(t.e21+t.e12)*a,n=(t.e02-t.e20)*a}else{var a=Math.sqrt(1+t.e22-t.e00-t.e11);i=.5*a,a=.5/a,e=(t.e02+t.e20)*a,r=(t.e21+t.e12)*a,n=(t.e10-t.e01)*a}return this.set(e,r,i,n)},n.prototype.toRotationMatrix=function(t){var e=t;e||(e=new r);var i=this.magnitudeSquared(),n=i>0?2/i:0,o=this.data,a=o[0]*n,s=o[1]*n,h=o[2]*n,d=o[0]*a,l=o[0]*s,u=o[0]*h,c=o[3]*a,p=o[1]*s,f=o[1]*h,m=o[3]*s,g=o[2]*h,v=o[3]*h,y=e.data;return y[0]=1-(p+g),y[1]=l+v,y[2]=u-m,y[3]=l-v,y[4]=1-(d+g),y[5]=f+c,y[6]=u+m,y[7]=f-c,y[8]=1-(d+p),e},n.prototype.fromVectorToVector=function(t,r){var o=t,a=r,s=o.length()*a.length();if(Math.abs(s)>i.EPSILON){var h=new e,d=o.dot(a)/s,l=Math.acos(Math.max(-1,Math.min(d,1)));if(e.cross(o,a,h),0>d&&h.length()<i.EPSILON){var u;u=Math.abs(o.x)>Math.abs(o.y)?Math.abs(o.x)>Math.abs(o.z)?0:2:Math.abs(o.y)>Math.abs(o.z)?1:2,h.setValue(u,-o[(u+1)%3]),h.setValue((u+1)%3,o[u]),h.setValue((u+2)%3,0)}return this.fromAngleAxis(l,h)}return this.set(n.IDENTITY)},n.prototype.normalize=function(){var t=1/this.magnitude(),e=this.x*t,r=this.y*t,i=this.z*t,n=this.w*t;return this.set(e,r,i,n)},n.prototype.magnitude=function(){var t=this.data[0]*this.data[0]+this.data[1]*this.data[1]+this.data[2]*this.data[2]+this.data[3]*this.data[3];return 1===t?1:Math.sqrt(t)},n.prototype.magnitudeSquared=function(){return this.data[0]*this.data[0]+this.data[1]*this.data[1]+this.data[2]*this.data[2]+this.data[3]*this.data[3]},n.prototype.fromAngleAxis=function(t,r){var i=new e(r).normalize();return this.fromAngleNormalAxis(t,i)},n.prototype.fromAngleNormalAxis=function(t,r){if(r.equals(e.ZERO))return this.set(n.IDENTITY);var i=.5*t,o=Math.sin(i),a=Math.cos(i),s=o*r.x,h=o*r.y,d=o*r.z;return this.set(s,h,d,a)},n.prototype.toAngleAxis=function(t){var e,r=this.x*this.x+this.y*this.y+this.z*this.z;if(Math.abs(r)<=n.ALLOWED_DEVIANCE)e=0,null!==t&&(t.x=1,t.y=0,t.z=0);else if(e=2*Math.acos(this.w),null!==t){var i=1/Math.sqrt(r);t.x=this.x*i,t.y=this.y*i,t.z=this.z*i}return e},n.prototype.equals=function(t){return this===t?!0:t instanceof n?Math.abs(this.data[0]-t.data[0])<n.ALLOWED_DEVIANCE&&Math.abs(this.data[1]-t.data[1])<n.ALLOWED_DEVIANCE&&Math.abs(this.data[2]-t.data[2])<n.ALLOWED_DEVIANCE&&Math.abs(this.data[3]-t.data[3])<n.ALLOWED_DEVIANCE:!1},n.prototype.setd=function(t,e,r,i){return this.data[0]=t,this.data[1]=e,this.data[2]=r,this.data[3]=i,this},n.prototype.seta=function(t){return this.data[0]=t[0],this.data[1]=t[1],this.data[2]=t[2],this.data[3]=t[3],this},n.prototype.setv=function(t){return this.data[0]=t.data[0],this.data[1]=t.data[1],this.data[2]=t.data[2],this.data[3]=t.data[3],this},n}),define("goo/noise/Noise",["goo/math/MathUtils"],function(t){"use strict";function e(){}return e.shifter=[37,91,12,128,216,96,51,153,39,231,223,180,160,157,135,179,74,50,205,151,4,213,196,58,212,120,53,45,10,195,137,159,103,144,109,170,202,48,121,13,245,68,232,28,210,174,197,80,107,206,156,116,155,240,162,79,41,59,147,117,0,242,118,164,129,101,98,126,214,105,89,26,130,254,85,199,8,165,76,75,187,166,64,143,217,149,78,7,172,230,87,119,42,247,84,139,16,141,134,86,154,71,253,60,99,235,168,30,34,55,113,140,191,69,31,106,40,82,73,33,81,14,234,131,255,88,169,136,248,148,220,138,219,102,44,127,36,200,95,208,54,152,47,20,23,15,52,123,177,224,122,171,215,173,211,188,190,133,244,167,236,35,63,145,221,104,65,24,70,100,56,150,49,77,110,228,112,209,198,1,237,185,250,225,93,201,124,108,218,72,243,21,22,6,114,38,125,29,66,249,222,111,241,11,186,61,176,183,17,163,229,161,57,238,227,132,67,83,207,226,46,189,115,193,194,233,182,192,18,27,25,2,3,252,97,62,184,239,175,92,246,142,251,204,203,32,146,90,19,9,178,158,181,94,43,5],e.split=function(e){var r=Math.floor(e),i=t.scurve5(e-r);return{i0:r+0,i1:r+1,f0:1-i,f1:0+i}},e.fractal1d=function(t,e,r,i,n,o){for(var a=0,s=1,h=0,d=0;r>d;d++)a+=s*o.evaluate1d(t,e),h+=s,s*=i,t*=n;return a/h},e.fractal2d=function(t,e,r,i,n,o,a){for(var s=0,h=1,d=0,l=0;i>l;l++)s+=h*a.evaluate2d(t,e,r),d+=h,h*=n,t*=o,e*=o;return s/d},e.fractal3d=function(t,e,r,i,n,o,a,s){for(var h=0,d=1,l=0,u=0;n>u;u++)h+=d*s.evaluate3d(t,e,r,i),l+=d,d*=o,t*=a,e*=a,r*=a;return h/l},e.fractal4d=function(t,e,r,i,n,o,a,s,h){for(var d=0,l=1,u=0,c=0;o>c;c++)d+=l*h.evaluate4d(t,e,r,i,n),u+=l,l*=a,t*=s,e*=s,r*=s,i*=s;return d/u},e}),define("goo/noise/ValueNoise",["goo/noise/Noise"],function(t){"use strict";function e(){t.call(this)}return e.prototype=Object.create(t.prototype),e.sources=[0,1/15,2/15,.2,4/15,5/15,.4,7/15,8/15,.6,10/15,11/15,.8,13/15,14/15,1],e.evaluate1d=function(r,i){var n=t.split(r/i),o=15&t.shifter[255&n.i0],a=15&t.shifter[255&n.i1],s=0;return s+=n.f0*e.sources[o],s+=n.f1*e.sources[a]},e.evaluate2d=function(r,i,n){var o=t.split(r/n),a=t.split(i/n),s=15&t.shifter[t.shifter[255&a.i0]+o.i0&255],h=15&t.shifter[t.shifter[255&a.i0]+o.i1&255],d=15&t.shifter[t.shifter[255&a.i1]+o.i0&255],l=15&t.shifter[t.shifter[255&a.i1]+o.i1&255],u=0;return u+=a.f0*o.f0*e.sources[s],u+=a.f0*o.f1*e.sources[h],u+=a.f1*o.f0*e.sources[d],u+=a.f1*o.f1*e.sources[l]},e.evaluate3d=function(r,i,n,o){var a=t.split(r/o),s=t.split(i/o),h=t.split(n/o),d=15&t.shifter[t.shifter[t.shifter[255&h.i0]+s.i0&255]+a.i0&255],l=15&t.shifter[t.shifter[t.shifter[255&h.i0]+s.i0&255]+a.i1&255],u=15&t.shifter[t.shifter[t.shifter[255&h.i0]+s.i1&255]+a.i0&255],c=15&t.shifter[t.shifter[t.shifter[255&h.i0]+s.i1&255]+a.i1&255],p=15&t.shifter[t.shifter[t.shifter[255&h.i1]+s.i0&255]+a.i0&255],f=15&t.shifter[t.shifter[t.shifter[255&h.i1]+s.i0&255]+a.i1&255],m=15&t.shifter[t.shifter[t.shifter[255&h.i1]+s.i1&255]+a.i0&255],g=15&t.shifter[t.shifter[t.shifter[255&h.i1]+s.i1&255]+a.i1&255],v=0;return v+=h.f0*s.f0*a.f0*e.sources[d],v+=h.f0*s.f0*a.f1*e.sources[l],v+=h.f0*s.f1*a.f0*e.sources[u],v+=h.f0*s.f1*a.f1*e.sources[c],v+=h.f1*s.f0*a.f0*e.sources[p],v+=h.f1*s.f0*a.f1*e.sources[f],v+=h.f1*s.f1*a.f0*e.sources[m],v+=h.f1*s.f1*a.f1*e.sources[g]},e.evaluate4d=function(r,i,n,o,a){var s=t.split(r/a),h=t.split(i/a),d=t.split(n/a),l=t.split(o/a),u=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i0]+d.i0&255]+h.i0&255]+s.i0&255],c=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i0]+d.i0&255]+h.i0&255]+s.i1&255],p=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i0]+d.i0&255]+h.i1&255]+s.i0&255],f=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i0]+d.i0&255]+h.i1&255]+s.i1&255],m=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i0]+d.i1&255]+h.i0&255]+s.i0&255],g=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i0]+d.i1&255]+h.i0&255]+s.i1&255],v=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i0]+d.i1&255]+h.i1&255]+s.i0&255],y=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i0]+d.i1&255]+h.i1&255]+s.i1&255],x=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i1]+d.i0&255]+h.i0&255]+s.i0&255],_=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i1]+d.i0&255]+h.i0&255]+s.i1&255],w=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i1]+d.i0&255]+h.i1&255]+s.i0&255],b=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i1]+d.i0&255]+h.i1&255]+s.i1&255],S=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i1]+d.i1&255]+h.i0&255]+s.i0&255],E=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i1]+d.i1&255]+h.i0&255]+s.i1&255],C=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i1]+d.i1&255]+h.i1&255]+s.i0&255],M=15&t.shifter[t.shifter[t.shifter[t.shifter[255&l.i1]+d.i1&255]+h.i1&255]+s.i1&255],T=0;return T+=l.f0*d.f0*h.f0*s.f0*e.sources[u],T+=l.f0*d.f0*h.f0*s.f1*e.sources[c],T+=l.f0*d.f0*h.f1*s.f0*e.sources[p],T+=l.f0*d.f0*h.f1*s.f1*e.sources[f],T+=l.f0*d.f1*h.f0*s.f0*e.sources[m],T+=l.f0*d.f1*h.f0*s.f1*e.sources[g],T+=l.f0*d.f1*h.f1*s.f0*e.sources[v],T+=l.f0*d.f1*h.f1*s.f1*e.sources[y],T+=l.f1*d.f0*h.f0*s.f0*e.sources[x],T+=l.f1*d.f0*h.f0*s.f1*e.sources[_],T+=l.f1*d.f0*h.f1*s.f0*e.sources[w],T+=l.f1*d.f0*h.f1*s.f1*e.sources[b],T+=l.f1*d.f1*h.f0*s.f0*e.sources[S],T+=l.f1*d.f1*h.f0*s.f1*e.sources[E],T+=l.f1*d.f1*h.f1*s.f0*e.sources[C],T+=l.f1*d.f1*h.f1*s.f1*e.sources[M]},e}),define("goo/particles/ParticleInfluence",[],function(){"use strict";function t(t){t=t||{},this.prepare=t.prepare?t.prepare:function(){},this.apply=t.apply?t.apply:function(){},this.enabled=void 0!==t.enabled?t.enabled===!0:!0}return t}),define("goo/picking/BoundingTree",["goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere","goo/math/Vector3"],function(t,e,r){"use strict";function i(t){this.leftTree=null,this.rightTree=null,this.localBound=null,this.worldBound=null,this.boundType=t?t:i.BOUNDTYPE_BOX}return i.BOUNDTYPE_SPHERE="sphere",i.BOUNDTYPE_BOX="box",i.MAX_PRIMITIVES_PER_LEAF=16,i.prototype.construct=function(t){if(!t.meshRendererComponent||!t.meshDataComponent||!t.transformComponent)return void console.warn("Entity missing required components for boundingtree construction: ",t);var e=t.meshDataComponent.meshData;if(e.updatePrimitiveCounts(),1===e.getSectionCount()){this.primitiveIndices=[];for(var r=0,i=e.getPrimitiveCount(0);i>r;r++)this.primitiveIndices.push(r);this.createTree(t,0,0,this.primitiveIndices.length)}else this.split(t,0,e.getSectionCount())},i.prototype.createTree=function(t,e,r,n){var o=t.meshDataComponent.meshData;this.section=e,this.start=r,this.end=n,this.primitiveIndices&&(this.createBounds(),this.localBound.computeFromPrimitives(o,e,this.primitiveIndices,r,n),n-r+1<=i.MAX_PRIMITIVES_PER_LEAF||(this.leftTree||(this.leftTree=new i(this.boundType)),this.leftTree.primitiveIndices=this.primitiveIndices,this.leftTree.createTree(t,e,r,Math.floor((r+n)/2)),this.rightTree||(this.rightTree=new i(this.boundType)),this.rightTree.primitiveIndices=this.primitiveIndices,this.rightTree.createTree(t,e,Math.floor((r+n)/2),n)))},i.prototype.split=function(t,e,r){var n=r-e,o=Math.floor(n/2);if(1===o){var a=e;this.leftTree=new i(this.boundType),this.leftTree.primitiveIndices=[];for(var s=0;s<this.leftTree.primitiveIndices.length;s++)this.leftTree.primitiveIndices.push(s);this.leftTree.createTree(t,a,0,this.leftTree.primitiveIndices.length)}else this.leftTree=new i(this.boundType),this.leftTree.split(t,e,e+o);if(n-o===1){var a=e+1;this.rightTree=new i(this.boundType),this.rightTree._primitiveIndices=[];for(var s=0;s<this.rightTree.primitiveIndices.length;s++)this.rightTree.primitiveIndices.push(s);this.rightTree.createTree(t,a,0,this.rightTree.primitiveIndices.length)}else this.rightTree=new i(this.boundType),this.rightTree.split(t,e+o,r);this.localBound=this.leftTree.localBound.clone(this.localBound),this.localBound.merge(this.rightTree.localBound),this.worldBound=this.localBound.clone(this.worldBound)},i.prototype.createBounds=function(){switch(this.boundType){case i.BOUNDTYPE_BOX:this.localBound=new t,this.worldBound=new t;break;case i.BOUNDTYPE_SPHERE:this.localBound=new e,this.worldBound=new e}},i.prototype.findPick=function(t,e,i){var n=i;n||(n={});var o=e.transformComponent.worldTransform;if(this.localBound.transform(o,this.worldBound),!this.worldBound.intersectsRay(t))return n;if(this.leftTree&&this.leftTree.findPick(t,e,n),this.rightTree)this.rightTree.findPick(t,e,n);else if(!this.leftTree)for(var a=e.meshDataComponent.meshData,s=null,h=new r,d=this.start;d<this.end;d++){s=a.getPrimitiveVertices(this.primitiveIndices[d],this.section,s);for(var l=0;l<s.length;l++)o.matrix.applyPostPoint(s[l]);if(t.intersects(s,!1,h)){n.distances=n.distances||[],n.distances.push(t.origin.distance(h)),n.points=n.points||[];var u=new r;u.setv(h),n.points.push(u),n.vertices=n.vertices||[];for(var c=[],p=s.length-1;p>=0;p--)c[p]=(new r).setv(s[p]);n.vertices.push(c)}}return n},i}),define("goo/picking/PrimitivePickLogic",["goo/picking/BoundingTree"],function(t){"use strict";function e(){}return e.prototype.getPickResult=function(t,e){var r=e.meshDataComponent.meshData.__boundingTree;return r?r.findPick(t,e,{}):null},e.prototype.added=function(t){this.isConstructed(t)||this.rebuild(t)},e.prototype.removed=function(t){t.meshDataComponent&&t.meshDataComponent.meshData&&(t.meshDataComponent.meshData.__boundingTree=null)},e.prototype.isConstructed=function(t){return!!t.meshDataComponent.meshData.__boundingTree},e.prototype.rebuild=function(e){e.meshDataComponent.meshData.__boundingTree=new t,e.meshDataComponent.meshData.__boundingTree.construct(e)},e}),define("goo/renderer/pass/Composer",["goo/renderer/pass/RenderTarget","goo/renderer/pass/FullscreenPass","goo/renderer/shaders/ShaderLib","goo/entities/SystemBus"],function(t,e,r,i){"use strict";function n(n){if(this._passedWriteBuffer=!!n,this.writeBuffer=n,void 0===this.writeBuffer){var o=window.innerWidth||1,a=window.innerHeight||1;this.writeBuffer=new t(o,a)}this.readBuffer=this.writeBuffer.clone(),this.passes=[],this._clearColor=[0,0,0,1],this.copyPass=new e(r.copy),this.size=null,this.dirty=!1,this._viewportResizeHandler=function(t){this.dirty=!0,this.size=t}.bind(this),i.addListener("goo.viewportResize",this._viewportResizeHandler,!0)}var o=window.WebGLRenderingContext;return n.prototype.destroy=function(t){this.deallocateBuffers(t);for(var e=0;e<this.passes.length;e++){var r=this.passes[e];r.destroy(t)}i.removeListener("goo.viewportResize",this._viewportResizeHandler)},n.prototype.deallocateBuffers=function(t){this.writeBuffer&&!this._passedWriteBuffer&&this.writeBuffer.destroy(t.context),this.readBuffer&&this.readBuffer.destroy(t.context),this.copyPass.destroy(t)},n.prototype.swapBuffers=function(){var t=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=t},n.prototype._checkPassResize=function(t,e){return t.viewportSize&&t.viewportSize.x===e.x&&t.viewportSize.y===e.y&&t.viewportSize.width===e.width&&t.viewportSize.height===e.height?!1:!0},n.prototype.addPass=function(t,e){this.passes.push(t),t.updateSize&&this.size&&this._checkPassResize(t,this.size)&&(t.updateSize(this.size,e),t.viewportSize=this.size)},n.prototype.setClearColor=function(t){this._clearColor[0]=t[0],this._clearColor[1]=t[1],this._clearColor[2]=t[2],this._clearColor[3]=t[3]},n.prototype.updateSize=function(e){var r=this.size;if(r){var i=r.width,n=r.height;this.deallocateBuffers(e),this.writeBuffer=new t(i,n),this.readBuffer=this.writeBuffer.clone();for(var o=0,a=this.passes.length;a>o;o++){var s=this.passes[o];s.updateSize&&this._checkPassResize(s,r)&&(s.updateSize(r,e),s.viewportSize=r)}}},n.prototype.render=function(t,e,r,i){this.dirty&&(this.updateSize(t),this.dirty=!1);var n,a,s=!1,h=this.passes.length;for(a=0;h>a;a++)if(n=this.passes[a],n.enabled&&(n.render(t,this.writeBuffer,this.readBuffer,e,s,r,i,this._clearColor),n.needsSwap)){if(s){var d=this.renderer.context;d.stencilFunc(o.NOTEQUAL,1,4294967295),this.copyPass.render(t,this.writeBuffer,this.readBuffer,e,r,i),d.stencilFunc(o.EQUAL,1,4294967295)}this.swapBuffers()}},n}),define("goo/renderer/pass/RenderPass",["goo/renderer/Renderer","goo/renderer/pass/Pass","goo/math/Vector4"],function(t,e,r){"use strict";function i(t,e){this.renderList=t,this.filter=e,this.clearColor=new r(0,0,0,0),this.oldClearColor=new r,this.renderToScreen=!1,this.overrideMaterial=null,this.enabled=!0,this.clear=!0,this.needsSwap=!1}return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.render=function(e,r,i,n,o,a,s,h){if(a=a||t.mainCamera){s=s||[];var d;d=this.filter?this.renderList.filter(this.filter):this.renderList,this.renderToScreen?e.render(d,a,s,null,this.clear,this.overrideMaterial):e.render(d,a,s,i,this.clear,this.overrideMaterial)}},i}),define("goo/shapes/SimpleBox",["goo/renderer/MeshData"],function(t){"use strict";function e(e,r,i){this.xExtent=void 0!==e?.5*e:.5,this.yExtent=void 0!==r?.5*r:.5,this.zExtent=void 0!==i?.5*i:.5;var n=t.defaultMap([t.POSITION]);t.call(this,n,8,36),this.rebuild()}return e.prototype=Object.create(t.prototype),e.prototype.rebuild=function(){var e=this.xExtent,r=this.yExtent,i=this.zExtent;return this.getAttributeBuffer(t.POSITION).set([-e,-r,-i,e,-r,-i,e,r,-i,-e,r,-i,-e,-r,i,e,-r,i,e,r,i,-e,r,i]),this.getIndexBuffer().set([0,1,2,2,3,0,7,6,5,5,4,7,0,3,7,7,4,0,1,2,6,6,5,1,3,2,6,6,7,3,0,1,5,5,4,0]),this},e}),define("goo/sound/OscillatorSound",["goo/sound/AudioContext","goo/math/MathUtils"],function(t,e){"use strict";function r(){this.id=null,this._volume=1,this._frequency=440,this._type="sine",this._outNode=t.createGain(),this.connectTo()}return r.prototype.stop=function(){this._oscNode.stop(),this._oscNode=null},r.prototype.play=function(){this._oscNode=t.createOscillator(),this._oscNode.connect(this._outNode),this._oscNode.frequency.value=this._frequency,this._oscNode.type=this._type,this._oscNode.start()},r.prototype.update=function(t){void 0!==t.volume&&(this._volume=e.clamp(t.volume,0,1),this._outNode.gain.value=this._volume),void 0!==t.frequency&&(this._frequency=t.frequency,this._oscNode&&(this._oscNode.frequency.value=this._frequency)),void 0!==t.type&&-1!==r.TYPES.indexOf(t.type)&&(this._type=t.type,this._oscNode&&(this._oscNode.type=this._type))},r.prototype.connectTo=function(e){if(!t)return void console.warn("Webaudio not supported");if(this._outNode.disconnect(),e){e instanceof Array||(e=[e]);for(var r=0;r<e.length;r++)this._outNode.connect(e[r])}},r.TYPES=["sine","square","sawtooth","triangle","custom"],r}),define("goo/util/MeshBuilder",["goo/renderer/MeshData","goo/math/Vector3","goo/entities/EntityUtils"],function(t,e,r){"use strict";function i(){this.meshDatas=[],this.vertexData={},this.indexData=[],this.vertexCounter=0,this.indexCounter=0,this.indexLengths=[],this.indexModes=[]}i.prototype.addEntity=function(t){t.traverse(function(t){t.transformComponent._dirty&&t.transformComponent.updateTransform()}),t.traverse(function(t){t.transformComponent._dirty&&r.updateWorldTransform(t.transformComponent)}),t.traverse(function(t){t.meshDataComponent&&this.addMeshData(t.meshDataComponent.meshData,t.transformComponent.worldTransform)})};var n=new e;return i.prototype.addMeshData=function(e,r){if(e.vertexCount>=65536)throw new Error("Maximum number of vertices for a mesh to add is 65535. Got: "+e.vertexCount);this.vertexCounter+e.vertexCount>=65536&&this._generateMesh();for(var i=r.matrix,o=r.rotation,a=e.attributeMap,s=Object.keys(a),h=0,d=s.length;d>h;h++){var l=s[h],u=a[l],c=this.vertexData[l];c||(this.vertexData[l]={},c=this.vertexData[l],c.array=[],c.map={count:u.count,type:u.type,stride:u.stride,offset:u.offset,normalized:u.normalized});var p=e.getAttributeBuffer(l),f=p.length,m=c.array,g=u.count,v=this.vertexCounter*g;if(l===t.POSITION)for(var y=0;f>y;y+=g)n.setd(p[y+0],p[y+1],p[y+2]),i.applyPostPoint(n),m[v+y+0]=n.data[0],m[v+y+1]=n.data[1],m[v+y+2]=n.data[2];else if(l===t.NORMAL)for(var y=0;f>y;y+=g)n.setd(p[y+0],p[y+1],p[y+2]),o.applyPost(n),m[v+y+0]=n.data[0],m[v+y+1]=n.data[1],m[v+y+2]=n.data[2];else if(l===t.TANGENT)for(var y=0;f>y;y+=g)n.setd(p[y+0],p[y+1],p[y+2]),o.applyPost(n),m[v+y+0]=n.data[0],m[v+y+1]=n.data[1],m[v+y+2]=n.data[2],m[v+y+3]=p[y+3];else for(var y=0;f>y;y++)m[v+y]=p[y]}for(var x=e.getIndexBuffer(),y=0,d=e.indexCount;d>y;y++)this.indexData[this.indexCounter+y]=x[y]+this.vertexCounter;this.vertexCounter+=e.vertexCount,this.indexCounter+=e.indexCount,this.indexLengths=this.indexLengths.concat(e.indexLengths?e.indexLengths:e.getIndexBuffer().length),this.indexModes=this.indexModes.concat(e.indexModes)},i.prototype._generateMesh=function(){var e={};for(var r in this.vertexData){var i=this.vertexData[r];e[r]=i.map}var n=new t(e,this.vertexCounter,this.indexCounter);for(var r in this.vertexData){var i=this.vertexData[r].array;n.getAttributeBuffer(r).set(i)}n.getIndexBuffer().set(this.indexData),n.indexLengths=this.indexLengths,n.indexModes=this.indexModes;for(var o=n.indexModes[0],a=0,s=[],h=[],d=0;d<n.indexModes.length;d++){var l=n.indexModes[d];o!==l&&(s.push(o),h.push(a),o=l,a=0),a+=n.indexLengths[d],d===n.indexModes.length-1&&(s.push(l),h.push(a),o=l,a=0)}n.indexLengths=h,n.indexModes=s,this.meshDatas.push(n),this.vertexData={},this.indexData=[],this.vertexCounter=0,this.indexCounter=0,this.indexLengths=[],this.indexModes=[]},i.prototype.build=function(){return this.vertexCounter>0&&this._generateMesh(),this.meshDatas},i.prototype.reset=function(){this.meshDatas=[],this.vertexData={},this.indexData=[],this.vertexCounter=0,this.indexCounter=0,this.indexLengths=[],this.indexModes=[]},i}),define("goo/util/Rc4Random",[],function(){"use strict";function t(t){function e(){i=(i+1)%256,n=(n+r[i])%256;var t=r[i];return r[i]=r[n],r[n]=t,r[(r[i]+r[n])%256]}var r=[],i=0,n=0;this.init=function(t){for(var e=0;256>e;e++)r[e]=e;for(var i=0,e=0;256>e;e++){i=(i+r[e]+t.charCodeAt(e%t.length))%256;var n=r[e];r[e]=r[i],r[i]=n}},this.init(t),this.getRandomNumber=function(){for(var t=0,r=1,i=0;8>i;i++)t+=e()*r,r*=256;return t/0x10000000000000000}}return t}),define("goo/util/SoundCreator",["goo/renderer/Util","goo/loaders/handlers/SoundHandler","goo/util/Ajax","goo/util/StringUtil"],function(t,e,r,i){"use strict";function n(){var t=this.ajax=new r;this.soundHandler=new e({},function(e,r){return t.load(e,r?r.noCache:!1)},function(){},function(e,r){return t.load(e,r?r.noCache:!1)})}return n.prototype.clear=function(){this.ajax.clear(),this.soundHandler.clear()},n.prototype.loadSound=function(t,e,r){var n=i.createUniqueId("sound");e=e||{},e.audioRefs={};var o=i.getAfterLast(t,".");e.audioRefs[o]=t;var a=this.soundHandler._objects[n]=this.soundHandler._create();return this.soundHandler.update(n,e,{}).then(function(){r&&r(a)}),a},n}),define("goo/util/combine/Rectangle",[],function(){"use strict";function t(t,e,r,i){this.x=t,this.y=e,this.w=r,this.h=i}return t}),define("goo/util/combine/AtlasNode",["goo/util/combine/Rectangle"],function(t){"use strict";function e(e,r){this.isLeaf=!0,this.isSet=!1,this.children=[],this.localRectangle=void 0!==e&&void 0!==r?new t(0,0,e,r):null}return e.prototype.getRectangles=function(){var t=[];return this._getRectangles(t),t},e.prototype._getRectangles=function(t){this.isSet&&t.push(this.localRectangle),this.isLeaf||(this.children[0]._getRectangles(t),this.children[1]._getRectangles(t))},e.prototype.insert=function(e,r){return this._insert(new t(0,0,e,r))},e.prototype._insert=function(r){if(this.isLeaf){if(this.isSet)return null;if(r.w>this.localRectangle.w||r.h>this.localRectangle.h)return null;if(r.w===this.localRectangle.w&&r.h===this.localRectangle.h)return this.isSet=!0,this;this.isLeaf=!1,this.children[0]=new e,this.children[1]=new e;var i=this.localRectangle.w-r.w,n=this.localRectangle.h-r.h;return i>n?(this.children[0].localRectangle=new t(this.localRectangle.x,this.localRectangle.y,r.w,this.localRectangle.h),this.children[1].localRectangle=new t(this.localRectangle.x+r.w,this.localRectangle.y,i,this.localRectangle.h)):(this.children[0].localRectangle=new t(this.localRectangle.x,this.localRectangle.y,this.localRectangle.w,r.h),this.children[1].localRectangle=new t(this.localRectangle.x,this.localRectangle.y+r.h,this.localRectangle.w,n)),this.children[0]._insert(r)}var o=this.children[0]._insert(r);return null!==o?o:this.children[1]._insert(r)},e}),define("goo/util/combine/EntityCombiner",["goo/entities/EntityUtils","goo/entities/Entity","goo/util/MeshBuilder","goo/math/Transform","goo/math/Vector3","goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere"],function(t,e,r,i,n,o,a){"use strict";function s(t,e,r,i){this.world=t,this.gridCount=e||1,this.gridSize=1,this.removeOldData=void 0!==r?r:!0,this.keepEntities=void 0!==i?i:!1}function h(){var t=[],e=[];return{put:function(r,i){var n=t.indexOf(r);-1===n?(t.push(r),e.push(i)):e[n]=i},get:function(r){return e[t.indexOf(r)]},getKeys:function(){return t},getValues:function(){return e}}}return s.prototype.combine=function(){this.world.processEntityChanges(),this.world.getSystem("TransformSystem")._process(),this.world.getSystem("BoundingUpdateSystem")._process();var t=this.world.entityManager.getTopEntities();this.gridSize>1&&(this.gridSize=this._calculateBounds(t)/this.gridCount),this._combineList(t)},s.prototype._combineList=function(t){var r=t;if(t instanceof e==!1){r=this.world.createEntity("root"),r.addToWorld();for(var i=0;i<t.length;i++)r.attachChild(t[i])}var n=new h;this._buildSubs(r,n);for(var o=n.getKeys(),i=0;i<o.length;i++){var a=o[i],s=n.get(a);this._combine(a,s)}},s.prototype._buildSubs=function(t,e,r){if(!(t._hidden||t.skip||t.animationComponent||t.particleComponent)){r&&t.static!==!1||(r=[],e.put(t,r)),t.meshDataComponent&&t.meshRendererComponent&&t.meshRendererComponent.worldBound&&r.push(t);for(var i=0;i<t.transformComponent.children.length;i++){var n=t.transformComponent.children[i];this._buildSubs(n.entity,e,r)}}},s.prototype._combine=function(t,e){var n=t.transformComponent.worldTransform,o=new i,a=new i;n.invert(o);for(var s=new h,d=0;d<e.length;d++){var l=e[d],u=l.meshRendererComponent.materials[0],c=l.meshDataComponent.meshData.attributeMap,p=Object.keys(c);if(p.sort(),p=p.join("_"),this.gridSize>1){var f=l.meshRendererComponent.worldBound.center.x/this.gridSize,m=l.meshRendererComponent.worldBound.center.z/this.gridSize;p=p+"_"+Math.round(f)+"_"+Math.round(m)}var g=s.get(u);g||(g=new h,s.put(u,g));var v=g.get(p);v||(v=[],g.put(p,v)),v.push(l)}for(var y=s.getKeys(),d=0;d<y.length;d++)for(var x=y[d],_=s.get(x),w=_.getKeys(),b=0;b<w.length;b++){var S=_.get(w[b]);if(1!==S.length){for(var E=new r,C=0;C<S.length;C++){var l=S[C];t!==l?a.multiply(o,l.transformComponent.worldTransform):a.setIdentity(),E.addMeshData(l.meshDataComponent.meshData,a),this.removeOldData?(l.clearComponent("meshDataComponent"),l.clearComponent("meshRendererComponent"),this.keepEntities||1!==l._components.length||0!==l.transformComponent.children.length||l.removeFromWorld()):(l.skip=!0,l._hidden=!0)}var M=E.build();for(var u in M){var l=this.world.createEntity(M[u],x);l.addToWorld(),t.attachChild(l)}}}},s.prototype._calculateBounds=function(t){for(var e=!0,r=new o,i=0;i<t.length;i++){var s=t[i];s.traverse(function(t){if(t.meshRendererComponent&&!t.particleComponent)if(e){var i=t.meshRendererComponent.worldBound;i instanceof o?i.clone(r):i instanceof a?(r.center.setv(i.center),r.xExtent=r.yExtent=r.zExtent=i.radius):(r.center.setv(n.ZERO),r.xExtent=r.yExtent=r.zExtent=10),e=!1}else r.merge(t.meshRendererComponent.worldBound)})}return 2*Math.max(r.xExtent,r.zExtent)},s}),define("goo/scripts/GooClassRegister",["goo/scripts/Scripts","goo/entities/Entity","goo/entities/EntitySelection","goo/entities/EntityUtils","goo/entities/Selection","goo/entities/SystemBus","goo/entities/World","goo/entities/components/CSSTransformComponent","goo/entities/components/CameraComponent","goo/entities/components/Component","goo/entities/components/HtmlComponent","goo/entities/components/LightComponent","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/entities/components/MovementComponent","goo/entities/components/ParticleComponent","goo/entities/components/PortalComponent","goo/entities/components/ScriptComponent","goo/entities/components/SoundComponent","goo/entities/components/TextComponent","goo/entities/components/TransformComponent","goo/entities/managers/EntityManager","goo/entities/managers/Manager","goo/entities/systems/BoundingUpdateSystem","goo/entities/systems/CSSTransformSystem","goo/entities/systems/CameraSystem","goo/entities/systems/GridRenderSystem","goo/entities/systems/HtmlSystem","goo/entities/systems/LightingSystem","goo/entities/systems/MovementSystem","goo/entities/systems/ParticlesSystem","goo/entities/systems/PickingSystem","goo/entities/systems/PortalSystem","goo/entities/systems/RenderSystem","goo/entities/systems/SoundSystem","goo/entities/systems/System","goo/entities/systems/TextSystem","goo/entities/systems/TransformSystem","goo/loaders/DynamicLoader","goo/math/MathUtils","goo/math/Matrix","goo/math/Matrix2x2","goo/math/Matrix3x3","goo/math/Matrix4x4","goo/math/Plane","goo/math/Quaternion","goo/math/Ray","goo/math/Transform","goo/math/Vector","goo/math/Vector2","goo/math/Vector3","goo/math/Vector4","goo/noise/Noise","goo/noise/ValueNoise","goo/particles/Particle","goo/particles/ParticleEmitter","goo/particles/ParticleInfluence","goo/particles/ParticleLib","goo/particles/ParticleUtils","goo/picking/BoundingTree","goo/picking/PrimitivePickLogic","goo/renderer/BufferData","goo/renderer/BufferUtils","goo/renderer/Camera","goo/renderer/Material","goo/renderer/MeshData","goo/renderer/RenderQueue","goo/renderer/Renderer","goo/renderer/RendererRecord","goo/renderer/Shader","goo/renderer/ShaderCall","goo/renderer/SimplePartitioner","goo/renderer/Texture","goo/renderer/TextureCreator","goo/renderer/Util","goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere","goo/renderer/bounds/BoundingVolume","goo/renderer/light/DirectionalLight","goo/renderer/light/Light","goo/renderer/light/PointLight","goo/renderer/light/SpotLight","goo/renderer/pass/Composer","goo/renderer/pass/FullscreenPass","goo/renderer/pass/FullscreenUtil","goo/renderer/pass/RenderPass","goo/renderer/pass/RenderTarget","goo/renderer/shaders/ShaderBuilder","goo/renderer/shaders/ShaderFragment","goo/renderer/shaders/ShaderLib","goo/renderer/shadow/ShadowHandler","goo/scripts/ScriptUtils","goo/shapes/Box","goo/shapes/Cone","goo/shapes/Cylinder","goo/shapes/Disk","goo/shapes/Grid","goo/shapes/Quad","goo/shapes/SimpleBox","goo/shapes/Sphere","goo/shapes/TextureGrid","goo/shapes/Torus","goo/sound/AudioContext","goo/sound/OscillatorSound","goo/sound/Sound","goo/util/Ajax","goo/util/ArrayUtil","goo/util/CanvasUtils","goo/util/Enum","goo/util/GameUtils","goo/util/MeshBuilder","goo/util/ObjectUtil","goo/util/ParticleSystemUtils","goo/util/PromiseUtil","goo/util/Rc4Random","goo/util/ShapeCreatorMemoized","goo/util/Skybox","goo/util/Snow","goo/util/SoundCreator","goo/util/Stats","goo/util/StringUtil","goo/util/TangentGenerator","goo/util/combine/AtlasNode","goo/util/combine/EntityCombiner","goo/util/combine/Rectangle","goo/util/rsvp"],function(t){"use strict";for(var e=["Scripts","Entity","EntitySelection","EntityUtils","Selection","SystemBus","World","CSSTransformComponent","CameraComponent","Component","HtmlComponent","LightComponent","MeshDataComponent","MeshRendererComponent","MovementComponent","ParticleComponent","PortalComponent","ScriptComponent","SoundComponent","TextComponent","TransformComponent","EntityManager","Manager","BoundingUpdateSystem","CSSTransformSystem","CameraSystem","GridRenderSystem","HtmlSystem","LightingSystem","MovementSystem","ParticlesSystem","PickingSystem","PortalSystem","RenderSystem","SoundSystem","System","TextSystem","TransformSystem","DynamicLoader","MathUtils","Matrix","Matrix2x2","Matrix3x3","Matrix4x4","Plane","Quaternion","Ray","Transform","Vector","Vector2","Vector3","Vector4","Noise","ValueNoise","Particle","ParticleEmitter","ParticleInfluence","ParticleLib","ParticleUtils","BoundingTree","PrimitivePickLogic","BufferData","BufferUtils","Camera","Material","MeshData","RenderQueue","Renderer","RendererRecord","Shader","ShaderCall","SimplePartitioner","Texture","TextureCreator","Util","boundingBox","boundingSphere","boundingVolume","DirectionalLight","Light","PointLight","SpotLight","Composer","FullscreenPass","FullscreenUtil","RenderPass","RenderTarget","ShaderBuilder","ShaderFragment","ShaderLib","ShadowHandler","ScriptUtils","Box","Cone","Cylinder","Disk","Grid","Quad","SimpleBox","Sphere","TextureGrid","Torus","AudioContext","OscillatorSound","Sound","Ajax","ArrayUtil","CanvasUtils","Enum","GameUtils","MeshBuilder","ObjectUtil","ParticleSystemUtils","PromiseUtil","Rc4Random","ShapeCreatorMemoized","Skybox","Snow","SoundCreator","Stats","StringUtil","TangentGenerator","AtlasNode","EntityCombiner","Rectangle","rsvp"],r=1;r<e.length;r++){var i=e[r].slice(e[r].lastIndexOf("/")+1);
t.addClass(i,arguments[r])}}),define("goo/scripts/OrbitCamControlScript",["goo/math/Vector3","goo/math/Vector2","goo/math/MathUtils","goo/renderer/Camera","goo/entities/SystemBus"],function(t,e,r,i,n){"use strict";function o(i,n){n.dirty=!0,n.timeSamples=[0,0,0,0,0],n.xSamples=[0,0,0,0,0],n.ySamples=[0,0,0,0,0],n.sample=0,n.velocity=new e(0,0),n.cartesian=new t,n.worldUpVector=new t(t.UNIT_Y),n.maxSampleTimeMS=200,n.mouseState={buttonDown:!1,lastX:0/0,lastY:0/0},n.smoothness=Math.pow(r.clamp(i.smoothness,0,1),.3),n.inertia=Math.pow(r.clamp(i.drag,0,1),.3),n.dragButton=["Any","Left","Middle","Right","None"].indexOf(i.dragButton)-1,n.dragButton<-1?n.dragButton=-1:4===n.dragButton&&(n.dragButton=null);var o;if(i.lookAtDistance){var a=n.entity.getRotation();o=n.spherical=new t(i.lookAtDistance,-a[1]+Math.PI/2,-a[0])}else if(i.spherical)var o=n.spherical=new t(i.spherical[0],i.spherical[1]*r.DEG_TO_RAD,i.spherical[2]*r.DEG_TO_RAD);else var o=n.spherical=new t(15,0,0);if(n.targetSpherical=new t(o),i.lookAtDistance){var s=n.entity.transformComponent.transform.rotation;n.lookAtPoint=new t(0,0,-i.lookAtDistance),s.applyPost(n.lookAtPoint),n.lookAtPoint.addv(n.entity.getTranslation())}else n.lookAtPoint=i.lookAtPoint?new t(i.lookAtPoint):new t;n.goingToLookAt=new t(n.lookAtPoint),d(1,n),c(i,n)}function a(t,e,i,n){n.domElement!==document&&n.domElement.focus();var o=n.dragButton,a=n.mouseState;(-1===o||o===t||e===!1)&&(a.buttonDown=e,e?(a.lastX=0/0,a.lastY=0/0,n.velocity.setd(0,0),n.spherical.data[1]=r.moduloPositive(n.spherical.data[1],r.TWO_PI),n.targetSpherical.setv(n.spherical)):u(i,n))}function s(t,e,r,i){var n=0,o=0,a=i.mouseState;isNaN(a.lastX)||isNaN(a.lastY)?(a.lastX=t,a.lastY=e):(n=-(t-a.lastX),o=e-a.lastY,a.lastX=t,a.lastY=e),!a.buttonDown||0===n&&0===o||(i.timeSamples[i.sample]=Date.now(),i.xSamples[i.sample]=n,i.ySamples[i.sample]=o,i.sample++,i.sample>i.timeSamples.length-1&&(i.sample=0),i.velocity.setd(0,0),h(r.orbitSpeed*n,r.orbitSpeed*o,r,i))}function h(t,e,i,n){var o=n.targetSpherical.data;if(i.clampAzimuth){var a=i.minAzimuth*r.DEG_TO_RAD,s=i.maxAzimuth*r.DEG_TO_RAD;o[1]=r.radialClamp(o[1]-t,a,s)}else o[1]=o[1]-t;var h=i.minAscent*r.DEG_TO_RAD,d=i.maxAscent*r.DEG_TO_RAD;o[2]=r.clamp(o[2]+e,h,d),n.dirty=!0}function d(t,e){var r=e.entity.cameraComponent.camera;if(r.projectionMode===i.Parallel){e.size=r.top,e.size/=t;var n=e.size;r.setFrustum(null,null,-n,n,n,-n)}}function l(t,e,i){var n=Math.max(-1,Math.min(1,-t.wheelDelta||t.detail));n*=v*i.targetSpherical.data[0];var o=i.targetSpherical.data;o[0]=r.clamp(o[0]+e.zoomSpeed*n,e.minZoomDistance,e.maxZoomDistance),i.dirty=!0}function u(t,e){for(var r=e.timeSamples,i=Date.now(),n=0,o=0,a=!1,s=0,h=r.length;h>s;s++)i-r[s]<e.maxSampleTimeMS&&(n+=e.xSamples[s],o+=e.ySamples[s],a=!0);a?e.velocity.setd(n*t.orbitSpeed/r.length,o*t.orbitSpeed/r.length):e.velocity.setd(0,0)}function c(t,e){var r=0,i=!!navigator.userAgent.match(/Android/i),n={wheelDelta:0};e.listeners={mousedown:function(r){if(!t.whenUsed||e.entity===e.activeCameraEntity){var i=r.button;0===i&&(r.altKey?i=2:r.shiftKey&&(i=1)),a(i,!0,t,e)}},mouseup:function(r){var i=r.button;0===i&&(r.altKey?i=2:r.shiftKey&&(i=1)),a(i,!1,t,e)},mousemove:function(r){t.whenUsed&&e.entity!==e.activeCameraEntity||s(r.clientX,r.clientY,t,e)},mouseleave:function(t){e.orbitListeners.mouseup(t)},mousewheel:function(r){t.whenUsed&&e.entity!==e.activeCameraEntity||l(r,t,e)},touchstart:function(r){t.whenUsed&&e.entity!==e.activeCameraEntity||a(e.dragButton,1===r.targetTouches.length,t,e),i&&r.preventDefault()},touchend:function(){a(e.dragButton,!1,t,e),r=0},touchmove:function(i){if(!t.whenUsed||e.entity===e.activeCameraEntity){var o,a,h,d=i.targetTouches,u=d[0].clientX,c=d[0].clientY;if(2===d.length){var p=d[1].clientX,f=d[1].clientY;h=(u-p)*(u-p)+(c-f)*(c-f)}else o=u,a=c,s(o,a,t,e);var m=(h-r)/Math.max(e.domElement.offsetHeight,e.domElement.offsetWidth);m/=3,0===r?r=h:2===d.length&&Math.abs(m)>.3&&(n.wheelDelta=m,l(n,t,e),r=h)}}},e.listeners.DOMMouseScroll=e.listeners.mousewheel,e.listeners.mouseleave=e.listeners.mouseup;for(var o in e.listeners)e.domElement.addEventListener(o,e.listeners[o]);e.domElement.oncontextmenu=function(){return!1}}function p(t,e,i){if(i.velocity.lengthSquared()>y){h(i.velocity.x,i.velocity.y,e,i);var n=r.lerp(i.inertia,0,1-t/i.inertia);i.velocity.mul(n)}else i.velocity.setd(0,0,0)}function f(t,e){if(e.dirty){var i=e.spherical,o=e.targetSpherical,a=e.lookAtPoint,s=e.goingToLookAt,h=e.cartesian,l=e.entity,u=l.transformComponent,c=u.transform,f=r.lerp(e.smoothness,1,e.world.tpf);s.distanceSquared(a)<y?a.setv(s):a.lerp(s,f),e.inertia>0&&p(l._world.tpf,t,e);var m=i.data,g=o.data;m[1]=r.lerp(f,m[1],g[1]),m[2]=r.lerp(f,m[2],g[2]);var v=m[0];m[0]=r.lerp(f,m[0],g[0]),v/=m[0],d(v,e),r.sphericalToCartesian(m[0],m[1],m[2],h),c.translation.set(h.add(a)),c.translation.equals(a)||c.lookAt(a,e.worldUpVector),i.distanceSquared(o)<y&&e.lookAtPoint.equals(e.goingToLookAt)&&(m[1]=r.moduloPositive(m[1],r.TWO_PI),o.setv(i),e.dirty=!1),u.setUpdated(),n.emit("goo.cameraPositionChanged",{spherical:e.spherical.data,translation:c.translation.data,lookAtPoint:e.lookAtPoint.data,id:l.id})}}function m(t,e){for(var r in e.listeners)e.domElement.removeEventListener(r,e.listeners[r])}function g(){return{setup:o,update:f,cleanup:m}}var v=.035,y=1e-6;return g.externals={key:"OrbitCamControlScript",name:"OrbitCamera Control",description:"Enables camera to orbit around a point in 3D space using the mouse",parameters:[{key:"whenUsed","default":!0,name:"When Camera Used",description:"Script only runs when the camera to which it is added is being used.",type:"boolean"},{key:"dragButton",description:"Button to enable dragging","default":"Any",options:["Any","Left","Middle","Right","None"],type:"string",control:"select"},{key:"orbitSpeed","default":.005,type:"float",scale:.001,decimals:3},{key:"zoomSpeed","default":1,type:"float",scale:.1},{key:"drag",name:"Inertia","default":.9,type:"float",control:"slider",min:0,max:1},{key:"smoothness","default":.4,type:"float",min:0,max:1,control:"slider"},{key:"minZoomDistance","default":1,type:"float",min:.01},{key:"maxZoomDistance","default":1e3,type:"float",min:1},{key:"minAscent",description:"Maximum arc the camera can reach below the target point","default":-89,type:"int",control:"slider",min:-89,max:89},{key:"maxAscent",description:"Maximum arc the camera can reach above the target point","default":89.95,type:"int",control:"slider",min:-89,max:89},{key:"clampAzimuth","default":!1,type:"boolean"},{key:"minAzimuth",description:"Maximum arc the camera can reach clockwise of the target point","default":90,type:"int",control:"slider",min:0,max:360},{key:"maxAzimuth",description:"Maximum arc the camera can reach counter-clockwise of the target point","default":270,type:"int",control:"slider",min:0,max:360},{key:"lookAtDistance",description:"The point to orbit around","default":15,type:"float",min:.001}]},g}),require(["goo/entities/Bus","goo/entities/Entity","goo/entities/EntitySelection","goo/entities/EntityUtils","goo/entities/GooRunner","goo/entities/Selection","goo/entities/SystemBus","goo/entities/World","goo/entities/components/CSSTransformComponent","goo/entities/components/CameraComponent","goo/entities/components/Component","goo/entities/components/HtmlComponent","goo/entities/components/LightComponent","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/entities/components/MovementComponent","goo/entities/components/ParticleComponent","goo/entities/components/PortalComponent","goo/entities/components/ScriptComponent","goo/entities/components/SoundComponent","goo/entities/components/TextComponent","goo/entities/components/TransformComponent","goo/entities/managers/EntityManager","goo/entities/managers/Manager","goo/entities/systems/BoundingUpdateSystem","goo/entities/systems/CSSTransformSystem","goo/entities/systems/CameraSystem","goo/entities/systems/GridRenderSystem","goo/entities/systems/HtmlSystem","goo/entities/systems/LightingSystem","goo/entities/systems/MovementSystem","goo/entities/systems/ParticlesSystem","goo/entities/systems/PickingSystem","goo/entities/systems/PortalSystem","goo/entities/systems/RenderSystem","goo/entities/systems/ScriptSystem","goo/entities/systems/SoundSystem","goo/entities/systems/System","goo/entities/systems/TextSystem","goo/entities/systems/TransformSystem","goo/loaders/DynamicLoader","goo/loaders/crunch/CrunchLoader","goo/loaders/dds/DdsLoader","goo/loaders/dds/DdsUtils","goo/loaders/handlers/CameraComponentHandler","goo/loaders/handlers/ComponentHandler","goo/loaders/handlers/ConfigHandler","goo/loaders/handlers/EntityHandler","goo/loaders/handlers/EnvironmentHandler","goo/loaders/handlers/HtmlComponentHandler","goo/loaders/handlers/LightComponentHandler","goo/loaders/handlers/MaterialHandler","goo/loaders/handlers/MeshDataComponentHandler","goo/loaders/handlers/MeshDataHandler","goo/loaders/handlers/MeshRendererComponentHandler","goo/loaders/handlers/ProjectHandler","goo/loaders/handlers/SceneHandler","goo/loaders/handlers/ShaderHandler","goo/loaders/handlers/SkyboxHandler","goo/loaders/handlers/SoundComponentHandler","goo/loaders/handlers/SoundHandler","goo/loaders/handlers/TextureHandler","goo/loaders/handlers/TransformComponentHandler","goo/loaders/tga/TgaLoader","goo/math/MathUtils","goo/math/Matrix","goo/math/Matrix2x2","goo/math/Matrix3x3","goo/math/Matrix4x4","goo/math/Plane","goo/math/Quaternion","goo/math/Ray","goo/math/Transform","goo/math/Vector","goo/math/Vector2","goo/math/Vector3","goo/math/Vector4","goo/noise/Noise","goo/noise/ValueNoise","goo/particles/Particle","goo/particles/ParticleEmitter","goo/particles/ParticleInfluence","goo/particles/ParticleLib","goo/particles/ParticleUtils","goo/picking/BoundingTree","goo/picking/PrimitivePickLogic","goo/renderer/BufferData","goo/renderer/BufferUtils","goo/renderer/Camera","goo/renderer/Material","goo/renderer/MeshData","goo/renderer/RenderQueue","goo/renderer/Renderer","goo/renderer/RendererRecord","goo/renderer/Shader","goo/renderer/ShaderCall","goo/renderer/SimplePartitioner","goo/renderer/TaskScheduler","goo/renderer/Texture","goo/renderer/TextureCreator","goo/renderer/Util","goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere","goo/renderer/bounds/BoundingVolume","goo/renderer/light/DirectionalLight","goo/renderer/light/Light","goo/renderer/light/PointLight","goo/renderer/light/SpotLight","goo/renderer/pass/Composer","goo/renderer/pass/FullscreenPass","goo/renderer/pass/FullscreenUtil","goo/renderer/pass/Pass","goo/renderer/pass/RenderPass","goo/renderer/pass/RenderTarget","goo/renderer/shaders/ShaderBuilder","goo/renderer/shaders/ShaderFragment","goo/renderer/shaders/ShaderLib","goo/renderer/shadow/ShadowHandler","goo/scripts/GooClassRegister","goo/scripts/OrbitCamControlScript","goo/scripts/ScriptUtils","goo/scripts/Scripts","goo/shapes/Box","goo/shapes/Cone","goo/shapes/Cylinder","goo/shapes/Disk","goo/shapes/Grid","goo/shapes/Quad","goo/shapes/SimpleBox","goo/shapes/Sphere","goo/shapes/TextureGrid","goo/shapes/Torus","goo/sound/AudioContext","goo/sound/OscillatorSound","goo/sound/Sound","goo/util/Ajax","goo/util/ArrayUtil","goo/util/CanvasUtils","goo/util/Enum","goo/util/GameUtils","goo/util/Handy","goo/util/Latch","goo/util/Logo","goo/util/MeshBuilder","goo/util/ObjectUtil","goo/util/ParticleSystemUtils","goo/util/PromiseUtil","goo/util/Rc4Random","goo/util/ShapeCreatorMemoized","goo/util/Skybox","goo/util/Snow","goo/util/SoundCreator","goo/util/Stats","goo/util/StringUtil","goo/util/TangentGenerator","goo/util/combine/AtlasNode","goo/util/combine/EntityCombiner","goo/util/combine/Rectangle","goo/util/rsvp"],function(t,e,r,i,n,o,a,s,h,d,l,u,c,p,f,m,g,v,y,x,_,w,b,S,E,C,M,T,P,R,A,D,I,O,L,N,B,F,k,U,z,V,j,H,G,X,W,Y,q,K,Z,J,Q,$,te,ee,re,ie,ne,oe,ae,se,he,de,le,ue,ce,pe,fe,me,ge,ve,ye,xe,_e,we,be,Se,Ee,Ce,Me,Te,Pe,Re,Ae,De,Ie,Oe,Le,Ne,Be,Fe,ke,Ue,ze,Ve,je,He,Ge,Xe,We,Ye,qe,Ke,Ze,Je,Qe,$e,tr,er,rr,ir,nr,or,ar,sr,hr,dr,lr,ur,cr,pr,fr,mr,gr,vr,yr,xr,_r,wr,br,Sr,Er,Cr,Mr,Tr,Pr,Rr,Ar,Dr,Ir,Or,Lr,Nr,Br,Fr,kr,Ur,zr,Vr,jr,Hr,Gr,Xr,Wr,Yr,qr,Kr,Zr){var Jr=window.goo;Jr&&(Jr.Bus=t,Jr.Entity=e,Jr.EntitySelection=r,Jr.EntityUtils=i,Jr.GooRunner=n,Jr.Selection=o,Jr.SystemBus=a,Jr.World=s,Jr.CSSTransformComponent=h,Jr.CameraComponent=d,Jr.Component=l,Jr.HtmlComponent=u,Jr.LightComponent=c,Jr.MeshDataComponent=p,Jr.MeshRendererComponent=f,Jr.MovementComponent=m,Jr.ParticleComponent=g,Jr.PortalComponent=v,Jr.ScriptComponent=y,Jr.SoundComponent=x,Jr.TextComponent=_,Jr.TransformComponent=w,Jr.EntityManager=b,Jr.Manager=S,Jr.BoundingUpdateSystem=E,Jr.CSSTransformSystem=C,Jr.CameraSystem=M,Jr.GridRenderSystem=T,Jr.HtmlSystem=P,Jr.LightingSystem=R,Jr.MovementSystem=A,Jr.ParticlesSystem=D,Jr.PickingSystem=I,Jr.PortalSystem=O,Jr.RenderSystem=L,Jr.ScriptSystem=N,Jr.SoundSystem=B,Jr.System=F,Jr.TextSystem=k,Jr.TransformSystem=U,Jr.DynamicLoader=z,Jr.CrunchLoader=V,Jr.DdsLoader=j,Jr.DdsUtils=H,Jr.CameraComponentHandler=G,Jr.ComponentHandler=X,Jr.ConfigHandler=W,Jr.EntityHandler=Y,Jr.EnvironmentHandler=q,Jr.HtmlComponentHandler=K,Jr.LightComponentHandler=Z,Jr.MaterialHandler=J,Jr.MeshDataComponentHandler=Q,Jr.MeshDataHandler=$,Jr.MeshRendererComponentHandler=te,Jr.ProjectHandler=ee,Jr.SceneHandler=re,Jr.ShaderHandler=ie,Jr.SkyboxHandler=ne,Jr.SoundComponentHandler=oe,Jr.SoundHandler=ae,Jr.TextureHandler=se,Jr.TransformComponentHandler=he,Jr.TgaLoader=de,Jr.MathUtils=le,Jr.Matrix=ue,Jr.Matrix2x2=ce,Jr.Matrix3x3=pe,Jr.Matrix4x4=fe,Jr.Plane=me,Jr.Quaternion=ge,Jr.Ray=ve,Jr.Transform=ye,Jr.Vector=xe,Jr.Vector2=_e,Jr.Vector3=we,Jr.Vector4=be,Jr.Noise=Se,Jr.ValueNoise=Ee,Jr.Particle=Ce,Jr.ParticleEmitter=Me,Jr.ParticleInfluence=Te,Jr.ParticleLib=Pe,Jr.ParticleUtils=Re,Jr.BoundingTree=Ae,Jr.PrimitivePickLogic=De,Jr.BufferData=Ie,Jr.BufferUtils=Oe,Jr.Camera=Le,Jr.Material=Ne,Jr.MeshData=Be,Jr.RenderQueue=Fe,Jr.Renderer=ke,Jr.RendererRecord=Ue,Jr.Shader=ze,Jr.ShaderCall=Ve,Jr.SimplePartitioner=je,Jr.TaskScheduler=He,Jr.Texture=Ge,Jr.TextureCreator=Xe,Jr.Util=We,Jr.BoundingBox=Ye,Jr.BoundingSphere=qe,Jr.BoundingVolume=Ke,Jr.DirectionalLight=Ze,Jr.Light=Je,Jr.PointLight=Qe,Jr.SpotLight=$e,Jr.Composer=tr,Jr.FullscreenPass=er,Jr.FullscreenUtil=rr,Jr.Pass=ir,Jr.RenderPass=nr,Jr.RenderTarget=or,Jr.ShaderBuilder=ar,Jr.ShaderFragment=sr,Jr.ShaderLib=hr,Jr.ShadowHandler=dr,Jr.GooClassRegister=lr,Jr.OrbitCamControlScript=ur,Jr.ScriptUtils=cr,Jr.Scripts=pr,Jr.Box=fr,Jr.Cone=mr,Jr.Cylinder=gr,Jr.Disk=vr,Jr.Grid=yr,Jr.Quad=xr,Jr.SimpleBox=_r,Jr.Sphere=wr,Jr.TextureGrid=br,Jr.Torus=Sr,Jr.AudioContext=Er,Jr.OscillatorSound=Cr,Jr.Sound=Mr,Jr.Ajax=Tr,Jr.ArrayUtil=Pr,Jr.CanvasUtils=Rr,Jr.Enum=Ar,Jr.GameUtils=Dr,Jr.Handy=Ir,Jr.Latch=Or,Jr.Logo=Lr,Jr.MeshBuilder=Nr,Jr.ObjectUtil=Br,Jr.ParticleSystemUtils=Fr,Jr.PromiseUtil=kr,Jr.Rc4Random=Ur,Jr.ShapeCreatorMemoized=zr,Jr.Skybox=Vr,Jr.Snow=jr,Jr.SoundCreator=Hr,Jr.Stats=Gr,Jr.StringUtil=Xr,Jr.TangentGenerator=Wr,Jr.AtlasNode=Yr,Jr.EntityCombiner=qr,Jr.Rectangle=Kr,Jr.rsvp=Zr)}),define("goo",function(){});
}try{if(window.localStorage&&window.localStorage.gooPath){window.require.config({paths:{goo:localStorage.gooPath}})}else f()}catch(e){f()}})(window,undefined)